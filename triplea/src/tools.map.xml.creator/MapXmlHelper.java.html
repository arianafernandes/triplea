<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>MapXmlHelper.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (25/nov/2016 10:16:58)</a> &gt; <a href="../../index.html" class="el_group">triplea</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">tools.map.xml.creator</a> &gt; <span class="el_source">MapXmlHelper.java</span></div><h1>MapXmlHelper.java</h1><pre class="source lang-java linenums">package tools.map.xml.creator;

import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.SortedSet;
import java.util.TreeSet;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import com.google.common.base.Joiner;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;

import games.strategy.triplea.Constants;
import games.strategy.triplea.attachments.CanalAttachment;
import games.strategy.triplea.attachments.TechAttachment;
import games.strategy.triplea.attachments.TerritoryAttachment;
import games.strategy.triplea.attachments.UnitAttachment;
import games.strategy.triplea.delegate.BattleDelegate;
import games.strategy.util.Triple;
import tools.map.xml.creator.MapXmlCreator.GameStep;

/**
 * This class reads, writes and keeps the Map XML properties.
 */
<span class="nc" id="L41">public class MapXmlHelper {</span>

  private static final String XML_ATTR_VALUE_SEPARATOR_OPTION_VALUE = &quot;:&quot;;
  public static final String XML_ATTR_STEP_NAME_DISPLAY = &quot;display&quot;;
  public static final String XML_ATTR_CONNECTION_NAME_T2 = &quot;t2&quot;;
  public static final String XML_ATTR_CONNECTION_NAME_T1 = &quot;t1&quot;;
  // XML Node Constants
  public static final String XML_NODE_NAME_ALLIANCE = &quot;alliance&quot;;
  public static final String XML_NODE_NAME_ATTACHMENT = &quot;attachment&quot;;
  public static final String XML_NODE_NAME_ATTACHMENT_LIST = &quot;attachmentList&quot;;
  public static final String XML_NODE_NAME_BOOLEAN = &quot;boolean&quot;;
  public static final String XML_NODE_NAME_CONNECTION = &quot;connection&quot;;
  public static final String XML_NODE_NAME_COST = &quot;cost&quot;;
  public static final String XML_NODE_NAME_DELEGATE = &quot;delegate&quot;;
  public static final String XML_NODE_NAME_FRONTIER_RULES = &quot;frontierRules&quot;;
  public static final String XML_NODE_NAME_GAME = &quot;game&quot;;
  public static final String XML_NODE_NAME_GAME_PLAY = &quot;gamePlay&quot;;
  public static final String XML_NODE_NAME_INFO = &quot;info&quot;;
  public static final String XML_NODE_NAME_INITIALIZE = &quot;initialize&quot;;
  public static final String XML_NODE_NAME_MAP = &quot;map&quot;;
  public static final String XML_NODE_NAME_NUMBER = &quot;number&quot;;
  public static final String XML_NODE_NAME_OPTION = &quot;option&quot;;
  public static final String XML_NODE_NAME_OWNER_INITIALIZE = &quot;ownerInitialize&quot;;
  public static final String XML_NODE_NAME_PLAYER = &quot;player&quot;;
  public static final String XML_NODE_NAME_PLAYER_LIST = &quot;playerList&quot;;
  public static final String XML_NODE_NAME_PRODUCTION = &quot;production&quot;;
  public static final String XML_NODE_NAME_PRODUCTION_FRONTIER = &quot;productionFrontier&quot;;
  public static final String XML_NODE_NAME_PRODUCTION_RULE = &quot;productionRule&quot;;
  public static final String XML_NODE_NAME_PROPERTY = &quot;property&quot;;
  public static final String XML_NODE_NAME_PROPERTY_LIST = &quot;propertyList&quot;;
  public static final String XML_NODE_NAME_RESOURCE = &quot;resource&quot;;
  public static final String XML_NODE_NAME_RESOURCE_LIST = &quot;resourceList&quot;;
  public static final String XML_NODE_NAME_RESULT = &quot;result&quot;;
  public static final String XML_NODE_NAME_SEQUENCE = &quot;sequence&quot;;
  public static final String XML_NODE_NAME_STEP = &quot;step&quot;;
  public static final String XML_NODE_NAME_TERRITORY = &quot;territory&quot;;
  public static final String XML_NODE_NAME_TERRITORY_OWNER = &quot;territoryOwner&quot;;
  public static final String XML_NODE_NAME_UNIT_INITIALIZE = &quot;unitInitialize&quot;;
  public static final String XML_NODE_NAME_UNIT_LIST = &quot;unitList&quot;;
  public static final String XML_NODE_NAME_UNIT_PLACEMENT = &quot;unitPlacement&quot;;
  public static final String XML_NODE_NAME_VALUE = &quot;value&quot;;
  public static final String XML_NODE_NAME_UNIT = &quot;unit&quot;;

  // XML Attribute Constants
  public static final String XML_ATTR_ALLIANCE_NAME_PLAYER = &quot;player&quot;;
  public static final String XML_ATTR_ALLIANCE_NAME_ALLIANCE = &quot;alliance&quot;;

  public static final String XML_ATTR_ATTACHMENT_NAME_NAME = &quot;name&quot;;
  public static final String XML_ATTR_ATTACHMENT_NAME_ATTACH_TO = &quot;attachTo&quot;;
  public static final String XML_ATTR_ATTACHMENT_NAME_TYPE = &quot;type&quot;;
  public static final String XML_ATTR_ATTACHMENT_NAME_JAVA_CLASS = &quot;javaClass&quot;;
  public static final String XML_ATTR_ATTACHMENT_NAME_TERRITORY = &quot;territory&quot;;
  public static final String XML_ATTR_ATTACHMENT_NAME_UNIT_TYPE = &quot;unitType&quot;;
  public static final String XML_ATTR_ATTACHMENT_NAME_PLAYER = &quot;player&quot;;

  public static final String XML_ATTR_COST_NAME_RESOURCE = &quot;resource&quot;;

  public static final String XML_ATTR_NUMBER_NAME_MAX = &quot;max&quot;;
  public static final String XML_ATTR_NUMBER_NAME_MIN = &quot;min&quot;;

  public static final String XML_ATTR_OPTION_NAME_NAME = &quot;name&quot;;
  public static final String XML_ATTR_OPTION_NAME_VALUE = &quot;value&quot;;

  public static final String XML_ATTR_PLAYER_NAME_NAME = &quot;name&quot;;
  public static final String XML_ATTR_PLAYER_NAME_OPTIONAL = &quot;optional&quot;;

  public static final String XML_ATTR_PROPERTY_NAME_NAME = &quot;name&quot;;
  public static final String XML_ATTR_PROPERTY_NAME_VALUE = &quot;value&quot;;
  public static final String XML_ATTR_PROPERTY_NAME_EDITABLE = &quot;editable&quot;;

  public static final String XML_ATTR_RESOURCE_NAME_NAME = &quot;name&quot;;

  public static final String XML_ATTR_RESULT_NAME_QUANTITY = &quot;quantity&quot;;
  public static final String XML_ATTR_RESULT_NAME_RESOURCE_OR_UNIT = &quot;resourceOrUnit&quot;;

  public static final String XML_ATTR_STEP_NAME_DELEGATE = &quot;delegate&quot;;
  public static final String XML_ATTR_STEP_NAME_PLAYER = &quot;player&quot;;
  public static final String XML_ATTR_STEP_NAME_NAME = &quot;name&quot;;
  public static final String XML_ATTR_STEP_NAME_MAX_RUN_COUNT = &quot;maxRunCount&quot;;

  public static final String XML_ATTR_TERRITORY_OWNER_NAME_TERRITORY = &quot;territoryOwner&quot;;

  public static final String XML_ATTR_UNIT_PLACEMENT_NAME_OWNER = &quot;owner&quot;;
  public static final String XML_ATTR_UNIT_PLACEMENT_NAME_TERRITORY = &quot;territory&quot;;
  public static final String XML_ATTR_UNIT_PLACEMENT_NAME_UNIT_TYPE = &quot;unitType&quot;;

  // XML Attribute Value Constants
  public static final String XML_ATTR_VALUE_PLAYER_OPTIONAL_NAME_FALSE = &quot;false&quot;;
  public static final String XML_ATTR_VALUE_OPTION_NAME_CANAL_NAME = &quot;canalName&quot;;
  public static final String XML_ATTR_VALUE_OPTION_NAME_LAND_TERRITORIES = &quot;landTerritories&quot;;
  public static final String XML_ATTR_VALUE_PROPERTY_NAME_MAP_NAME = &quot;mapName&quot;;
  public static final String XML_ATTR_VALUE_PROPERTY_NAME_NOTES = &quot;notes&quot;;


<span class="nc" id="L135">  public static final String TRIPLEA_JAVA_CLASS_DELEGATE_PATH =</span>
<span class="nc" id="L136">      BattleDelegate.class.getPackage().toString().concat(&quot;.&quot;);</span>

  ///////////////////////////////////////////
  // Getter and Setter methods for mapXmlData attributes
  ///////////////////////////////////////////
  public static Map&lt;String, String&gt; getXmlStringsMap() {
<span class="nc" id="L142">    return mapXmlData.getXmlStringsMap();</span>
  }

  public static void setXmlStrings(final Map&lt;String, String&gt; xmlStrings) {
<span class="nc" id="L146">    mapXmlData.setXmlStringsMap(xmlStrings);</span>
<span class="nc" id="L147">  }</span>

  public static List&lt;String&gt; getResourceList() {
<span class="nc" id="L150">    return mapXmlData.getResourceList();</span>
  }

  public static void setResourceList(final List&lt;String&gt; resourceList) {
<span class="nc" id="L154">    mapXmlData.setResourceList(resourceList);</span>
<span class="nc" id="L155">  }</span>

  public static Map&lt;String, Map&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt;&gt; getTerritoryDefintionsMap() {
<span class="nc" id="L158">    return mapXmlData.getTerritoryDefintionsMap();</span>
  }

  public static void setTerritoryDefintions(
      final Map&lt;String, Map&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt;&gt; territoryDefintions) {
<span class="nc" id="L163">    mapXmlData.setTerritoryDefintionsMap(territoryDefintions);</span>
<span class="nc" id="L164">  }</span>

  public static Map&lt;String, Set&lt;String&gt;&gt; getTerritoryConnectionsMap() {
<span class="nc" id="L167">    return mapXmlData.getTerritoryConnectionsMap();</span>
  }

  public static void setTerritoryConnections(final Map&lt;String, Set&lt;String&gt;&gt; territoryConnections) {
<span class="nc" id="L171">    mapXmlData.setTerritoryConnectionsMap(territoryConnections);</span>
<span class="nc" id="L172">  }</span>

  public static List&lt;String&gt; getPlayerNames() {
<span class="nc" id="L175">    return mapXmlData.getPlayerNames();</span>
  }

  public static void setPlayerNames(final List&lt;String&gt; playerName) {
<span class="nc" id="L179">    mapXmlData.setPlayerNames(playerName);</span>
<span class="nc" id="L180">  }</span>

  public static Map&lt;String, String&gt; getPlayerAllianceMap() {
<span class="nc" id="L183">    return mapXmlData.getPlayerAllianceMap();</span>
  }

  public static void setPlayerAlliance(final Map&lt;String, String&gt; playerAlliance) {
<span class="nc" id="L187">    mapXmlData.setPlayerAllianceMap(playerAlliance);</span>
<span class="nc" id="L188">  }</span>

  public static Map&lt;String, Integer&gt; getPlayerInitResourcesMap() {
<span class="nc" id="L191">    return mapXmlData.getPlayerInitResourcesMap();</span>
  }

  public static void setPlayerInitResources(final Map&lt;String, Integer&gt; playerInitResources) {
<span class="nc" id="L195">    mapXmlData.setPlayerInitResourcesMap(playerInitResources);</span>
<span class="nc" id="L196">  }</span>

  public static Map&lt;String, List&lt;Integer&gt;&gt; getUnitDefinitionsMap() {
<span class="nc" id="L199">    return mapXmlData.getUnitDefinitionsMap();</span>
  }

  public static void setUnitDefinitions(final Map&lt;String, List&lt;Integer&gt;&gt; unitDefinitions) {
<span class="nc" id="L203">    mapXmlData.setUnitDefinitionsMap(unitDefinitions);</span>
<span class="nc" id="L204">  }</span>

  public static Map&lt;String, List&lt;String&gt;&gt; getGamePlaySequenceMap() {
<span class="nc" id="L207">    return mapXmlData.getGamePlaySequenceMap();</span>
  }

  public static void setGamePlaySequence(final Map&lt;String, List&lt;String&gt;&gt; gamePlaySequence) {
<span class="nc" id="L211">    mapXmlData.setGamePlaySequenceMap(gamePlaySequence);</span>
<span class="nc" id="L212">  }</span>

  public static Map&lt;String, Triple&lt;String, String, Integer&gt;&gt; getPlayerSequenceMap() {
<span class="nc" id="L215">    return mapXmlData.getPlayerSequenceMap();</span>
  }

  public static void setPlayerSequence(final Map&lt;String, Triple&lt;String, String, Integer&gt;&gt; playerSequence) {
<span class="nc" id="L219">    mapXmlData.setPlayerSequenceMap(playerSequence);</span>
<span class="nc" id="L220">  }</span>

  public static Map&lt;String, List&lt;String&gt;&gt; getTechnologyDefinitionsMap() {
<span class="nc" id="L223">    return mapXmlData.getTechnologyDefinitionsMap();</span>
  }

  public static void setTechnologyDefinitions(final Map&lt;String, List&lt;String&gt;&gt; technologyDefinitions) {
<span class="nc" id="L227">    mapXmlData.setTechnologyDefinitionsMap(technologyDefinitions);</span>
<span class="nc" id="L228">  }</span>

  public static Map&lt;String, List&lt;String&gt;&gt; getProductionFrontiersMap() {
<span class="nc" id="L231">    return mapXmlData.getProductionFrontiersMap();</span>
  }

  public static void setProductionFrontiers(final Map&lt;String, List&lt;String&gt;&gt; productionFrontiers) {
<span class="nc" id="L235">    mapXmlData.setProductionFrontiersMap(productionFrontiers);</span>
<span class="nc" id="L236">  }</span>

  public static Map&lt;String, List&lt;String&gt;&gt; getUnitAttachmentsMap() {
<span class="nc" id="L239">    return mapXmlData.getUnitAttachmentsMap();</span>
  }

  public static void setUnitAttachments(final Map&lt;String, List&lt;String&gt;&gt; unitAttachments) {
<span class="nc" id="L243">    mapXmlData.setUnitAttachmentsMap(unitAttachments);</span>
<span class="nc" id="L244">  }</span>

  public static Map&lt;String, Integer&gt; getTerritoyProductionsMap() {
<span class="nc" id="L247">    return mapXmlData.getTerritoyProductionsMap();</span>
  }

  public static void setTerritoyProductions(final Map&lt;String, Integer&gt; territoyProductions) {
<span class="nc" id="L251">    mapXmlData.setTerritoyProductionsMap(territoyProductions);</span>
<span class="nc" id="L252">  }</span>

  public static Map&lt;String, CanalTerritoriesTuple&gt; getCanalDefinitionsMap() {
<span class="nc" id="L255">    return mapXmlData.getCanalDefinitionsMap();</span>
  }

  public static void setCanalDefinitions(final Map&lt;String, CanalTerritoriesTuple&gt; canalDefinitions) {
<span class="nc" id="L259">    mapXmlData.setCanalDefinitionsMap(canalDefinitions);</span>
<span class="nc" id="L260">  }</span>

  public static Map&lt;String, String&gt; getTerritoryOwnershipsMap() {
<span class="nc" id="L263">    return mapXmlData.getTerritoryOwnershipsMap();</span>
  }

  public static void setTerritoryOwnerships(final Map&lt;String, String&gt; territoryOwnerships) {
<span class="nc" id="L267">    mapXmlData.setTerritoryOwnershipsMap(territoryOwnerships);</span>
<span class="nc" id="L268">  }</span>

  public static Map&lt;String, Map&lt;String, Map&lt;String, Integer&gt;&gt;&gt; getUnitPlacementsMap() {
<span class="nc" id="L271">    return mapXmlData.getUnitPlacementsMap();</span>
  }

  public static void setUnitPlacements(final Map&lt;String, Map&lt;String, Map&lt;String, Integer&gt;&gt;&gt; unitPlacements) {
<span class="nc" id="L275">    mapXmlData.setUnitPlacementsMap(unitPlacements);</span>
<span class="nc" id="L276">  }</span>

  public static Map&lt;String, List&lt;String&gt;&gt; getGameSettingsMap() {
<span class="nc" id="L279">    return mapXmlData.getGameSettingsMap();</span>
  }

  public static void setGameSettings(final Map&lt;String, List&lt;String&gt;&gt; gameSettings) {
<span class="nc" id="L283">    mapXmlData.setGameSettingsMap(gameSettings);</span>
<span class="nc" id="L284">  }</span>

  public static String getNotes() {
<span class="nc" id="L287">    return mapXmlData.getNotes();</span>
  }

  public static void setNotes(final String notes) {
<span class="nc" id="L291">    mapXmlData.setNotes(notes);</span>
<span class="nc" id="L292">  }</span>

  public static File getMapXMLFile() {
<span class="nc" id="L295">    return mapXmlData.getMapXMLFile();</span>
  }

  public static void setMapXMLFile(final File mapXMLFile) {
<span class="nc" id="L299">    MapXmlHelper.mapXmlData.setMapXMLFile(mapXMLFile);</span>
<span class="nc" id="L300">  }</span>

<span class="nc" id="L302">  private static MapXmlData mapXmlData = new MapXmlData();</span>

  static void putXmlStrings(final String key, final String value) {
<span class="nc" id="L305">    getXmlStringsMap().put(key, value);</span>
<span class="nc" id="L306">  }</span>

  static void addResourceList(final String value) {
<span class="nc" id="L309">    getResourceList().add(value);</span>
<span class="nc" id="L310">  }</span>

  static void addResourceList(final int index, final String value) {
<span class="nc" id="L313">    getResourceList().add(index, value);</span>
<span class="nc" id="L314">  }</span>

  static void putTerritoryDefintions(final String key,
      final HashMap&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt; value) {
<span class="nc" id="L318">    getTerritoryDefintionsMap().put(key, value);</span>
<span class="nc" id="L319">  }</span>

  static void putTerritoryConnections(final String key, final Set&lt;String&gt; value) {
<span class="nc" id="L322">    getTerritoryConnectionsMap().put(key, value);</span>
<span class="nc" id="L323">  }</span>

  static void addPlayerName(final String value) {
<span class="nc" id="L326">    getPlayerNames().add(value);</span>
<span class="nc" id="L327">  }</span>

  static void putPlayerAlliance(final String key, final String value) {
<span class="nc" id="L330">    getPlayerAllianceMap().put(key, value);</span>
<span class="nc" id="L331">  }</span>

  static void putPlayerInitResources(final String key, final int value) {
<span class="nc" id="L334">    getPlayerInitResourcesMap().put(key, value);</span>
<span class="nc" id="L335">  }</span>

  static void putUnitDefinitions(final String key, final ArrayList&lt;Integer&gt; value) {
<span class="nc" id="L338">    getUnitDefinitionsMap().put(key, value);</span>
<span class="nc" id="L339">  }</span>

  static void putGamePlaySequence(final String key, final ArrayList&lt;String&gt; value) {
<span class="nc" id="L342">    getGamePlaySequenceMap().put(key, value);</span>
<span class="nc" id="L343">  }</span>

  static void putPlayerSequence(final String key, final Triple&lt;String, String, Integer&gt; value) {
<span class="nc" id="L346">    getPlayerSequenceMap().put(key, value);</span>
<span class="nc" id="L347">  }</span>

  static void putTechnologyDefinitions(final String key, final ArrayList&lt;String&gt; value) {
<span class="nc" id="L350">    getTechnologyDefinitionsMap().put(key, value);</span>
<span class="nc" id="L351">  }</span>

  static void putProductionFrontiers(final String key, final ArrayList&lt;String&gt; value) {
<span class="nc" id="L354">    getProductionFrontiersMap().put(key, value);</span>
<span class="nc" id="L355">  }</span>

  static void putUnitAttachments(final String key, final ArrayList&lt;String&gt; value) {
<span class="nc" id="L358">    getUnitAttachmentsMap().put(key, value);</span>
<span class="nc" id="L359">  }</span>

  static void putTerritoyProductions(final String key, final int value) {
<span class="nc" id="L362">    getTerritoyProductionsMap().put(key, value);</span>
<span class="nc" id="L363">  }</span>

  static void putCanalDefinitions(final String key, final CanalTerritoriesTuple value) {
<span class="nc" id="L366">    getCanalDefinitionsMap().put(key, value);</span>
<span class="nc" id="L367">  }</span>

  static void putTerritoyOwnerships(final String key, final String value) {
<span class="nc" id="L370">    getTerritoryOwnershipsMap().put(key, value);</span>
<span class="nc" id="L371">  }</span>

  static void putUnitPlacements(final String key, final Map&lt;String, Map&lt;String, Integer&gt;&gt; value) {
<span class="nc" id="L374">    getUnitPlacementsMap().put(key, value);</span>
<span class="nc" id="L375">  }</span>

  static void putGameSettings(final String key, final ArrayList&lt;String&gt; value) {
<span class="nc" id="L378">    getGameSettingsMap().put(key, value);</span>
<span class="nc" id="L379">  }</span>

  static void clearXmlStrings() {
<span class="nc" id="L382">    getXmlStringsMap().clear();</span>
<span class="nc" id="L383">  }</span>

  static void clearResourceList() {
<span class="nc" id="L386">    getResourceList().clear();</span>
<span class="nc" id="L387">  }</span>

  static void clearTerritoyDefintions() {
<span class="nc" id="L390">    getTerritoryDefintionsMap().clear();</span>
<span class="nc" id="L391">  }</span>

  static void clearTerritoryConnections() {
<span class="nc" id="L394">    getTerritoryConnectionsMap().clear();</span>
<span class="nc" id="L395">  }</span>

  static void clearPlayerName() {
<span class="nc" id="L398">    getPlayerNames().clear();</span>
<span class="nc" id="L399">  }</span>

  static void clearPlayerAlliance() {
<span class="nc" id="L402">    getPlayerAllianceMap().clear();</span>
<span class="nc" id="L403">  }</span>

  static void clearPlayerInitResources() {
<span class="nc" id="L406">    getPlayerInitResourcesMap().clear();</span>
<span class="nc" id="L407">  }</span>

  static void clearUnitDefinitions() {
<span class="nc" id="L410">    getUnitDefinitionsMap().clear();</span>
<span class="nc" id="L411">  }</span>

  static void clearGamePlaySequence() {
<span class="nc" id="L414">    getGamePlaySequenceMap().clear();</span>
<span class="nc" id="L415">  }</span>

  static void clearPlayerSequence() {
<span class="nc" id="L418">    getPlayerSequenceMap().clear();</span>
<span class="nc" id="L419">  }</span>

  static void clearTechnologyDefinitions() {
<span class="nc" id="L422">    getTechnologyDefinitionsMap().clear();</span>
<span class="nc" id="L423">  }</span>

  static void clearProductionFrontiers() {
<span class="nc" id="L426">    getProductionFrontiersMap().clear();</span>
<span class="nc" id="L427">  }</span>

  static void clearUnitAttachments() {
<span class="nc" id="L430">    getUnitAttachmentsMap().clear();</span>
<span class="nc" id="L431">  }</span>

  static void clearTerritoyProductions() {
<span class="nc" id="L434">    getTerritoyProductionsMap().clear();</span>
<span class="nc" id="L435">  }</span>

  static void clearCanalDefinitions() {
<span class="nc" id="L438">    getCanalDefinitionsMap().clear();</span>
<span class="nc" id="L439">  }</span>

  static void clearTerritoyOwnerships() {
<span class="nc" id="L442">    getTerritoryOwnershipsMap().clear();</span>
<span class="nc" id="L443">  }</span>

  static void clearUnitPlacements() {
<span class="nc" id="L446">    getUnitPlacementsMap().clear();</span>
<span class="nc" id="L447">  }</span>

  static void clearGameSettings() {
<span class="nc" id="L450">    getGameSettingsMap().clear();</span>
<span class="nc" id="L451">  }</span>

  ///////////////////////////////////////////
  // Start of XML parsing methods
  ///////////////////////////////////////////
  static public GameStep parseValuesFromXML(final Document dom) {
<span class="nc" id="L457">    initializeAll();</span>

<span class="nc" id="L459">    final Node mainlastChild = dom.getLastChild();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">    if (!mainlastChild.getNodeName().equals(XML_NODE_NAME_GAME)) {</span>
<span class="nc" id="L461">      throw new IllegalArgumentException(</span>
<span class="nc" id="L462">          &quot;Last node of XML document is not the expeced 'game' node, but '&quot; + mainlastChild.getNodeName() + &quot;'&quot;);</span>
    }
<span class="nc" id="L464">    return parseGameNode(mainlastChild);</span>
  }

  /**
   * @param gameNode
   * @return step to go to
   */
  public static GameStep parseGameNode(final Node gameNode) {
<span class="nc" id="L472">    GameStep stepToGo = MapXmlCreator.GAME_STEP_FIRST;</span>
<span class="nc" id="L473">    final NodeList children = gameNode.getChildNodes();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">    for (int i = 0; i &lt; children.getLength(); ++i) {</span>
<span class="nc" id="L475">      final Node childNode = children.item(i);</span>
<span class="nc" id="L476">      final String childNodeName = childNode.getNodeName();</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">      if (childNodeName.equals(XML_NODE_NAME_INFO)) {</span>
<span class="nc" id="L478">        final HashMap&lt;String, String&gt; infoAttr = getAttributesMap(childNode.getAttributes());</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">        for (final Entry&lt;String, String&gt; infoAttrEntry : infoAttr.entrySet()) {</span>
<span class="nc" id="L480">          getXmlStringsMap().put(&quot;info_@&quot; + infoAttrEntry.getKey(), infoAttrEntry.getValue());</span>
        }
<span class="nc bnc" id="L482" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_RESOURCE_LIST)) {</span>
<span class="nc" id="L483">        final NodeList resourceNodes = childNode.getChildNodes();</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">        for (int resource_i = 0; resource_i &lt; resourceNodes.getLength(); ++resource_i) {</span>
<span class="nc" id="L486">          final Node resourceNode = resourceNodes.item(resource_i);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">          if (resourceNode.getNodeName().equals(XML_NODE_NAME_RESOURCE)) {</span>
<span class="nc" id="L488">            getResourceList().add(resourceNode.getAttributes().item(0).getNodeValue());</span>
          }
        }
<span class="nc bnc" id="L491" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_MAP)) {</span>
<span class="nc" id="L492">        parseMapNode(childNode.getChildNodes());</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">        stepToGo = MapXmlCreator.getMaxGameStep(stepToGo, (getTerritoryConnectionsMap().isEmpty()</span>
<span class="nc" id="L494">            ? GameStep.TERRITORY_DEFINITIONS : GameStep.TERRITORY_CONNECTIONS));</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_PLAYER_LIST)) {</span>
<span class="nc" id="L496">        parsePlayerListNode(childNode.getChildNodes());</span>
<span class="nc" id="L497">        stepToGo = MapXmlCreator.getMaxGameStep(stepToGo,</span>
<span class="nc" id="L498">            GameStep.PLAYERS_AND_ALLIANCES);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_PRODUCTION)) {</span>
<span class="nc" id="L500">        putNodesToProductionFrontiers(childNode.getChildNodes());</span>
<span class="nc" id="L501">        stepToGo = MapXmlCreator.getMaxGameStep(stepToGo,</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">            (getProductionFrontiersMap().isEmpty() ? GameStep.UNIT_DEFINITIONS : GameStep.PRODUCTION_FRONTIERS));</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_GAME_PLAY)) {</span>
<span class="nc" id="L504">        putNodesToPlayerSequence(childNode.getChildNodes());</span>
<span class="nc" id="L505">        stepToGo = MapXmlCreator.getMaxGameStep(stepToGo,</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            (getPlayerSequenceMap().isEmpty() ? GameStep.UNIT_ATTACHMENTS : GameStep.TERRITORY_PRODUCTION));</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_ATTACHMENT_LIST)) {</span>
<span class="nc" id="L508">        final NodeList attachmentListChildNodes = childNode.getChildNodes();</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">        for (int p_i = 0; p_i &lt; attachmentListChildNodes.getLength(); ++p_i) {</span>
<span class="nc" id="L510">          final Node attachment = attachmentListChildNodes.item(p_i);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">          if (attachment.getNodeName().equals(XML_NODE_NAME_ATTACHMENT)) {</span>
<span class="nc" id="L512">            parseAttachmentNode(attachment);</span>
          }
        }
<span class="nc" id="L515">        stepToGo = MapXmlCreator.getMaxGameStep(MapXmlCreator.getMaxGameStep(stepToGo,</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            getUnitAttachmentsMap().isEmpty() ? GameStep.PRODUCTION_FRONTIERS : GameStep.UNIT_ATTACHMENTS),</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">            getTerritoyProductionsMap().isEmpty() ? GameStep.UNIT_ATTACHMENTS : GameStep.TERRITORY_PRODUCTION);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_INITIALIZE)) {</span>
<span class="nc" id="L519">        final NodeList initializeChildNodes = childNode.getChildNodes();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        for (int init_i = 0; init_i &lt; initializeChildNodes.getLength(); ++init_i) {</span>
<span class="nc" id="L521">          final Node ownerInitialize = initializeChildNodes.item(init_i);</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">          if (ownerInitialize.getNodeName().equals(XML_NODE_NAME_OWNER_INITIALIZE)) {</span>
<span class="nc" id="L523">            putNodesToTerritoryOwnerships(ownerInitialize.getChildNodes());</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">          } else if (ownerInitialize.getNodeName().equals(XML_NODE_NAME_UNIT_INITIALIZE)) {</span>
<span class="nc" id="L525">            putNodesToUnitPlacements(ownerInitialize.getChildNodes());</span>
          }
        }
<span class="nc" id="L528">        stepToGo = MapXmlCreator.getMaxGameStep(stepToGo,</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">            (getUnitPlacementsMap().isEmpty() ? GameStep.TERRITORY_OWNERSHIP : GameStep.UNIT_PLACEMENTS));</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">      } else if (childNodeName.equals(XML_NODE_NAME_PROPERTY_LIST)) {</span>
<span class="nc" id="L531">        final NodeList propertyListChildNodes = childNode.getChildNodes();</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">        for (int prop_i = 0; prop_i &lt; propertyListChildNodes.getLength(); ++prop_i) {</span>
<span class="nc" id="L533">          final Node property = propertyListChildNodes.item(prop_i);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">          if (property.getNodeName().equals(XML_NODE_NAME_PROPERTY)) {</span>
<span class="nc" id="L535">            parsePropertyNode(property);</span>
          }
        }
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (!getGameSettingsMap().isEmpty()) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">          stepToGo = (getNotes().length() &gt; 0 ? GameStep.MAP_FINISHED : GameStep.GAME_SETTINGS);</span>
        }
      }
    }
<span class="nc" id="L543">    return stepToGo;</span>
  }

  public static void initializeAll() {
<span class="nc" id="L547">    MapXmlCreator.mapFolderLocation = null;</span>
<span class="nc" id="L548">    MapXmlCreator.mapImageFile = null;</span>
<span class="nc" id="L549">    MapXmlCreator.mapCentersFile = null;</span>
<span class="nc" id="L550">    mapXmlData.initialize();</span>
<span class="nc" id="L551">  }</span>

  public static void putNodesToProductionFrontiers(final NodeList productionChildNodes) {
<span class="nc bnc" id="L554" title="All 2 branches missed.">    for (int p_i = 0; p_i &lt; productionChildNodes.getLength(); ++p_i) {</span>
<span class="nc" id="L555">      final Node productionRule = productionChildNodes.item(p_i);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">      if (productionRule.getNodeName().equals(XML_NODE_NAME_PRODUCTION_RULE)) {</span>
<span class="nc" id="L557">        parseProductionRuleNode(productionRule.getChildNodes());</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">      } else if (productionRule.getNodeName().equals(XML_NODE_NAME_PRODUCTION_FRONTIER)) {</span>
<span class="nc" id="L559">        final String playerName =</span>
<span class="nc" id="L560">            productionRule.getAttributes().getNamedItem(XML_ATTR_ATTACHMENT_NAME_NAME).getNodeValue().substring(10);</span>
<span class="nc" id="L561">        final ArrayList&lt;String&gt; frontierRules = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L562">        final NodeList productionFrontierChildNodes = productionRule.getChildNodes();</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">        for (int pr_i = 0; pr_i &lt; productionFrontierChildNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L564">          final Node productionFrontierChildNode = productionFrontierChildNodes.item(pr_i);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">          if (productionFrontierChildNode.getNodeName().equals(XML_NODE_NAME_FRONTIER_RULES)) {</span>
<span class="nc" id="L566">            frontierRules</span>
<span class="nc" id="L567">                .add(productionFrontierChildNode.getAttributes().getNamedItem(XML_ATTR_ATTACHMENT_NAME_NAME)</span>
<span class="nc" id="L568">                    .getNodeValue().substring(3));</span>
          }
        }
<span class="nc" id="L571">        getProductionFrontiersMap().put(playerName, frontierRules);</span>
      }
    }
<span class="nc" id="L574">  }</span>

  public static void putNodesToPlayerSequence(final NodeList gamePlayChildNodes) {
<span class="nc bnc" id="L577" title="All 2 branches missed.">    for (int p_i = 0; p_i &lt; gamePlayChildNodes.getLength(); ++p_i) {</span>
<span class="nc" id="L578">      final Node gamePlayChildNode = gamePlayChildNodes.item(p_i);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">      if (gamePlayChildNode.getNodeName().equals(XML_NODE_NAME_DELEGATE)) {</span>
<span class="nc" id="L580">        final HashMap&lt;String, String&gt; attrDelegate = getAttributesMap(gamePlayChildNode.getAttributes());</span>
<span class="nc" id="L581">        final ArrayList&lt;String&gt; newValues = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L582">        newValues</span>
<span class="nc" id="L583">            .add(attrDelegate.get(XML_ATTR_ATTACHMENT_NAME_JAVA_CLASS).replace(TRIPLEA_JAVA_CLASS_DELEGATE_PATH, &quot;&quot;));</span>
<span class="nc" id="L584">        newValues.add(attrDelegate.get(XML_ATTR_STEP_NAME_DISPLAY));</span>
<span class="nc" id="L585">        getGamePlaySequenceMap().put(attrDelegate.get(XML_ATTR_ATTACHMENT_NAME_NAME), newValues);</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">      } else if (gamePlayChildNode.getNodeName().equals(XML_NODE_NAME_SEQUENCE)) {</span>
<span class="nc" id="L587">        final NodeList sequenceChildNodes = gamePlayChildNode.getChildNodes();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        for (int seq_i = 0; seq_i &lt; sequenceChildNodes.getLength(); ++seq_i) {</span>
<span class="nc" id="L589">          final Node sequenceChildNode = sequenceChildNodes.item(seq_i);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">          if (sequenceChildNode.getNodeName().equals(XML_NODE_NAME_STEP)) {</span>
<span class="nc" id="L591">            final HashMap&lt;String, String&gt; attrSequence = getAttributesMap(sequenceChildNode.getAttributes());</span>
<span class="nc" id="L592">            final String maxRunCount = attrSequence.get(XML_ATTR_STEP_NAME_MAX_RUN_COUNT);</span>
<span class="nc" id="L593">            final String player = attrSequence.get(XML_ATTR_STEP_NAME_PLAYER);</span>
<span class="nc" id="L594">            final Triple&lt;String, String, Integer&gt; newValues = Triple.of(attrSequence.get(XML_ATTR_STEP_NAME_DELEGATE),</span>
<span class="nc bnc" id="L595" title="All 4 branches missed.">                (player == null ? &quot;&quot; : player), (maxRunCount == null ? 0 : Integer.parseInt(maxRunCount)));</span>
<span class="nc" id="L596">            getPlayerSequenceMap().put(attrSequence.get(XML_ATTR_STEP_NAME_NAME), newValues);</span>
          }
        }
      }
    }
<span class="nc" id="L601">  }</span>

  public static void putNodesToUnitPlacements(final NodeList initializeUnitChildNodes) {
<span class="nc bnc" id="L604" title="All 2 branches missed.">    for (int initOwner_i = 0; initOwner_i &lt; initializeUnitChildNodes.getLength(); ++initOwner_i) {</span>
<span class="nc" id="L605">      final Node unitPlacement = initializeUnitChildNodes.item(initOwner_i);</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">      if (unitPlacement.getNodeName().equals(XML_NODE_NAME_UNIT_PLACEMENT)) {</span>
<span class="nc" id="L607">        final HashMap&lt;String, String&gt; attrUnitPlacements = getAttributesMap(unitPlacement.getAttributes());</span>
<span class="nc" id="L608">        final String territory = attrUnitPlacements.get(XML_NODE_NAME_TERRITORY);</span>
<span class="nc" id="L609">        final String owner = attrUnitPlacements.get(XML_ATTR_UNIT_PLACEMENT_NAME_OWNER);</span>
<span class="nc" id="L610">        Map&lt;String, Map&lt;String, Integer&gt;&gt; terrPlacements = getUnitPlacementsMap().get(territory);</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (terrPlacements == null) {</span>
<span class="nc" id="L612">          terrPlacements = Maps.newHashMap();</span>
<span class="nc" id="L613">          getUnitPlacementsMap().put(territory, terrPlacements);</span>
        }
<span class="nc" id="L615">        Map&lt;String, Integer&gt; terrOwnerPlacements = terrPlacements.get(owner);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">        if (terrOwnerPlacements == null) {</span>
<span class="nc" id="L617">          terrOwnerPlacements = Maps.newLinkedHashMap();</span>
<span class="nc" id="L618">          terrPlacements.put(owner, terrOwnerPlacements);</span>
        }
<span class="nc" id="L620">        terrOwnerPlacements.put(attrUnitPlacements.get(XML_ATTR_UNIT_PLACEMENT_NAME_UNIT_TYPE),</span>
<span class="nc" id="L621">            Integer.parseInt(attrUnitPlacements.get(XML_ATTR_RESULT_NAME_QUANTITY)));</span>
      }
    }
<span class="nc" id="L624">  }</span>

  public static void putNodesToTerritoryOwnerships(final NodeList initializeOwnerChildNodes) {
<span class="nc bnc" id="L627" title="All 2 branches missed.">    for (int initOwner_i = 0; initOwner_i &lt; initializeOwnerChildNodes.getLength(); ++initOwner_i) {</span>
<span class="nc" id="L628">      final Node territoryOwner = initializeOwnerChildNodes.item(initOwner_i);</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">      if (territoryOwner.getNodeName().equals(XML_NODE_NAME_TERRITORY_OWNER)) {</span>
<span class="nc" id="L630">        final HashMap&lt;String, String&gt; attrTerrOwner = getAttributesMap(territoryOwner.getAttributes());</span>
<span class="nc" id="L631">        getTerritoryOwnershipsMap().put(attrTerrOwner.get(XML_NODE_NAME_TERRITORY),</span>
<span class="nc" id="L632">            attrTerrOwner.get(XML_ATTR_UNIT_PLACEMENT_NAME_OWNER));</span>
      }
    }
<span class="nc" id="L635">  }</span>

  private static void parsePropertyNode(final Node property) {
<span class="nc" id="L638">    final HashMap&lt;String, String&gt; propertyAttr = getAttributesMap(property.getAttributes());</span>
<span class="nc" id="L639">    final ArrayList&lt;String&gt; settingValues = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L640">    final String propertyName = propertyAttr.get(XML_ATTR_PROPERTY_NAME_NAME);</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">    if (propertyName.equals(XML_ATTR_VALUE_PROPERTY_NAME_NOTES)</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">        || propertyName.equals(XML_ATTR_VALUE_PROPERTY_NAME_MAP_NAME)) {</span>
<span class="nc" id="L643">      final NodeList propertyListChildNodes = property.getChildNodes();</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">      for (int prop_i = 0; prop_i &lt; propertyListChildNodes.getLength(); ++prop_i) {</span>
<span class="nc" id="L645">        final Node subProperty = propertyListChildNodes.item(prop_i);</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (subProperty.getNodeName().equals(XML_NODE_NAME_VALUE)) {</span>
<span class="nc" id="L647">          setNotes(subProperty.getTextContent());</span>
        }
      }
<span class="nc" id="L650">      return;</span>
    }
<span class="nc" id="L652">    settingValues.add(propertyAttr.get(XML_NODE_NAME_VALUE));</span>
<span class="nc" id="L653">    settingValues.add(Boolean.toString(Boolean.parseBoolean(propertyAttr.get(XML_ATTR_PROPERTY_NAME_EDITABLE))));</span>
<span class="nc" id="L654">    final NodeList propertyNodes = property.getChildNodes();</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">    for (int pr_i = 0; pr_i &lt; propertyNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L656">      final Node propertyRange = propertyNodes.item(pr_i);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">      if (propertyRange.getNodeName().equals(XML_NODE_NAME_NUMBER)) {</span>
<span class="nc" id="L658">        final HashMap&lt;String, String&gt; propertyRangeAttr = getAttributesMap(propertyRange.getAttributes());</span>
<span class="nc" id="L659">        settingValues.add(propertyRangeAttr.get(XML_ATTR_NUMBER_NAME_MIN));</span>
<span class="nc" id="L660">        settingValues.add(propertyRangeAttr.get(XML_ATTR_NUMBER_NAME_MAX));</span>
<span class="nc" id="L661">        getGameSettingsMap().put(propertyName, settingValues);</span>
<span class="nc" id="L662">        break;</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">      } else if (propertyRange.getNodeName().equals(XML_NODE_NAME_BOOLEAN)) {</span>
<span class="nc" id="L664">        settingValues.add(&quot;0&quot;); // min</span>
<span class="nc" id="L665">        settingValues.add(&quot;0&quot;); // max</span>
<span class="nc" id="L666">        getGameSettingsMap().put(propertyName, settingValues);</span>
<span class="nc" id="L667">        break;</span>
      }
    }
<span class="nc" id="L670">  }</span>

  private static void parseAttachmentNode(final Node attachment) {
<span class="nc" id="L673">    final HashMap&lt;String, String&gt; attachmentAttr = getAttributesMap(attachment.getAttributes());</span>
<span class="nc" id="L674">    final String attachmentName = attachmentAttr.get(XML_ATTR_ATTACHMENT_NAME_NAME);</span>
<span class="nc" id="L675">    final String attachmentType = attachmentAttr.get(XML_ATTR_ATTACHMENT_NAME_TYPE);</span>
<span class="nc" id="L676">    final String attachmentAttachTo = attachmentAttr.get(XML_ATTR_ATTACHMENT_NAME_ATTACH_TO);</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">    if (attachmentName.equals(Constants.TECH_ATTACHMENT_NAME)</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">        &amp;&amp; attachmentType.equals(XML_ATTR_ATTACHMENT_NAME_PLAYER)) {</span>
<span class="nc" id="L679">      parseNodeTechAttachment(attachment, attachmentAttachTo);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">    } else if (attachmentName.equals(Constants.UNIT_ATTACHMENT_NAME)</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        &amp;&amp; attachmentType.equals(XML_ATTR_ATTACHMENT_NAME_UNIT_TYPE)) {</span>
<span class="nc" id="L682">      parseNodeUnitAttachment(attachment, attachmentAttachTo);</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">    } else if (attachmentName.equals(Constants.INF_ATTACHMENT_NAME)</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">        &amp;&amp; attachmentType.equals(XML_ATTR_ATTACHMENT_NAME_TERRITORY)) {</span>
<span class="nc" id="L685">      parseNodeCanalAttachment(attachment, attachmentAttachTo);</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">    } else if (attachmentName.equals(Constants.TERRITORY_ATTACHMENT_NAME)</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">        &amp;&amp; attachmentType.equals(XML_ATTR_ATTACHMENT_NAME_NAME)) {</span>
<span class="nc" id="L688">      parseNodeTerritoryAttachment(attachment, attachmentAttachTo);</span>
    }
<span class="nc" id="L690">  }</span>

  private static void parseNodeTerritoryAttachment(final Node attachment, final String attachmentAttachTo) {
<span class="nc" id="L693">    final NodeList attachmentOptionNodes = attachment.getChildNodes();</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">    for (int pr_i = 0; pr_i &lt; attachmentOptionNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L695">      final Node attachmentOption = attachmentOptionNodes.item(pr_i);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">      if (attachmentOption.getNodeName().equals(XML_NODE_NAME_OPTION)) {</span>
<span class="nc" id="L697">        final HashMap&lt;String, String&gt; attachmentOptionAttr = getAttributesMap(attachmentOption.getAttributes());</span>
<span class="nc" id="L698">        final String optionNameAttr = attachmentOptionAttr.get(XML_ATTR_OPTION_NAME_NAME);</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (optionNameAttr.equals(XML_NODE_NAME_PRODUCTION)) {</span>
<span class="nc" id="L700">          getTerritoyProductionsMap().put(attachmentAttachTo,</span>
<span class="nc" id="L701">              Integer.parseInt(attachmentOptionAttr.get(XML_NODE_NAME_VALUE)));</span>
<span class="nc" id="L702">        } else {</span>
<span class="nc" id="L703">          Map&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt; terrDefinitions =</span>
<span class="nc" id="L704">              getTerritoryDefintionsMap().get(attachmentAttachTo);</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">          if (terrDefinitions == null) {</span>
<span class="nc" id="L706">            terrDefinitions = Maps.newHashMap();</span>
<span class="nc" id="L707">            getTerritoryDefintionsMap().put(attachmentAttachTo, terrDefinitions);</span>
          }
<span class="nc bnc" id="L709" title="All 5 branches missed.">          switch (TerritoryDefinitionDialog.valueOf(optionNameAttr)) {</span>
            case IS_CAPITAL:
<span class="nc" id="L711">              terrDefinitions.put(TerritoryDefinitionDialog.DEFINITION.IS_CAPITAL, true);</span>
<span class="nc" id="L712">              break;</span>
            case IS_VICTORY_CITY:
<span class="nc" id="L714">              terrDefinitions.put(TerritoryDefinitionDialog.DEFINITION.IS_VICTORY_CITY, true);</span>
<span class="nc" id="L715">              break;</span>
            case IS_WATER:
<span class="nc" id="L717">              terrDefinitions.put(TerritoryDefinitionDialog.DEFINITION.IS_WATER, true);</span>
<span class="nc" id="L718">              break;</span>
            case IMPASSABLE:
<span class="nc" id="L720">              terrDefinitions.put(TerritoryDefinitionDialog.DEFINITION.IMPASSABLE, true);</span>
              break;
          }
        }
      }
    }
<span class="nc" id="L726">  }</span>

  private static void parseNodeTechAttachment(final Node attachment, final String attachmentAttachTo) {
<span class="nc" id="L729">    final NodeList attachmentOptionNodes = attachment.getChildNodes();</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">    for (int pr_i = 0; pr_i &lt; attachmentOptionNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L731">      final Node attachmentOption = attachmentOptionNodes.item(pr_i);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">      if (attachmentOption.getNodeName().equals(XML_NODE_NAME_OPTION)) {</span>
<span class="nc" id="L733">        final HashMap&lt;String, String&gt; attachmentOptionAttr = getAttributesMap(attachmentOption.getAttributes());</span>
<span class="nc" id="L734">        final ArrayList&lt;String&gt; values = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L735">        values.add(attachmentAttachTo); // playerName</span>
<span class="nc" id="L736">        values.add(attachmentOptionAttr.get(XML_NODE_NAME_VALUE));</span>
<span class="nc" id="L737">        getTechnologyDefinitionsMap().put(</span>
<span class="nc" id="L738">            attachmentOptionAttr.get(XML_ATTR_ATTACHMENT_NAME_NAME) + &quot;_&quot; + attachmentAttachTo,</span>
<span class="nc" id="L739">            values);</span>
      }
    }
<span class="nc" id="L742">  }</span>

  private static void parseNodeUnitAttachment(final Node attachment, final String attachmentAttachTo) {
<span class="nc" id="L745">    final NodeList attachmentOptionNodes = attachment.getChildNodes();</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">    for (int pr_i = 0; pr_i &lt; attachmentOptionNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L747">      final Node attachmentOption = attachmentOptionNodes.item(pr_i);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">      if (attachmentOption.getNodeName().equals(XML_NODE_NAME_OPTION)) {</span>
<span class="nc" id="L749">        final HashMap&lt;String, String&gt; attachmentOptionAttr = getAttributesMap(attachmentOption.getAttributes());</span>
<span class="nc" id="L750">        final ArrayList&lt;String&gt; values = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L751">        values.add(attachmentAttachTo); // unitName</span>
<span class="nc" id="L752">        values.add(attachmentOptionAttr.get(XML_NODE_NAME_VALUE));</span>
<span class="nc" id="L753">        getUnitAttachmentsMap().put(</span>
<span class="nc" id="L754">            attachmentOptionAttr.get(XML_ATTR_ATTACHMENT_NAME_NAME) + &quot;_&quot; + attachmentAttachTo,</span>
<span class="nc" id="L755">            values);</span>
      }
    }
<span class="nc" id="L758">  }</span>

  private static void parseNodeCanalAttachment(final Node attachment, final String attachmentAttachTo) {
<span class="nc" id="L761">    final NodeList attachmentOptionNodes = attachment.getChildNodes();</span>

<span class="nc" id="L763">    CanalTerritoriesTuple canalDef = null;</span>
<span class="nc" id="L764">    String newCanalName = null;</span>
<span class="nc" id="L765">    final SortedSet&lt;String&gt; newLandTerritories = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">    for (int pr_i = 0; pr_i &lt; attachmentOptionNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L767">      final Node attachmentOption = attachmentOptionNodes.item(pr_i);</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">      if (attachmentOption.getNodeName().equals(XML_NODE_NAME_OPTION)) {</span>
<span class="nc" id="L769">        final HashMap&lt;String, String&gt; attachmentOptionAttr = getAttributesMap(attachmentOption.getAttributes());</span>
<span class="nc" id="L770">        final String attachOptAttrName = attachmentOptionAttr.get(XML_ATTR_OPTION_NAME_NAME);</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (attachOptAttrName.equals(XML_ATTR_VALUE_OPTION_NAME_CANAL_NAME)) {</span>
<span class="nc" id="L772">          newCanalName = attachmentOptionAttr.get(XML_NODE_NAME_VALUE);</span>
<span class="nc" id="L773">          canalDef = getCanalDefinitionsMap().get(newCanalName);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">          if (canalDef != null) {</span>
<span class="nc" id="L775">            break;</span>
          }
<span class="nc bnc" id="L777" title="All 2 branches missed.">        } else if (attachOptAttrName.equals(XML_ATTR_VALUE_OPTION_NAME_LAND_TERRITORIES)) {</span>
<span class="nc" id="L778">          newLandTerritories.addAll(Arrays</span>
<span class="nc" id="L779">              .asList(</span>
<span class="nc" id="L780">                  attachmentOptionAttr.get(XML_ATTR_OPTION_NAME_VALUE).split(XML_ATTR_VALUE_SEPARATOR_OPTION_VALUE)));</span>
        }
      }
    }
<span class="nc bnc" id="L784" title="All 2 branches missed.">    if (canalDef == null) {</span>
<span class="nc" id="L785">      final SortedSet&lt;String&gt; newWaterTerritories = new TreeSet&lt;&gt;();</span>
<span class="nc" id="L786">      newWaterTerritories.add(attachmentAttachTo);</span>
<span class="nc" id="L787">      getCanalDefinitionsMap().put(newCanalName, new CanalTerritoriesTuple(newWaterTerritories, newLandTerritories));</span>
<span class="nc" id="L788">    } else {</span>
<span class="nc" id="L789">      canalDef.getWaterTerritories().add(attachmentAttachTo);</span>
    }
<span class="nc" id="L791">  }</span>

  private static void parseProductionRuleNode(final NodeList productionRuleChildNodes) {
<span class="nc" id="L794">    HashMap&lt;String, String&gt; attrMapCost = null;</span>
<span class="nc" id="L795">    HashMap&lt;String, String&gt; attrMapResult = null;</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">    for (int pr_i = 0; pr_i &lt; productionRuleChildNodes.getLength(); ++pr_i) {</span>
<span class="nc" id="L797">      final Node productionRuleChildNode = productionRuleChildNodes.item(pr_i);</span>
<span class="nc" id="L798">      final String productionRuleChildNodeName = productionRuleChildNode.getNodeName();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">      if (productionRuleChildNodeName.equals(XML_NODE_NAME_COST)) {</span>
<span class="nc" id="L800">        attrMapCost = getAttributesMap(productionRuleChildNode.getAttributes());</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (attrMapResult != null) {</span>
<span class="nc" id="L802">          break;</span>
        }
<span class="nc bnc" id="L804" title="All 2 branches missed.">      } else if (productionRuleChildNodeName.equals(XML_NODE_NAME_RESULT)) {</span>
<span class="nc" id="L805">        attrMapResult = getAttributesMap(productionRuleChildNode.getAttributes());</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">        if (attrMapCost != null) {</span>
<span class="nc" id="L807">          break;</span>
        }
      }
    }
<span class="nc" id="L811">    final ArrayList&lt;Integer&gt; newValues = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L812">    newValues.add(Integer.parseInt(attrMapCost.get(XML_ATTR_RESULT_NAME_QUANTITY)));</span>
<span class="nc" id="L813">    newValues.add(Integer.parseInt(attrMapResult.get(XML_ATTR_RESULT_NAME_QUANTITY)));</span>
<span class="nc" id="L814">    putUnitDefinitions(attrMapResult.get(XML_ATTR_RESULT_NAME_RESOURCE_OR_UNIT), newValues);</span>
<span class="nc" id="L815">  }</span>

  private static HashMap&lt;String, String&gt; getAttributesMap(final NamedNodeMap attrNodeMap) {
<span class="nc" id="L818">    final HashMap&lt;String, String&gt; rVal = Maps.newHashMap();</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">    for (int i = 0; i &lt; attrNodeMap.getLength(); ++i) {</span>
<span class="nc" id="L820">      final Node attrNodeItem = attrNodeMap.item(i);</span>
<span class="nc" id="L821">      rVal.put(attrNodeItem.getNodeName(), attrNodeItem.getNodeValue());</span>
    }
<span class="nc" id="L823">    return rVal;</span>
  }

  private static void parsePlayerListNode(final NodeList playerListChildNodes) {
<span class="nc bnc" id="L827" title="All 2 branches missed.">    for (int pl_i = 0; pl_i &lt; playerListChildNodes.getLength(); ++pl_i) {</span>
<span class="nc" id="L828">      final Node playerListChildNode = playerListChildNodes.item(pl_i);</span>
<span class="nc" id="L829">      final String playerListChildNodeName = playerListChildNode.getNodeName();</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">      if (playerListChildNodeName.equals(XML_NODE_NAME_PLAYER)) {</span>
<span class="nc" id="L831">        final HashMap&lt;String, String&gt; attrMapPlayer = getAttributesMap(playerListChildNode.getAttributes());</span>

<span class="nc" id="L833">        final String playerNameAttr = attrMapPlayer.get(XML_ATTR_PLAYER_NAME_NAME);</span>
<span class="nc" id="L834">        getPlayerNames().add(playerNameAttr);</span>
<span class="nc" id="L835">        getPlayerInitResourcesMap().put(playerNameAttr, 0);</span>
        // TODO: add logic for optional value
        // attrMapPlayer.get(&quot;optional&quot;)
<span class="nc bnc" id="L838" title="All 2 branches missed.">      } else if (playerListChildNodeName.equals(XML_NODE_NAME_ALLIANCE)) {</span>
<span class="nc" id="L839">        final HashMap&lt;String, String&gt; attrMapPlayer = getAttributesMap(playerListChildNode.getAttributes());</span>
<span class="nc" id="L840">        getPlayerAllianceMap().put(attrMapPlayer.get(XML_ATTR_ALLIANCE_NAME_PLAYER),</span>
<span class="nc" id="L841">            attrMapPlayer.get(XML_ATTR_ALLIANCE_NAME_ALLIANCE));</span>
      }
    }
<span class="nc" id="L844">  }</span>

  private static void parseMapNode(final NodeList mapChildNodes) {
<span class="nc bnc" id="L847" title="All 2 branches missed.">    for (int map_i = 0; map_i &lt; mapChildNodes.getLength(); ++map_i) {</span>
<span class="nc" id="L848">      final Node mapChildNode = mapChildNodes.item(map_i);</span>
<span class="nc" id="L849">      final String mapChildNodeName = mapChildNode.getNodeName();</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">      if (mapChildNodeName.equals(XML_NODE_NAME_TERRITORY)) {</span>
<span class="nc" id="L851">        parseNodeTerritory(mapChildNode);</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">      } else if (mapChildNodeName.equals(XML_NODE_NAME_CONNECTION)) {</span>
<span class="nc" id="L853">        parseNodeConnection(mapChildNode);</span>
      }
    }
<span class="nc" id="L856">  }</span>

  private static void parseNodeConnection(final Node mapChildNode) {
<span class="nc" id="L859">    final NamedNodeMap connectionAttrNodes = mapChildNode.getAttributes();</span>
<span class="nc" id="L860">    String t1Name = connectionAttrNodes.item(0).getNodeValue();</span>
<span class="nc" id="L861">    String t2Name = connectionAttrNodes.item(1).getNodeValue();</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">    if (t1Name.compareTo(t2Name) &gt; 0) {</span>
<span class="nc" id="L863">      final String swapHelper = t1Name;</span>
<span class="nc" id="L864">      t1Name = t2Name;</span>
<span class="nc" id="L865">      t2Name = swapHelper;</span>
    }
<span class="nc" id="L867">    Set&lt;String&gt; t1Connections = getTerritoryConnectionsMap().get(t1Name);</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">    if (t1Connections != null) {</span>
<span class="nc" id="L869">      t1Connections.add(t2Name);</span>
<span class="nc" id="L870">    } else {</span>
<span class="nc" id="L871">      t1Connections = Sets.newLinkedHashSet();</span>
<span class="nc" id="L872">      t1Connections.add(t2Name);</span>
<span class="nc" id="L873">      getTerritoryConnectionsMap().put(t1Name, t1Connections);</span>
    }
<span class="nc" id="L875">  }</span>

  private static void parseNodeTerritory(final Node mapChildNode) {
<span class="nc" id="L878">    final NamedNodeMap terrAttrNodes = mapChildNode.getAttributes();</span>
<span class="nc" id="L879">    String terrName = null;</span>
<span class="nc" id="L880">    final HashMap&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt; terrDef = Maps.newHashMap();</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">    for (int terrAttr_i = 0; terrAttr_i &lt; terrAttrNodes.getLength(); ++terrAttr_i) {</span>
<span class="nc" id="L882">      final Node terrAttrNode = terrAttrNodes.item(terrAttr_i);</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">      if (terrAttrNode.getNodeName().equals(XML_ATTR_ATTACHMENT_NAME_NAME)) {</span>
<span class="nc" id="L884">        terrName = terrAttrNode.getNodeValue();</span>
<span class="nc" id="L885">      } else {</span>
<span class="nc" id="L886">        terrDef.put(TerritoryDefinitionDialog.valueOf(terrAttrNode.getNodeName()),</span>
<span class="nc" id="L887">            Boolean.valueOf(terrAttrNode.getNodeValue()));</span>
      }
    }
<span class="nc" id="L890">    getTerritoryDefintionsMap().put(terrName, terrDef);</span>
<span class="nc" id="L891">  }</span>

  ///////////////////////////////////////////
  // Start of XML creation methods
  ///////////////////////////////////////////
  static Document getXMLDocument() throws ParserConfigurationException {
    // TODO: break into smaller chunks, consider builder pattern
<span class="nc" id="L898">    final DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L899">    final DocumentBuilder db = dbf.newDocumentBuilder();</span>

<span class="nc" id="L901">    final Document doc = db.newDocument();</span>
<span class="nc" id="L902">    final Element game = doc.createElement(XML_NODE_NAME_GAME);</span>
<span class="nc" id="L903">    doc.appendChild(game);</span>

<span class="nc" id="L905">    appendFromXMLStrings(doc, game);</span>

<span class="nc" id="L907">    final Element map = doc.createElement(XML_NODE_NAME_MAP);</span>
<span class="nc" id="L908">    game.appendChild(map);</span>


<span class="nc" id="L911">    map.appendChild(doc.createComment(&quot; Territory Definitions &quot;));</span>

<span class="nc" id="L913">    boolean territoryAttachmentNeeded = appendFromTerritoryDefinitions(doc, map);</span>

<span class="nc" id="L915">    appendFromResourceList(doc, game);</span>

<span class="nc" id="L917">    appendFromPlayerName(doc, game);</span>

<span class="nc" id="L919">    appendFromUnitDefinitions(doc, game, map);</span>

<span class="nc" id="L921">    appendFromGamePlaySequence(doc, game);</span>

<span class="nc bnc" id="L923" title="All 2 branches missed.">    if (!getTerritoyProductionsMap().isEmpty()) {</span>
<span class="nc" id="L924">      territoryAttachmentNeeded = true;</span>
    }

<span class="nc bnc" id="L927" title="All 6 branches missed.">    if (!getTechnologyDefinitionsMap().isEmpty() || !getUnitAttachmentsMap().isEmpty() || territoryAttachmentNeeded</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">        || !getCanalDefinitionsMap().isEmpty()) {</span>
<span class="nc" id="L929">      final Element attachmentList = doc.createElement(XML_NODE_NAME_ATTACHMENT_LIST);</span>
<span class="nc" id="L930">      game.appendChild(attachmentList);</span>

<span class="nc" id="L932">      appendToAttachmentList(doc, territoryAttachmentNeeded, attachmentList);</span>
    }

<span class="nc" id="L935">    appendInitialize(doc, game);</span>

<span class="nc" id="L937">    return doc;</span>
  }

  /**
   * @param doc
   * @param game
   */
  private static void appendInitialize(final Document doc, final Element game) {
<span class="nc" id="L945">    final Element initialize = doc.createElement(XML_NODE_NAME_INITIALIZE);</span>
<span class="nc" id="L946">    game.appendChild(initialize);</span>

<span class="nc" id="L948">    appendFromTerritoryOwnerships(doc, initialize);</span>

<span class="nc" id="L950">    appendFromUnitPlacements(doc, initialize);</span>

<span class="nc" id="L952">    appendPropertyList(doc, game);</span>
<span class="nc" id="L953">  }</span>

  /**
   * @param doc
   * @param game
   */
  private static void appendPropertyList(final Document doc, final Element game) {
<span class="nc" id="L960">    final Element propertyList = doc.createElement(XML_NODE_NAME_PROPERTY_LIST);</span>
<span class="nc" id="L961">    game.appendChild(propertyList);</span>

<span class="nc" id="L963">    appendFromGameSettings(doc, propertyList);</span>

<span class="nc bnc" id="L965" title="All 2 branches missed.">    if (getNotes().length() &gt; 0) {</span>
<span class="nc" id="L966">      final Element property = doc.createElement(XML_NODE_NAME_PROPERTY);</span>
<span class="nc" id="L967">      property.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, XML_ATTR_VALUE_PROPERTY_NAME_NOTES);</span>
<span class="nc" id="L968">      final Element propertyValue = doc.createElement(XML_NODE_NAME_VALUE);</span>
<span class="nc" id="L969">      propertyValue.setTextContent(getNotes());</span>
<span class="nc" id="L970">      property.appendChild(propertyValue);</span>
<span class="nc" id="L971">      propertyList.appendChild(property);</span>
    }

<span class="nc bnc" id="L974" title="All 2 branches missed.">    if (getMapXMLFile() != null) {</span>
<span class="nc" id="L975">      propertyList.appendChild(doc.createComment(&quot; Map Name: also used for map utils when asked &quot;));</span>
<span class="nc" id="L976">      final Element property = doc.createElement(XML_NODE_NAME_PROPERTY);</span>
<span class="nc" id="L977">      property.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, XML_ATTR_VALUE_PROPERTY_NAME_MAP_NAME);</span>
<span class="nc" id="L978">      final String fileName = getMapXMLFile().getName();</span>
<span class="nc" id="L979">      property.setAttribute(XML_ATTR_PROPERTY_NAME_VALUE, fileName.substring(0, fileName.lastIndexOf(&quot;.&quot;) - 1));</span>
<span class="nc" id="L980">      property.setAttribute(XML_ATTR_PROPERTY_NAME_EDITABLE, Constants.PROPERTY_FALSE);</span>
<span class="nc" id="L981">      propertyList.appendChild(property);</span>
    }
<span class="nc" id="L983">  }</span>

  public static void appendFromGameSettings(final Document doc, final Element propertyList) {
<span class="nc bnc" id="L986" title="All 2 branches missed.">    if (!getGameSettingsMap().isEmpty()) {</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">      for (final Entry&lt;String, List&lt;String&gt;&gt; gameSettingsEntry : getGameSettingsMap().entrySet()) {</span>
<span class="nc" id="L988">        final Element property = doc.createElement(XML_NODE_NAME_PROPERTY);</span>
<span class="nc" id="L989">        final List&lt;String&gt; settingsValue = gameSettingsEntry.getValue();</span>
<span class="nc" id="L990">        property.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, gameSettingsEntry.getKey());</span>
<span class="nc" id="L991">        final String valueString = settingsValue.get(0);</span>
<span class="nc" id="L992">        property.setAttribute(XML_ATTR_PROPERTY_NAME_VALUE, valueString);</span>
<span class="nc" id="L993">        property.setAttribute(XML_ATTR_PROPERTY_NAME_EDITABLE, settingsValue.get(1));</span>
<span class="nc bnc" id="L994" title="All 4 branches missed.">        if (valueString.equals(Constants.PROPERTY_TRUE) || valueString.equals(Constants.PROPERTY_FALSE)) {</span>
<span class="nc" id="L995">          property.appendChild(doc.createElement(XML_NODE_NAME_BOOLEAN));</span>
<span class="nc" id="L996">        } else {</span>
<span class="nc" id="L997">          final String minString = settingsValue.get(2);</span>
<span class="nc" id="L998">          final String maxString = settingsValue.get(3);</span>
          try {
<span class="nc" id="L1000">            Integer.valueOf(minString);</span>
<span class="nc" id="L1001">            Integer.valueOf(maxString);</span>
<span class="nc" id="L1002">            final Element number = doc.createElement(XML_NODE_NAME_NUMBER);</span>
<span class="nc" id="L1003">            number.setAttribute(XML_ATTR_NUMBER_NAME_MIN, minString);</span>
<span class="nc" id="L1004">            number.setAttribute(XML_ATTR_NUMBER_NAME_MAX, maxString);</span>
<span class="nc" id="L1005">            property.appendChild(number);</span>
<span class="nc" id="L1006">          } catch (final NumberFormatException nfe) {</span>
            // nothing to do
          }
        }
<span class="nc" id="L1010">        propertyList.appendChild(property);</span>
      }
    }
<span class="nc" id="L1013">  }</span>

  public static void appendFromUnitPlacements(final Document doc, final Element initialize) {
<span class="nc bnc" id="L1016" title="All 2 branches missed.">    if (!getUnitPlacementsMap().isEmpty()) {</span>
<span class="nc" id="L1017">      final Element unitInitialize = doc.createElement(XML_NODE_NAME_UNIT_INITIALIZE);</span>
<span class="nc" id="L1018">      initialize.appendChild(unitInitialize);</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">      for (final Entry&lt;String, Map&lt;String, Map&lt;String, Integer&gt;&gt;&gt; placementEntry : getUnitPlacementsMap()</span>
<span class="nc" id="L1020">          .entrySet()) {</span>
<span class="nc" id="L1021">        final Element unitPlacementTemplate = doc.createElement(XML_NODE_NAME_UNIT_PLACEMENT);</span>
<span class="nc" id="L1022">        unitPlacementTemplate.setAttribute(XML_ATTR_UNIT_PLACEMENT_NAME_TERRITORY, placementEntry.getKey());</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        for (final Entry&lt;String, Map&lt;String, Integer&gt;&gt; playerPlacements : placementEntry.getValue()</span>
<span class="nc" id="L1024">            .entrySet()) {</span>
<span class="nc" id="L1025">          final Element playerUnitPlacementTemplate = (Element) unitPlacementTemplate.cloneNode(false);</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">          if (playerPlacements.getKey() != null) {</span>
<span class="nc" id="L1027">            playerUnitPlacementTemplate.setAttribute(XML_ATTR_UNIT_PLACEMENT_NAME_OWNER, playerPlacements.getKey());</span>
          }
<span class="nc bnc" id="L1029" title="All 2 branches missed.">          for (final Entry&lt;String, Integer&gt; unitDetails : playerPlacements.getValue().entrySet()) {</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (unitDetails.getValue() &gt; 0) {</span>
<span class="nc" id="L1031">              final Element unitPlacement = (Element) playerUnitPlacementTemplate.cloneNode(false);</span>
<span class="nc" id="L1032">              unitPlacement.setAttribute(XML_ATTR_ATTACHMENT_NAME_UNIT_TYPE, unitDetails.getKey());</span>
<span class="nc" id="L1033">              unitPlacement.setAttribute(XML_ATTR_RESULT_NAME_QUANTITY, unitDetails.getValue().toString());</span>
<span class="nc" id="L1034">              unitInitialize.appendChild(unitPlacement);</span>
            }
          }
        }
      }
    }
<span class="nc" id="L1040">  }</span>

  public static void appendFromTerritoryOwnerships(final Document doc, final Element initialize) {
<span class="nc bnc" id="L1043" title="All 2 branches missed.">    if (!getTerritoryOwnershipsMap().isEmpty()) {</span>
<span class="nc" id="L1044">      final Element ownerInitialize = doc.createElement(XML_NODE_NAME_OWNER_INITIALIZE);</span>
<span class="nc" id="L1045">      initialize.appendChild(ownerInitialize);</span>
<span class="nc" id="L1046">      final HashMap&lt;String, ArrayList&lt;String&gt;&gt; playerTerritories = Maps.newHashMap();</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">      for (final String player : getPlayerNames()) {</span>
<span class="nc" id="L1048">        playerTerritories.put(player, new ArrayList&lt;&gt;());</span>
      }
<span class="nc bnc" id="L1050" title="All 2 branches missed.">      for (final Entry&lt;String, String&gt; ownershipEntry : getTerritoryOwnershipsMap().entrySet()) {</span>
<span class="nc" id="L1051">        playerTerritories.get(ownershipEntry.getValue()).add(ownershipEntry.getKey());</span>
      }
<span class="nc bnc" id="L1053" title="All 2 branches missed.">      for (final Entry&lt;String, ArrayList&lt;String&gt;&gt; playerTerritoriesEntry : playerTerritories.entrySet()) {</span>
<span class="nc" id="L1054">        doc.createComment(&quot; &quot; + playerTerritoriesEntry.getKey() + &quot; Owned Territories &quot;);</span>
<span class="nc" id="L1055">        final Element territoryOwnerTemplate = doc.createElement(XML_NODE_NAME_TERRITORY_OWNER);</span>
<span class="nc" id="L1056">        territoryOwnerTemplate.setAttribute(XML_ATTR_UNIT_PLACEMENT_NAME_OWNER, playerTerritoriesEntry.getKey());</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        for (final String territory : playerTerritoriesEntry.getValue()) {</span>
<span class="nc" id="L1058">          final Element territoryOwner = (Element) territoryOwnerTemplate.cloneNode(false);</span>
<span class="nc" id="L1059">          territoryOwner.setAttribute(XML_ATTR_TERRITORY_OWNER_NAME_TERRITORY, territory);</span>
<span class="nc" id="L1060">          ownerInitialize.appendChild(territoryOwner);</span>
        }
      }
    }
<span class="nc" id="L1064">  }</span>

  public static void appendFromResourceList(final Document doc, final Element game) {
<span class="nc bnc" id="L1067" title="All 2 branches missed.">    if (!getResourceList().isEmpty()) {</span>
<span class="nc" id="L1068">      final Element resourceListElement = doc.createElement(XML_NODE_NAME_RESOURCE_LIST);</span>
<span class="nc" id="L1069">      game.appendChild(resourceListElement);</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">      for (final String resourceName : getResourceList()) {</span>
<span class="nc" id="L1071">        final Element resourceElement = doc.createElement(XML_NODE_NAME_RESOURCE);</span>
<span class="nc" id="L1072">        resourceElement.setAttribute(XML_ATTR_RESOURCE_NAME_NAME, resourceName);</span>
<span class="nc" id="L1073">        resourceListElement.appendChild(resourceElement);</span>
      }
    }
<span class="nc" id="L1076">  }</span>

  public static void appendToAttachmentList(final Document doc, final boolean territoryAttachmentNeeded,
      final Element attachmentList) {
<span class="nc" id="L1080">    final Element attachmentTemplate = doc.createElement(XML_NODE_NAME_ATTACHMENT);</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">    if (!getTechnologyDefinitionsMap().isEmpty()) {</span>
<span class="nc" id="L1082">      setAttachmentTemplateAttributes(attachmentTemplate, Constants.TECH_ATTACHMENT_NAME,</span>
<span class="nc" id="L1083">          TechAttachment.class.getName(), XML_ATTR_ATTACHMENT_NAME_PLAYER);</span>
<span class="nc" id="L1084">      writeAttachmentNodes(doc, attachmentList, getTechnologyDefinitionsMap(), attachmentTemplate);</span>
    }
<span class="nc bnc" id="L1086" title="All 2 branches missed.">    if (!getUnitAttachmentsMap().isEmpty()) {</span>
<span class="nc" id="L1087">      setAttachmentTemplateAttributes(attachmentTemplate, Constants.UNIT_ATTACHMENT_NAME,</span>
<span class="nc" id="L1088">          UnitAttachment.class.getName(), XML_ATTR_ATTACHMENT_NAME_UNIT_TYPE);</span>
<span class="nc" id="L1089">      writeAttachmentNodes(doc, attachmentList, getUnitAttachmentsMap(), attachmentTemplate);</span>
    }
<span class="nc bnc" id="L1091" title="All 2 branches missed.">    if (territoryAttachmentNeeded) {</span>
<span class="nc" id="L1092">      setAttachmentTemplateAttributes(attachmentTemplate, Constants.TERRITORY_ATTACHMENT_NAME,</span>
<span class="nc" id="L1093">          TerritoryAttachment.class.getName(), XML_NODE_NAME_TERRITORY);</span>
<span class="nc" id="L1094">      writeAttachmentNodes(doc, attachmentList, getTerritoryAttachments(), attachmentTemplate);</span>
    }
<span class="nc bnc" id="L1096" title="All 2 branches missed.">    if (!getCanalDefinitionsMap().isEmpty()) {</span>
<span class="nc" id="L1097">      setAttachmentTemplateAttributes(attachmentTemplate, Constants.INF_ATTACHMENT_NAME,</span>
<span class="nc" id="L1098">          CanalAttachment.class.getName(), XML_NODE_NAME_TERRITORY);</span>
<span class="nc" id="L1099">      addCanalDefinitionsAttachmentNodes(doc, attachmentList, attachmentTemplate);</span>
<span class="nc" id="L1100">      writeAttachmentNodes(doc, attachmentList, getUnitAttachmentsMap(), attachmentTemplate);</span>
    }
<span class="nc" id="L1102">  }</span>


  private static void setAttachmentTemplateAttributes(final Element attachmentTemplate, final String name,
      final String javaClass, final String player) {
<span class="nc" id="L1107">    attachmentTemplate.setAttribute(XML_ATTR_ATTACHMENT_NAME_NAME, name);</span>
<span class="nc" id="L1108">    attachmentTemplate.setAttribute(XML_ATTR_ATTACHMENT_NAME_JAVA_CLASS, javaClass);</span>
<span class="nc" id="L1109">    attachmentTemplate.setAttribute(XML_ATTR_ATTACHMENT_NAME_TYPE, player);</span>
<span class="nc" id="L1110">  }</span>

  private static void addCanalDefinitionsAttachmentNodes(final Document doc, final Element attachmentList,
      final Element attachmentTemplate) {
<span class="nc bnc" id="L1114" title="All 2 branches missed.">    for (final Entry&lt;String, CanalTerritoriesTuple&gt; canalDefEntry : getCanalDefinitionsMap()</span>
<span class="nc" id="L1115">        .entrySet()) {</span>
<span class="nc" id="L1116">      final CanalTerritoriesTuple canalDef = canalDefEntry.getValue();</span>
<span class="nc" id="L1117">      final Iterator&lt;String&gt; iter_landTerrs = canalDef.getLandTerritories().iterator();</span>
<span class="nc" id="L1118">      final StringBuilder sb = new StringBuilder(iter_landTerrs.next());</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">      while (iter_landTerrs.hasNext()) {</span>
<span class="nc" id="L1120">        sb.append(XML_ATTR_VALUE_SEPARATOR_OPTION_VALUE).append(iter_landTerrs.next());</span>
      }
<span class="nc" id="L1122">      final String landTerritories = sb.toString();</span>

<span class="nc" id="L1124">      final Element attachmentTemplateCanal = (Element) attachmentTemplate.cloneNode(false);</span>
<span class="nc" id="L1125">      final Element canalOptionName = doc.createElement(XML_NODE_NAME_OPTION);</span>
<span class="nc" id="L1126">      canalOptionName.setAttribute(XML_ATTR_OPTION_NAME_NAME, XML_ATTR_VALUE_OPTION_NAME_CANAL_NAME);</span>
<span class="nc" id="L1127">      canalOptionName.setAttribute(XML_ATTR_PROPERTY_NAME_VALUE, canalDefEntry.getKey());</span>
<span class="nc" id="L1128">      attachmentTemplateCanal.appendChild(canalOptionName);</span>
<span class="nc" id="L1129">      final Element canalOptionLandTerrs = doc.createElement(XML_NODE_NAME_OPTION);</span>
<span class="nc" id="L1130">      canalOptionLandTerrs.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, XML_ATTR_VALUE_OPTION_NAME_LAND_TERRITORIES);</span>
<span class="nc" id="L1131">      canalOptionLandTerrs.setAttribute(XML_ATTR_PROPERTY_NAME_VALUE, landTerritories);</span>
<span class="nc" id="L1132">      attachmentTemplateCanal.appendChild(canalOptionLandTerrs);</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">      for (final String waterTerr : canalDef.getWaterTerritories()) {</span>
<span class="nc" id="L1134">        final Element canalAttachment = (Element) attachmentTemplateCanal.cloneNode(true);</span>
<span class="nc" id="L1135">        canalAttachment.setAttribute(XML_ATTR_ATTACHMENT_NAME_ATTACH_TO, waterTerr);</span>
<span class="nc" id="L1136">        attachmentList.appendChild(canalAttachment);</span>
      }
    }
<span class="nc" id="L1139">  }</span>

  private static Map&lt;String, List&lt;String&gt;&gt; getTerritoryAttachments() {
<span class="nc" id="L1142">    final Map&lt;String, List&lt;String&gt;&gt; territoryAttachments = Maps.newLinkedHashMap();</span>
<span class="nc" id="L1143">    addAttachmentsFromTerritoryDefinitions(territoryAttachments);</span>
<span class="nc" id="L1144">    addAttachmentsFromTerritoryProductions(territoryAttachments);</span>
<span class="nc" id="L1145">    return territoryAttachments;</span>
  }

  private static void addAttachmentsFromTerritoryProductions(final Map&lt;String, List&lt;String&gt;&gt; territoryAttachments) {
<span class="nc bnc" id="L1149" title="All 2 branches missed.">    for (final Entry&lt;String, Integer&gt; productionEntry : getTerritoyProductionsMap().entrySet()) {</span>
<span class="nc" id="L1150">      final int production = productionEntry.getValue();</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">      if (production &gt; 0) {</span>
<span class="nc" id="L1152">        final String territoryName = productionEntry.getKey();</span>
<span class="nc" id="L1153">        final ArrayList&lt;String&gt; attachmentOptions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1154">        attachmentOptions.add(territoryName);</span>
<span class="nc" id="L1155">        attachmentOptions.add(Integer.toString(production));</span>
<span class="nc" id="L1156">        territoryAttachments.put(&quot;production_&quot; + territoryName, attachmentOptions);</span>
      }
    }
<span class="nc" id="L1159">  }</span>

  private static void addAttachmentsFromTerritoryDefinitions(final Map&lt;String, List&lt;String&gt;&gt; territoryAttachments) {
<span class="nc bnc" id="L1162" title="All 2 branches missed.">    for (final Entry&lt;String, Map&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt;&gt; territoryDefinition : getTerritoryDefintionsMap()</span>
<span class="nc" id="L1163">        .entrySet()) {</span>
<span class="nc" id="L1164">      final String territoryName = territoryDefinition.getKey();</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">      for (final Entry&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt; definition : territoryDefinition.getValue()</span>
<span class="nc" id="L1166">          .entrySet()) {</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (definition.getValue() == Boolean.TRUE) {</span>
<span class="nc" id="L1168">          final ArrayList&lt;String&gt; attachmentOptions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1169">          attachmentOptions.add(territoryName);</span>
<span class="nc" id="L1170">          attachmentOptions.add(&quot;true&quot;);</span>
          // TODO: handle capital different based on owner
          // owner defined (step 13) only after territory definitions (step 2)
          // &lt;option name=&quot;capital&quot; value=&quot;Italians&quot;/&gt;
<span class="nc" id="L1174">          territoryAttachments.put(</span>
<span class="nc" id="L1175">              TerritoryDefinitionDialog.getDefinitionString(definition.getKey()) + &quot;_&quot; + territoryName,</span>
<span class="nc" id="L1176">              attachmentOptions);</span>
        }
      }
    }
<span class="nc" id="L1180">  }</span>

  public static boolean appendFromTerritoryDefinitions(final Document doc, final Element map) {
<span class="nc" id="L1183">    boolean territoryAttachmentNeeded = false;</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">    for (final Entry&lt;String, Map&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt;&gt; entryTerritoryDefinition : getTerritoryDefintionsMap()</span>
<span class="nc" id="L1185">        .entrySet()) {</span>
<span class="nc" id="L1186">      final Element territory = doc.createElement(XML_NODE_NAME_TERRITORY);</span>
<span class="nc" id="L1187">      territory.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, entryTerritoryDefinition.getKey());</span>
<span class="nc" id="L1188">      final Map&lt;TerritoryDefinitionDialog.DEFINITION, Boolean&gt; territoryDefinition =</span>
<span class="nc" id="L1189">          entryTerritoryDefinition.getValue();</span>
<span class="nc" id="L1190">      final int territoryDefinitionSize = territoryDefinition.size();</span>
<span class="nc" id="L1191">      final Boolean isWater = territoryDefinition.get(TerritoryDefinitionDialog.DEFINITION.IS_WATER);</span>
<span class="nc bnc" id="L1192" title="All 4 branches missed.">      if (isWater != null &amp;&amp; isWater) {</span>
<span class="nc" id="L1193">        territory.setAttribute(</span>
<span class="nc" id="L1194">            TerritoryDefinitionDialog.getDefinitionString(TerritoryDefinitionDialog.DEFINITION.IS_WATER), &quot;true&quot;);</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">        if (territoryDefinitionSize &gt; 1) {</span>
<span class="nc" id="L1196">          territoryAttachmentNeeded = true;</span>
        }
<span class="nc bnc" id="L1198" title="All 6 branches missed.">      } else if (territoryDefinitionSize &gt; 1 || isWater == null &amp;&amp; territoryDefinitionSize &gt; 0) {</span>
<span class="nc" id="L1199">        territoryAttachmentNeeded = true;</span>
      }
<span class="nc" id="L1201">      map.appendChild(territory);</span>
    }

<span class="nc" id="L1204">    map.appendChild(doc.createComment(&quot; Territory Connections &quot;));</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">    for (final Entry&lt;String, Set&lt;String&gt;&gt; entryTerritoryConnection : getTerritoryConnectionsMap().entrySet()) {</span>
<span class="nc" id="L1206">      final Element connectionTemp = doc.createElement(XML_NODE_NAME_CONNECTION);</span>
<span class="nc" id="L1207">      connectionTemp.setAttribute(XML_ATTR_CONNECTION_NAME_T1, entryTerritoryConnection.getKey());</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">      for (final String t2 : entryTerritoryConnection.getValue()) {</span>
<span class="nc" id="L1209">        connectionTemp.setAttribute(XML_ATTR_CONNECTION_NAME_T2, t2);</span>
<span class="nc" id="L1210">        map.appendChild(connectionTemp.cloneNode(false));</span>
      }
    }
<span class="nc" id="L1213">    return territoryAttachmentNeeded;</span>
  }

  public static void appendFromXMLStrings(final Document doc, final Element game) {
<span class="nc" id="L1217">    Element currentElem = null;</span>
<span class="nc" id="L1218">    String prevKeyNode = null;</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">    for (final Entry&lt;String, String&gt; entryXMLString : getXmlStringsMap().entrySet()) {</span>
<span class="nc" id="L1220">      final String key = entryXMLString.getKey();</span>
<span class="nc" id="L1221">      final String[] split = key.split(&quot;_@&quot;);</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">      if (!split[0].equals(prevKeyNode)) {</span>
<span class="nc" id="L1223">        Element parentElem = game;</span>
<span class="nc bnc" id="L1224" title="All 2 branches missed.">        for (final String newNode : split[0].split(&quot;_&quot;)) {</span>
<span class="nc" id="L1225">          currentElem = doc.createElement(newNode);</span>
<span class="nc" id="L1226">          parentElem.appendChild(currentElem);</span>
<span class="nc" id="L1227">          parentElem = currentElem;</span>
        }
      }
<span class="nc" id="L1230">      currentElem.setAttribute(split[1], entryXMLString.getValue());</span>
<span class="nc" id="L1231">      prevKeyNode = split[0];</span>
    }
<span class="nc" id="L1233">  }</span>

  public static void appendFromGamePlaySequence(final Document doc, final Element game) {
<span class="nc bnc" id="L1236" title="All 2 branches missed.">    if (!getGamePlaySequenceMap().isEmpty()) {</span>
<span class="nc" id="L1237">      final Element gamePlay = doc.createElement(XML_NODE_NAME_GAME_PLAY);</span>
<span class="nc" id="L1238">      game.appendChild(gamePlay);</span>

<span class="nc bnc" id="L1240" title="All 2 branches missed.">      for (final Entry&lt;String, List&lt;String&gt;&gt; delegateStep : getGamePlaySequenceMap().entrySet()) {</span>
<span class="nc" id="L1241">        final List&lt;String&gt; delegateProperties = delegateStep.getValue();</span>
<span class="nc" id="L1242">        final Element delegate = doc.createElement(XML_NODE_NAME_DELEGATE);</span>
<span class="nc" id="L1243">        delegate.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, delegateStep.getKey());</span>
<span class="nc" id="L1244">        delegate.setAttribute(XML_ATTR_ATTACHMENT_NAME_JAVA_CLASS,</span>
<span class="nc" id="L1245">            TRIPLEA_JAVA_CLASS_DELEGATE_PATH + delegateProperties.get(0));</span>
<span class="nc" id="L1246">        delegate.setAttribute(XML_ATTR_STEP_NAME_DISPLAY, delegateProperties.get(1));</span>
<span class="nc" id="L1247">        gamePlay.appendChild(delegate);</span>
      }

<span class="nc bnc" id="L1250" title="All 2 branches missed.">      if (!getPlayerSequenceMap().isEmpty()) {</span>
<span class="nc" id="L1251">        final Element sequence = doc.createElement(XML_NODE_NAME_SEQUENCE);</span>
<span class="nc" id="L1252">        gamePlay.appendChild(sequence);</span>

<span class="nc bnc" id="L1254" title="All 2 branches missed.">        for (final Entry&lt;String, Triple&lt;String, String, Integer&gt;&gt; sequenceStep : getPlayerSequenceMap().entrySet()) {</span>
<span class="nc" id="L1255">          final Triple&lt;String, String, Integer&gt; sequenceProperties = sequenceStep.getValue();</span>
<span class="nc" id="L1256">          final Element step = doc.createElement(XML_NODE_NAME_STEP);</span>
<span class="nc" id="L1257">          final String sequenceStepKey = sequenceStep.getKey();</span>
<span class="nc" id="L1258">          step.setAttribute(XML_ATTR_STEP_NAME_NAME, sequenceStepKey);</span>
<span class="nc" id="L1259">          step.setAttribute(XML_ATTR_STEP_NAME_DELEGATE, sequenceProperties.getFirst());</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">          if (sequenceProperties.getSecond().length() &gt; 0) {</span>
<span class="nc" id="L1261">            step.setAttribute(XML_ATTR_ATTACHMENT_NAME_PLAYER, sequenceProperties.getSecond());</span>
          }
<span class="nc" id="L1263">          final int maxRunCount = sequenceProperties.getThird();</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">          if (maxRunCount &gt; 0) {</span>
<span class="nc" id="L1265">            step.setAttribute(XML_ATTR_STEP_NAME_MAX_RUN_COUNT, Integer.toString(maxRunCount));</span>
          }
<span class="nc bnc" id="L1267" title="All 2 branches missed.">          if (stepNameIndicatesNonCombatMove(sequenceStepKey)) {</span>
<span class="nc" id="L1268">            step.setAttribute(XML_ATTR_STEP_NAME_DISPLAY, &quot;Non Combat Move&quot;);</span>
          }
<span class="nc" id="L1270">          sequence.appendChild(step);</span>
        }
      }
    }
<span class="nc" id="L1274">  }</span>

  // TODO REPLACE 'endsWith(&quot;NonCombatMove&quot;)'-checks IN REMAINING PROJEKT
  /**
   * @param stepName - string of the step name
   * @return true if string ends with &quot;NonCombatMove&quot;, false otherwise
   */
  private static boolean stepNameIndicatesNonCombatMove(final String stepName) {
<span class="nc" id="L1282">    return stepName.endsWith(&quot;NonCombatMove&quot;);</span>
  }

  public static void appendFromPlayerName(final Document doc, final Element game) {
<span class="nc bnc" id="L1286" title="All 2 branches missed.">    if (!getPlayerNames().isEmpty()) {</span>
<span class="nc" id="L1287">      final Element playerList = doc.createElement(XML_NODE_NAME_PLAYER_LIST);</span>
<span class="nc" id="L1288">      game.appendChild(playerList);</span>
<span class="nc" id="L1289">      playerList.appendChild(doc.createComment(&quot; In Turn Order &quot;));</span>
<span class="nc" id="L1290">      appendChildrenWithTwoAttributesFromList(doc, playerList, getPlayerNames(), XML_NODE_NAME_PLAYER,</span>
<span class="nc" id="L1291">          XML_ATTR_PLAYER_NAME_NAME, XML_ATTR_PLAYER_NAME_OPTIONAL, XML_ATTR_VALUE_PLAYER_OPTIONAL_NAME_FALSE);</span>

<span class="nc" id="L1293">      final HashMap&lt;String, ArrayList&lt;String&gt;&gt; alliances = Maps.newHashMap();</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">      for (final Entry&lt;String, String&gt; allianceEntry : getPlayerAllianceMap().entrySet()) {</span>
<span class="nc" id="L1295">        final String allianceName = allianceEntry.getValue();</span>
<span class="nc" id="L1296">        ArrayList&lt;String&gt; players = alliances.get(allianceName);</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        if (players == null) {</span>
<span class="nc" id="L1298">          players = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1299">          alliances.put(allianceName, players);</span>
        }
<span class="nc" id="L1301">        players.add(allianceEntry.getKey());</span>
      }
<span class="nc bnc" id="L1303" title="All 2 branches missed.">      for (final Entry&lt;String, ArrayList&lt;String&gt;&gt; allianceEntry : alliances.entrySet()) {</span>
<span class="nc" id="L1304">        final String allianceName = allianceEntry.getKey();</span>
<span class="nc" id="L1305">        playerList.appendChild(doc.createComment(&quot; &quot; + allianceName + &quot; Alliance &quot;));</span>
<span class="nc" id="L1306">        appendChildrenWithTwoAttributesFromList(doc, playerList, allianceEntry.getValue(), XML_NODE_NAME_ALLIANCE,</span>
<span class="nc" id="L1307">            XML_ATTR_ATTACHMENT_NAME_PLAYER,</span>
<span class="nc" id="L1308">            XML_NODE_NAME_ALLIANCE, allianceName);</span>
      }
    }
<span class="nc" id="L1311">  }</span>

  public static void appendFromUnitDefinitions(final Document doc, final Element game, final Element map) {
<span class="nc bnc" id="L1314" title="All 2 branches missed.">    if (!getUnitDefinitionsMap().isEmpty()) {</span>
<span class="nc" id="L1315">      map.appendChild(doc.createComment(&quot; Unit Definitions &quot;));</span>
<span class="nc" id="L1316">      final Element unitList = doc.createElement(XML_NODE_NAME_UNIT_LIST);</span>
<span class="nc" id="L1317">      game.appendChild(unitList);</span>

<span class="nc" id="L1319">      final Element production = doc.createElement(XML_NODE_NAME_PRODUCTION);</span>
<span class="nc" id="L1320">      game.appendChild(production);</span>
<span class="nc" id="L1321">      final String firstResourceName = getResourceList().get(0);</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">      for (final Entry&lt;String, List&lt;Integer&gt;&gt; unitDefinition : getUnitDefinitionsMap().entrySet()) {</span>
<span class="nc" id="L1323">        final String unitName = unitDefinition.getKey();</span>

<span class="nc" id="L1325">        final Element unit = doc.createElement(XML_NODE_NAME_UNIT);</span>
<span class="nc" id="L1326">        unit.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, unitName);</span>
<span class="nc" id="L1327">        unitList.appendChild(unit);</span>

<span class="nc" id="L1329">        final List&lt;Integer&gt; definition = unitDefinition.getValue();</span>
<span class="nc" id="L1330">        final Element productionRule = doc.createElement(XML_NODE_NAME_PRODUCTION_RULE);</span>
<span class="nc" id="L1331">        productionRule.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, getProductionRuleAttrNameValue(unitName));</span>
<span class="nc" id="L1332">        production.appendChild(productionRule);</span>
<span class="nc" id="L1333">        final Element prCost = doc.createElement(XML_NODE_NAME_COST);</span>
<span class="nc" id="L1334">        prCost.setAttribute(XML_ATTR_COST_NAME_RESOURCE, firstResourceName);</span>
<span class="nc" id="L1335">        prCost.setAttribute(XML_ATTR_RESULT_NAME_QUANTITY, definition.get(0).toString());</span>
<span class="nc" id="L1336">        productionRule.appendChild(prCost);</span>
<span class="nc" id="L1337">        final Element prResult = doc.createElement(XML_NODE_NAME_RESULT);</span>
<span class="nc" id="L1338">        prResult.setAttribute(XML_ATTR_RESULT_NAME_RESOURCE_OR_UNIT, unitName);</span>
<span class="nc" id="L1339">        prResult.setAttribute(XML_ATTR_RESULT_NAME_QUANTITY, definition.get(1).toString());</span>
<span class="nc" id="L1340">        productionRule.appendChild(prResult);</span>
      }

<span class="nc bnc" id="L1343" title="All 2 branches missed.">      for (final Entry&lt;String, List&lt;String&gt;&gt; productionFrontierEntry : getProductionFrontiersMap().entrySet()) {</span>
<span class="nc" id="L1344">        final String productionFrontierName = productionFrontierEntry.getKey();</span>

<span class="nc" id="L1346">        final Element productionFrontier = doc.createElement(XML_NODE_NAME_PRODUCTION_FRONTIER);</span>
<span class="nc" id="L1347">        productionFrontier.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, productionFrontierName);</span>
<span class="nc" id="L1348">        production.appendChild(productionFrontier);</span>

<span class="nc bnc" id="L1350" title="All 2 branches missed.">        for (final String frontierRuleName : productionFrontierEntry.getValue()) {</span>
<span class="nc" id="L1351">          final Element frontierRule = doc.createElement(XML_NODE_NAME_FRONTIER_RULES);</span>
<span class="nc" id="L1352">          frontierRule.setAttribute(XML_ATTR_PROPERTY_NAME_NAME, getFrontierRuleValue(frontierRuleName));</span>
<span class="nc" id="L1353">          productionFrontier.appendChild(frontierRule);</span>
        }
      }
    }
<span class="nc" id="L1357">  }</span>

  private static String getFrontierRuleValue(final String frontierRuleName) {
<span class="nc" id="L1360">    return &quot;buy&quot; + frontierRuleName;</span>
  }

  private static String getProductionRuleAttrNameValue(final String unitName) {
<span class="nc" id="L1364">    return &quot;buy&quot; + unitName.substring(0, 1).toUpperCase() + unitName.substring(1);</span>
  }

  /**
   * Appends new Elements to parentElement from list having two attributes.
   * Attribute 1 is coming from the provided list
   * Attribute 2 has a fix value for all new elements
   */
  public static void appendChildrenWithTwoAttributesFromList(final Document doc, final Element parentElement,
      final List&lt;String&gt; list, final String childName, final String attrOneKey, final String attrTwoKey,
      final String attrTwoFixValue) {
<span class="nc bnc" id="L1375" title="All 2 branches missed.">    for (final String attrOneValue : list) {</span>
<span class="nc" id="L1376">      final Element newChild = doc.createElement(childName);</span>
<span class="nc" id="L1377">      newChild.setAttribute(attrOneKey, attrOneValue);</span>
<span class="nc" id="L1378">      newChild.setAttribute(attrTwoKey, attrTwoFixValue);</span>
<span class="nc" id="L1379">      parentElement.appendChild(newChild);</span>
    }
<span class="nc" id="L1381">  }</span>

  protected static void writeAttachmentNodes(final Document doc, final Element attachmentList,
      final Map&lt;String, List&lt;String&gt;&gt; hashMap, final Element attachmentTemplate) {
<span class="nc" id="L1385">    final HashMap&lt;String, List&lt;Element&gt;&gt; playerAttachOptions = Maps.newHashMap();</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">    for (final Entry&lt;String, List&lt;String&gt;&gt; technologyDefinition : hashMap.entrySet()) {</span>
<span class="nc" id="L1387">      final List&lt;String&gt; definitionValues = technologyDefinition.getValue();</span>
<span class="nc" id="L1388">      final Element option = doc.createElement(XML_NODE_NAME_OPTION);</span>
<span class="nc" id="L1389">      final String techKey = technologyDefinition.getKey();</span>
<span class="nc" id="L1390">      option.setAttribute(XML_ATTR_PROPERTY_NAME_NAME,</span>
<span class="nc" id="L1391">          techKey.substring(0, techKey.lastIndexOf(definitionValues.get(0)) - 1));</span>
<span class="nc" id="L1392">      option.setAttribute(XML_ATTR_PROPERTY_NAME_VALUE, definitionValues.get(1));</span>
<span class="nc" id="L1393">      final String playerName = definitionValues.get(0);</span>
<span class="nc" id="L1394">      List&lt;Element&gt; elementList = playerAttachOptions.get(playerName);</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">      if (elementList == null) {</span>
<span class="nc" id="L1396">        elementList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1397">        playerAttachOptions.put(playerName, elementList);</span>
      }
<span class="nc" id="L1399">      elementList.add(option);</span>
    }
<span class="nc bnc" id="L1401" title="All 2 branches missed.">    for (final Entry&lt;String, List&lt;Element&gt;&gt; optionElementList : playerAttachOptions.entrySet()) {</span>
<span class="nc" id="L1402">      final String playerName = optionElementList.getKey();</span>
<span class="nc" id="L1403">      final Element attachment = (Element) attachmentTemplate.cloneNode(false);</span>
<span class="nc" id="L1404">      attachment.setAttribute(XML_ATTR_ATTACHMENT_NAME_ATTACH_TO, playerName);</span>
<span class="nc" id="L1405">      attachmentList.appendChild(attachment);</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">      for (final Element option : optionElementList.getValue()) {</span>
<span class="nc" id="L1407">        attachment.appendChild(option);</span>
      }
    }
<span class="nc" id="L1410">  }</span>

<span class="nc" id="L1412">  public final static String playerNeutral = &quot;&lt;Neutral&gt;&quot;;</span>

  public static String[] getPlayersListInclNeutral() {
<span class="nc" id="L1415">    getPlayerNames().add(playerNeutral);</span>
<span class="nc" id="L1416">    final String[] rVal = getPlayerNames().toArray(new String[getPlayerNames().size()]);</span>
<span class="nc" id="L1417">    getPlayerNames().remove(playerNeutral);</span>
<span class="nc" id="L1418">    return rVal;</span>
  }

  public static void filterForWaterTerrsWithAtLeastOneWaterNeighbor(final Set&lt;String&gt; waterTerrs2) {
<span class="nc" id="L1422">    final Set&lt;String&gt; waterTerrs2Copy = new TreeSet&lt;&gt;(waterTerrs2);</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">    for (final Iterator&lt;String&gt; iter_waterTerr2 = waterTerrs2.iterator(); iter_waterTerr2.hasNext();) {</span>
<span class="nc" id="L1424">      final String waterTerr2 = iter_waterTerr2.next();</span>
<span class="nc" id="L1425">      waterTerrs2Copy.remove(waterTerr2);</span>
<span class="nc" id="L1426">      final Set&lt;String&gt; waterTerrs2ReqNeighbors = new TreeSet&lt;&gt;(waterTerrs2Copy);</span>
<span class="nc" id="L1427">      final Set&lt;String&gt; waterTerr2Neightbors = getTerritoryConnectionsMap().get(waterTerr2);</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">      if (waterTerr2Neightbors != null) {</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">        for (final String waterTerr2Neighbor : waterTerr2Neightbors) {</span>
<span class="nc" id="L1430">          waterTerrs2ReqNeighbors.remove(waterTerr2Neighbor);</span>
        }
      }
<span class="nc bnc" id="L1433" title="All 2 branches missed.">      if (!waterTerrs2ReqNeighbors.isEmpty()) {</span>
<span class="nc" id="L1434">        iter_waterTerr2.remove();</span>
      }
    }
<span class="nc" id="L1437">  }</span>

  public static void validateAndAddCanalDefinition(final String landTerr, final Set&lt;String&gt; waterTerrs,
      final Set&lt;String&gt; landTerrNeighbors, final Entry&lt;String, Set&lt;String&gt;&gt; landWaterTerrConn2) {
<span class="nc" id="L1441">    final String landTerr2 = landWaterTerrConn2.getKey();</span>

<span class="nc" id="L1443">    Set&lt;String&gt; landTerrNeighbors2 = getTerritoryConnectionsMap().get(landTerr2);</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">    if (landTerrNeighbors2 == null) {</span>
<span class="nc" id="L1445">      landTerrNeighbors2 = Sets.newLinkedHashSet();</span>
    }

<span class="nc bnc" id="L1448" title="All 4 branches missed.">    if (!landTerrNeighbors.contains(landTerr2) &amp;&amp; !landTerrNeighbors2.contains(landTerr)) {</span>
<span class="nc" id="L1449">      return;</span>
    }
<span class="nc" id="L1451">    final Set&lt;String&gt; waterTerrs2 = new TreeSet&lt;&gt;(landWaterTerrConn2.getValue());</span>
<span class="nc" id="L1452">    waterTerrs2.retainAll(waterTerrs);</span>
<span class="nc bnc" id="L1453" title="All 2 branches missed.">    if (waterTerrs2.size() &gt; 1) {</span>
<span class="nc" id="L1454">      filterForWaterTerrsWithAtLeastOneWaterNeighbor(waterTerrs2);</span>
      // create canal only if at least 2 water territories remain
<span class="nc bnc" id="L1456" title="All 2 branches missed.">      if (waterTerrs2.size() &gt; 1) {</span>
<span class="nc" id="L1457">        final Set&lt;String&gt; newLandSet = new TreeSet&lt;&gt;();</span>
<span class="nc" id="L1458">        newLandSet.add(landTerr);</span>
<span class="nc" id="L1459">        newLandSet.add(landTerr2);</span>
<span class="nc" id="L1460">        final CanalTerritoriesTuple terrTuple =</span>
<span class="nc" id="L1461">            new CanalTerritoriesTuple(new TreeSet&lt;&gt;(waterTerrs2), newLandSet);</span>
<span class="nc" id="L1462">        putCanalDefinitions(&quot;Canal&quot; + getCanalDefinitionsMap().size(), terrTuple);</span>
      }
    }
<span class="nc" id="L1465">  }</span>

  public static void validateAndAddCanalDefinitions(final Map&lt;String, Set&lt;String&gt;&gt; landWaterTerritoyConnections) {
<span class="nc" id="L1468">    final Map&lt;String, Set&lt;String&gt;&gt; landWaterTerrConnChecks =</span>
<span class="nc" id="L1469">        Maps.newHashMap(landWaterTerritoyConnections);</span>
<span class="nc bnc" id="L1470" title="All 2 branches missed.">    for (final Entry&lt;String, Set&lt;String&gt;&gt; landWaterTerrConn : landWaterTerritoyConnections.entrySet()) {</span>
<span class="nc" id="L1471">      final String landTerr = landWaterTerrConn.getKey();</span>
<span class="nc" id="L1472">      final Set&lt;String&gt; waterTerrs = landWaterTerrConn.getValue();</span>
<span class="nc" id="L1473">      Set&lt;String&gt; landTerrNeighbors = getTerritoryConnectionsMap().get(landTerr);</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">      if (landTerrNeighbors == null) {</span>
<span class="nc" id="L1475">        landTerrNeighbors = Sets.newLinkedHashSet();</span>
      }
<span class="nc" id="L1477">      landWaterTerrConnChecks.remove(landTerr);</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">      for (final Entry&lt;String, Set&lt;String&gt;&gt; landWaterTerrConn2 : landWaterTerrConnChecks.entrySet()) {</span>
<span class="nc" id="L1479">        validateAndAddCanalDefinition(landTerr, waterTerrs, landTerrNeighbors, landWaterTerrConn2);</span>
      }
    }
<span class="nc" id="L1482">  }</span>

  /**
   * @return HTML string listing the canal definitions in the following format:
   *         ' - &lt;canal name&gt;: &lt;water territory 1&gt;-&lt;water territory 2&gt;- ...'
   */
  public static String getHtmlStringFromCanalDefinitions() {
<span class="nc" id="L1489">    final StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L1490">    sb.append(&quot;&lt;html&gt;The following &quot;).append(getCanalDefinitionsMap().size()).append(&quot; canals have been build:&quot;);</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">    for (final Entry&lt;String, CanalTerritoriesTuple&gt; canalDef : getCanalDefinitionsMap()</span>
<span class="nc" id="L1492">        .entrySet()) {</span>
<span class="nc" id="L1493">      sb.append(CanalDefinitionsPanel.HTML_CANAL_KEY_PREFIX).append(canalDef.getKey())</span>
<span class="nc" id="L1494">          .append(CanalDefinitionsPanel.HTML_CANAL_KEY_POSTFIX);</span>
<span class="nc" id="L1495">      sb.append(Joiner.on(&quot;-&quot;).join(canalDef.getValue().getWaterTerritories().iterator()));</span>
    }
<span class="nc" id="L1497">    sb.append(&quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L1498">    return sb.toString();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>test (25/nov/2016 10:16:58)</div></body></html>