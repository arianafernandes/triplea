<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>HeadlessGameServer.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (25/nov/2016 10:16:58)</a> &gt; <a href="../../index.html" class="el_group">triplea</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">games.strategy.engine.framework.headlessGameServer</a> &gt; <span class="el_source">HeadlessGameServer.java</span></div><h1>HeadlessGameServer.java</h1><pre class="source lang-java linenums">package games.strategy.engine.framework.headlessGameServer;

import java.io.File;
import java.io.InputStream;
import java.io.PrintStream;
import java.util.Date;
import java.util.HashSet;
import java.util.Set;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.logging.Logger;

import games.strategy.debug.ClientLogger;
import games.strategy.debug.DebugUtils;
import games.strategy.engine.ClientContext;
import games.strategy.engine.chat.Chat;
import games.strategy.engine.chat.IChatPanel;
import games.strategy.engine.data.GameData;
import games.strategy.engine.data.properties.GameProperties;
import games.strategy.engine.framework.GameRunner;
import games.strategy.engine.framework.ServerGame;
import games.strategy.engine.framework.startup.launcher.ILauncher;
import games.strategy.engine.framework.startup.mc.GameSelectorModel;
import games.strategy.engine.framework.startup.mc.ServerModel;
import games.strategy.engine.framework.startup.mc.SetupPanelModel;
import games.strategy.engine.framework.startup.ui.ClientSetupPanel;
import games.strategy.engine.framework.startup.ui.ISetupPanel;
import games.strategy.engine.framework.startup.ui.ServerSetupPanel;
import games.strategy.engine.framework.ui.SaveGameFileChooser;
import games.strategy.engine.lobby.server.LobbyServer;
import games.strategy.net.INode;
import games.strategy.net.IServerMessenger;
import games.strategy.sound.ClipPlayer;
import games.strategy.triplea.Constants;
import games.strategy.util.MD5Crypt;
import games.strategy.util.ThreadUtil;
import games.strategy.util.TimeManager;

/**
 * A way of hosting a game, but headless.
 */
public class HeadlessGameServer {

<span class="fc" id="L45">  final static Logger s_logger = Logger.getLogger(HeadlessGameServer.class.getName());</span>
<span class="fc" id="L46">  static HeadlessGameServerConsole s_console = null;</span>
<span class="fc" id="L47">  private static HeadlessGameServer s_instance = null;</span>
  private final AvailableGames m_availableGames;
  private final GameSelectorModel m_gameSelectorModel;
<span class="nc" id="L50">  private SetupPanelModel m_setupPanelModel = null;</span>
<span class="nc" id="L51">  private final ScheduledExecutorService m_lobbyWatcherResetupThread = Executors.newScheduledThreadPool(1);</span>
<span class="nc" id="L52">  private ServerGame m_iGame = null;</span>
<span class="nc" id="L53">  private boolean m_shutDown = false;</span>
<span class="nc" id="L54">  private final String m_startDate = TimeManager.getGMTString(new Date());</span>

  public static synchronized HeadlessGameServer getInstance() {
<span class="fc" id="L57">    return s_instance;</span>
  }

  public static synchronized boolean headless() {
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">    if (getInstance() != null) {</span>
<span class="nc" id="L62">      return true;</span>
    }
<span class="fc" id="L64">    return Boolean.parseBoolean(System.getProperty(GameRunner.TRIPLEA_HEADLESS, &quot;false&quot;));</span>
  }

  public Set&lt;String&gt; getAvailableGames() {
<span class="nc" id="L68">    return new HashSet&lt;&gt;(m_availableGames.getGameNames());</span>
  }

  public synchronized void setGameMapTo(final String gameName) {
    // don't change mid-game
<span class="nc bnc" id="L73" title="All 4 branches missed.">    if (m_setupPanelModel.getPanel() != null &amp;&amp; m_iGame == null) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">      if (!m_availableGames.getGameNames().contains(gameName)) {</span>
<span class="nc" id="L75">        return;</span>
      }
<span class="nc" id="L77">      m_gameSelectorModel.load(m_availableGames.getGameData(gameName), m_availableGames.getGameFilePath(gameName));</span>
<span class="nc" id="L78">      System.out.println(&quot;Changed to game map: &quot; + gameName);</span>
    }
<span class="nc" id="L80">  }</span>

  public synchronized void loadGameSave(final File file) {
    // don't change mid-game
<span class="nc bnc" id="L84" title="All 4 branches missed.">    if (m_setupPanelModel.getPanel() != null &amp;&amp; m_iGame == null) {</span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">      if (file == null || !file.exists()) {</span>
<span class="nc" id="L86">        return;</span>
      }
<span class="nc" id="L88">      m_gameSelectorModel.load(file, null);</span>
<span class="nc" id="L89">      System.out.println(&quot;Changed to save: &quot; + file.getName());</span>
    }
<span class="nc" id="L91">  }</span>

  public synchronized void loadGameSave(final InputStream input, final String fileName) {
    // don't change mid-game
<span class="nc bnc" id="L95" title="All 4 branches missed.">    if (m_setupPanelModel.getPanel() != null &amp;&amp; m_iGame == null) {</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">      if (input == null || fileName == null) {</span>
<span class="nc" id="L97">        return;</span>
      }
<span class="nc" id="L99">      final GameData data = m_gameSelectorModel.getGameData(input);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">      if (data == null) {</span>
<span class="nc" id="L101">        System.out.println(&quot;Loading GameData failed for: &quot; + fileName);</span>
<span class="nc" id="L102">        return;</span>
      }
<span class="nc" id="L104">      final String mapNameProperty = data.getProperties().get(Constants.MAP_NAME, &quot;&quot;);</span>
<span class="nc" id="L105">      Set&lt;String&gt; availableMaps = m_availableGames.getAvailableMapFolderOrZipNames();</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">      if (!availableMaps.contains(mapNameProperty) &amp;&amp; !availableMaps.contains(mapNameProperty + &quot;-master&quot;)) {</span>
<span class="nc" id="L107">        System.out.println(&quot;Game mapName not in available games listing: &quot; + mapNameProperty);</span>
<span class="nc" id="L108">        return;</span>
      }
<span class="nc" id="L110">      m_gameSelectorModel.load(data, fileName);</span>
<span class="nc" id="L111">      System.out.println(&quot;Changed to user savegame: &quot; + fileName);</span>
    }
<span class="nc" id="L113">  }</span>

  public synchronized void loadGameOptions(final byte[] bytes) {
    // don't change mid-game
<span class="nc bnc" id="L117" title="All 4 branches missed.">    if (m_setupPanelModel.getPanel() != null &amp;&amp; m_iGame == null) {</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">      if (bytes == null || bytes.length == 0) {</span>
<span class="nc" id="L119">        return;</span>
      }
<span class="nc" id="L121">      final GameData data = m_gameSelectorModel.getGameData();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">      if (data == null) {</span>
<span class="nc" id="L123">        return;</span>
      }
<span class="nc" id="L125">      final GameProperties props = data.getProperties();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">      if (props == null) {</span>
<span class="nc" id="L127">        return;</span>
      }
<span class="nc" id="L129">      GameProperties.applyByteMapToChangeProperties(bytes, props);</span>
<span class="nc" id="L130">      System.out.println(&quot;Changed to user game options.&quot;);</span>
    }
<span class="nc" id="L132">  }</span>

  public static synchronized void setServerGame(final ServerGame serverGame) {
<span class="nc" id="L135">    final HeadlessGameServer instance = getInstance();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">    if (instance != null) {</span>
<span class="nc" id="L137">      instance.m_iGame = serverGame;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">      if (serverGame != null) {</span>
<span class="nc" id="L139">        System.out.println(&quot;Game starting up: &quot; + instance.m_iGame.isGameSequenceRunning() + &quot;, GameOver: &quot;</span>
<span class="nc" id="L140">            + instance.m_iGame.isGameOver() + &quot;, Players: &quot; + instance.m_iGame.getPlayerManager().toString());</span>
      }
    }
<span class="nc" id="L143">  }</span>

  public static synchronized void log(final String stdout) {
<span class="nc" id="L146">    final HeadlessGameServer instance = getInstance();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">    if (instance != null) {</span>
<span class="nc" id="L148">      System.out.println(stdout);</span>
    }
<span class="nc" id="L150">  }</span>

  public static synchronized void sendChat(final String chatString) {
<span class="nc" id="L153">    final HeadlessGameServer instance = getInstance();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">    if (instance != null) {</span>
<span class="nc" id="L155">      final Chat chat = instance.getChat();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">      if (chat != null) {</span>
        try {
<span class="nc" id="L158">          chat.sendMessage(chatString, false);</span>
<span class="nc" id="L159">        } catch (final Exception e) {</span>
<span class="nc" id="L160">          ClientLogger.logQuietly(e);</span>
        }
      }
    }
<span class="nc" id="L164">  }</span>

  public String getSalt() {
<span class="nc" id="L167">    final String encryptedPassword = MD5Crypt.crypt(System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;));</span>
<span class="nc" id="L168">    final String salt = MD5Crypt.getSalt(MD5Crypt.MAGIC, encryptedPassword);</span>
<span class="nc" id="L169">    return salt;</span>
  }

  public String remoteShutdown(final String hashedPassword, final String salt) {
<span class="nc" id="L173">    final String password = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">    if (password.equals(GameRunner.NO_REMOTE_REQUESTS_ALLOWED)) {</span>
<span class="nc" id="L175">      return &quot;Host not accepting remote requests!&quot;;</span>
    }
<span class="nc" id="L177">    final String localPassword = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L178">    final String encryptedPassword = MD5Crypt.crypt(localPassword, salt);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">    if (encryptedPassword.equals(hashedPassword)) {</span>
<span class="nc" id="L180">      (new Thread(() -&gt; {</span>
<span class="nc" id="L181">        System.out.println(&quot;Remote Shutdown Initiated.&quot;);</span>
<span class="nc" id="L182">        ThreadUtil.sleep(1000);</span>
<span class="nc" id="L183">        System.exit(0);</span>
<span class="nc" id="L184">      })).start();</span>
<span class="nc" id="L185">      return null;</span>
    }
<span class="nc" id="L187">    System.out.println(&quot;Attempted remote shutdown with invalid password.&quot;);</span>
<span class="nc" id="L188">    return &quot;Invalid password!&quot;;</span>
  }

  public String remoteStopGame(final String hashedPassword, final String salt) {
<span class="nc" id="L192">    final String password = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">    if (password.equals(GameRunner.NO_REMOTE_REQUESTS_ALLOWED)) {</span>
<span class="nc" id="L194">      return &quot;Host not accepting remote requests!&quot;;</span>
    }
<span class="nc" id="L196">    final String localPassword = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L197">    final String encryptedPassword = MD5Crypt.crypt(localPassword, salt);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (encryptedPassword.equals(hashedPassword)) {</span>
<span class="nc" id="L199">      final ServerGame iGame = m_iGame;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">      if (iGame != null) {</span>
<span class="nc" id="L201">        (new Thread(() -&gt; {</span>
<span class="nc" id="L202">          System.out.println(&quot;Remote Stop Game Initiated.&quot;);</span>
<span class="nc" id="L203">          SaveGameFileChooser.ensureMapsFolderExists();</span>
<span class="nc" id="L204">          final File f1 =</span>
<span class="nc" id="L205">              new File(ClientContext.folderSettings().getSaveGamePath(), SaveGameFileChooser.getAutoSaveFileName());</span>
<span class="nc" id="L206">          final File f2 =</span>
<span class="nc" id="L207">              new File(ClientContext.folderSettings().getSaveGamePath(), SaveGameFileChooser.getAutoSave2FileName());</span>
          final File f;
<span class="nc bnc" id="L209" title="All 2 branches missed.">          if (f1.lastModified() &gt; f2.lastModified()) {</span>
<span class="nc" id="L210">            f = f2;</span>
<span class="nc" id="L211">          } else {</span>
<span class="nc" id="L212">            f = f1;</span>
          }
          try {
<span class="nc" id="L215">            iGame.saveGame(f);</span>
<span class="nc" id="L216">          } catch (final Exception e) {</span>
<span class="nc" id="L217">            ClientLogger.logQuietly(e);</span>
          }
<span class="nc" id="L219">          iGame.stopGame();</span>
<span class="nc" id="L220">        })).start();</span>
      }
<span class="nc" id="L222">      return null;</span>
    }
<span class="nc" id="L224">    System.out.println(&quot;Attempted remote stop game with invalid password.&quot;);</span>
<span class="nc" id="L225">    return &quot;Invalid password!&quot;;</span>
  }

  public String remoteGetChatLog(final String hashedPassword, final String salt) {
<span class="nc" id="L229">    final String password = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">    if (password.equals(GameRunner.NO_REMOTE_REQUESTS_ALLOWED)) {</span>
<span class="nc" id="L231">      return &quot;Host not accepting remote requests!&quot;;</span>
    }
<span class="nc" id="L233">    final String localPassword = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L234">    final String encryptedPassword = MD5Crypt.crypt(localPassword, salt);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">    if (encryptedPassword.equals(hashedPassword)) {</span>
<span class="nc" id="L236">      final IChatPanel chat = getServerModel().getChatPanel();</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">      if (chat == null || chat.getAllText() == null) {</span>
<span class="nc" id="L238">        return &quot;Empty or null chat&quot;;</span>
      }
<span class="nc" id="L240">      return chat.getAllText();</span>
    }
<span class="nc" id="L242">    System.out.println(&quot;Attempted remote get chat log with invalid password.&quot;);</span>
<span class="nc" id="L243">    return &quot;Invalid password!&quot;;</span>
  }

  public String remoteMutePlayer(final String playerName, final int minutes, final String hashedPassword,
      final String salt) {
<span class="nc" id="L248">    final String password = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">    if (password.equals(GameRunner.NO_REMOTE_REQUESTS_ALLOWED)) {</span>
<span class="nc" id="L250">      return &quot;Host not accepting remote requests!&quot;;</span>
    }
<span class="nc" id="L252">    final String localPassword = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L253">    final String encryptedPassword = MD5Crypt.crypt(localPassword, salt);</span>
    // milliseconds (48 hours max)
<span class="nc" id="L255">    final long expire = System.currentTimeMillis() + (Math.max(0, Math.min(60 * 24 * 2, minutes)) * 1000 * 60);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">    if (encryptedPassword.equals(hashedPassword)) {</span>
<span class="nc" id="L257">      (new Thread(() -&gt; {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (getServerModel() == null) {</span>
<span class="nc" id="L259">          return;</span>
        }
<span class="nc" id="L261">        final IServerMessenger messenger = getServerModel().getMessenger();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (messenger == null) {</span>
<span class="nc" id="L263">          return;</span>
        }
<span class="nc" id="L265">        final Set&lt;INode&gt; nodes = messenger.getNodes();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (nodes == null) {</span>
<span class="nc" id="L267">          return;</span>
        }
        try {
<span class="nc bnc" id="L270" title="All 2 branches missed.">          for (final INode node : nodes) {</span>
<span class="nc" id="L271">            final String realName = node.getName().split(&quot; &quot;)[0];</span>
<span class="nc" id="L272">            final String ip = node.getAddress().getHostAddress();</span>
<span class="nc" id="L273">            final String mac = messenger.getPlayerMac(node.getName());</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (realName.equals(playerName)) {</span>
<span class="nc" id="L275">              System.out.println(&quot;Remote Mute of Player: &quot; + playerName);</span>
<span class="nc" id="L276">              messenger.NotifyUsernameMutingOfPlayer(realName, new Date(expire));</span>
<span class="nc" id="L277">              messenger.NotifyIPMutingOfPlayer(ip, new Date(expire));</span>
<span class="nc" id="L278">              messenger.NotifyMacMutingOfPlayer(mac, new Date(expire));</span>
<span class="nc" id="L279">              return;</span>
            }
          }
<span class="nc" id="L282">        } catch (final Exception e) {</span>
<span class="nc" id="L283">          ClientLogger.logQuietly(e);</span>
        }
<span class="nc" id="L285">      })).start();</span>
<span class="nc" id="L286">      return null;</span>
    }
<span class="nc" id="L288">    System.out.println(&quot;Attempted remote mute player with invalid password.&quot;);</span>
<span class="nc" id="L289">    return &quot;Invalid password!&quot;;</span>
  }

  public String remoteBootPlayer(final String playerName, final String hashedPassword, final String salt) {
<span class="nc" id="L293">    final String password = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">    if (password.equals(GameRunner.NO_REMOTE_REQUESTS_ALLOWED)) {</span>
<span class="nc" id="L295">      return &quot;Host not accepting remote requests!&quot;;</span>
    }
<span class="nc" id="L297">    final String localPassword = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L298">    final String encryptedPassword = MD5Crypt.crypt(localPassword, salt);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">    if (encryptedPassword.equals(hashedPassword)) {</span>
<span class="nc" id="L300">      (new Thread(() -&gt; {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (getServerModel() == null) {</span>
<span class="nc" id="L302">          return;</span>
        }
<span class="nc" id="L304">        final IServerMessenger messenger = getServerModel().getMessenger();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (messenger == null) {</span>
<span class="nc" id="L306">          return;</span>
        }
<span class="nc" id="L308">        final Set&lt;INode&gt; nodes = messenger.getNodes();</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (nodes == null) {</span>
<span class="nc" id="L310">          return;</span>
        }
        try {
<span class="nc bnc" id="L313" title="All 2 branches missed.">          for (final INode node : nodes) {</span>
<span class="nc" id="L314">            final String realName = node.getName().split(&quot; &quot;)[0];</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (realName.equals(playerName)) {</span>
<span class="nc" id="L316">              System.out.println(&quot;Remote Boot of Player: &quot; + playerName);</span>
<span class="nc" id="L317">              messenger.removeConnection(node);</span>
            }
          }
<span class="nc" id="L320">        } catch (final Exception e) {</span>
<span class="nc" id="L321">          ClientLogger.logQuietly(e);</span>
        }
<span class="nc" id="L323">      })).start();</span>
<span class="nc" id="L324">      return null;</span>
    }
<span class="nc" id="L326">    System.out.println(&quot;Attempted remote boot player with invalid password.&quot;);</span>
<span class="nc" id="L327">    return &quot;Invalid password!&quot;;</span>
  }

  public String remoteBanPlayer(final String playerName, final int hours, final String hashedPassword,
      final String salt) {
<span class="nc" id="L332">    final String password = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">    if (password.equals(GameRunner.NO_REMOTE_REQUESTS_ALLOWED)) {</span>
<span class="nc" id="L334">      return &quot;Host not accepting remote requests!&quot;;</span>
    }
<span class="nc" id="L336">    final String localPassword = System.getProperty(GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L337">    final String encryptedPassword = MD5Crypt.crypt(localPassword, salt);</span>
    // milliseconds (30 days max)
<span class="nc" id="L339">    final long expire = System.currentTimeMillis() + (Math.max(0, Math.min(24 * 30, hours)) * 1000 * 60 * 60);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">    if (encryptedPassword.equals(hashedPassword)) {</span>
<span class="nc" id="L341">      (new Thread(() -&gt; {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (getServerModel() == null) {</span>
<span class="nc" id="L343">          return;</span>
        }
<span class="nc" id="L345">        final IServerMessenger messenger = getServerModel().getMessenger();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        if (messenger == null) {</span>
<span class="nc" id="L347">          return;</span>
        }
<span class="nc" id="L349">        final Set&lt;INode&gt; nodes = messenger.getNodes();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (nodes == null) {</span>
<span class="nc" id="L351">          return;</span>
        }
        try {
<span class="nc bnc" id="L354" title="All 2 branches missed.">          for (final INode node : nodes) {</span>
<span class="nc" id="L355">            final String realName = node.getName().split(&quot; &quot;)[0];</span>
<span class="nc" id="L356">            final String ip = node.getAddress().getHostAddress();</span>
<span class="nc" id="L357">            final String mac = messenger.getPlayerMac(node.getName());</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (realName.equals(playerName)) {</span>
<span class="nc" id="L359">              System.out.println(&quot;Remote Ban of Player: &quot; + playerName);</span>
              try {
<span class="nc" id="L361">                messenger.NotifyUsernameMiniBanningOfPlayer(realName, new Date(expire));</span>
<span class="nc" id="L362">              } catch (final Exception e) {</span>
<span class="nc" id="L363">                ClientLogger.logQuietly(e);</span>
              }
              try {
<span class="nc" id="L366">                messenger.NotifyIPMiniBanningOfPlayer(ip, new Date(expire));</span>
<span class="nc" id="L367">              } catch (final Exception e) {</span>
<span class="nc" id="L368">                ClientLogger.logQuietly(e);</span>
              }
              try {
<span class="nc" id="L371">                messenger.NotifyMacMiniBanningOfPlayer(mac, new Date(expire));</span>
<span class="nc" id="L372">              } catch (final Exception e) {</span>
<span class="nc" id="L373">                ClientLogger.logQuietly(e);</span>
              }
<span class="nc" id="L375">              messenger.removeConnection(node);</span>
            }
          }
<span class="nc" id="L378">        } catch (final Exception e) {</span>
<span class="nc" id="L379">          ClientLogger.logQuietly(e);</span>
        }
<span class="nc" id="L381">      })).start();</span>
<span class="nc" id="L382">      return null;</span>
    }
<span class="nc" id="L384">    System.out.println(&quot;Attempted remote ban player with invalid password.&quot;);</span>
<span class="nc" id="L385">    return &quot;Invalid password!&quot;;</span>
  }

  ServerGame getIGame() {
<span class="nc" id="L389">    return m_iGame;</span>
  }

  public boolean isShutDown() {
<span class="nc" id="L393">    return m_shutDown;</span>
  }

  public HeadlessGameServer() {
<span class="nc" id="L397">    super();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">    if (s_instance != null) {</span>
<span class="nc" id="L399">      throw new IllegalStateException(&quot;Instance already exists&quot;);</span>
    }
<span class="nc" id="L401">    s_instance = this;</span>
<span class="nc" id="L402">    Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {</span>
<span class="nc" id="L403">      System.out.println(&quot;Running ShutdownHook.&quot;);</span>
<span class="nc" id="L404">      shutdown();</span>
<span class="nc" id="L405">    }));</span>
<span class="nc" id="L406">    m_availableGames = new AvailableGames();</span>
<span class="nc" id="L407">    m_gameSelectorModel = new GameSelectorModel();</span>
<span class="nc" id="L408">    final String fileName = System.getProperty(GameRunner.TRIPLEA_GAME_PROPERTY, &quot;&quot;);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">    if (fileName.length() &gt; 0) {</span>
      try {
<span class="nc" id="L411">        final File file = new File(fileName);</span>
<span class="nc" id="L412">        m_gameSelectorModel.load(file, null);</span>
<span class="nc" id="L413">      } catch (final Exception e) {</span>
<span class="nc" id="L414">        m_gameSelectorModel.resetGameDataToNull();</span>
      }
    }
<span class="nc" id="L417">    final Runnable r = () -&gt; {</span>
<span class="nc" id="L418">      System.out.println(&quot;Headless Start&quot;);</span>
<span class="nc" id="L419">      m_setupPanelModel = new HeadlessServerSetupPanelModel(m_gameSelectorModel, null);</span>
<span class="nc" id="L420">      m_setupPanelModel.showSelectType();</span>
<span class="nc" id="L421">      System.out.println(&quot;Waiting for users to connect.&quot;);</span>
<span class="nc" id="L422">      waitForUsersHeadless();</span>
<span class="nc" id="L423">    };</span>
<span class="nc" id="L424">    final Thread t = new Thread(r, &quot;Initialize Headless Server Setup Model&quot;);</span>
<span class="nc" id="L425">    t.start();</span>

    int reconnect;
    try {
<span class="nc" id="L429">      final String reconnectionSeconds =</span>
<span class="nc" id="L430">          System.getProperty(GameRunner.LOBBY_GAME_RECONNECTION, &quot;&quot; + GameRunner.LOBBY_RECONNECTION_REFRESH_SECONDS_DEFAULT);</span>
<span class="nc" id="L431">      reconnect = Math.max(Integer.parseInt(reconnectionSeconds), GameRunner.LOBBY_RECONNECTION_REFRESH_SECONDS_MINIMUM);</span>
<span class="nc" id="L432">    } catch (final NumberFormatException e) {</span>
<span class="nc" id="L433">      reconnect = GameRunner.LOBBY_RECONNECTION_REFRESH_SECONDS_DEFAULT;</span>
    }
<span class="nc" id="L435">    m_lobbyWatcherResetupThread.scheduleAtFixedRate(() -&gt; {</span>
      try {
<span class="nc" id="L437">        restartLobbyWatcher(m_setupPanelModel, m_iGame);</span>
<span class="nc" id="L438">      } catch (final Exception e) {</span>
<span class="nc" id="L439">        ThreadUtil.sleep(10 * 60 * 1000);</span>
        // try again, but don't catch it this time
<span class="nc" id="L441">        restartLobbyWatcher(m_setupPanelModel, m_iGame);</span>
      }
<span class="nc" id="L443">    }, reconnect, reconnect, TimeUnit.SECONDS);</span>
<span class="nc" id="L444">    s_logger.info(&quot;Game Server initialized&quot;);</span>
<span class="nc" id="L445">  }</span>

  private static synchronized void restartLobbyWatcher(final SetupPanelModel setupPanelModel, final ServerGame iGame) {
    try {
<span class="nc" id="L449">      final ISetupPanel setup = setupPanelModel.getPanel();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">      if (setup == null) {</span>
<span class="nc" id="L451">        return;</span>
      }
<span class="nc bnc" id="L453" title="All 2 branches missed.">      if (iGame != null) {</span>
<span class="nc" id="L454">        return;</span>
      }
<span class="nc bnc" id="L456" title="All 2 branches missed.">      if (setup.canGameStart()) {</span>
<span class="nc" id="L457">        return;</span>
      }
<span class="nc bnc" id="L459" title="All 2 branches missed.">      if (setup instanceof ServerSetupPanel) {</span>
<span class="nc" id="L460">        ((ServerSetupPanel) setup).repostLobbyWatcher(iGame);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">      } else if (setup instanceof HeadlessServerSetup) {</span>
<span class="nc" id="L462">        ((HeadlessServerSetup) setup).repostLobbyWatcher(iGame);</span>
      }
<span class="nc" id="L464">    } catch (final Exception e) {</span>
<span class="nc" id="L465">      ClientLogger.logQuietly(e);</span>
    }
<span class="nc" id="L467">  }</span>

  public static void resetLobbyHostOldExtensionProperties() {
<span class="nc bnc" id="L470" title="All 2 branches missed.">    for (final String property : getProperties()) {</span>
<span class="nc bnc" id="L471" title="All 4 branches missed.">      if (GameRunner.LOBBY_HOST.equals(property) || LobbyServer.TRIPLEA_LOBBY_PORT_PROPERTY.equals(property)</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">          || GameRunner.LOBBY_GAME_HOSTED_BY.equals(property)) {</span>
        // for these 3 properties, we clear them after hosting, but back them up.
<span class="nc" id="L474">        final String oldValue = System.getProperty(property + GameRunner.OLD_EXTENSION);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">        if (oldValue != null) {</span>
<span class="nc" id="L476">          System.setProperty(property, oldValue);</span>
        }
      }
    }
<span class="nc" id="L480">  }</span>

  public static String[] getProperties() {
<span class="nc" id="L483">    return new String[] {GameRunner.TRIPLEA_GAME_PROPERTY, GameRunner.TRIPLEA_GAME_HOST_CONSOLE_PROPERTY,</span>
<span class="nc" id="L484">        GameRunner.TRIPLEA_SERVER_PROPERTY, GameRunner.TRIPLEA_PORT_PROPERTY,</span>
<span class="nc" id="L485">        GameRunner.TRIPLEA_NAME_PROPERTY, GameRunner.LOBBY_HOST, LobbyServer.TRIPLEA_LOBBY_PORT_PROPERTY,</span>
<span class="nc" id="L486">        GameRunner.LOBBY_GAME_COMMENTS, GameRunner.LOBBY_GAME_HOSTED_BY, GameRunner.LOBBY_GAME_SUPPORT_EMAIL,</span>
<span class="nc" id="L487">        GameRunner.LOBBY_GAME_SUPPORT_PASSWORD, GameRunner.LOBBY_GAME_RECONNECTION,</span>
<span class="nc" id="L488">        GameRunner.TRIPLEA_SERVER_START_GAME_SYNC_WAIT_TIME, GameRunner.TRIPLEA_SERVER_OBSERVER_JOIN_WAIT_TIME,</span>
<span class="nc" id="L489">        GameRunner.MAP_FOLDER};</span>
  }

  public String getStatus() {
<span class="nc" id="L493">    String message = &quot;Server Start Date: &quot; + m_startDate;</span>
<span class="nc" id="L494">    final ServerGame game = getIGame();</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">    if (game != null) {</span>
<span class="nc" id="L496">      message += &quot;\nIs currently running: &quot; + game.isGameSequenceRunning() + &quot;\nIs GameOver: &quot; + game.isGameOver()</span>
<span class="nc" id="L497">          + &quot;\nGame: &quot; + game.getData().getGameName() + &quot;\nRound: &quot; + game.getData().getSequence().getRound()</span>
<span class="nc" id="L498">          + &quot;\nPlayers: &quot; + game.getPlayerManager().toString();</span>
<span class="nc" id="L499">    } else {</span>
<span class="nc" id="L500">      message += &quot;\nCurrently Waiting To Start A Game&quot;;</span>
    }
<span class="nc" id="L502">    return message;</span>
  }

  public void printThreadDumpsAndStatus() {
<span class="nc" id="L506">    final StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L507">    sb.append(&quot;Dump to Log:&quot;);</span>
<span class="nc" id="L508">    sb.append(&quot;\n\nStatus:\n&quot;);</span>
<span class="nc" id="L509">    sb.append(getStatus());</span>
<span class="nc" id="L510">    sb.append(&quot;\n\nServer:\n&quot;);</span>
<span class="nc" id="L511">    sb.append(getServerModel());</span>
<span class="nc" id="L512">    sb.append(&quot;\n\n&quot;);</span>
<span class="nc" id="L513">    sb.append(DebugUtils.getThreadDumps());</span>
<span class="nc" id="L514">    sb.append(&quot;\n\n&quot;);</span>
<span class="nc" id="L515">    sb.append(DebugUtils.getMemory());</span>
<span class="nc" id="L516">    sb.append(&quot;\n\nDump finished.\n&quot;);</span>
<span class="nc" id="L517">    System.out.println(sb.toString());</span>
<span class="nc" id="L518">  }</span>

  public synchronized void shutdown() {
<span class="nc" id="L521">    m_shutDown = true;</span>
<span class="nc" id="L522">    printThreadDumpsAndStatus();</span>
    try {
<span class="nc bnc" id="L524" title="All 2 branches missed.">      if (m_lobbyWatcherResetupThread != null) {</span>
<span class="nc" id="L525">        m_lobbyWatcherResetupThread.shutdown();</span>
      }
<span class="nc" id="L527">    } catch (final Exception e) {</span>
    }
    try {
<span class="nc bnc" id="L530" title="All 2 branches missed.">      if (m_iGame != null) {</span>
<span class="nc" id="L531">        m_iGame.stopGame();</span>
      }
<span class="nc" id="L533">    } catch (final Exception e) {</span>
    }
    try {
<span class="nc bnc" id="L536" title="All 2 branches missed.">      if (m_setupPanelModel != null) {</span>
<span class="nc" id="L537">        final ISetupPanel setup = m_setupPanelModel.getPanel();</span>
<span class="nc bnc" id="L538" title="All 4 branches missed.">        if (setup != null &amp;&amp; setup instanceof ServerSetupPanel) {</span>
          // this is causing a deadlock when in a shutdown hook, due to swing/awt
          // ((ServerSetupPanel) setup).shutDown();
<span class="nc bnc" id="L541" title="All 4 branches missed.">        } else if (setup != null &amp;&amp; setup instanceof HeadlessServerSetup) {</span>
<span class="nc" id="L542">          setup.shutDown();</span>
        }
      }
<span class="nc" id="L545">    } catch (final Exception e) {</span>
    }
    try {
<span class="nc bnc" id="L548" title="All 4 branches missed.">      if (m_gameSelectorModel != null &amp;&amp; m_gameSelectorModel.getGameData() != null) {</span>
<span class="nc" id="L549">        m_gameSelectorModel.getGameData().clearAllListeners();</span>
      }
<span class="nc" id="L551">    } catch (final Exception e) {</span>
    }
<span class="nc" id="L553">    s_instance = null;</span>
<span class="nc" id="L554">    m_setupPanelModel = null;</span>
<span class="nc" id="L555">    m_iGame = null;</span>
<span class="nc" id="L556">    System.out.println(&quot;Shutdown Script Finished.&quot;);</span>
<span class="nc" id="L557">  }</span>

  public void waitForUsersHeadless() {
<span class="nc" id="L560">    setServerGame(null);</span>

<span class="nc" id="L562">    final Runnable r = () -&gt; {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">      while (!m_shutDown) {</span>
<span class="nc" id="L564">        ThreadUtil.sleep(8000);</span>
<span class="nc bnc" id="L565" title="All 4 branches missed.">        if (m_setupPanelModel != null &amp;&amp; m_setupPanelModel.getPanel() != null</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">            &amp;&amp; m_setupPanelModel.getPanel().canGameStart()) {</span>
<span class="nc" id="L567">          final boolean started = startHeadlessGame(m_setupPanelModel);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">          if (!started) {</span>
<span class="nc" id="L569">            System.out.println(&quot;Error in launcher, going back to waiting.&quot;);</span>
          } else {
            // TODO: need a latch instead?
            break;
          }
        }
      }
<span class="nc" id="L576">    };</span>
<span class="nc" id="L577">    final Thread t = new Thread(r, &quot;Headless Server Waiting For Users To Connect And Start&quot;);</span>
<span class="nc" id="L578">    t.start();</span>
<span class="nc" id="L579">  }</span>

  private synchronized static boolean startHeadlessGame(final SetupPanelModel setupPanelModel) {
    try {
<span class="nc bnc" id="L583" title="All 6 branches missed.">      if (setupPanelModel != null &amp;&amp; setupPanelModel.getPanel() != null &amp;&amp; setupPanelModel.getPanel().canGameStart()) {</span>
<span class="nc" id="L584">        System.out.println(&quot;Starting Game: &quot; + setupPanelModel.getGameSelectorModel().getGameData().getGameName()</span>
<span class="nc" id="L585">            + &quot;, Round: &quot; + setupPanelModel.getGameSelectorModel().getGameData().getSequence().getRound());</span>
<span class="nc" id="L586">        setupPanelModel.getPanel().preStartGame();</span>
<span class="nc" id="L587">        final ILauncher launcher = setupPanelModel.getPanel().getLauncher();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (launcher != null) {</span>
<span class="nc" id="L589">          launcher.launch(null);</span>
        }
<span class="nc" id="L591">        setupPanelModel.getPanel().postStartGame();</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">        return launcher != null;</span>
      }
<span class="nc" id="L594">    } catch (final Exception e) {</span>
<span class="nc" id="L595">      ClientLogger.logQuietly(e);</span>
<span class="nc" id="L596">      final ServerModel model = getServerModel(setupPanelModel);</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">      if (model != null) {</span>
        // if we do not do this, we can get into an infinite loop of launching a game, then crashing out,
        // then launching, etc.
<span class="nc" id="L600">        model.setAllPlayersToNullNodes();</span>
      }
    }
<span class="nc" id="L603">    return false;</span>
  }

  public static void waitForUsersHeadlessInstance() {
<span class="nc" id="L607">    final HeadlessGameServer server = getInstance();</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">    if (server == null) {</span>
<span class="nc" id="L609">      System.err.println(&quot;Couldn't find instance.&quot;);</span>
<span class="nc" id="L610">      System.exit(-1);</span>
<span class="nc" id="L611">    } else {</span>
<span class="nc" id="L612">      System.out.println(&quot;Waiting for users to connect.&quot;);</span>
<span class="nc" id="L613">      server.waitForUsersHeadless();</span>
    }
<span class="nc" id="L615">  }</span>

  SetupPanelModel getSetupPanelModel() {
<span class="nc" id="L618">    return m_setupPanelModel;</span>
  }

  ServerModel getServerModel() {
<span class="nc" id="L622">    return getServerModel(m_setupPanelModel);</span>
  }

  static ServerModel getServerModel(final SetupPanelModel setupPanelModel) {
<span class="nc bnc" id="L626" title="All 2 branches missed.">    if (setupPanelModel == null) {</span>
<span class="nc" id="L627">      return null;</span>
    }
<span class="nc" id="L629">    final ISetupPanel setup = setupPanelModel.getPanel();</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">    if (setup == null) {</span>
<span class="nc" id="L631">      return null;</span>
    }
<span class="nc bnc" id="L633" title="All 2 branches missed.">    if (setup instanceof ServerSetupPanel) {</span>
<span class="nc" id="L634">      return ((ServerSetupPanel) setup).getModel();</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">    } else if (setup instanceof HeadlessServerSetup) {</span>
<span class="nc" id="L636">      return ((HeadlessServerSetup) setup).getModel();</span>
    }
<span class="nc" id="L638">    return null;</span>
  }

  /**
   * todo, replace with something better
   * Get the chat for the game, or null if there is no chat
   */
  public Chat getChat() {
<span class="nc" id="L646">    final ISetupPanel model = m_setupPanelModel.getPanel();</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">    if (model instanceof ServerSetupPanel) {</span>
<span class="nc" id="L648">      return model.getChatPanel().getChat();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">    } else if (model instanceof ClientSetupPanel) {</span>
<span class="nc" id="L650">      return model.getChatPanel().getChat();</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">    } else if (model instanceof HeadlessServerSetup) {</span>
<span class="nc" id="L652">      return model.getChatPanel().getChat();</span>
    } else {
<span class="nc" id="L654">      return null;</span>
    }
  }

  public static void main(final String[] args) {
<span class="nc" id="L659">    System.out.println(&quot;Headless AWT Test: &quot; + java.awt.GraphicsEnvironment.isHeadless());</span>
<span class="nc" id="L660">    handleCommandLineArgs(args);</span>
    // grab these before we override them with the loggers
<span class="nc" id="L662">    final InputStream in = System.in;</span>
<span class="nc" id="L663">    final PrintStream out = System.out;</span>
    // after handling the command lines, because we use the triplea.game.name= property in our log file name
<span class="nc" id="L665">    GameRunner.setupLogging(GameRunner.GameMode.HEADLESS_BOT);</span>
<span class="nc" id="L666">    ClipPlayer.setBeSilentInPreferencesWithoutAffectingCurrent(true);</span>
<span class="nc" id="L667">    HeadlessGameServer server = null;</span>
    try {
<span class="nc" id="L669">      server = new HeadlessGameServer();</span>
<span class="nc" id="L670">    } catch (final Exception e) {</span>
<span class="nc" id="L671">      ClientLogger.logQuietly(e);</span>
    }
<span class="nc bnc" id="L673" title="All 2 branches missed.">    if (Boolean.parseBoolean(System.getProperty(GameRunner.TRIPLEA_GAME_HOST_CONSOLE_PROPERTY, &quot;false&quot;))) {</span>
<span class="nc" id="L674">      startConsole(server, in, out);</span>
    }
<span class="nc" id="L676">  }</span>

  private static void startConsole(final HeadlessGameServer server, final InputStream in, final PrintStream out) {
<span class="nc" id="L679">    System.out.println(&quot;Starting console.&quot;);</span>
<span class="nc" id="L680">    s_console = new HeadlessGameServerConsole(server, in, out);</span>
<span class="nc" id="L681">    s_console.start();</span>
<span class="nc" id="L682">  }</span>


  /**
   * Move command line arguments to System.properties
   */
  private static void handleCommandLineArgs(final String[] args) {
<span class="nc" id="L689">    GameRunner.handleCommandLineArgs(args, getProperties(), GameRunner.GameMode.HEADLESS_BOT);</span>
<span class="nc" id="L690">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>test (25/nov/2016 10:16:58)</div></body></html>