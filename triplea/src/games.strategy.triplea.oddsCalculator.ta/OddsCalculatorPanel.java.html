<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>OddsCalculatorPanel.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (25/nov/2016 10:16:58)</a> &gt; <a href="../../index.html" class="el_group">triplea</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">games.strategy.triplea.oddsCalculator.ta</a> &gt; <span class="el_source">OddsCalculatorPanel.java</span></div><h1>OddsCalculatorPanel.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package games.strategy.triplea.oddsCalculator.ta;</span>

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Image;
import java.awt.Insets;
import java.awt.Window;
import java.awt.event.ActionEvent;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionListener;
import java.awt.event.WindowEvent;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.Vector;
import java.util.concurrent.atomic.AtomicReference;

import javax.swing.AbstractAction;
import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.DefaultListCellRenderer;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextField;
import javax.swing.ListSelectionModel;
import javax.swing.SwingUtilities;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;

import games.strategy.debug.ClientLogger;
import games.strategy.engine.ClientContext;
import games.strategy.engine.data.GameData;
import games.strategy.engine.data.NamedAttachable;
import games.strategy.engine.data.PlayerID;
import games.strategy.engine.data.ProductionFrontier;
import games.strategy.engine.data.ProductionRule;
import games.strategy.engine.data.Territory;
import games.strategy.engine.data.TerritoryEffect;
import games.strategy.engine.data.Unit;
import games.strategy.engine.data.UnitType;
import games.strategy.engine.framework.ui.background.WaitDialog;
import games.strategy.triplea.Properties;
import games.strategy.triplea.TripleAUnit;
import games.strategy.triplea.attachments.UnitAttachment;
import games.strategy.triplea.delegate.BattleCalculator;
import games.strategy.triplea.delegate.DiceRoll;
import games.strategy.triplea.delegate.Matches;
import games.strategy.triplea.delegate.TerritoryEffectHelper;
import games.strategy.triplea.delegate.UnitBattleComparator;
import games.strategy.triplea.ui.IUIContext;
import games.strategy.triplea.util.UnitCategory;
import games.strategy.triplea.util.UnitSeperator;
import games.strategy.ui.IntTextField;
import games.strategy.ui.ScrollableTextField;
import games.strategy.ui.ScrollableTextFieldListener;
import games.strategy.ui.WidgetChangedListener;
import games.strategy.util.CompositeMatchOr;
import games.strategy.util.IntegerMap;
import games.strategy.util.ListenerList;
import games.strategy.util.Match;

public class OddsCalculatorPanel extends JPanel {
  private static final long serialVersionUID = -3559687618320469183L;
  private static final String NO_EFFECTS = &quot;*None*&quot;;
  private final Window m_parent;
<span class="nc" id="L86">  private final JLabel m_attackerWin = new JLabel();</span>
<span class="nc" id="L87">  private final JLabel m_defenderWin = new JLabel();</span>
<span class="nc" id="L88">  private final JLabel m_draw = new JLabel();</span>
<span class="nc" id="L89">  private final JLabel m_defenderLeft = new JLabel();</span>
<span class="nc" id="L90">  private final JLabel m_attackerLeft = new JLabel();</span>
<span class="nc" id="L91">  private final JLabel m_defenderLeftWhenDefenderWon = new JLabel();</span>
<span class="nc" id="L92">  private final JLabel m_attackerLeftWhenAttackerWon = new JLabel();</span>
<span class="nc" id="L93">  private final JLabel m_averageChangeInTUV = new JLabel();</span>
<span class="nc" id="L94">  private final JLabel m_roundsAverage = new JLabel();</span>
<span class="nc" id="L95">  private final JLabel m_count = new JLabel();</span>
<span class="nc" id="L96">  private final JLabel m_time = new JLabel();</span>
<span class="nc" id="L97">  private final IntTextField m_numRuns = new games.strategy.ui.IntTextField();</span>
<span class="nc" id="L98">  private final IntTextField m_retreatAfterXRounds = new games.strategy.ui.IntTextField();</span>
<span class="nc" id="L99">  private final IntTextField m_retreatAfterXUnitsLeft = new games.strategy.ui.IntTextField();</span>
<span class="nc" id="L100">  private final JPanel m_resultsPanel = new JPanel();</span>
<span class="nc" id="L101">  private final JButton m_calculateButton = new JButton(&quot;Pls Wait, Copying Data...&quot;);</span>
<span class="nc" id="L102">  private final JButton m_clearButton = new JButton(&quot;Clear&quot;);</span>
<span class="nc" id="L103">  private final JButton m_closeButton = new JButton(&quot;Close&quot;);</span>
<span class="nc" id="L104">  private final JButton m_SwapSidesButton = new JButton(&quot;Swap Sides&quot;);</span>
<span class="nc" id="L105">  private final JButton m_orderOfLossesButton = new JButton(&quot;Order Of Losses&quot;);</span>
<span class="nc" id="L106">  private final JCheckBox m_keepOneAttackingLandUnitCheckBox = new JCheckBox(&quot;One attacking land must live&quot;);</span>
<span class="nc" id="L107">  private final JCheckBox m_amphibiousCheckBox = new JCheckBox(&quot;Battle is Amphibious&quot;);</span>
<span class="nc" id="L108">  private final JCheckBox m_landBattleCheckBox = new JCheckBox(&quot;Land Battle&quot;);</span>
<span class="nc" id="L109">  private final JCheckBox m_retreatWhenOnlyAirLeftCheckBox = new JCheckBox(&quot;Retreat when only air left&quot;);</span>
  private final IUIContext m_context;
  private final GameData m_data;
  private final IOddsCalculator m_calculator;
  private PlayerUnitsPanel m_attackingUnitsPanel;
  private PlayerUnitsPanel m_defendingUnitsPanel;
  private JComboBox&lt;PlayerID&gt; m_attackerCombo;
  private JComboBox&lt;PlayerID&gt; m_defenderCombo;
  private JComboBox&lt;PlayerID&gt; m_SwapSidesCombo;
<span class="nc" id="L118">  private final JLabel m_attackerUnitsTotalNumber = new JLabel();</span>
<span class="nc" id="L119">  private final JLabel m_defenderUnitsTotalNumber = new JLabel();</span>
<span class="nc" id="L120">  private final JLabel m_attackerUnitsTotalTUV = new JLabel();</span>
<span class="nc" id="L121">  private final JLabel m_defenderUnitsTotalTUV = new JLabel();</span>
<span class="nc" id="L122">  private final JLabel m_attackerUnitsTotalHitpoints = new JLabel();</span>
<span class="nc" id="L123">  private final JLabel m_defenderUnitsTotalHitpoints = new JLabel();</span>
<span class="nc" id="L124">  private final JLabel m_attackerUnitsTotalPower = new JLabel();</span>
<span class="nc" id="L125">  private final JLabel m_defenderUnitsTotalPower = new JLabel();</span>
<span class="nc" id="L126">  private String m_attackerOrderOfLosses = null;</span>
<span class="nc" id="L127">  private String m_defenderOrderOfLosses = null;</span>
<span class="nc" id="L128">  private Territory m_location = null;</span>
  private JList&lt;String&gt; m_territoryEffectsJList;
<span class="nc" id="L130">  private final WidgetChangedListener m_listenerPlayerUnitsPanel = () -&gt; setWidgetActivation();</span>

<span class="nc" id="L132">  public OddsCalculatorPanel(final GameData data, final IUIContext context, final Territory location,</span>
      final Window parent) {
<span class="nc" id="L134">    m_data = data;</span>
<span class="nc" id="L135">    m_context = context;</span>
<span class="nc" id="L136">    m_location = location;</span>
<span class="nc" id="L137">    m_parent = parent;</span>
<span class="nc" id="L138">    m_calculateButton.setEnabled(false);</span>
<span class="nc" id="L139">    createComponents();</span>
<span class="nc" id="L140">    layoutComponents();</span>
<span class="nc" id="L141">    setupListeners();</span>
    // use the one passed, not the one we found:
<span class="nc bnc" id="L143" title="All 2 branches missed.">    if (location != null) {</span>
<span class="nc" id="L144">      m_data.acquireReadLock();</span>
      try {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        m_landBattleCheckBox.setSelected(!location.isWater());</span>
        // default to the current player
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (m_data.getSequence().getStep().getPlayerID() != null</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">            &amp;&amp; !m_data.getSequence().getStep().getPlayerID().isNull()) {</span>
<span class="nc" id="L150">          m_attackerCombo.setSelectedItem(m_data.getSequence().getStep().getPlayerID());</span>
        }
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!location.isWater()) {</span>
<span class="nc" id="L153">          m_defenderCombo.setSelectedItem(location.getOwner());</span>
<span class="nc" id="L154">        } else {</span>
          // we need to find out the defender for sea zones
<span class="nc bnc" id="L156" title="All 2 branches missed.">          for (final PlayerID player : location.getUnits().getPlayersWithUnits()) {</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">            if (player != getAttacker() &amp;&amp; !m_data.getRelationshipTracker().isAllied(player, getAttacker())) {</span>
<span class="nc" id="L158">              m_defenderCombo.setSelectedItem(player);</span>
<span class="nc" id="L159">              break;</span>
            }
          }
        }
<span class="nc" id="L163">        updateDefender(location.getUnits().getMatches(Matches.alliedUnit(getDefender(), data)));</span>
<span class="nc" id="L164">        updateAttacker(location.getUnits().getMatches(Matches.alliedUnit(getAttacker(), data)));</span>
<span class="nc" id="L165">      } finally {</span>
<span class="nc" id="L166">        m_data.releaseReadLock();</span>
<span class="nc" id="L167">      }</span>
<span class="nc" id="L168">    } else {</span>
<span class="nc" id="L169">      m_landBattleCheckBox.setSelected(true);</span>
<span class="nc" id="L170">      m_defenderCombo.setSelectedItem(data.getPlayerList().getPlayers().iterator().next());</span>
<span class="nc" id="L171">      updateDefender(null);</span>
<span class="nc" id="L172">      updateAttacker(null);</span>
    }
<span class="nc bnc" id="L174" title="All 2 branches missed.">    if (OddsCalculatorPanel.percentageOfFreeMemoryAvailable() &lt; 0.4) {</span>
<span class="nc" id="L175">      System.gc();</span>
<span class="nc" id="L176">      System.runFinalization();</span>
<span class="nc" id="L177">      System.gc();</span>
    }
<span class="nc" id="L179">    m_calculator = new ConcurrentOddsCalculator(&quot;BtlCalc Panel&quot;);</span>

<span class="nc" id="L181">    m_calculator.addOddsCalculatorListener(() -&gt; {</span>
<span class="nc" id="L182">      m_calculateButton.setText(&quot;Calculate Odds&quot;);</span>
<span class="nc" id="L183">      m_calculateButton.setEnabled(true);</span>
<span class="nc" id="L184">    });</span>

<span class="nc" id="L186">    m_calculator.setGameData(m_data);</span>
<span class="nc" id="L187">    setWidgetActivation();</span>
<span class="nc" id="L188">    revalidate();</span>
<span class="nc" id="L189">  }</span>

  public void shutdown() {
    try {
      // use this if not using a static calc, so that we gc the calc and shutdown all threads.
      // must be shutdown, as it has a thread pool per each instance.
<span class="nc" id="L195">      m_calculator.shutdown();</span>
<span class="nc" id="L196">    } catch (final Exception e) {</span>
<span class="nc" id="L197">      ClientLogger.logQuietly(e);</span>
    }
<span class="nc" id="L199">  }</span>

  @Override
  protected void finalize() throws Throwable {
<span class="nc" id="L203">    shutdown();</span>
<span class="nc" id="L204">    super.finalize();</span>
<span class="nc" id="L205">  }</span>

  private static double percentageOfFreeMemoryAvailable() {
<span class="nc" id="L208">    final Runtime runtime = Runtime.getRuntime();</span>
<span class="nc" id="L209">    final long maxMemory = runtime.maxMemory();</span>
<span class="nc" id="L210">    final long memoryAvailable = Math.min(maxMemory, maxMemory - (runtime.totalMemory() - runtime.freeMemory()));</span>
<span class="nc" id="L211">    return (((double) memoryAvailable) / ((double) maxMemory));</span>
  }

  private static long freeMemoryAvailable() {
<span class="nc" id="L215">    final Runtime runtime = Runtime.getRuntime();</span>
<span class="nc" id="L216">    final long maxMemory = runtime.maxMemory();</span>
<span class="nc" id="L217">    return Math.min(maxMemory, maxMemory - (runtime.totalMemory() - runtime.freeMemory()));</span>
  }

  private PlayerID getDefender() {
<span class="nc" id="L221">    return (PlayerID) m_defenderCombo.getSelectedItem();</span>
  }

  private PlayerID getAttacker() {
<span class="nc" id="L225">    return (PlayerID) m_attackerCombo.getSelectedItem();</span>
  }

  private PlayerID getSwapSides() {
<span class="nc" id="L229">    return (PlayerID) m_SwapSidesCombo.getSelectedItem();</span>
  }

  private void setupListeners() {
<span class="nc" id="L233">    m_defenderCombo.addActionListener(e -&gt; {</span>
<span class="nc" id="L234">      m_data.acquireReadLock();</span>
      try {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (m_data.getRelationshipTracker().isAllied(getDefender(), getAttacker())) {</span>
<span class="nc" id="L237">          m_attackerCombo.setSelectedItem(getEnemy(getDefender()));</span>
        }
<span class="nc" id="L239">      } finally {</span>
<span class="nc" id="L240">        m_data.releaseReadLock();</span>
<span class="nc" id="L241">      }</span>
<span class="nc" id="L242">      updateDefender(null);</span>
<span class="nc" id="L243">      setWidgetActivation();</span>
<span class="nc" id="L244">    });</span>
<span class="nc" id="L245">    m_attackerCombo.addActionListener(e -&gt; {</span>
<span class="nc" id="L246">      m_data.acquireReadLock();</span>
      try {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (m_data.getRelationshipTracker().isAllied(getDefender(), getAttacker())) {</span>
<span class="nc" id="L249">          m_defenderCombo.setSelectedItem(getEnemy(getAttacker()));</span>
        }
<span class="nc" id="L251">      } finally {</span>
<span class="nc" id="L252">        m_data.releaseReadLock();</span>
<span class="nc" id="L253">      }</span>
<span class="nc" id="L254">      updateAttacker(null);</span>
<span class="nc" id="L255">      setWidgetActivation();</span>
<span class="nc" id="L256">    });</span>
<span class="nc" id="L257">    m_amphibiousCheckBox.addActionListener(e -&gt; setWidgetActivation());</span>
<span class="nc" id="L258">    m_landBattleCheckBox.addActionListener(e -&gt; {</span>
<span class="nc" id="L259">      m_attackerOrderOfLosses = null;</span>
<span class="nc" id="L260">      m_defenderOrderOfLosses = null;</span>
<span class="nc" id="L261">      updateDefender(null);</span>
<span class="nc" id="L262">      updateAttacker(null);</span>
<span class="nc" id="L263">      setWidgetActivation();</span>
<span class="nc" id="L264">    });</span>
<span class="nc" id="L265">    m_calculateButton.addMouseMotionListener(new MouseMotionListener() {</span>
      @Override
<span class="nc" id="L267">      public void mouseDragged(final MouseEvent e) {}</span>

      @Override
      public void mouseMoved(final MouseEvent e) {
<span class="nc" id="L271">        final String memoryAvailable = &quot;&lt;br/&gt;Percentage of memory available: &quot;</span>
<span class="nc" id="L272">            + String.format(&quot;%.2f&quot;, (percentageOfFreeMemoryAvailable() * 100)) + &quot;% &lt;br/&gt;Free memory available: &quot;</span>
<span class="nc" id="L273">            + (freeMemoryAvailable() / (1024 * 1024)) + &quot;MB &lt;br/&gt;Maximum allowed memory: &quot;</span>
<span class="nc" id="L274">            + (Runtime.getRuntime().maxMemory() / (1024 * 1024)) + &quot;MB &lt;/html&gt;&quot;;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (m_calculateButton.isEnabled()) {</span>
<span class="nc" id="L276">          m_calculateButton.setToolTipText(&quot;&lt;html&gt;Data copying finished. &quot; + memoryAvailable);</span>
<span class="nc" id="L277">        } else {</span>
<span class="nc" id="L278">          m_calculateButton.setToolTipText(&quot;&lt;html&gt;If this is taking forever to enable, it means &quot;</span>
              + &quot;&lt;br/&gt;you do not have enough memory to copy the data quickly! &quot;
<span class="nc" id="L280">              + &quot;&lt;br/&gt;Consider increasing the max memory for TripleA. &quot; + memoryAvailable);</span>
        }
<span class="nc" id="L282">      }</span>
    });
<span class="nc" id="L284">    m_calculateButton.addActionListener(e -&gt; updateStats());</span>
<span class="nc" id="L285">    m_closeButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L286">      m_attackerOrderOfLosses = null;</span>
<span class="nc" id="L287">      m_defenderOrderOfLosses = null;</span>
<span class="nc" id="L288">      m_parent.setVisible(false);</span>
<span class="nc" id="L289">      shutdown();</span>
<span class="nc" id="L290">      m_parent.dispatchEvent(new WindowEvent(m_parent, WindowEvent.WINDOW_CLOSING));</span>
<span class="nc" id="L291">    });</span>
<span class="nc" id="L292">    m_clearButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L293">      m_defendingUnitsPanel.clear();</span>
<span class="nc" id="L294">      m_attackingUnitsPanel.clear();</span>
<span class="nc" id="L295">      setWidgetActivation();</span>
<span class="nc" id="L296">    });</span>
<span class="nc" id="L297">    m_SwapSidesButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L298">      m_attackerOrderOfLosses = null;</span>
<span class="nc" id="L299">      m_defenderOrderOfLosses = null;</span>
<span class="nc" id="L300">      List&lt;Unit&gt; getdefenders = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L301">      List&lt;Unit&gt; getattackers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L302">      getdefenders = m_defendingUnitsPanel.getUnits();</span>
<span class="nc" id="L303">      getattackers = m_attackingUnitsPanel.getUnits();</span>
<span class="nc" id="L304">      m_SwapSidesCombo.setSelectedItem(getAttacker());</span>
<span class="nc" id="L305">      m_attackerCombo.setSelectedItem(getDefender());</span>
<span class="nc" id="L306">      m_defenderCombo.setSelectedItem(getSwapSides());</span>
<span class="nc" id="L307">      m_attackingUnitsPanel.init(getAttacker(), getdefenders, isLand());</span>
<span class="nc" id="L308">      m_defendingUnitsPanel.init(getDefender(), getattackers, isLand());</span>
<span class="nc" id="L309">      setWidgetActivation();</span>
<span class="nc" id="L310">    });</span>
<span class="nc" id="L311">    m_orderOfLossesButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L312">      final OrderOfLossesInputPanel oolPanel = new OrderOfLossesInputPanel(m_attackerOrderOfLosses,</span>
<span class="nc" id="L313">          m_defenderOrderOfLosses, m_attackingUnitsPanel.getCategories(), m_defendingUnitsPanel.getCategories(),</span>
<span class="nc" id="L314">          m_landBattleCheckBox.isSelected(), m_context, m_data);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">      if (JOptionPane.OK_OPTION == JOptionPane.showConfirmDialog(OddsCalculatorPanel.this, oolPanel,</span>
<span class="nc" id="L316">          &quot;Create Order Of Losses for each side&quot;, JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE)) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (OddsCalculator.isValidOrderOfLoss(oolPanel.getAttackerOrder(), m_data)) {</span>
<span class="nc" id="L318">          m_attackerOrderOfLosses = oolPanel.getAttackerOrder();</span>
        }
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (OddsCalculator.isValidOrderOfLoss(oolPanel.getDefenderOrder(), m_data)) {</span>
<span class="nc" id="L321">          m_defenderOrderOfLosses = oolPanel.getDefenderOrder();</span>
        }
      }
<span class="nc" id="L324">    });</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">    if (m_territoryEffectsJList != null) {</span>
<span class="nc" id="L326">      m_territoryEffectsJList.addListSelectionListener(e -&gt; setWidgetActivation());</span>
    }
<span class="nc" id="L328">    m_attackingUnitsPanel.addChangeListener(m_listenerPlayerUnitsPanel);</span>
<span class="nc" id="L329">    m_defendingUnitsPanel.addChangeListener(m_listenerPlayerUnitsPanel);</span>
<span class="nc" id="L330">  }</span>

  private boolean isAmphibiousBattle() {
<span class="nc bnc" id="L333" title="All 4 branches missed.">    return (m_landBattleCheckBox.isSelected() &amp;&amp; m_amphibiousCheckBox.isSelected());</span>
  }

  private Collection&lt;TerritoryEffect&gt; getTerritoryEffects() {
<span class="nc" id="L337">    final Collection&lt;TerritoryEffect&gt; territoryEffects = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">    if (m_territoryEffectsJList != null) {</span>
<span class="nc" id="L339">      final List&lt;String&gt; selected = m_territoryEffectsJList.getSelectedValuesList();</span>
<span class="nc" id="L340">      m_data.acquireReadLock();</span>
      try {
<span class="nc" id="L342">        final Hashtable&lt;String, TerritoryEffect&gt; allTerritoryEffects = m_data.getTerritoryEffectList();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        for (final String selection : selected) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">          if (selection.equals(NO_EFFECTS)) {</span>
<span class="nc" id="L345">            territoryEffects.clear();</span>
<span class="nc" id="L346">            break;</span>
          }
<span class="nc" id="L348">          territoryEffects.add(allTerritoryEffects.get(selection));</span>
        }
<span class="nc" id="L350">      } finally {</span>
<span class="nc" id="L351">        m_data.releaseReadLock();</span>
<span class="nc" id="L352">      }</span>
    }
<span class="nc" id="L354">    return territoryEffects;</span>
  }

  private void updateStats() {
<span class="nc bnc" id="L358" title="All 2 branches missed.">    if (!SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L359">      throw new IllegalStateException(&quot;Wrong thread&quot;);</span>
    }
<span class="nc" id="L361">    final AtomicReference&lt;AggregateResults&gt; results = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L362">    final WaitDialog dialog =</span>
<span class="nc" id="L363">        new WaitDialog(this, &quot;Calculating Odds (&quot; + m_calculator.getThreadCount() + &quot; threads)&quot;, new AbstractAction() {</span>
          private static final long serialVersionUID = -2148507015083214974L;

          @Override
          public void actionPerformed(final ActionEvent e) {
<span class="nc" id="L368">            m_calculator.cancel();</span>
<span class="nc" id="L369">          }</span>
        });
<span class="nc" id="L371">    final AtomicReference&lt;Collection&lt;Unit&gt;&gt; defenders = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L372">    final AtomicReference&lt;Collection&lt;Unit&gt;&gt; attackers = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L373">    dialog.pack();</span>
<span class="nc" id="L374">    dialog.setLocationRelativeTo(this);</span>
<span class="nc" id="L375">    final Thread calcThread = new Thread(() -&gt; {</span>
      try {
        // find a territory to fight in
<span class="nc" id="L378">        Territory location = null;</span>
<span class="nc bnc" id="L379" title="All 4 branches missed.">        if (m_location == null || m_location.isWater() == isLand()) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">          for (final Territory t : m_data.getMap()) {</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">            if (t.isWater() == !isLand()) {</span>
<span class="nc" id="L382">              location = t;</span>
<span class="nc" id="L383">              break;</span>
            }
          }
<span class="nc" id="L386">        } else {</span>
<span class="nc" id="L387">          location = m_location;</span>
        }
<span class="nc bnc" id="L389" title="All 2 branches missed.">        if (location == null) {</span>
<span class="nc" id="L390">          throw new IllegalStateException(&quot;No territory found that is land:&quot; + isLand());</span>
        }
<span class="nc" id="L392">        final List&lt;Unit&gt; defending = m_defendingUnitsPanel.getUnits();</span>
<span class="nc" id="L393">        final List&lt;Unit&gt; attacking = m_attackingUnitsPanel.getUnits();</span>
<span class="nc" id="L394">        List&lt;Unit&gt; bombarding = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (isLand()) {</span>
<span class="nc" id="L396">          bombarding = Match.getMatches(attacking, Matches.unitCanBombard(getAttacker()));</span>
<span class="nc" id="L397">          attacking.removeAll(bombarding);</span>
        }
<span class="nc" id="L399">        m_calculator.setRetreatAfterRound(m_retreatAfterXRounds.getValue());</span>
<span class="nc" id="L400">        m_calculator.setRetreatAfterXUnitsLeft(m_retreatAfterXUnitsLeft.getValue());</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (m_retreatWhenOnlyAirLeftCheckBox.isSelected()) {</span>
<span class="nc" id="L402">          m_calculator.setRetreatWhenOnlyAirLeft(true);</span>
<span class="nc" id="L403">        } else {</span>
<span class="nc" id="L404">          m_calculator.setRetreatWhenOnlyAirLeft(false);</span>
        }
<span class="nc bnc" id="L406" title="All 4 branches missed.">        if (m_landBattleCheckBox.isSelected() &amp;&amp; m_keepOneAttackingLandUnitCheckBox.isSelected()) {</span>
<span class="nc" id="L407">          m_calculator.setKeepOneAttackingLandUnit(true);</span>
<span class="nc" id="L408">        } else {</span>
<span class="nc" id="L409">          m_calculator.setKeepOneAttackingLandUnit(false);</span>
        }
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (isAmphibiousBattle()) {</span>
<span class="nc" id="L412">          m_calculator.setAmphibious(true);</span>
<span class="nc" id="L413">        } else {</span>
<span class="nc" id="L414">          m_calculator.setAmphibious(false);</span>
        }
<span class="nc" id="L416">        m_calculator.setAttackerOrderOfLosses(m_attackerOrderOfLosses);</span>
<span class="nc" id="L417">        m_calculator.setDefenderOrderOfLosses(m_defenderOrderOfLosses);</span>
<span class="nc" id="L418">        final Collection&lt;TerritoryEffect&gt; territoryEffects = getTerritoryEffects();</span>
<span class="nc" id="L419">        defenders.set(defending);</span>
<span class="nc" id="L420">        attackers.set(attacking);</span>
<span class="nc" id="L421">        results.set(m_calculator.setCalculateDataAndCalculate(getAttacker(), getDefender(), location, attacking,</span>
<span class="nc" id="L422">            defending, bombarding, territoryEffects, m_numRuns.getValue()));</span>
<span class="nc" id="L423">      } finally {</span>
<span class="nc" id="L424">        SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc" id="L425">          dialog.setVisible(false);</span>
<span class="nc" id="L426">          dialog.dispose();</span>
<span class="nc" id="L427">        });</span>
<span class="nc" id="L428">      }</span>
<span class="nc" id="L429">    }, &quot;Odds calc thread&quot;);</span>
    // Actually start thread.
<span class="nc" id="L431">    calcThread.start();</span>
    // the runnable setting the dialog visible must run after this code executes, since this code is running on the
    // swing event thread
<span class="nc" id="L434">    dialog.setVisible(true);</span>
    // results.get() could be null if we cancelled to quickly or something weird like that.
<span class="nc bnc" id="L436" title="All 4 branches missed.">    if (results == null || results.get() == null) {</span>
<span class="nc" id="L437">      setResultsToBlank();</span>
<span class="nc" id="L438">    } else {</span>
<span class="nc" id="L439">      m_attackerWin.setText(formatPercentage(results.get().getAttackerWinPercent()));</span>
<span class="nc" id="L440">      m_defenderWin.setText(formatPercentage(results.get().getDefenderWinPercent()));</span>
<span class="nc" id="L441">      m_draw.setText(formatPercentage(results.get().getDrawPercent()));</span>
<span class="nc" id="L442">      final boolean isLand = isLand();</span>
<span class="nc" id="L443">      final List&lt;Unit&gt; mainCombatAttackers =</span>
<span class="nc" id="L444">          Match.getMatches(attackers.get(), Matches.UnitCanBeInBattle(true, isLand, m_data, 1, false, true, true));</span>
<span class="nc" id="L445">      final List&lt;Unit&gt; mainCombatDefenders =</span>
<span class="nc" id="L446">          Match.getMatches(defenders.get(), Matches.UnitCanBeInBattle(false, isLand, m_data, 1, false, true, true));</span>
<span class="nc" id="L447">      final int attackersTotal = mainCombatAttackers.size();</span>
<span class="nc" id="L448">      final int defendersTotal = mainCombatDefenders.size();</span>
<span class="nc" id="L449">      m_defenderLeft.setText(formatValue(results.get().getAverageDefendingUnitsLeft()) + &quot; /&quot; + defendersTotal);</span>
<span class="nc" id="L450">      m_attackerLeft.setText(formatValue(results.get().getAverageAttackingUnitsLeft()) + &quot; /&quot; + attackersTotal);</span>
<span class="nc" id="L451">      m_defenderLeftWhenDefenderWon</span>
<span class="nc" id="L452">          .setText(formatValue(results.get().getAverageDefendingUnitsLeftWhenDefenderWon()) + &quot; /&quot; + defendersTotal);</span>
<span class="nc" id="L453">      m_attackerLeftWhenAttackerWon</span>
<span class="nc" id="L454">          .setText(formatValue(results.get().getAverageAttackingUnitsLeftWhenAttackerWon()) + &quot; /&quot; + attackersTotal);</span>
<span class="nc" id="L455">      m_roundsAverage.setText(&quot;&quot; + formatValue(results.get().getAverageBattleRoundsFought()));</span>
      try {
<span class="nc" id="L457">        m_data.acquireReadLock();</span>
<span class="nc" id="L458">        m_averageChangeInTUV.setText(&quot;&quot; + formatValue(results.get().getAverageTUVswing(getAttacker(),</span>
<span class="nc" id="L459">            mainCombatAttackers, getDefender(), mainCombatDefenders, m_data)));</span>
<span class="nc" id="L460">      } finally {</span>
<span class="nc" id="L461">        m_data.releaseReadLock();</span>
<span class="nc" id="L462">      }</span>
<span class="nc" id="L463">      m_count.setText(results.get().getRollCount() + &quot;&quot;);</span>
<span class="nc" id="L464">      m_time.setText(formatValue(results.get().getTime() / 1000.0) + &quot;s&quot;);</span>
    }
<span class="nc" id="L466">  }</span>

  public String formatPercentage(final double percentage) {
<span class="nc" id="L469">    final NumberFormat format = new DecimalFormat(&quot;%&quot;);</span>
<span class="nc" id="L470">    return format.format(percentage);</span>
  }

  public String formatValue(final double value) {
<span class="nc" id="L474">    final NumberFormat format = new DecimalFormat(&quot;#0.##&quot;);</span>
<span class="nc" id="L475">    return format.format(value);</span>
  }

  private void updateDefender(List&lt;Unit&gt; units) {
<span class="nc bnc" id="L479" title="All 2 branches missed.">    if (units == null) {</span>
<span class="nc" id="L480">      units = Collections.emptyList();</span>
    }
<span class="nc" id="L482">    final boolean isLand = isLand();</span>
<span class="nc" id="L483">    units = Match.getMatches(units, Matches.UnitCanBeInBattle(false, isLand, m_data, 1, false, false, false));</span>
<span class="nc" id="L484">    m_defendingUnitsPanel.init(getDefender(), units, isLand);</span>
<span class="nc" id="L485">  }</span>

  private void updateAttacker(List&lt;Unit&gt; units) {
<span class="nc bnc" id="L488" title="All 2 branches missed.">    if (units == null) {</span>
<span class="nc" id="L489">      units = Collections.emptyList();</span>
    }
<span class="nc" id="L491">    final boolean isLand = isLand();</span>
<span class="nc" id="L492">    units = Match.getMatches(units, Matches.UnitCanBeInBattle(true, isLand, m_data, 1, false, false, false));</span>
<span class="nc" id="L493">    m_attackingUnitsPanel.init(getAttacker(), units, isLand);</span>
<span class="nc" id="L494">  }</span>

  private boolean isLand() {
<span class="nc" id="L497">    return m_landBattleCheckBox.isSelected();</span>
  }

  private PlayerID getEnemy(final PlayerID player) {
<span class="nc bnc" id="L501" title="All 2 branches missed.">    for (final PlayerID id : m_data.getPlayerList()) {</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">      if (m_data.getRelationshipTracker().isAtWar(player, id)) {</span>
<span class="nc" id="L503">        return id;</span>
      }
    }
<span class="nc bnc" id="L506" title="All 2 branches missed.">    for (final PlayerID id : m_data.getPlayerList()) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">      if (!m_data.getRelationshipTracker().isAllied(player, id)) {</span>
<span class="nc" id="L508">        return id;</span>
      }
    }
    // TODO: do we allow fighting allies in the battle calc?
<span class="nc" id="L512">    throw new IllegalStateException(&quot;No enemies or non-allies for :&quot; + player);</span>
  }

  private void layoutComponents() {
<span class="nc" id="L516">    setLayout(new BorderLayout());</span>
<span class="nc" id="L517">    final JPanel main = new JPanel();</span>
<span class="nc" id="L518">    main.setBorder(BorderFactory.createEmptyBorder(10, 0, 10, 0));</span>
<span class="nc" id="L519">    add(main, BorderLayout.CENTER);</span>
<span class="nc" id="L520">    main.setLayout(new BorderLayout());</span>
<span class="nc" id="L521">    final JPanel attackAndDefend = new JPanel();</span>
<span class="nc" id="L522">    attackAndDefend.setLayout(new GridBagLayout());</span>
<span class="nc" id="L523">    final int gap = 20;</span>
<span class="nc" id="L524">    int row0 = 0;</span>
<span class="nc" id="L525">    attackAndDefend.add(new JLabel(&quot;Attacker: &quot;), new GridBagConstraints(0, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L526">        GridBagConstraints.NONE, new Insets(0, gap, gap, 0), 0, 0));</span>
<span class="nc" id="L527">    attackAndDefend.add(m_attackerCombo, new GridBagConstraints(1, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L528">        GridBagConstraints.NONE, new Insets(0, 0, gap / 2, gap), 0, 0));</span>
<span class="nc" id="L529">    attackAndDefend.add(new JLabel(&quot;Defender: &quot;), new GridBagConstraints(2, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L530">        GridBagConstraints.NONE, new Insets(0, gap, gap, 0), 0, 0));</span>
<span class="nc" id="L531">    attackAndDefend.add(m_defenderCombo, new GridBagConstraints(3, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L532">        GridBagConstraints.NONE, new Insets(0, 0, gap / 2, gap), 0, 0));</span>
<span class="nc" id="L533">    row0++;</span>
<span class="nc" id="L534">    attackAndDefend.add(m_attackerUnitsTotalNumber, new GridBagConstraints(0, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L535">        GridBagConstraints.NONE, new Insets(0, gap, 0, 0), 0, 0));</span>
<span class="nc" id="L536">    attackAndDefend.add(m_attackerUnitsTotalTUV, new GridBagConstraints(1, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L537">        GridBagConstraints.NONE, new Insets(0, gap / 2, 0, gap * 2), 0, 0));</span>
<span class="nc" id="L538">    attackAndDefend.add(m_defenderUnitsTotalNumber, new GridBagConstraints(2, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L539">        GridBagConstraints.NONE, new Insets(0, gap, 0, 0), 0, 0));</span>
<span class="nc" id="L540">    attackAndDefend.add(m_defenderUnitsTotalTUV, new GridBagConstraints(3, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L541">        GridBagConstraints.NONE, new Insets(0, gap / 2, 0, gap * 2), 0, 0));</span>
<span class="nc" id="L542">    row0++;</span>
<span class="nc" id="L543">    attackAndDefend.add(m_attackerUnitsTotalHitpoints, new GridBagConstraints(0, row0, 1, 1, 0, 0,</span>
<span class="nc" id="L544">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(0, gap, gap / 2, 0), 0, 0));</span>
<span class="nc" id="L545">    attackAndDefend.add(m_attackerUnitsTotalPower, new GridBagConstraints(1, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L546">        GridBagConstraints.NONE, new Insets(0, gap / 2, gap / 2, gap * 2), 0, 0));</span>
<span class="nc" id="L547">    attackAndDefend.add(m_defenderUnitsTotalHitpoints, new GridBagConstraints(2, row0, 1, 1, 0, 0,</span>
<span class="nc" id="L548">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(0, gap, gap / 2, 0), 0, 0));</span>
<span class="nc" id="L549">    attackAndDefend.add(m_defenderUnitsTotalPower, new GridBagConstraints(3, row0, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L550">        GridBagConstraints.NONE, new Insets(0, gap / 2, gap / 2, gap * 2), 0, 0));</span>
<span class="nc" id="L551">    row0++;</span>
<span class="nc" id="L552">    final JScrollPane attackerScroll = new JScrollPane(m_attackingUnitsPanel);</span>
<span class="nc" id="L553">    attackerScroll.setBorder(null);</span>
<span class="nc" id="L554">    attackerScroll.getViewport().setBorder(null);</span>
<span class="nc" id="L555">    final JScrollPane defenderScroll = new JScrollPane(m_defendingUnitsPanel);</span>
<span class="nc" id="L556">    defenderScroll.setBorder(null);</span>
<span class="nc" id="L557">    defenderScroll.getViewport().setBorder(null);</span>
<span class="nc" id="L558">    attackAndDefend.add(attackerScroll, new GridBagConstraints(0, row0, 2, 1, 1, 1, GridBagConstraints.NORTH,</span>
<span class="nc" id="L559">        GridBagConstraints.BOTH, new Insets(10, gap, gap, gap), 0, 0));</span>
<span class="nc" id="L560">    attackAndDefend.add(defenderScroll, new GridBagConstraints(2, row0, 2, 1, 1, 1, GridBagConstraints.NORTH,</span>
<span class="nc" id="L561">        GridBagConstraints.BOTH, new Insets(10, gap, gap, gap), 0, 0));</span>
<span class="nc" id="L562">    main.add(attackAndDefend, BorderLayout.CENTER);</span>
<span class="nc" id="L563">    final JPanel resultsText = new JPanel();</span>
<span class="nc" id="L564">    resultsText.setLayout(new GridBagLayout());</span>
<span class="nc" id="L565">    int row1 = 0;</span>
<span class="nc" id="L566">    resultsText.add(new JLabel(&quot;Attacker Wins:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L567">        GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L568">    resultsText.add(new JLabel(&quot;Draw:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L569">        GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L570">    resultsText.add(new JLabel(&quot;Defender Wins:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L571">        GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L572">    resultsText.add(new JLabel(&quot;Ave. Defender Units Left:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L573">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(6, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L574">    resultsText.add(new JLabel(&quot;Units Left If Def Won:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L575">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L576">    resultsText.add(new JLabel(&quot;Ave. Attacker Units Left:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L577">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(6, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L578">    resultsText.add(new JLabel(&quot;Units Left If Att Won:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L579">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L580">    resultsText.add(new JLabel(&quot;Average TUV Swing:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L581">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(6, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L582">    resultsText.add(new JLabel(&quot;Average Rounds:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L583">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L584">    resultsText.add(new JLabel(&quot;Simulation Count:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L585">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(15, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L586">    resultsText.add(new JLabel(&quot;Time:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L587">        GridBagConstraints.NONE, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L588">    resultsText.add(m_calculateButton, new GridBagConstraints(0, row1++, 2, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L589">        GridBagConstraints.BOTH, new Insets(20, 60, 0, 100), 0, 0));</span>
<span class="nc" id="L590">    resultsText.add(m_clearButton, new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L591">        GridBagConstraints.BOTH, new Insets(6, 60, 0, 0), 0, 0));</span>
<span class="nc" id="L592">    resultsText.add(new JLabel(&quot;Run Count:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L593">        GridBagConstraints.NONE, new Insets(20, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L594">    resultsText.add(new JLabel(&quot;Retreat After Round:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L595">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(10, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L596">    resultsText.add(new JLabel(&quot;Retreat When X Units Left:&quot;), new GridBagConstraints(0, row1++, 1, 1, 0, 0,</span>
<span class="nc" id="L597">        GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(10, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L598">    int row2 = 0;</span>
<span class="nc" id="L599">    resultsText.add(m_attackerWin, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L600">        GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L601">    resultsText.add(m_draw, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L602">        GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L603">    resultsText.add(m_defenderWin, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L604">        GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L605">    resultsText.add(m_defenderLeft, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L606">        GridBagConstraints.NONE, new Insets(6, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L607">    resultsText.add(m_defenderLeftWhenDefenderWon, new GridBagConstraints(1, row2++, 1, 1, 0, 0,</span>
<span class="nc" id="L608">        GridBagConstraints.WEST, GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L609">    resultsText.add(m_attackerLeft, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L610">        GridBagConstraints.NONE, new Insets(6, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L611">    resultsText.add(m_attackerLeftWhenAttackerWon, new GridBagConstraints(1, row2++, 1, 1, 0, 0,</span>
<span class="nc" id="L612">        GridBagConstraints.WEST, GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L613">    resultsText.add(m_averageChangeInTUV, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L614">        GridBagConstraints.NONE, new Insets(6, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L615">    resultsText.add(m_roundsAverage, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L616">        GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L617">    resultsText.add(m_count, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L618">        GridBagConstraints.NONE, new Insets(15, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L619">    resultsText.add(m_time, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L620">        GridBagConstraints.NONE, new Insets(0, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L621">    row2++;</span>
<span class="nc" id="L622">    resultsText.add(m_SwapSidesButton, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L623">        GridBagConstraints.BOTH, new Insets(6, 10, 0, 100), 0, 0));</span>
<span class="nc" id="L624">    resultsText.add(m_numRuns, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L625">        GridBagConstraints.NONE, new Insets(20, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L626">    resultsText.add(m_retreatAfterXRounds, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L627">        GridBagConstraints.NONE, new Insets(10, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L628">    resultsText.add(m_retreatAfterXUnitsLeft, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L629">        GridBagConstraints.NONE, new Insets(10, 10, 0, 0), 0, 0));</span>
<span class="nc" id="L630">    row1 = row2;</span>
<span class="nc" id="L631">    resultsText.add(m_orderOfLossesButton, new GridBagConstraints(0, row1++, 1, 1, 0, 0, GridBagConstraints.EAST,</span>
<span class="nc" id="L632">        GridBagConstraints.BOTH, new Insets(10, 15, 0, 0), 0, 0));</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">    if (m_territoryEffectsJList != null) {</span>
<span class="nc" id="L634">      resultsText.add(new JScrollPane(m_territoryEffectsJList),</span>
<span class="nc" id="L635">          new GridBagConstraints(0, row1, 1, m_territoryEffectsJList.getVisibleRowCount(), 0, 0,</span>
<span class="nc" id="L636">              GridBagConstraints.EAST, GridBagConstraints.BOTH, new Insets(10, 15, 0, 0), 0, 0));</span>
<span class="nc" id="L637">      row1 += m_territoryEffectsJList.getVisibleRowCount();</span>
    }
<span class="nc" id="L639">    resultsText.add(m_retreatWhenOnlyAirLeftCheckBox, new GridBagConstraints(1, row2++, 1, 1, 0, 0,</span>
<span class="nc" id="L640">        GridBagConstraints.WEST, GridBagConstraints.NONE, new Insets(10, 10, 0, 5), 0, 0));</span>
<span class="nc" id="L641">    resultsText.add(m_keepOneAttackingLandUnitCheckBox, new GridBagConstraints(1, row2++, 1, 1, 0, 0,</span>
<span class="nc" id="L642">        GridBagConstraints.WEST, GridBagConstraints.NONE, new Insets(2, 10, 0, 5), 0, 0));</span>
<span class="nc" id="L643">    resultsText.add(m_amphibiousCheckBox, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L644">        GridBagConstraints.NONE, new Insets(2, 10, 0, 5), 0, 0));</span>
<span class="nc" id="L645">    resultsText.add(m_landBattleCheckBox, new GridBagConstraints(1, row2++, 1, 1, 0, 0, GridBagConstraints.WEST,</span>
<span class="nc" id="L646">        GridBagConstraints.NONE, new Insets(2, 10, 0, 5), 0, 0));</span>
<span class="nc" id="L647">    m_resultsPanel.add(resultsText);</span>
<span class="nc" id="L648">    m_resultsPanel.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L649">    final JScrollPane resultsScroll = new JScrollPane(m_resultsPanel);</span>
<span class="nc" id="L650">    resultsScroll.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L651">    final Dimension resultsScrollDimensions = resultsScroll.getPreferredSize();</span>
    // add some so that we don't have double scroll bars appear when only one is needed
<span class="nc" id="L653">    resultsScrollDimensions.width += 22;</span>
<span class="nc" id="L654">    resultsScroll.setPreferredSize(resultsScrollDimensions);</span>
<span class="nc" id="L655">    main.add(resultsScroll, BorderLayout.EAST);</span>
<span class="nc" id="L656">    final JPanel south = new JPanel();</span>
<span class="nc" id="L657">    south.setLayout(new BorderLayout());</span>
<span class="nc" id="L658">    final JPanel buttons = new JPanel();</span>
<span class="nc" id="L659">    buttons.setLayout(new FlowLayout(FlowLayout.CENTER));</span>
<span class="nc" id="L660">    buttons.add(m_closeButton);</span>
<span class="nc" id="L661">    south.add(buttons, BorderLayout.SOUTH);</span>
<span class="nc" id="L662">    add(south, BorderLayout.SOUTH);</span>
<span class="nc" id="L663">  }</span>

  private void createComponents() {
<span class="nc" id="L666">    m_data.acquireReadLock();</span>
    try {
<span class="nc" id="L668">      final Collection&lt;PlayerID&gt; playerList = new ArrayList&lt;&gt;(m_data.getPlayerList().getPlayers());</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">      if (doesPlayerHaveUnitsOnMap(PlayerID.NULL_PLAYERID, m_data)) {</span>
<span class="nc" id="L670">        playerList.add(PlayerID.NULL_PLAYERID);</span>
      }
<span class="nc" id="L672">      m_attackerCombo = new JComboBox&lt;&gt;(new Vector&lt;&gt;(playerList));</span>
<span class="nc" id="L673">      m_defenderCombo = new JComboBox&lt;&gt;(new Vector&lt;&gt;(playerList));</span>
<span class="nc" id="L674">      m_SwapSidesCombo = new JComboBox&lt;&gt;(new Vector&lt;&gt;(playerList));</span>
<span class="nc" id="L675">      final Hashtable&lt;String, TerritoryEffect&gt; allTerritoryEffects = m_data.getTerritoryEffectList();</span>
<span class="nc bnc" id="L676" title="All 4 branches missed.">      if (allTerritoryEffects == null || allTerritoryEffects.isEmpty()) {</span>
<span class="nc" id="L677">        m_territoryEffectsJList = null;</span>
<span class="nc" id="L678">      } else {</span>
<span class="nc" id="L679">        final Vector&lt;String&gt; effectNames = new Vector&lt;&gt;();</span>
<span class="nc" id="L680">        effectNames.add(NO_EFFECTS);</span>
<span class="nc" id="L681">        effectNames.addAll(allTerritoryEffects.keySet());</span>
<span class="nc" id="L682">        m_territoryEffectsJList = new JList&lt;&gt;(effectNames);</span>
<span class="nc" id="L683">        m_territoryEffectsJList.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);</span>
<span class="nc" id="L684">        m_territoryEffectsJList.setLayoutOrientation(JList.VERTICAL);</span>
        // equal to the amount of space left (number of remaining items on the right)
<span class="nc" id="L686">        m_territoryEffectsJList.setVisibleRowCount(4);</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (m_location != null) {</span>
<span class="nc" id="L688">          final Collection&lt;TerritoryEffect&gt; currentEffects = TerritoryEffectHelper.getEffects(m_location);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">          if (!currentEffects.isEmpty()) {</span>
<span class="nc" id="L690">            final int[] selectedIndexes = new int[currentEffects.size()];</span>
<span class="nc" id="L691">            int currentIndex = 0;</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">            for (final TerritoryEffect te : currentEffects) {</span>
<span class="nc" id="L693">              selectedIndexes[currentIndex] = effectNames.indexOf(te.getName());</span>
<span class="nc" id="L694">              currentIndex++;</span>
            }
<span class="nc" id="L696">            m_territoryEffectsJList.setSelectedIndices(selectedIndexes);</span>
          }
        }
      }
<span class="nc" id="L700">    } finally {</span>
<span class="nc" id="L701">      m_data.releaseReadLock();</span>
<span class="nc" id="L702">    }</span>
<span class="nc" id="L703">    m_defenderCombo.setRenderer(new PlayerRenderer());</span>
<span class="nc" id="L704">    m_attackerCombo.setRenderer(new PlayerRenderer());</span>
<span class="nc" id="L705">    m_SwapSidesCombo.setRenderer(new PlayerRenderer());</span>
<span class="nc" id="L706">    m_defendingUnitsPanel = new PlayerUnitsPanel(m_data, m_context, true);</span>
<span class="nc" id="L707">    m_attackingUnitsPanel = new PlayerUnitsPanel(m_data, m_context, false);</span>
<span class="nc" id="L708">    m_numRuns.setColumns(4);</span>
<span class="nc" id="L709">    m_numRuns.setMin(1);</span>
<span class="nc" id="L710">    m_numRuns.setMax(20000);</span>

<span class="nc" id="L712">    final int simulationCount =</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">        Properties.getLow_Luck(m_data) ? ClientContext.battleCalcSettings().getSimulationCountLowLuck()</span>
<span class="nc" id="L714">            : ClientContext.battleCalcSettings().getSimulationCountDice();</span>
<span class="nc" id="L715">    m_numRuns.setValue(simulationCount);</span>
<span class="nc" id="L716">    m_retreatAfterXRounds.setColumns(4);</span>
<span class="nc" id="L717">    m_retreatAfterXRounds.setMin(-1);</span>
<span class="nc" id="L718">    m_retreatAfterXRounds.setMax(1000);</span>
<span class="nc" id="L719">    m_retreatAfterXRounds.setValue(-1);</span>
<span class="nc" id="L720">    m_retreatAfterXRounds.setToolTipText(&quot;-1 means never.&quot;);</span>
<span class="nc" id="L721">    m_retreatAfterXUnitsLeft.setColumns(4);</span>
<span class="nc" id="L722">    m_retreatAfterXUnitsLeft.setMin(-1);</span>
<span class="nc" id="L723">    m_retreatAfterXUnitsLeft.setMax(1000);</span>
<span class="nc" id="L724">    m_retreatAfterXUnitsLeft.setValue(-1);</span>
<span class="nc" id="L725">    m_retreatAfterXUnitsLeft.setToolTipText(</span>
<span class="nc" id="L726">        &quot;-1 means never. If positive and 'retreat when only air left' is also selected, then we will retreat when X of non-air units is left.&quot;);</span>
<span class="nc" id="L727">    setResultsToBlank();</span>
<span class="nc" id="L728">    m_defenderLeft.setToolTipText(</span>
<span class="nc" id="L729">        &quot;Units Left does not include AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L730">    m_attackerLeft.setToolTipText(</span>
<span class="nc" id="L731">        &quot;Units Left does not include AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L732">    m_defenderLeftWhenDefenderWon.setToolTipText(</span>
<span class="nc" id="L733">        &quot;Units Left does not include AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L734">    m_attackerLeftWhenAttackerWon.setToolTipText(</span>
<span class="nc" id="L735">        &quot;Units Left does not include AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L736">    m_averageChangeInTUV.setToolTipText(</span>
<span class="nc" id="L737">        &quot;TUV Swing does not include captured AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L738">    m_retreatWhenOnlyAirLeftCheckBox.setToolTipText(</span>
<span class="nc" id="L739">        &quot;We retreat if only air is left, and if 'retreat when x units left' is positive we will retreat when x of non-air is left too.&quot;);</span>
<span class="nc" id="L740">    m_attackerUnitsTotalNumber.setToolTipText(</span>
<span class="nc" id="L741">        &quot;Totals do not include AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L742">    m_defenderUnitsTotalNumber.setToolTipText(</span>
<span class="nc" id="L743">        &quot;Totals do not include AA guns and other infrastructure, and does not include Bombarding sea units for land battles.&quot;);</span>
<span class="nc" id="L744">  }</span>

  private void setResultsToBlank() {
<span class="nc" id="L747">    final String blank = &quot;------&quot;;</span>
<span class="nc" id="L748">    m_attackerWin.setText(blank);</span>
<span class="nc" id="L749">    m_defenderWin.setText(blank);</span>
<span class="nc" id="L750">    m_draw.setText(blank);</span>
<span class="nc" id="L751">    m_defenderLeft.setText(blank);</span>
<span class="nc" id="L752">    m_attackerLeft.setText(blank);</span>
<span class="nc" id="L753">    m_defenderLeftWhenDefenderWon.setText(blank);</span>
<span class="nc" id="L754">    m_attackerLeftWhenAttackerWon.setText(blank);</span>
<span class="nc" id="L755">    m_roundsAverage.setText(blank);</span>
<span class="nc" id="L756">    m_averageChangeInTUV.setText(blank);</span>
<span class="nc" id="L757">    m_count.setText(blank);</span>
<span class="nc" id="L758">    m_time.setText(blank);</span>
<span class="nc" id="L759">  }</span>

  public void setWidgetActivation() {
<span class="nc" id="L762">    m_keepOneAttackingLandUnitCheckBox.setEnabled(m_landBattleCheckBox.isSelected());</span>
<span class="nc" id="L763">    m_amphibiousCheckBox.setEnabled(m_landBattleCheckBox.isSelected());</span>
<span class="nc" id="L764">    final boolean isLand = isLand();</span>
    try {
<span class="nc" id="L766">      m_data.acquireReadLock();</span>
      // do not include bombardment and aa guns in our &quot;total&quot; labels
<span class="nc" id="L768">      final List&lt;Unit&gt; attackers = Match.getMatches(m_attackingUnitsPanel.getUnits(),</span>
<span class="nc" id="L769">          Matches.UnitCanBeInBattle(true, isLand, m_data, 1, false, true, true));</span>
<span class="nc" id="L770">      final List&lt;Unit&gt; defenders = Match.getMatches(m_defendingUnitsPanel.getUnits(),</span>
<span class="nc" id="L771">          Matches.UnitCanBeInBattle(false, isLand, m_data, 1, false, true, true));</span>
<span class="nc" id="L772">      m_attackerUnitsTotalNumber.setText(&quot;Units: &quot; + attackers.size());</span>
<span class="nc" id="L773">      m_defenderUnitsTotalNumber.setText(&quot;Units: &quot; + defenders.size());</span>
<span class="nc" id="L774">      m_attackerUnitsTotalTUV.setText(&quot;TUV: &quot; + BattleCalculator.getTUV(attackers, getAttacker(),</span>
<span class="nc" id="L775">          BattleCalculator.getCostsForTUV(getAttacker(), m_data), m_data));</span>
<span class="nc" id="L776">      m_defenderUnitsTotalTUV.setText(&quot;TUV: &quot; + BattleCalculator.getTUV(defenders, getDefender(),</span>
<span class="nc" id="L777">          BattleCalculator.getCostsForTUV(getDefender(), m_data), m_data));</span>
<span class="nc" id="L778">      final int attackHP = BattleCalculator.getTotalHitpointsLeft(attackers);</span>
<span class="nc" id="L779">      final int defenseHP = BattleCalculator.getTotalHitpointsLeft(defenders);</span>
<span class="nc" id="L780">      m_attackerUnitsTotalHitpoints.setText(&quot;HP: &quot; + attackHP);</span>
<span class="nc" id="L781">      m_defenderUnitsTotalHitpoints.setText(&quot;HP: &quot; + defenseHP);</span>
<span class="nc" id="L782">      final boolean isAmphibiousBattle = isAmphibiousBattle();</span>
<span class="nc" id="L783">      final Collection&lt;TerritoryEffect&gt; territoryEffects = getTerritoryEffects();</span>
<span class="nc" id="L784">      final IntegerMap&lt;UnitType&gt; costs = BattleCalculator.getCostsForTUV(getAttacker(), m_data);</span>
<span class="nc" id="L785">      Collections.sort(attackers, new UnitBattleComparator(false, costs, territoryEffects, m_data, false, false));</span>
<span class="nc" id="L786">      Collections.reverse(attackers);</span>
<span class="nc" id="L787">      final int attackPower = DiceRoll.getTotalPower(DiceRoll.getUnitPowerAndRollsForNormalBattles(attackers, defenders,</span>
<span class="nc" id="L788">          false, false, m_data, m_location, territoryEffects, isAmphibiousBattle,</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">          (isAmphibiousBattle ? attackers : new ArrayList&lt;&gt;())), m_data);</span>
      // defender is never amphibious
<span class="nc" id="L791">      final int defensePower =</span>
          DiceRoll
<span class="nc" id="L793">              .getTotalPower(</span>
<span class="nc" id="L794">                  DiceRoll.getUnitPowerAndRollsForNormalBattles(defenders, attackers, true, false,</span>
<span class="nc" id="L795">                      m_data, m_location, territoryEffects, isAmphibiousBattle, new ArrayList&lt;&gt;()),</span>
<span class="nc" id="L796">                  m_data);</span>
<span class="nc" id="L797">      m_attackerUnitsTotalPower.setText(&quot;Power: &quot; + attackPower);</span>
<span class="nc" id="L798">      m_defenderUnitsTotalPower.setText(&quot;Power: &quot; + defensePower);</span>
<span class="nc" id="L799">    } finally {</span>
<span class="nc" id="L800">      m_data.releaseReadLock();</span>
<span class="nc" id="L801">    }</span>
<span class="nc" id="L802">  }</span>

<span class="nc" id="L804">  class PlayerRenderer extends DefaultListCellRenderer {</span>
    private static final long serialVersionUID = -7639128794342607309L;

    @Override
    public Component getListCellRendererComponent(final JList&lt;?&gt; list, final Object value, final int index,
        final boolean isSelected, final boolean cellHasFocus) {
<span class="nc" id="L810">      super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>
<span class="nc" id="L811">      final PlayerID id = (PlayerID) value;</span>
<span class="nc" id="L812">      setText(id.getName());</span>
<span class="nc" id="L813">      setIcon(new ImageIcon(m_context.getFlagImageFactory().getSmallFlag(id)));</span>
<span class="nc" id="L814">      return this;</span>
    }
  }

  public void selectCalculateButton() {
<span class="nc" id="L819">    m_calculateButton.requestFocus();</span>
<span class="nc" id="L820">  }</span>

  private static boolean doesPlayerHaveUnitsOnMap(final PlayerID player, final GameData data) {
<span class="nc bnc" id="L823" title="All 2 branches missed.">    for (final Territory t : data.getMap()) {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">      for (final Unit u : t.getUnits()) {</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">        if (u.getOwner().equals(player)) {</span>
<span class="nc" id="L826">          return true;</span>
        }
      }
    }
<span class="nc" id="L830">    return false;</span>
  }
}


class PlayerUnitsPanel extends JPanel {
  private static final long serialVersionUID = -1206338960403314681L;
  private final GameData m_data;
  private final IUIContext m_context;
  private final boolean m_defender;
<span class="nc" id="L840">  private boolean m_isLand = true;</span>
<span class="nc" id="L841">  private List&lt;UnitCategory&gt; m_categories = null;</span>
<span class="nc" id="L842">  private final ListenerList&lt;WidgetChangedListener&gt; m_listeners = new ListenerList&lt;&gt;();</span>
<span class="nc" id="L843">  private final WidgetChangedListener m_listenerUnitPanel = () -&gt; notifyListeners();</span>

<span class="nc" id="L845">  PlayerUnitsPanel(final GameData data, final IUIContext context, final boolean defender) {</span>
<span class="nc" id="L846">    m_data = data;</span>
<span class="nc" id="L847">    m_context = context;</span>
<span class="nc" id="L848">    m_defender = defender;</span>
<span class="nc" id="L849">    setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));</span>
<span class="nc" id="L850">  }</span>

  public void clear() {
<span class="nc bnc" id="L853" title="All 2 branches missed.">    for (final Component c : getComponents()) {</span>
<span class="nc" id="L854">      final UnitPanel panel = (UnitPanel) c;</span>
<span class="nc" id="L855">      panel.setCount(0);</span>
    }
<span class="nc" id="L857">  }</span>

  public List&lt;Unit&gt; getUnits() {
<span class="nc" id="L860">    final List&lt;Unit&gt; allUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">    for (final Component c : getComponents()) {</span>
<span class="nc" id="L862">      final UnitPanel panel = (UnitPanel) c;</span>
<span class="nc" id="L863">      allUnits.addAll(panel.getUnits());</span>
    }
<span class="nc" id="L865">    return allUnits;</span>
  }

  public List&lt;UnitCategory&gt; getCategories() {
<span class="nc" id="L869">    return m_categories;</span>
  }

  public void init(final PlayerID id, final List&lt;Unit&gt; units, final boolean land) {
<span class="nc" id="L873">    m_isLand = land;</span>
<span class="nc" id="L874">    m_categories = new ArrayList&lt;&gt;(categorize(id, units));</span>
<span class="nc" id="L875">    Collections.sort(m_categories, (o1, o2) -&gt; {</span>
<span class="nc" id="L876">      final UnitType ut1 = o1.getType();</span>
<span class="nc" id="L877">      final UnitType ut2 = o2.getType();</span>
<span class="nc" id="L878">      final UnitAttachment u1 = UnitAttachment.get(ut1);</span>
<span class="nc" id="L879">      final UnitAttachment u2 = UnitAttachment.get(ut2);</span>
      // for land, we want land, air, aa gun, then bombarding
<span class="nc bnc" id="L881" title="All 2 branches missed.">      if (land) {</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if (u1.getIsSea() != u2.getIsSea()) {</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">          return u1.getIsSea() ? 1 : -1;</span>
        }
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if (Matches.UnitTypeIsAAforAnything.match(ut1) != Matches.UnitTypeIsAAforAnything.match(ut2)) {</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">          return Matches.UnitTypeIsAAforAnything.match(ut1) ? 1 : -1;</span>
        }
<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (u1.getIsAir() != u2.getIsAir()) {</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">          return u1.getIsAir() ? 1 : -1;</span>
        }
      } else {
<span class="nc bnc" id="L892" title="All 2 branches missed.">        if (u1.getIsSea() != u2.getIsSea()) {</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">          return u1.getIsSea() ? -1 : 1;</span>
        }
      }
<span class="nc" id="L896">      return u1.getName().compareTo(u2.getName());</span>
    });
<span class="nc" id="L898">    removeAll();</span>
    Match&lt;UnitType&gt; predicate;
<span class="nc bnc" id="L900" title="All 2 branches missed.">    if (land) {</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">      if (m_defender) {</span>
<span class="nc" id="L902">        predicate = Matches.UnitTypeIsNotSea;</span>
<span class="nc" id="L903">      } else {</span>
<span class="nc" id="L904">        predicate = new CompositeMatchOr&lt;&gt;(Matches.UnitTypeIsNotSea, Matches.unitTypeCanBombard(id));</span>
      }
<span class="nc" id="L906">    } else {</span>
<span class="nc" id="L907">      predicate = Matches.UnitTypeIsSeaOrAir;</span>
    }
    final IntegerMap&lt;UnitType&gt; costs;
    try {
<span class="nc" id="L911">      m_data.acquireReadLock();</span>
<span class="nc" id="L912">      costs = BattleCalculator.getCostsForTUV(id, m_data);</span>
<span class="nc" id="L913">    } finally {</span>
<span class="nc" id="L914">      m_data.releaseReadLock();</span>
<span class="nc" id="L915">    }</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">    for (final UnitCategory category : m_categories) {</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">      if (predicate.match(category.getType())) {</span>
<span class="nc" id="L918">        final UnitPanel upanel = new UnitPanel(m_data, m_context, category, costs);</span>
<span class="nc" id="L919">        upanel.addChangeListener(m_listenerUnitPanel);</span>
<span class="nc" id="L920">        add(upanel);</span>
      }
    }
<span class="nc" id="L923">    invalidate();</span>
<span class="nc" id="L924">    validate();</span>
<span class="nc" id="L925">    revalidate();</span>
<span class="nc" id="L926">    getParent().invalidate();</span>
<span class="nc" id="L927">  }</span>

  private Set&lt;UnitCategory&gt; categorize(final PlayerID id, final List&lt;Unit&gt; units) {
    // these are the units that exist
<span class="nc" id="L931">    final Set&lt;UnitCategory&gt; categories = UnitSeperator.categorize(units);</span>
    // the units that can be produced or moved in
<span class="nc bnc" id="L933" title="All 2 branches missed.">    for (final UnitType t : getUnitTypes(id)) {</span>
<span class="nc" id="L934">      final UnitCategory category = new UnitCategory(t, id);</span>
<span class="nc" id="L935">      categories.add(category);</span>
    }
<span class="nc" id="L937">    return categories;</span>
  }

  /**
   * return all the unit types available for the given player. a unit type is
   * available if the unit is producable, or if a player has one
   */
  private Collection&lt;UnitType&gt; getUnitTypes(final PlayerID player) {
<span class="nc" id="L945">    Collection&lt;UnitType&gt; rVal = new HashSet&lt;&gt;();</span>
<span class="nc" id="L946">    final ProductionFrontier frontier = player.getProductionFrontier();</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">    if (frontier != null) {</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">      for (final ProductionRule rule : frontier) {</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">        for (final NamedAttachable type : rule.getResults().keySet()) {</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">          if (type instanceof UnitType) {</span>
<span class="nc" id="L951">            rVal.add((UnitType) type);</span>
          }
        }
      }
    }
<span class="nc bnc" id="L956" title="All 2 branches missed.">    for (final Territory t : m_data.getMap()) {</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">      for (final Unit u : t.getUnits()) {</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">        if (u.getOwner().equals(player)) {</span>
<span class="nc" id="L959">          rVal.add(u.getType());</span>
        }
      }
    }
    // we want to filter out anything like factories, or units that have no combat ability AND cannot be taken
    // casualty.
    // in addition, as of right now AA guns cannot fire on the offensive side, so we want to take them out too, unless
    // they have other
    // combat abilities.
<span class="nc" id="L968">    rVal = Match.getMatches(rVal,</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">        Matches.UnitTypeCanBeInBattle(!m_defender, m_isLand, player, m_data, 1, false, false, false));</span>
<span class="nc" id="L970">    return rVal;</span>
  }

  public void addChangeListener(final WidgetChangedListener listener) {
<span class="nc" id="L974">    m_listeners.add(listener);</span>
<span class="nc" id="L975">  }</span>

  public void removeChangeListener(final WidgetChangedListener listener) {
<span class="nc" id="L978">    m_listeners.remove(listener);</span>
<span class="nc" id="L979">  }</span>

  private void notifyListeners() {
<span class="nc bnc" id="L982" title="All 2 branches missed.">    for (final WidgetChangedListener listener : m_listeners) {</span>
<span class="nc" id="L983">      listener.widgetChanged();</span>
    }
<span class="nc" id="L985">  }</span>
}


class UnitPanel extends JPanel {
  private static final long serialVersionUID = 1509643150038705671L;
  private final IUIContext m_context;
  private final UnitCategory m_category;
  private final ScrollableTextField m_textField;
  private final GameData m_data;
<span class="nc" id="L995">  private final ListenerList&lt;WidgetChangedListener&gt; m_listeners = new ListenerList&lt;&gt;();</span>
<span class="nc" id="L996">  private final ScrollableTextFieldListener m_listenerTextField = field -&gt; notifyListeners();</span>

<span class="nc" id="L998">  public UnitPanel(final GameData data, final IUIContext context, final UnitCategory category,</span>
      final IntegerMap&lt;UnitType&gt; costs) {
<span class="nc" id="L1000">    m_category = category;</span>
<span class="nc" id="L1001">    m_context = context;</span>
<span class="nc" id="L1002">    m_data = data;</span>
<span class="nc" id="L1003">    m_textField = new ScrollableTextField(0, 512);</span>
<span class="nc" id="L1004">    m_textField.setShowMaxAndMin(false);</span>
<span class="nc" id="L1005">    m_textField.addChangeListener(m_listenerTextField);</span>

<span class="nc" id="L1007">    final String toolTipText = &quot;&lt;html&gt;&quot; + m_category.getType().getName() + &quot;:  &quot; + costs.getInt(m_category.getType())</span>
<span class="nc" id="L1008">        + &quot; cost, &lt;br /&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &quot; + m_category.getType().getTooltip(m_category.getOwner())</span>
<span class="nc" id="L1009">        + &quot;&lt;/html&gt;&quot;;</span>
<span class="nc" id="L1010">    setCount(m_category.getUnits().size());</span>
<span class="nc" id="L1011">    setLayout(new GridBagLayout());</span>


<span class="nc" id="L1014">    final Optional&lt;Image&gt; img =</span>
<span class="nc" id="L1015">        m_context.getUnitImageFactory().getImage(m_category.getType(), m_category.getOwner(), m_data,</span>
<span class="nc" id="L1016">            m_category.hasDamageOrBombingUnitDamage(), m_category.getDisabled());</span>

<span class="nc bnc" id="L1018" title="All 2 branches missed.">    final JLabel label = img.isPresent() ? new JLabel(new ImageIcon(img.get())) : new JLabel();</span>
<span class="nc" id="L1019">    label.setToolTipText(toolTipText);</span>
<span class="nc" id="L1020">    add(label, new GridBagConstraints(0, 0, 1, 1, 0, 0, GridBagConstraints.EAST, GridBagConstraints.NONE,</span>
<span class="nc" id="L1021">        new Insets(0, 0, 0, 10), 0, 0));</span>
<span class="nc" id="L1022">    add(m_textField, new GridBagConstraints(1, 0, 1, 1, 0, 0, GridBagConstraints.EAST, GridBagConstraints.NONE,</span>
<span class="nc" id="L1023">        new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L1024">  }</span>

  public List&lt;Unit&gt; getUnits() {
<span class="nc" id="L1027">    final List&lt;Unit&gt; units = m_category.getType().create(m_textField.getValue(), m_category.getOwner(), true);</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">    if (!units.isEmpty()) {</span>
      // creating the unit just makes it, we want to make sure it is damaged if the category says it is damaged
<span class="nc bnc" id="L1030" title="All 4 branches missed.">      if (m_category.getHitPoints() &gt; 1 &amp;&amp; m_category.getDamaged() &gt; 0) {</span>
        // we do not need to use bridge and change factory here because this is not sent over the network. these are
        // just some temporary
        // units for the battle calc.
<span class="nc bnc" id="L1034" title="All 2 branches missed.">        for (final Unit u : units) {</span>
<span class="nc" id="L1035">          u.setHits(m_category.getDamaged());</span>
        }
      }
<span class="nc bnc" id="L1038" title="All 4 branches missed.">      if (m_category.getDisabled() &amp;&amp; Matches.UnitTypeCanBeDamaged.match(m_category.getType())) {</span>
        // add 1 because it is the max operational damage and we want to disable it
<span class="nc" id="L1040">        final int uDamage = Math.max(0, 1 + UnitAttachment.get(m_category.getType()).getMaxOperationalDamage());</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">        for (final Unit u : units) {</span>
<span class="nc" id="L1042">          ((TripleAUnit) u).setUnitDamage(uDamage);</span>
        }
      }
    }
<span class="nc" id="L1046">    return units;</span>
  }

  public int getCount() {
<span class="nc" id="L1050">    return m_textField.getValue();</span>
  }

  public void setCount(final int value) {
<span class="nc" id="L1054">    m_textField.setValue(value);</span>
<span class="nc" id="L1055">  }</span>

  public UnitCategory getCategory() {
<span class="nc" id="L1058">    return m_category;</span>
  }

  public void addChangeListener(final WidgetChangedListener listener) {
<span class="nc" id="L1062">    m_listeners.add(listener);</span>
<span class="nc" id="L1063">  }</span>

  public void removeChangeListener(final WidgetChangedListener listener) {
<span class="nc" id="L1066">    m_listeners.remove(listener);</span>
<span class="nc" id="L1067">  }</span>

  private void notifyListeners() {
<span class="nc bnc" id="L1070" title="All 2 branches missed.">    for (final WidgetChangedListener listener : m_listeners) {</span>
<span class="nc" id="L1071">      listener.widgetChanged();</span>
    }
<span class="nc" id="L1073">  }</span>
}


class OrderOfLossesInputPanel extends JPanel {
  private static final long serialVersionUID = 8815617685388156219L;
  private final GameData m_data;
  private final IUIContext m_context;
  private final List&lt;UnitCategory&gt; m_attackerCategories;
  private final List&lt;UnitCategory&gt; m_defenderCategories;
  private final JTextField m_attackerTextField;
  private final JTextField m_defenderTextField;
<span class="nc" id="L1085">  private final JLabel m_attackerLabel = new JLabel(&quot;Attacker Units:&quot;);</span>
<span class="nc" id="L1086">  private final JLabel m_defenderLabel = new JLabel(&quot;Defender Units:&quot;);</span>
  private final JButton m_clear;
  private final boolean m_land;

<span class="nc" id="L1090">  public OrderOfLossesInputPanel(final String attackerOrder, final String defenderOrder,</span>
      final List&lt;UnitCategory&gt; attackerCategories, final List&lt;UnitCategory&gt; defenderCategories, final boolean land,
      final IUIContext context, final GameData data) {
<span class="nc" id="L1093">    m_data = data;</span>
<span class="nc" id="L1094">    m_context = context;</span>
<span class="nc" id="L1095">    m_land = land;</span>
<span class="nc" id="L1096">    m_attackerCategories = attackerCategories;</span>
<span class="nc" id="L1097">    m_defenderCategories = defenderCategories;</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">    m_attackerTextField = new JTextField(attackerOrder == null ? &quot;&quot; : attackerOrder);</span>
<span class="nc" id="L1099">    m_attackerTextField.getDocument().addDocumentListener(new DocumentListener() {</span>
      @Override
      public void insertUpdate(final DocumentEvent e) {
<span class="nc bnc" id="L1102" title="All 2 branches missed.">        if (!OddsCalculator.isValidOrderOfLoss(m_attackerTextField.getText(), m_data)) {</span>
<span class="nc" id="L1103">          m_attackerLabel.setForeground(Color.red);</span>
<span class="nc" id="L1104">        } else {</span>
<span class="nc" id="L1105">          m_attackerLabel.setForeground(null);</span>
        }
<span class="nc" id="L1107">      }</span>

      @Override
      public void removeUpdate(final DocumentEvent e) {
<span class="nc bnc" id="L1111" title="All 2 branches missed.">        if (!OddsCalculator.isValidOrderOfLoss(m_attackerTextField.getText(), m_data)) {</span>
<span class="nc" id="L1112">          m_attackerLabel.setForeground(Color.red);</span>
<span class="nc" id="L1113">        } else {</span>
<span class="nc" id="L1114">          m_attackerLabel.setForeground(null);</span>
        }
<span class="nc" id="L1116">      }</span>

      @Override
      public void changedUpdate(final DocumentEvent e) {
<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if (!OddsCalculator.isValidOrderOfLoss(m_attackerTextField.getText(), m_data)) {</span>
<span class="nc" id="L1121">          m_attackerLabel.setForeground(Color.red);</span>
<span class="nc" id="L1122">        } else {</span>
<span class="nc" id="L1123">          m_attackerLabel.setForeground(null);</span>
        }
<span class="nc" id="L1125">      }</span>
    });
<span class="nc bnc" id="L1127" title="All 2 branches missed.">    m_defenderTextField = new JTextField(defenderOrder == null ? &quot;&quot; : defenderOrder);</span>
<span class="nc" id="L1128">    m_defenderTextField.getDocument().addDocumentListener(new DocumentListener() {</span>
      @Override
      public void insertUpdate(final DocumentEvent e) {
<span class="nc bnc" id="L1131" title="All 2 branches missed.">        if (!OddsCalculator.isValidOrderOfLoss(m_defenderTextField.getText(), m_data)) {</span>
<span class="nc" id="L1132">          m_defenderLabel.setForeground(Color.red);</span>
<span class="nc" id="L1133">        } else {</span>
<span class="nc" id="L1134">          m_defenderLabel.setForeground(null);</span>
        }
<span class="nc" id="L1136">      }</span>

      @Override
      public void removeUpdate(final DocumentEvent e) {
<span class="nc bnc" id="L1140" title="All 2 branches missed.">        if (!OddsCalculator.isValidOrderOfLoss(m_defenderTextField.getText(), m_data)) {</span>
<span class="nc" id="L1141">          m_defenderLabel.setForeground(Color.red);</span>
<span class="nc" id="L1142">        } else {</span>
<span class="nc" id="L1143">          m_defenderLabel.setForeground(null);</span>
        }
<span class="nc" id="L1145">      }</span>

      @Override
      public void changedUpdate(final DocumentEvent e) {
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        if (!OddsCalculator.isValidOrderOfLoss(m_defenderTextField.getText(), m_data)) {</span>
<span class="nc" id="L1150">          m_defenderLabel.setForeground(Color.red);</span>
<span class="nc" id="L1151">        } else {</span>
<span class="nc" id="L1152">          m_defenderLabel.setForeground(null);</span>
        }
<span class="nc" id="L1154">      }</span>
    });
<span class="nc" id="L1156">    m_clear = new JButton(&quot;Clear&quot;);</span>
<span class="nc" id="L1157">    m_clear.addActionListener(e -&gt; {</span>
<span class="nc" id="L1158">      m_attackerTextField.setText(&quot;&quot;);</span>
<span class="nc" id="L1159">      m_defenderTextField.setText(&quot;&quot;);</span>
<span class="nc" id="L1160">    });</span>
<span class="nc" id="L1161">    layoutComponents();</span>
<span class="nc" id="L1162">  }</span>

  private void layoutComponents() {
<span class="nc" id="L1165">    this.setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));</span>
<span class="nc" id="L1166">    final JLabel instructions = new JLabel(&quot;&lt;html&gt;Here you can specify the 'Order of Losses' (OOL) for each side.&quot;</span>
        + &quot;&lt;br /&gt;Damageable units will be damanged first always. If the player label is red, your OOL is invalid.&quot;
        + &quot;&lt;br /&gt;The engine will take your input and add all units to a list starting on the RIGHT side of your text line.&quot;
        + &quot;&lt;br /&gt;Then, during combat, casualties will be chosen starting on the LEFT side of your OOL.&quot; + &quot;&lt;br /&gt;&quot;
        + OddsCalculator.OOL_SEPARATOR + &quot; separates unit types.&quot; + &quot;&lt;br /&gt;&quot; + OddsCalculator.OOL_AMOUNT_DESCRIPTOR
        + &quot; is in front of the unit type and describes the number of units.&quot; + &quot;&lt;br /&gt;&quot; + OddsCalculator.OOL_ALL
        + &quot; means all units of that type.&quot; + &quot;&lt;br /&gt;Examples:&quot; + &quot;&lt;br /&gt;&quot; + OddsCalculator.OOL_ALL
        + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;infantry&quot; + OddsCalculator.OOL_SEPARATOR + OddsCalculator.OOL_ALL
        + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;artillery&quot; + OddsCalculator.OOL_SEPARATOR + OddsCalculator.OOL_ALL
        + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;fighter&quot;
        + &quot;&lt;br /&gt;The above will take all infantry, then all artillery, then all fighters, then all other units as casualty.&quot;
        + &quot;&lt;br /&gt;&lt;br /&gt;1&quot; + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;infantry&quot; + OddsCalculator.OOL_SEPARATOR + &quot;2&quot;
        + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;artillery&quot; + OddsCalculator.OOL_SEPARATOR + &quot;6&quot;
        + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;fighter&quot;
        + &quot;&lt;br /&gt;The above will take 1 infantry, then 2 artillery, then 6 fighters, then all other units as casualty.&quot;
        + &quot;&lt;br /&gt;&lt;br /&gt;&quot; + OddsCalculator.OOL_ALL + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;infantry&quot;
        + OddsCalculator.OOL_SEPARATOR + OddsCalculator.OOL_ALL + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;fighter&quot;
        + OddsCalculator.OOL_SEPARATOR + &quot;1&quot; + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + &quot;infantry&quot;
        + &quot;&lt;br /&gt;The above will take all except 1 infantry casualty, then all fighters, then the last infantry, then all other units casualty.&lt;/html&gt;&quot;);
<span class="nc" id="L1185">    instructions.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1186">    this.add(instructions);</span>
<span class="nc" id="L1187">    this.add(Box.createVerticalStrut(30));</span>
<span class="nc" id="L1188">    m_attackerLabel.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1189">    this.add(m_attackerLabel);</span>
<span class="nc" id="L1190">    final JPanel attackerUnits = getUnitButtonPanel(m_attackerCategories, m_attackerTextField);</span>
<span class="nc" id="L1191">    attackerUnits.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1192">    this.add(attackerUnits);</span>
<span class="nc" id="L1193">    m_attackerTextField.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1194">    this.add(m_attackerTextField);</span>
<span class="nc" id="L1195">    this.add(Box.createVerticalStrut(30));</span>
<span class="nc" id="L1196">    m_defenderLabel.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1197">    this.add(m_defenderLabel);</span>
<span class="nc" id="L1198">    final JPanel defenderUnits = getUnitButtonPanel(m_defenderCategories, m_defenderTextField);</span>
<span class="nc" id="L1199">    defenderUnits.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1200">    this.add(defenderUnits);</span>
<span class="nc" id="L1201">    m_defenderTextField.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1202">    this.add(m_defenderTextField);</span>
<span class="nc" id="L1203">    this.add(Box.createVerticalStrut(10));</span>
<span class="nc" id="L1204">    m_clear.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L1205">    this.add(m_clear);</span>
<span class="nc" id="L1206">  }</span>

  private JPanel getUnitButtonPanel(final List&lt;UnitCategory&gt; categories, final JTextField textField) {
<span class="nc" id="L1209">    final JPanel panel = new JPanel();</span>
<span class="nc" id="L1210">    panel.setLayout(new BoxLayout(panel, BoxLayout.X_AXIS));</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">    if (categories != null) {</span>
<span class="nc" id="L1212">      final Set&lt;UnitType&gt; typesUsed = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">      for (final UnitCategory category : categories) {</span>
        // no duplicates or infrastructure allowed. no sea if land, no land if sea.
<span class="nc bnc" id="L1215" title="All 4 branches missed.">        if (typesUsed.contains(category.getType()) || Matches.UnitTypeIsInfrastructure.match(category.getType())</span>
<span class="nc bnc" id="L1216" title="All 4 branches missed.">            || (m_land &amp;&amp; Matches.UnitTypeIsSea.match(category.getType()))</span>
<span class="nc bnc" id="L1217" title="All 4 branches missed.">            || (!m_land &amp;&amp; Matches.UnitTypeIsLand.match(category.getType()))) {</span>
<span class="nc" id="L1218">          continue;</span>
        }
<span class="nc" id="L1220">        final String unitName =</span>
<span class="nc" id="L1221">            OddsCalculator.OOL_ALL + OddsCalculator.OOL_AMOUNT_DESCRIPTOR + category.getType().getName();</span>
<span class="nc" id="L1222">        final String toolTipText = &quot;&lt;html&gt;&quot; + category.getType().getName() + &quot;:  &quot;</span>
<span class="nc" id="L1223">            + category.getType().getTooltip(category.getOwner()) + &quot;&lt;/html&gt;&quot;;</span>
<span class="nc" id="L1224">        final Optional&lt;Image&gt; img =</span>
<span class="nc" id="L1225">            m_context.getUnitImageFactory().getImage(category.getType(), category.getOwner(), m_data,</span>
<span class="nc" id="L1226">                category.hasDamageOrBombingUnitDamage(), category.getDisabled());</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">        if (img.isPresent()) {</span>
<span class="nc" id="L1228">          final JButton button = new JButton(new ImageIcon(img.get()));</span>
<span class="nc" id="L1229">          button.setToolTipText(toolTipText);</span>
<span class="nc" id="L1230">          button.addActionListener(e -&gt; textField</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">              .setText((textField.getText().length() &gt; 0 ? (textField.getText() + OddsCalculator.OOL_SEPARATOR) : &quot;&quot;)</span>
<span class="nc" id="L1232">                  + unitName));</span>
<span class="nc" id="L1233">          panel.add(button);</span>
        }
<span class="nc" id="L1235">        typesUsed.add(category.getType());</span>
      }
    }
<span class="nc" id="L1238">    return panel;</span>
  }

  public String getAttackerOrder() {
<span class="nc" id="L1242">    return m_attackerTextField.getText();</span>
  }

  public String getDefenderOrder() {
<span class="nc" id="L1246">    return m_defenderTextField.getText();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>test (25/nov/2016 10:16:58)</div></body></html>