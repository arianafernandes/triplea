<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>TripleAFrame.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (25/nov/2016 10:16:58)</a> &gt; <a href="../../index.html" class="el_group">triplea</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">games.strategy.triplea.ui</a> &gt; <span class="el_source">TripleAFrame.java</span></div><h1>TripleAFrame.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package games.strategy.triplea.ui;</span>

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.Frame;
import java.awt.Graphics;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Image;
import java.awt.Insets;
import java.awt.MouseInfo;
import java.awt.Point;
import java.awt.event.ActionEvent;
import java.awt.event.FocusAdapter;
import java.awt.event.FocusEvent;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.awt.event.WindowListener;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectOutputStream;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.Set;
import java.util.Vector;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.atomic.AtomicReference;

import javax.swing.AbstractAction;
import javax.swing.Action;
import javax.swing.BorderFactory;
import javax.swing.BoxLayout;
import javax.swing.ButtonModel;
import javax.swing.ImageIcon;
import javax.swing.JComponent;
import javax.swing.JDialog;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JSplitPane;
import javax.swing.JTabbedPane;
import javax.swing.JTextArea;
import javax.swing.JToggleButton;
import javax.swing.JToolTip;
import javax.swing.KeyStroke;
import javax.swing.ListSelectionModel;
import javax.swing.Popup;
import javax.swing.PopupFactory;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.WindowConstants;
import javax.swing.border.EmptyBorder;
import javax.swing.border.EtchedBorder;
import javax.swing.tree.DefaultMutableTreeNode;

import com.google.common.base.Joiner;
import com.google.common.collect.FluentIterable;
import com.google.common.collect.ImmutableList;

import games.strategy.debug.ClientLogger;
import games.strategy.engine.ClientContext;
import games.strategy.engine.chat.ChatPanel;
import games.strategy.engine.chat.PlayerChatRenderer;
import games.strategy.engine.data.Change;
import games.strategy.engine.data.GameData;
import games.strategy.engine.data.PlayerID;
import games.strategy.engine.data.ProductionRule;
import games.strategy.engine.data.RepairRule;
import games.strategy.engine.data.Resource;
import games.strategy.engine.data.ResourceCollection;
import games.strategy.engine.data.Route;
import games.strategy.engine.data.Territory;
import games.strategy.engine.data.TerritoryEffect;
import games.strategy.engine.data.Unit;
import games.strategy.engine.data.changefactory.ChangeFactory;
import games.strategy.engine.data.events.GameDataChangeListener;
import games.strategy.engine.data.events.GameStepListener;
import games.strategy.engine.framework.ClientGame;
import games.strategy.engine.framework.GameDataManager;
import games.strategy.engine.framework.GameDataUtils;
import games.strategy.engine.framework.HistorySynchronizer;
import games.strategy.engine.framework.IGame;
import games.strategy.engine.framework.LocalPlayers;
import games.strategy.engine.framework.ServerGame;
import games.strategy.engine.framework.startup.ui.InGameLobbyWatcherWrapper;
import games.strategy.engine.framework.startup.ui.MainFrame;
import games.strategy.engine.framework.system.SystemProperties;
import games.strategy.engine.gamePlayer.IGamePlayer;
import games.strategy.engine.gamePlayer.IPlayerBridge;
import games.strategy.engine.history.HistoryNode;
import games.strategy.engine.history.Renderable;
import games.strategy.engine.history.Round;
import games.strategy.engine.history.Step;
import games.strategy.sound.ClipPlayer;
import games.strategy.sound.SoundPath;
import games.strategy.thread.ThreadPool;
import games.strategy.triplea.TripleAPlayer;
import games.strategy.triplea.ai.proAI.ProAI;
import games.strategy.triplea.attachments.AbstractConditionsAttachment;
import games.strategy.triplea.attachments.AbstractTriggerAttachment;
import games.strategy.triplea.attachments.PoliticalActionAttachment;
import games.strategy.triplea.attachments.TerritoryAttachment;
import games.strategy.triplea.attachments.UnitAttachment;
import games.strategy.triplea.attachments.UserActionAttachment;
import games.strategy.triplea.delegate.AbstractEndTurnDelegate;
import games.strategy.triplea.delegate.AirThatCantLandUtil;
import games.strategy.triplea.delegate.BaseEditDelegate;
import games.strategy.triplea.delegate.BattleCalculator;
import games.strategy.triplea.delegate.BattleDelegate;
import games.strategy.triplea.delegate.GameStepPropertiesHelper;
import games.strategy.triplea.delegate.IBattle.BattleType;
import games.strategy.triplea.delegate.Matches;
import games.strategy.triplea.delegate.TerritoryEffectHelper;
import games.strategy.triplea.delegate.UnitBattleComparator;
import games.strategy.triplea.delegate.dataObjects.FightBattleDetails;
import games.strategy.triplea.delegate.dataObjects.MoveDescription;
import games.strategy.triplea.delegate.dataObjects.TechResults;
import games.strategy.triplea.delegate.dataObjects.TechRoll;
import games.strategy.triplea.delegate.remote.IEditDelegate;
import games.strategy.triplea.delegate.remote.IPoliticsDelegate;
import games.strategy.triplea.delegate.remote.IUserActionDelegate;
import games.strategy.triplea.formatter.MyFormatter;
import games.strategy.triplea.image.TileImageFactory;
import games.strategy.triplea.settings.scrolling.ScrollSettings;
import games.strategy.triplea.ui.history.HistoryDetailsPanel;
import games.strategy.triplea.ui.history.HistoryLog;
import games.strategy.triplea.ui.history.HistoryPanel;
import games.strategy.triplea.ui.menubar.ExportMenu;
import games.strategy.triplea.ui.menubar.HelpMenu;
import games.strategy.triplea.ui.menubar.TripleAMenuBar;
import games.strategy.triplea.ui.screen.UnitsDrawer;
import games.strategy.ui.ImageScrollModel;
import games.strategy.ui.ScrollableTextField;
import games.strategy.ui.SwingAction;
import games.strategy.ui.Util;
import games.strategy.util.EventThreadJOptionPane;
import games.strategy.util.IntegerMap;
import games.strategy.util.LocalizeHTML;
import games.strategy.util.Match;
import games.strategy.util.ThreadUtil;
import games.strategy.util.Tuple;

/**
 * Main frame for the triple a game
 */
public class TripleAFrame extends MainGameFrame {
  private static final long serialVersionUID = 7640069668264418976L;
  private GameData data;
  private IGame game;
  private MapPanel mapPanel;
  private MapPanelSmallView smallView;
<span class="nc" id="L170">  private final JLabel message = new JLabel(&quot;No selection&quot;);</span>
<span class="nc" id="L171">  private final JLabel status = new JLabel(&quot;&quot;);</span>
<span class="nc" id="L172">  private final JLabel step = new JLabel(&quot;xxxxxx&quot;);</span>
<span class="nc" id="L173">  private final JLabel round = new JLabel(&quot;xxxxxx&quot;);</span>
<span class="nc" id="L174">  private final JLabel player = new JLabel(&quot;xxxxxx&quot;);</span>
  private ActionButtons actionButtons;
<span class="nc" id="L176">  private final JPanel gameMainPanel = new JPanel();</span>
<span class="nc" id="L177">  private final JPanel rightHandSidePanel = new JPanel();</span>
<span class="nc" id="L178">  private final JTabbedPane tabsPanel = new JTabbedPane();</span>
  private StatPanel statsPanel;
  private EconomyPanel economyPanel;
  private ObjectivePanel objectivePanel;
  private NotesPanel notesPanel;
  private TerritoryDetailPanel details;
<span class="nc" id="L184">  private final JPanel historyComponent = new JPanel();</span>
  private JPanel gameSouthPanel;
  private HistoryPanel historyPanel;
<span class="nc" id="L187">  private boolean inHistory = false;</span>
<span class="nc" id="L188">  private boolean inGame = true;</span>
  private HistorySynchronizer historySyncher;
  private IUIContext uiContext;
  private JPanel mapAndChatPanel;
  private ChatPanel chatPanel;
  private CommentPanel commentPanel;
  private JSplitPane chatSplit;
  private JSplitPane commentSplit;
  private EditPanel editPanel;
  private final ButtonModel editModeButtonModel;
  private final ButtonModel showCommentLogButtonModel;
  private IEditDelegate editDelegate;
  private JSplitPane gameCenterPanel;
  private Territory territoryLastEntered;
  private List&lt;Unit&gt; unitsBeingMousedOver;
  private PlayerID lastStepPlayer;
  private PlayerID currentStepPlayer;
<span class="nc" id="L205">  private final Map&lt;PlayerID, Boolean&gt; requiredTurnSeries = new HashMap&lt;&gt;();</span>
  private ThreadPool messageAndDialogThreadPool;
  private TripleAMenuBar menu;
  private final ScrollSettings scrollSettings;

  /** Creates new TripleAFrame */
  public TripleAFrame(final IGame game, final LocalPlayers players) {
<span class="nc" id="L212">    super(&quot;TripleA - &quot; + game.getData().getGameName(), players);</span>
<span class="nc" id="L213">    scrollSettings = ClientContext.scrollSettings();</span>
<span class="nc" id="L214">    this.game = game;</span>
<span class="nc" id="L215">    data = game.getData();</span>
<span class="nc" id="L216">    messageAndDialogThreadPool = new ThreadPool(1);</span>
<span class="nc" id="L217">    addZoomKeyboardShortcuts();</span>
<span class="nc" id="L218">    this.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L219">    final WindowListener WINDOW_LISTENER = new WindowAdapter() {</span>
      @Override
      public void windowClosing(final WindowEvent e) {
<span class="nc" id="L222">        leaveGame();</span>
<span class="nc" id="L223">      }</span>
    };
<span class="nc" id="L225">    this.addWindowListener(WINDOW_LISTENER);</span>
<span class="nc" id="L226">    uiContext = new UIContext();</span>
<span class="nc" id="L227">    uiContext.setDefaultMapDir(game.getData());</span>
<span class="nc" id="L228">    uiContext.getMapData().verify(data);</span>
<span class="nc" id="L229">    uiContext.setLocalPlayers(players);</span>
<span class="nc" id="L230">    this.setCursor(uiContext.getCursor());</span>
    // initialize m_editModeButtonModel before createMenuBar()
<span class="nc" id="L232">    editModeButtonModel = new JToggleButton.ToggleButtonModel();</span>
<span class="nc" id="L233">    editModeButtonModel.setEnabled(false);</span>
<span class="nc" id="L234">    showCommentLogButtonModel = new JToggleButton.ToggleButtonModel();</span>
<span class="nc" id="L235">    final AbstractAction m_showCommentLogAction = new AbstractAction() {</span>
      private static final long serialVersionUID = 3964381772343872268L;

      @Override
      public void actionPerformed(final ActionEvent ae) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (showCommentLogButtonModel.isSelected()) {</span>
<span class="nc" id="L241">          showCommentLog();</span>
<span class="nc" id="L242">        } else {</span>
<span class="nc" id="L243">          hideCommentLog();</span>
        }
<span class="nc" id="L245">      }</span>

      private void hideCommentLog() {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (chatPanel != null) {</span>
<span class="nc" id="L249">          commentSplit.setBottomComponent(null);</span>
<span class="nc" id="L250">          chatSplit.setBottomComponent(chatPanel);</span>
<span class="nc" id="L251">          chatSplit.validate();</span>
<span class="nc" id="L252">        } else {</span>
<span class="nc" id="L253">          mapAndChatPanel.removeAll();</span>
<span class="nc" id="L254">          chatSplit.setTopComponent(null);</span>
<span class="nc" id="L255">          chatSplit.setBottomComponent(null);</span>
<span class="nc" id="L256">          mapAndChatPanel.add(mapPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L257">          mapAndChatPanel.validate();</span>
        }
<span class="nc" id="L259">      }</span>

      private void showCommentLog() {
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (chatPanel != null) {</span>
<span class="nc" id="L263">          commentSplit.setBottomComponent(chatPanel);</span>
<span class="nc" id="L264">          chatSplit.setBottomComponent(commentSplit);</span>
<span class="nc" id="L265">          chatSplit.validate();</span>
<span class="nc" id="L266">        } else {</span>
<span class="nc" id="L267">          mapAndChatPanel.removeAll();</span>
<span class="nc" id="L268">          chatSplit.setTopComponent(mapPanel);</span>
<span class="nc" id="L269">          chatSplit.setBottomComponent(commentPanel);</span>
<span class="nc" id="L270">          mapAndChatPanel.add(chatSplit, BorderLayout.CENTER);</span>
<span class="nc" id="L271">          mapAndChatPanel.validate();</span>
        }
<span class="nc" id="L273">      }</span>
    };
<span class="nc" id="L275">    showCommentLogButtonModel.addActionListener(m_showCommentLogAction);</span>
<span class="nc" id="L276">    showCommentLogButtonModel.setSelected(false);</span>
<span class="nc" id="L277">    menu = new TripleAMenuBar(this);</span>
<span class="nc" id="L278">    this.setJMenuBar(menu);</span>
<span class="nc" id="L279">    final ImageScrollModel model = new ImageScrollModel();</span>
<span class="nc" id="L280">    model.setScrollX(uiContext.getMapData().scrollWrapX());</span>
<span class="nc" id="L281">    model.setScrollY(uiContext.getMapData().scrollWrapY());</span>
<span class="nc" id="L282">    model.setMaxBounds(uiContext.getMapData().getMapDimensions().width,</span>
<span class="nc" id="L283">        uiContext.getMapData().getMapDimensions().height);</span>
<span class="nc" id="L284">    final Image small = uiContext.getMapImage().getSmallMapImage();</span>
<span class="nc" id="L285">    smallView = new MapPanelSmallView(small, model);</span>
<span class="nc" id="L286">    mapPanel = new MapPanel(data, smallView, uiContext, model);</span>
<span class="nc" id="L287">    mapPanel.addMapSelectionListener(MAP_SELECTION_LISTENER);</span>
<span class="nc" id="L288">    final MouseOverUnitListener MOUSE_OVER_UNIT_LISTENER = (units, territory, me) -&gt; unitsBeingMousedOver = units;</span>
<span class="nc" id="L289">    mapPanel.addMouseOverUnitListener(MOUSE_OVER_UNIT_LISTENER);</span>
    // link the small and large images
<span class="nc" id="L291">    mapPanel.initSmallMap();</span>
<span class="nc" id="L292">    mapAndChatPanel = new JPanel();</span>
<span class="nc" id="L293">    mapAndChatPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L294">    commentPanel = new CommentPanel(this, data);</span>
<span class="nc" id="L295">    chatSplit = new JSplitPane();</span>
<span class="nc" id="L296">    chatSplit.setOrientation(JSplitPane.VERTICAL_SPLIT);</span>
<span class="nc" id="L297">    chatSplit.setOneTouchExpandable(true);</span>
<span class="nc" id="L298">    chatSplit.setDividerSize(8);</span>
<span class="nc" id="L299">    chatSplit.setResizeWeight(0.95);</span>
<span class="nc bnc" id="L300" title="All 4 branches missed.">    if (MainFrame.getInstance() != null &amp;&amp; MainFrame.getInstance().getChat() != null) {</span>
<span class="nc" id="L301">      commentSplit = new JSplitPane();</span>
<span class="nc" id="L302">      commentSplit.setOrientation(JSplitPane.VERTICAL_SPLIT);</span>
<span class="nc" id="L303">      commentSplit.setOneTouchExpandable(true);</span>
<span class="nc" id="L304">      commentSplit.setDividerSize(8);</span>
<span class="nc" id="L305">      commentSplit.setResizeWeight(0.5);</span>
<span class="nc" id="L306">      commentSplit.setTopComponent(commentPanel);</span>
<span class="nc" id="L307">      commentSplit.setBottomComponent(null);</span>
<span class="nc" id="L308">      chatPanel = new ChatPanel(MainFrame.getInstance().getChat());</span>
<span class="nc" id="L309">      chatPanel.setPlayerRenderer(new PlayerChatRenderer(this.game, uiContext));</span>
<span class="nc" id="L310">      final Dimension chatPrefSize = new Dimension((int) chatPanel.getPreferredSize().getWidth(), 95);</span>
<span class="nc" id="L311">      chatPanel.setPreferredSize(chatPrefSize);</span>
<span class="nc" id="L312">      chatSplit.setTopComponent(mapPanel);</span>
<span class="nc" id="L313">      chatSplit.setBottomComponent(chatPanel);</span>
<span class="nc" id="L314">      mapAndChatPanel.add(chatSplit, BorderLayout.CENTER);</span>
<span class="nc" id="L315">    } else {</span>
<span class="nc" id="L316">      mapAndChatPanel.add(mapPanel, BorderLayout.CENTER);</span>
    }
<span class="nc" id="L318">    gameMainPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L319">    this.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L320">    this.getContentPane().add(gameMainPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L321">    gameSouthPanel = new JPanel();</span>
<span class="nc" id="L322">    gameSouthPanel.setLayout(new BorderLayout());</span>
    // m_gameSouthPanel.add(m_message, BorderLayout.WEST);
<span class="nc" id="L324">    message.setBorder(new EtchedBorder(EtchedBorder.RAISED));</span>
<span class="nc" id="L325">    message.setPreferredSize(message.getPreferredSize());</span>
<span class="nc" id="L326">    message.setText(&quot;some text to set a reasonable preferred size&quot;);</span>
<span class="nc" id="L327">    status.setText(&quot;some text to set a reasonable preferred size for movement error messages&quot;);</span>
<span class="nc" id="L328">    message.setPreferredSize(message.getPreferredSize());</span>
<span class="nc" id="L329">    status.setPreferredSize(message.getPreferredSize());</span>
<span class="nc" id="L330">    message.setText(&quot;&quot;);</span>
<span class="nc" id="L331">    status.setText(&quot;&quot;);</span>
    // m_gameSouthPanel.add(m_status, BorderLayout.CENTER);
<span class="nc" id="L333">    final JPanel bottomMessagePanel = new JPanel();</span>
<span class="nc" id="L334">    bottomMessagePanel.setLayout(new GridBagLayout());</span>
<span class="nc" id="L335">    bottomMessagePanel.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L336">    bottomMessagePanel.add(message, new GridBagConstraints(0, 0, 1, 1, .35, 1, GridBagConstraints.WEST,</span>
<span class="nc" id="L337">        GridBagConstraints.BOTH, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L338">    bottomMessagePanel.add(status, new GridBagConstraints(1, 0, 1, 1, .65, 1, GridBagConstraints.CENTER,</span>
<span class="nc" id="L339">        GridBagConstraints.BOTH, new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L340">    gameSouthPanel.add(bottomMessagePanel, BorderLayout.CENTER);</span>
<span class="nc" id="L341">    status.setBorder(new EtchedBorder(EtchedBorder.RAISED));</span>
<span class="nc" id="L342">    final JPanel stepPanel = new JPanel();</span>
<span class="nc" id="L343">    stepPanel.setLayout(new GridBagLayout());</span>
<span class="nc" id="L344">    stepPanel.add(step, new GridBagConstraints(1, 0, 1, 1, 0, 0, GridBagConstraints.EAST, GridBagConstraints.BOTH,</span>
<span class="nc" id="L345">        new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L346">    stepPanel.add(player, new GridBagConstraints(0, 0, 1, 1, 0, 0, GridBagConstraints.EAST, GridBagConstraints.BOTH,</span>
<span class="nc" id="L347">        new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L348">    stepPanel.add(round, new GridBagConstraints(2, 0, 1, 1, 0, 0, GridBagConstraints.EAST, GridBagConstraints.BOTH,</span>
<span class="nc" id="L349">        new Insets(0, 0, 0, 0), 0, 0));</span>
<span class="nc" id="L350">    step.setBorder(new EtchedBorder(EtchedBorder.RAISED));</span>
<span class="nc" id="L351">    round.setBorder(new EtchedBorder(EtchedBorder.RAISED));</span>
<span class="nc" id="L352">    player.setBorder(new EtchedBorder(EtchedBorder.RAISED));</span>
<span class="nc" id="L353">    step.setHorizontalTextPosition(SwingConstants.LEADING);</span>
<span class="nc" id="L354">    gameSouthPanel.add(stepPanel, BorderLayout.EAST);</span>
<span class="nc" id="L355">    gameMainPanel.add(gameSouthPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L356">    rightHandSidePanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L357">    final FocusAdapter focusToMapPanelFocusListener = new FocusAdapter() {</span>
      @Override
      public void focusGained(final FocusEvent e) {
        // give the focus back to the map panel
<span class="nc" id="L361">        mapPanel.requestFocusInWindow();</span>
<span class="nc" id="L362">      }</span>
    };
<span class="nc" id="L364">    rightHandSidePanel.addFocusListener(focusToMapPanelFocusListener);</span>
<span class="nc" id="L365">    smallView.addFocusListener(focusToMapPanelFocusListener);</span>
<span class="nc" id="L366">    tabsPanel.addFocusListener(focusToMapPanelFocusListener);</span>
<span class="nc" id="L367">    rightHandSidePanel.add(smallView, BorderLayout.NORTH);</span>
<span class="nc" id="L368">    tabsPanel.setBorder(null);</span>
<span class="nc" id="L369">    rightHandSidePanel.add(tabsPanel, BorderLayout.CENTER);</span>

<span class="nc" id="L371">    final MovePanel movePanel = new MovePanel(data, mapPanel, this);</span>
<span class="nc" id="L372">    actionButtons = new ActionButtons(data, mapPanel, movePanel, this);</span>

<span class="nc" id="L374">    final List&lt;KeyListener&gt; keyListeners =</span>
<span class="nc" id="L375">        ImmutableList.of(getArrowKeyListener(), movePanel.getCustomKeyListeners(), getFlagToggleKeyListener(this));</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">    for (final KeyListener keyListener : keyListeners) {</span>
<span class="nc" id="L377">      mapPanel.addKeyListener(keyListener);</span>
    }

<span class="nc" id="L380">    tabsPanel.addTab(&quot;Actions&quot;, actionButtons);</span>
<span class="nc" id="L381">    actionButtons.setBorder(null);</span>
<span class="nc" id="L382">    statsPanel = new StatPanel(data, uiContext);</span>
<span class="nc" id="L383">    tabsPanel.addTab(&quot;Stats&quot;, statsPanel);</span>
<span class="nc" id="L384">    economyPanel = new EconomyPanel(data);</span>
<span class="nc" id="L385">    tabsPanel.addTab(&quot;Economy&quot;, economyPanel);</span>
<span class="nc" id="L386">    objectivePanel = new ObjectivePanel(data);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">    if (objectivePanel.isEmpty()) {</span>
<span class="nc" id="L388">      objectivePanel.removeDataChangeListener();</span>
<span class="nc" id="L389">      objectivePanel = null;</span>
<span class="nc" id="L390">    } else {</span>
<span class="nc" id="L391">      tabsPanel.addTab(objectivePanel.getName(), objectivePanel);</span>
    }
<span class="nc" id="L393">    notesPanel = new NotesPanel(HelpMenu.gameNotesPane);</span>
<span class="nc" id="L394">    tabsPanel.addTab(&quot;Notes&quot;, notesPanel);</span>
<span class="nc" id="L395">    details = new TerritoryDetailPanel(mapPanel, data, uiContext, this);</span>
<span class="nc" id="L396">    tabsPanel.addTab(&quot;Territory&quot;, null, details, TerritoryDetailPanel.getHoverText());</span>
<span class="nc" id="L397">    editPanel = new EditPanel(data, mapPanel, this);</span>
    // Register a change listener
<span class="nc" id="L399">    tabsPanel.addChangeListener(evt -&gt; {</span>
<span class="nc" id="L400">      final JTabbedPane pane = (JTabbedPane) evt.getSource();</span>
      // Get current tab
<span class="nc" id="L402">      final int sel = pane.getSelectedIndex();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">      if (sel == -1) {</span>
<span class="nc" id="L404">        return;</span>
      }
<span class="nc bnc" id="L406" title="All 2 branches missed.">      if (pane.getComponentAt(sel).equals(notesPanel)) {</span>
<span class="nc" id="L407">        notesPanel.layoutNotes();</span>
<span class="nc" id="L408">      } else {</span>
        // for memory management reasons the notes are in a SoftReference,
        // so we must remove our hard reference link to them so it can be reclaimed if needed
<span class="nc" id="L411">        notesPanel.removeNotes();</span>
      }
<span class="nc bnc" id="L413" title="All 2 branches missed.">      if (pane.getComponentAt(sel).equals(editPanel)) {</span>
<span class="nc" id="L414">        PlayerID player1 = null;</span>
<span class="nc" id="L415">        data.acquireReadLock();</span>
        try {
<span class="nc" id="L417">          player1 = data.getSequence().getStep().getPlayerID();</span>
<span class="nc" id="L418">        } finally {</span>
<span class="nc" id="L419">          data.releaseReadLock();</span>
<span class="nc" id="L420">        }</span>
<span class="nc" id="L421">        actionButtons.getCurrent().setActive(false);</span>
<span class="nc" id="L422">        editPanel.display(player1);</span>
<span class="nc" id="L423">      } else {</span>
<span class="nc" id="L424">        actionButtons.getCurrent().setActive(true);</span>
<span class="nc" id="L425">        editPanel.setActive(false);</span>
      }
<span class="nc" id="L427">    });</span>
<span class="nc" id="L428">    rightHandSidePanel.setPreferredSize(new Dimension((int) smallView.getPreferredSize().getWidth(),</span>
<span class="nc" id="L429">        (int) mapPanel.getPreferredSize().getHeight()));</span>
<span class="nc" id="L430">    gameCenterPanel = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, mapAndChatPanel, rightHandSidePanel);</span>
<span class="nc" id="L431">    gameCenterPanel.setOneTouchExpandable(true);</span>
<span class="nc" id="L432">    gameCenterPanel.setDividerSize(8);</span>
<span class="nc" id="L433">    gameCenterPanel.setResizeWeight(1.0);</span>
<span class="nc" id="L434">    gameMainPanel.add(gameCenterPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L435">    gameCenterPanel.resetToPreferredSizes();</span>
    // set up the edit mode overlay text
<span class="nc" id="L437">    this.setGlassPane(new JComponent() {</span>
      private static final long serialVersionUID = 6724687534214427291L;

      @Override
      protected void paintComponent(final Graphics g) {
<span class="nc" id="L442">        g.setFont(new Font(&quot;Ariel&quot;, Font.BOLD, 50));</span>
<span class="nc" id="L443">        g.setColor(new Color(255, 255, 255, 175));</span>
<span class="nc" id="L444">        final Dimension size = mapPanel.getSize();</span>
<span class="nc" id="L445">        g.drawString(&quot;Edit Mode&quot;, (int) ((size.getWidth() - 200) / 2), (int) ((size.getHeight() - 100) / 2));</span>
<span class="nc" id="L446">      }</span>
    });
    // force a data change event to update the UI for edit mode
<span class="nc" id="L449">    m_dataChangeListener.gameDataChanged(ChangeFactory.EMPTY_CHANGE);</span>
<span class="nc" id="L450">    data.addDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L451">    game.addGameStepListener(m_stepListener);</span>
<span class="nc" id="L452">    updateStep();</span>
<span class="nc" id="L453">    uiContext.addShutdownWindow(this);</span>
<span class="nc" id="L454">  }</span>


  public static KeyListener getFlagToggleKeyListener(final TripleAFrame frame) {
<span class="nc" id="L458">    return new KeyListener() {</span>
<span class="nc" id="L459">      private boolean blockInputs = false;</span>
<span class="nc" id="L460">      private long timeSinceLastPressEvent = 0;</span>
<span class="nc" id="L461">      private boolean running = true;</span>

      @Override
<span class="nc" id="L464">      public void keyTyped(final KeyEvent e) {/* Do nothing */}</span>

      @Override
      public void keyPressed(final KeyEvent e) {
<span class="nc" id="L468">        timeSinceLastPressEvent = 0;</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">        if (!blockInputs) {</span>
<span class="nc" id="L470">          resetFlagsOnTimeOut(e.getKeyCode());</span>
<span class="nc" id="L471">          toggleFlags(e.getKeyCode());</span>
<span class="nc" id="L472">          blockInputs = true;</span>
        }
<span class="nc" id="L474">      }</span>

      private void resetFlagsOnTimeOut(final int keyCode) {
<span class="nc" id="L477">        new Thread(() -&gt; {</span>
<span class="nc" id="L478">          running = true;</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">          while (running) {</span>
<span class="nc" id="L480">            timeSinceLastPressEvent++;</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (timeSinceLastPressEvent &gt; 5) {</span>
<span class="nc" id="L482">              running = false;</span>
<span class="nc" id="L483">              toggleFlags(keyCode);</span>
<span class="nc" id="L484">              blockInputs = false;</span>
            }
<span class="nc" id="L486">            ThreadUtil.sleep(100);</span>
          }
<span class="nc" id="L488">        }).start();</span>
<span class="nc" id="L489">      }</span>

      @Override
      public void keyReleased(final KeyEvent e) {
<span class="nc" id="L493">        toggleFlags(e.getKeyCode());</span>
<span class="nc" id="L494">        blockInputs = false;</span>
<span class="nc" id="L495">        running = false;</span>
<span class="nc" id="L496">      }</span>

      private void toggleFlags(final int keyCode) {
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (keyCode == KeyEvent.VK_L) {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">          UnitsDrawer.enabledFlags = !UnitsDrawer.enabledFlags;</span>
<span class="nc" id="L501">          frame.getMapPanel().resetMap();</span>
        }
<span class="nc" id="L503">      }</span>
    };

  }

  private void addZoomKeyboardShortcuts() {
<span class="nc" id="L509">    final String zoom_map_in = &quot;zoom_map_in&quot;;</span>
    // do both = and + (since = is what you get when you hit ctrl+ )
<span class="nc" id="L511">    ((JComponent) getContentPane()).getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)</span>
<span class="nc" id="L512">        .put(KeyStroke.getKeyStroke('+', java.awt.event.InputEvent.META_MASK), zoom_map_in);</span>
<span class="nc" id="L513">    ((JComponent) getContentPane()).getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)</span>
<span class="nc" id="L514">        .put(KeyStroke.getKeyStroke('+', java.awt.event.InputEvent.CTRL_MASK), zoom_map_in);</span>
<span class="nc" id="L515">    ((JComponent) getContentPane()).getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)</span>
<span class="nc" id="L516">        .put(KeyStroke.getKeyStroke('=', java.awt.event.InputEvent.META_MASK), zoom_map_in);</span>
<span class="nc" id="L517">    ((JComponent) getContentPane()).getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)</span>
<span class="nc" id="L518">        .put(KeyStroke.getKeyStroke('=', java.awt.event.InputEvent.CTRL_MASK), zoom_map_in);</span>
<span class="nc" id="L519">    ((JComponent) getContentPane()).getActionMap().put(zoom_map_in, new AbstractAction(zoom_map_in) {</span>
      private static final long serialVersionUID = -7565304172320049817L;

      @Override
      public void actionPerformed(final ActionEvent e) {
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (getScale() &lt; 100) {</span>
<span class="nc" id="L525">          setScale(getScale() + 10);</span>
        }
<span class="nc" id="L527">      }</span>
    });
<span class="nc" id="L529">    final String zoom_map_out = &quot;zoom_map_out&quot;;</span>
<span class="nc" id="L530">    ((JComponent) getContentPane()).getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)</span>
<span class="nc" id="L531">        .put(KeyStroke.getKeyStroke('-', java.awt.event.InputEvent.META_MASK), zoom_map_out);</span>
<span class="nc" id="L532">    ((JComponent) getContentPane()).getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)</span>
<span class="nc" id="L533">        .put(KeyStroke.getKeyStroke('-', java.awt.event.InputEvent.CTRL_MASK), zoom_map_out);</span>
<span class="nc" id="L534">    ((JComponent) getContentPane()).getActionMap().put(zoom_map_out, new AbstractAction(zoom_map_out) {</span>
      private static final long serialVersionUID = 7677111833274819304L;

      @Override
      public void actionPerformed(final ActionEvent e) {
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (getScale() &gt; 16) {</span>
<span class="nc" id="L540">          setScale(getScale() - 10);</span>
        }
<span class="nc" id="L542">      }</span>
    });
<span class="nc" id="L544">  }</span>

  /**
   * @param value
   *        - a number between 15 and 100
   */
  public void setScale(final double value) {
<span class="nc" id="L551">    getMapPanel().setScale(value / 100);</span>
<span class="nc" id="L552">  }</span>

  /**
   * @return a scale between 15 and 100
   */
  private double getScale() {
<span class="nc" id="L558">    return getMapPanel().getScale() * 100;</span>
  }

  @Override
  public void stopGame() {
    // we have already shut down
<span class="nc bnc" id="L564" title="All 2 branches missed.">    if (uiContext == null) {</span>
<span class="nc" id="L565">      return;</span>
    }
<span class="nc" id="L567">    this.setVisible(false);</span>
<span class="nc" id="L568">    TripleAFrame.this.dispose();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">    if (SystemProperties.isMac()) {</span>
      // this frame should not handle shutdowns anymore
<span class="nc" id="L571">      MacQuitMenuWrapper.unregisterShutdownHandler();</span>
    }
<span class="nc" id="L573">    messageAndDialogThreadPool.shutDown();</span>
<span class="nc" id="L574">    uiContext.shutDown();</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">    if (chatPanel != null) {</span>
<span class="nc" id="L576">      chatPanel.setPlayerRenderer(null);</span>
<span class="nc" id="L577">      chatPanel.setChat(null);</span>
    }
<span class="nc bnc" id="L579" title="All 2 branches missed.">    if (historySyncher != null) {</span>
<span class="nc" id="L580">      historySyncher.deactivate();</span>
<span class="nc" id="L581">      historySyncher = null;</span>
    }
<span class="nc" id="L583">    ProAI.gameOverClearCache();</span>
<span class="nc" id="L584">  }</span>

  @Override
  public void shutdown() {
<span class="nc" id="L588">    final int rVal = EventThreadJOptionPane.showConfirmDialog(this,</span>
<span class="nc" id="L589">        &quot;Are you sure you want to exit TripleA?\nUnsaved game data will be lost.&quot;, &quot;Exit Program&quot;,</span>
<span class="nc" id="L590">        JOptionPane.YES_NO_OPTION,</span>
<span class="nc" id="L591">        getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">    if (rVal != JOptionPane.OK_OPTION) {</span>
<span class="nc" id="L593">      return;</span>
    }
<span class="nc" id="L595">    stopGame();</span>
<span class="nc" id="L596">    System.exit(0);</span>
<span class="nc" id="L597">  }</span>

  @Override
  public void leaveGame() {
<span class="nc" id="L601">    final int rVal = EventThreadJOptionPane.showConfirmDialog(this,</span>
<span class="nc" id="L602">        &quot;Are you sure you want to leave the current game?\nUnsaved game data will be lost.&quot;, &quot;Leave Game&quot;,</span>
<span class="nc" id="L603">        JOptionPane.YES_NO_OPTION,</span>
<span class="nc" id="L604">        getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">    if (rVal != JOptionPane.OK_OPTION) {</span>
<span class="nc" id="L606">      return;</span>
    }
<span class="nc bnc" id="L608" title="All 2 branches missed.">    if (game instanceof ServerGame) {</span>
<span class="nc" id="L609">      ((ServerGame) game).stopGame();</span>
<span class="nc" id="L610">    } else {</span>
<span class="nc" id="L611">      game.getMessenger().shutDown();</span>
<span class="nc" id="L612">      ((ClientGame) game).shutDown();</span>
      // an ugly hack, we need a better
      // way to get the main frame
<span class="nc" id="L615">      MainFrame.getInstance().clientLeftGame();</span>
    }
<span class="nc" id="L617">  }</span>

<span class="nc" id="L619">  public MapSelectionListener MAP_SELECTION_LISTENER = new DefaultMapSelectionListener() {</span>
    @Override
    public void mouseEntered(final Territory territory) {
<span class="nc" id="L622">      territoryLastEntered = territory;</span>
<span class="nc" id="L623">      refresh();</span>
<span class="nc" id="L624">    }</span>

    void refresh() {
<span class="nc" id="L627">      final StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">      buf.append(territoryLastEntered == null ? &quot;none&quot; : territoryLastEntered.getName());</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">      if (territoryLastEntered != null) {</span>
<span class="nc" id="L630">        final TerritoryAttachment ta = TerritoryAttachment.get(territoryLastEntered);</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">        if (ta != null) {</span>
<span class="nc" id="L632">          final Iterator&lt;TerritoryEffect&gt; iter = ta.getTerritoryEffect().iterator();</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">          if (iter.hasNext()) {</span>
<span class="nc" id="L634">            buf.append(&quot; (&quot;);</span>
          }
<span class="nc bnc" id="L636" title="All 2 branches missed.">          while (iter.hasNext()) {</span>
<span class="nc" id="L637">            buf.append(iter.next().getName());</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">            if (iter.hasNext()) {</span>
<span class="nc" id="L639">              buf.append(&quot;, &quot;);</span>
<span class="nc" id="L640">            } else {</span>
<span class="nc" id="L641">              buf.append(&quot;)&quot;);</span>
            }
          }
<span class="nc" id="L644">          final int production = ta.getProduction();</span>
<span class="nc" id="L645">          final int unitProduction = ta.getUnitProduction();</span>
<span class="nc" id="L646">          final ResourceCollection resource = ta.getResources();</span>
<span class="nc bnc" id="L647" title="All 4 branches missed.">          if (unitProduction &gt; 0 &amp;&amp; unitProduction != production) {</span>
<span class="nc" id="L648">            buf.append(&quot;, UnitProd: &quot;).append(unitProduction);</span>
          }
<span class="nc bnc" id="L650" title="All 6 branches missed.">          if (production &gt; 0 || (resource != null &amp;&amp; resource.toString().length() &gt; 0)) {</span>
<span class="nc" id="L651">            buf.append(&quot;, Prod: &quot;);</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">            if (production &gt; 0) {</span>
<span class="nc" id="L653">              buf.append(production).append(&quot; PUs&quot;);</span>
<span class="nc bnc" id="L654" title="All 4 branches missed.">              if (resource != null &amp;&amp; resource.toString().length() &gt; 0) {</span>
<span class="nc" id="L655">                buf.append(&quot;, &quot;);</span>
              }
            }
<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (resource != null) {</span>
<span class="nc" id="L659">              buf.append(resource.toString());</span>
            }
          }
        }
      }
<span class="nc" id="L664">      message.setText(buf.toString());</span>
<span class="nc" id="L665">    }</span>
  };

  public void clearStatusMessage() {
<span class="nc bnc" id="L669" title="All 2 branches missed.">    if (status == null) {</span>
<span class="nc" id="L670">      return;</span>
    }
<span class="nc" id="L672">    status.setText(&quot;&quot;);</span>
<span class="nc" id="L673">    status.setIcon(null);</span>
<span class="nc" id="L674">  }</span>

  public void setStatusErrorMessage(final String msg) {
<span class="nc" id="L677">    setStatus(msg, mapPanel.getErrorImage());</span>
<span class="nc" id="L678">  }</span>

  private void setStatus(final String msg, final Optional&lt;Image&gt; image) {
<span class="nc bnc" id="L681" title="All 2 branches missed.">    if (status == null) {</span>
<span class="nc" id="L682">      return;</span>
    }
<span class="nc" id="L684">    status.setText(msg);</span>

<span class="nc bnc" id="L686" title="All 4 branches missed.">    if (!msg.equals(&quot;&quot;) &amp;&amp; image.isPresent()) {</span>
<span class="nc" id="L687">      status.setIcon(new ImageIcon(image.get()));</span>
<span class="nc" id="L688">    } else {</span>
<span class="nc" id="L689">      status.setIcon(null);</span>
    }
<span class="nc" id="L691">  }</span>

  public void setStatusWarningMessage(final String msg) {
<span class="nc" id="L694">    setStatus(msg, mapPanel.getWarningImage());</span>
<span class="nc" id="L695">  }</span>

  public IntegerMap&lt;ProductionRule&gt; getProduction(final PlayerID player, final boolean bid) {
<span class="nc bnc" id="L698" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L699">      return null;</span>
    }
<span class="nc" id="L701">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L702">    actionButtons.changeToProduce(player);</span>
<span class="nc" id="L703">    return actionButtons.waitForPurchase(bid);</span>
  }

  public HashMap&lt;Unit, IntegerMap&lt;RepairRule&gt;&gt; getRepair(final PlayerID player, final boolean bid,
      final Collection&lt;PlayerID&gt; allowedPlayersToRepair) {
<span class="nc bnc" id="L708" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L709">      return null;</span>
    }
<span class="nc" id="L711">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L712">    actionButtons.changeToRepair(player);</span>
<span class="nc" id="L713">    return actionButtons.waitForRepair(bid, allowedPlayersToRepair);</span>
  }

  public MoveDescription getMove(final PlayerID player, final IPlayerBridge bridge, final boolean nonCombat,
      final String stepName) {
<span class="nc bnc" id="L718" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L719">      return null;</span>
    }
<span class="nc" id="L721">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L722">    actionButtons.changeToMove(player, nonCombat, stepName);</span>
    // workaround for panel not receiving focus at beginning of n/c move phase
<span class="nc bnc" id="L724" title="All 2 branches missed.">    if (!getBattlePanel().getBattleFrame().isVisible()) {</span>
<span class="nc" id="L725">      requestWindowFocus();</span>
    }
<span class="nc" id="L727">    return actionButtons.waitForMove(bridge);</span>
  }

  private void requestWindowFocus() {
<span class="nc" id="L731">    SwingAction.invokeAndWait(() -&gt; {</span>
<span class="nc" id="L732">      requestFocusInWindow();</span>
<span class="nc" id="L733">      transferFocus();</span>
<span class="nc" id="L734">    });</span>
<span class="nc" id="L735">  }</span>

  public PlaceData waitForPlace(final PlayerID player, final boolean bid, final IPlayerBridge bridge) {
<span class="nc bnc" id="L738" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L739">      return null;</span>
    }
<span class="nc" id="L741">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L742">    actionButtons.changeToPlace(player);</span>
<span class="nc" id="L743">    return actionButtons.waitForPlace(bid, bridge);</span>
  }

  public void waitForMoveForumPoster(final PlayerID player, final IPlayerBridge bridge) {
<span class="nc bnc" id="L747" title="All 4 branches missed.">    if (actionButtons == null || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L748">      return;</span>
    }
    // m_messageAndDialogThreadPool.waitForAll();
<span class="nc" id="L751">    actionButtons.changeToMoveForumPosterPanel(player);</span>
<span class="nc" id="L752">    actionButtons.waitForMoveForumPosterPanel(this, bridge);</span>
<span class="nc" id="L753">  }</span>

  public void waitForEndTurn(final PlayerID player, final IPlayerBridge bridge) {
<span class="nc bnc" id="L756" title="All 4 branches missed.">    if (actionButtons == null || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L757">      return;</span>
    }
    // m_messageAndDialogThreadPool.waitForAll();
<span class="nc" id="L760">    actionButtons.changeToEndTurn(player);</span>
<span class="nc" id="L761">    actionButtons.waitForEndTurn(this, bridge);</span>
<span class="nc" id="L762">  }</span>

  public FightBattleDetails getBattle(final PlayerID player, final Map&lt;BattleType, Collection&lt;Territory&gt;&gt; battles) {
<span class="nc bnc" id="L765" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L766">      return null;</span>
    }
<span class="nc" id="L768">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L769">    actionButtons.changeToBattle(player, battles);</span>
<span class="nc" id="L770">    return actionButtons.waitForBattleSelection();</span>
  }

  /**
   * We do NOT want to block the next player from beginning their turn.
   */
  @Override
  public void notifyError(final String message) {
<span class="nc" id="L778">    final String displayMessage = LocalizeHTML.localizeImgLinksInHTML(message);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L780">      return;</span>
    }
<span class="nc" id="L782">    messageAndDialogThreadPool.runTask(</span>
<span class="nc" id="L783">        () -&gt; EventThreadJOptionPane.showMessageDialog(TripleAFrame.this, displayMessage, &quot;Error&quot;,</span>
<span class="nc" id="L784">            JOptionPane.ERROR_MESSAGE,</span>
<span class="nc" id="L785">            true, getUIContext().getCountDownLatchHandler()));</span>
<span class="nc" id="L786">  }</span>

  /**
   * We do NOT want to block the next player from beginning their turn.
   *
   * @param message
   * @param title
   */
  public void notifyMessage(final String message, final String title) {
<span class="nc bnc" id="L795" title="All 4 branches missed.">    if (message == null || title == null) {</span>
<span class="nc" id="L796">      return;</span>
    }
<span class="nc bnc" id="L798" title="All 2 branches missed.">    if (title.indexOf(AbstractConditionsAttachment.TRIGGER_CHANCE_FAILURE) != -1</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        &amp;&amp; message.indexOf(AbstractConditionsAttachment.TRIGGER_CHANCE_FAILURE) != -1</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">        &amp;&amp; !getUIContext().getShowTriggerChanceFailure()) {</span>
<span class="nc" id="L801">      return;</span>
    }
<span class="nc bnc" id="L803" title="All 2 branches missed.">    if (title.indexOf(AbstractConditionsAttachment.TRIGGER_CHANCE_SUCCESSFUL) != -1</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">        &amp;&amp; message.indexOf(AbstractConditionsAttachment.TRIGGER_CHANCE_SUCCESSFUL) != -1</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        &amp;&amp; !getUIContext().getShowTriggerChanceSuccessful()) {</span>
<span class="nc" id="L806">      return;</span>
    }
<span class="nc bnc" id="L808" title="All 4 branches missed.">    if (title.equals(AbstractTriggerAttachment.NOTIFICATION) &amp;&amp; !getUIContext().getShowTriggeredNotifications()) {</span>
<span class="nc" id="L809">      return;</span>
    }
<span class="nc bnc" id="L811" title="All 2 branches missed.">    if (title.indexOf(AbstractEndTurnDelegate.END_TURN_REPORT_STRING) != -1</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">        &amp;&amp; message.indexOf(AbstractEndTurnDelegate.END_TURN_REPORT_STRING) != -1</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">        &amp;&amp; !getUIContext().getShowEndOfTurnReport()) {</span>
<span class="nc" id="L814">      return;</span>
    }
<span class="nc" id="L816">    final String displayMessage = LocalizeHTML.localizeImgLinksInHTML(message);</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">    if (messageAndDialogThreadPool != null) {</span>
<span class="nc" id="L818">      messageAndDialogThreadPool.runTask(</span>
<span class="nc" id="L819">          () -&gt; EventThreadJOptionPane.showMessageDialog(TripleAFrame.this, displayMessage, title,</span>
<span class="nc" id="L820">              JOptionPane.INFORMATION_MESSAGE, true, getUIContext().getCountDownLatchHandler()));</span>
    }
<span class="nc" id="L822">  }</span>

  public boolean getOKToLetAirDie(final PlayerID m_id, final Collection&lt;Territory&gt; airCantLand,
      final boolean movePhase) {
<span class="nc bnc" id="L826" title="All 6 branches missed.">    if (airCantLand == null || airCantLand.isEmpty() || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L827">      return true;</span>
    }
<span class="nc" id="L829">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">    final String airUnitPlural = (airCantLand.size() == 1) ? &quot;&quot; : &quot;s&quot;;</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">    final String territoryPlural = (airCantLand.size() == 1) ? &quot;y&quot; : &quot;ies&quot;;</span>
<span class="nc" id="L832">    final StringBuilder sb = new StringBuilder(&quot;&lt;html&gt;&quot; + airCantLand.size() + &quot; air unit&quot; + airUnitPlural</span>
<span class="nc" id="L833">        + &quot; cannot land in the following territor&quot; + territoryPlural + &quot;:&lt;ul&gt; &quot;);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">    for (final Territory t : airCantLand) {</span>
<span class="nc" id="L835">      sb.append(&quot;&lt;li&gt;&quot;).append(t.getName()).append(&quot;&lt;/li&gt;&quot;);</span>
    }
<span class="nc" id="L837">    sb.append(&quot;&lt;/ul&gt;&lt;/html&gt;&quot;);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">    final boolean lhtrProd = AirThatCantLandUtil.isLHTRCarrierProduction(data)</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">        || AirThatCantLandUtil.isLandExistingFightersOnNewCarriers(data);</span>
<span class="nc" id="L840">    int carrierCount = 0;</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">    for (final PlayerID p : GameStepPropertiesHelper.getCombinedTurns(data, m_id)) {</span>
<span class="nc" id="L842">      carrierCount += p.getUnits().getMatches(Matches.UnitIsCarrier).size();</span>
    }
<span class="nc bnc" id="L844" title="All 4 branches missed.">    final boolean canProduceCarriersUnderFighter = lhtrProd &amp;&amp; carrierCount != 0;</span>
<span class="nc bnc" id="L845" title="All 4 branches missed.">    if (canProduceCarriersUnderFighter &amp;&amp; carrierCount &gt; 0) {</span>
<span class="nc" id="L846">      sb.append(&quot;\nYou have &quot;).append(carrierCount).append(&quot; &quot;).append(MyFormatter.pluralize(&quot;carrier&quot;, carrierCount))</span>
<span class="nc" id="L847">          .append(&quot; on which planes can land&quot;);</span>
    }
<span class="nc bnc" id="L849" title="All 2 branches missed.">    final String ok = movePhase ? &quot;End Move Phase&quot; : &quot;Kill Planes&quot;;</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">    final String cancel = movePhase ? &quot;Keep Moving&quot; : &quot;Change Placement&quot;;</span>
<span class="nc" id="L851">    final String[] options = {cancel, ok};</span>
<span class="nc" id="L852">    mapPanel.centerOn(airCantLand.iterator().next());</span>
<span class="nc" id="L853">    final int choice =</span>
<span class="nc" id="L854">        EventThreadJOptionPane.showOptionDialog(this, sb.toString(), &quot;Air cannot land&quot;, JOptionPane.YES_NO_OPTION,</span>
<span class="nc" id="L855">            JOptionPane.WARNING_MESSAGE, null, options, cancel, getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">    return choice == 1;</span>
  }

  public boolean getOKToLetUnitsDie(final Collection&lt;Territory&gt; unitsCantFight, final boolean movePhase) {
<span class="nc bnc" id="L860" title="All 6 branches missed.">    if (unitsCantFight == null || unitsCantFight.isEmpty() || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L861">      return true;</span>
    }
<span class="nc" id="L863">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L864">    final StringBuilder buf = new StringBuilder(&quot;Units in the following territories will die: &quot;);</span>
<span class="nc" id="L865">    Joiner.on(' ').appendTo(buf, FluentIterable.from(unitsCantFight).transform(unit -&gt; unit.getName()));</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">    final String ok = movePhase ? &quot;Done Moving&quot; : &quot;Kill Units&quot;;</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">    final String cancel = movePhase ? &quot;Keep Moving&quot; : &quot;Change Placement&quot;;</span>
<span class="nc" id="L868">    final String[] options = {cancel, ok};</span>
<span class="nc" id="L869">    this.mapPanel.centerOn(unitsCantFight.iterator().next());</span>
<span class="nc" id="L870">    final int choice =</span>
<span class="nc" id="L871">        EventThreadJOptionPane.showOptionDialog(this, buf.toString(), &quot;Units cannot fight&quot;, JOptionPane.YES_NO_OPTION,</span>
<span class="nc" id="L872">            JOptionPane.WARNING_MESSAGE, null, options, cancel, getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">    return choice == 1;</span>
  }

  public boolean acceptAction(final PlayerID playerSendingProposal, final String acceptanceQuestion,
      final boolean politics) {
<span class="nc bnc" id="L878" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L879">      return true;</span>
    }
<span class="nc" id="L881">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L882">    final int choice = EventThreadJOptionPane.showConfirmDialog(this, acceptanceQuestion,</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">        &quot;Accept &quot; + (politics ? &quot;Political &quot; : &quot;&quot;) + &quot;Proposal from &quot; + playerSendingProposal.getName() + &quot;?&quot;,</span>
<span class="nc" id="L884">        JOptionPane.YES_NO_OPTION, getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">    return choice == JOptionPane.YES_OPTION;</span>
  }

  public boolean getOK(final String message) {
<span class="nc bnc" id="L889" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L890">      return true;</span>
    }
<span class="nc" id="L892">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L893">    final int choice = EventThreadJOptionPane.showConfirmDialog(this, message, message, JOptionPane.OK_CANCEL_OPTION,</span>
<span class="nc" id="L894">        getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">    return choice == JOptionPane.OK_OPTION;</span>
  }

  public void notifyTechResults(final TechResults msg) {
<span class="nc bnc" id="L899" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L900">      return;</span>
    }
<span class="nc" id="L902">    messageAndDialogThreadPool.runTask(() -&gt; {</span>
<span class="nc" id="L903">      final AtomicReference&lt;TechResultsDisplay&gt; displayRef = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L904">      SwingAction.invokeAndWait(() -&gt; {</span>
<span class="nc" id="L905">        final TechResultsDisplay display = new TechResultsDisplay(msg, uiContext, data);</span>
<span class="nc" id="L906">        displayRef.set(display);</span>
<span class="nc" id="L907">      });</span>
<span class="nc" id="L908">      EventThreadJOptionPane.showOptionDialog(TripleAFrame.this, displayRef.get(), &quot;Tech roll&quot;, JOptionPane.OK_OPTION,</span>
<span class="nc" id="L909">          JOptionPane.PLAIN_MESSAGE, null, new String[] {&quot;OK&quot;}, &quot;OK&quot;, getUIContext().getCountDownLatchHandler());</span>
<span class="nc" id="L910">    });</span>
<span class="nc" id="L911">  }</span>

  public boolean getStrategicBombingRaid(final Territory location) {
<span class="nc bnc" id="L914" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L915">      return true;</span>
    }
<span class="nc" id="L917">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L918">    final String message =</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">        (games.strategy.triplea.Properties.getRaidsMayBePreceededByAirBattles(data) ? &quot;Bomb/Escort&quot; : &quot;Bomb&quot;) + &quot; in &quot;</span>
<span class="nc" id="L920">            + location.getName();</span>
<span class="nc" id="L921">    final String bomb =</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">        (games.strategy.triplea.Properties.getRaidsMayBePreceededByAirBattles(data) ? &quot;Bomb/Escort&quot; : &quot;Bomb&quot;);</span>
<span class="nc" id="L923">    final String normal = &quot;Attack&quot;;</span>
<span class="nc" id="L924">    final String[] choices = {bomb, normal};</span>
<span class="nc" id="L925">    int choice = -1;</span>
<span class="nc bnc" id="L926" title="All 4 branches missed.">    while (choice &lt; 0 || choice &gt; 1) {</span>
<span class="nc" id="L927">      choice = EventThreadJOptionPane.showOptionDialog(this, message, &quot;Bomb?&quot;, JOptionPane.OK_CANCEL_OPTION,</span>
<span class="nc" id="L928">          JOptionPane.INFORMATION_MESSAGE, null, choices, bomb, getUIContext().getCountDownLatchHandler());</span>
    }
<span class="nc bnc" id="L930" title="All 2 branches missed.">    return choice == JOptionPane.OK_OPTION;</span>
  }

  public Unit getStrategicBombingRaidTarget(final Territory territory, final Collection&lt;Unit&gt; potentialTargets,
      final Collection&lt;Unit&gt; bombers) {
<span class="nc bnc" id="L935" title="All 4 branches missed.">    if (potentialTargets == null || potentialTargets.size() == 0) {</span>
<span class="nc" id="L936">      return null;</span>
    }
<span class="nc bnc" id="L938" title="All 4 branches missed.">    if (potentialTargets.size() == 1 || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L939">      return potentialTargets.iterator().next();</span>
    }
<span class="nc" id="L941">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L942">    final AtomicReference&lt;Unit&gt; selected = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L943">    final String message = &quot;Select bombing target in &quot; + territory.getName();</span>
<span class="nc" id="L944">    final Tuple&lt;JPanel, JList&lt;Unit&gt;&gt; comps = Util.runInSwingEventThread(() -&gt; {</span>
<span class="nc" id="L945">      final JList&lt;Unit&gt; list = new JList&lt;&gt;(new Vector&lt;&gt;(potentialTargets));</span>
<span class="nc" id="L946">      list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L947">      list.setSelectedIndex(0);</span>
<span class="nc" id="L948">      final JPanel panel = new JPanel();</span>
<span class="nc" id="L949">      panel.setLayout(new BorderLayout());</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">      if (bombers != null) {</span>
<span class="nc" id="L951">        panel.add(new JLabel(&quot;For Units: &quot; + MyFormatter.unitsToTextNoOwner(bombers)), BorderLayout.NORTH);</span>
      }
<span class="nc" id="L953">      final JScrollPane scroll = new JScrollPane(list);</span>
<span class="nc" id="L954">      panel.add(scroll, BorderLayout.CENTER);</span>
<span class="nc" id="L955">      return Tuple.of(panel, list);</span>
    });
<span class="nc" id="L957">    final JPanel panel = comps.getFirst();</span>
<span class="nc" id="L958">    final JList&lt;?&gt; list = comps.getSecond();</span>
<span class="nc" id="L959">    final String[] options = {&quot;OK&quot;, &quot;Cancel&quot;};</span>
<span class="nc" id="L960">    final int selection = EventThreadJOptionPane.showOptionDialog(this, panel, message, JOptionPane.OK_CANCEL_OPTION,</span>
<span class="nc" id="L961">        JOptionPane.PLAIN_MESSAGE, null, options, null, getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">    if (selection == 0) {</span>
<span class="nc" id="L963">      selected.set((Unit) list.getSelectedValue());</span>
    }
    // Unit selected = (Unit) list.getSelectedValue();
<span class="nc" id="L966">    return selected.get();</span>
  }

  public int[] selectFixedDice(final int numDice, final int hitAt, final boolean hitOnlyIfEquals, final String title,
      final int diceSides) {
<span class="nc bnc" id="L971" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L972">      return new int[numDice];</span>
    }
<span class="nc" id="L974">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L975">    final DiceChooser chooser = Util.runInSwingEventThread(</span>
<span class="nc" id="L976">        () -&gt; new DiceChooser(getUIContext(), numDice, hitAt, hitOnlyIfEquals, diceSides));</span>
    do {
<span class="nc" id="L978">      EventThreadJOptionPane.showMessageDialog(null, chooser, title, JOptionPane.PLAIN_MESSAGE,</span>
<span class="nc" id="L979">          getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">    } while (chooser.getDice() == null);</span>
<span class="nc" id="L981">    return chooser.getDice();</span>
  }

  public Territory selectTerritoryForAirToLand(final Collection&lt;Territory&gt; candidates, final Territory currentTerritory,
      final String unitMessage) {
<span class="nc bnc" id="L986" title="All 4 branches missed.">    if (candidates == null || candidates.isEmpty()) {</span>
<span class="nc" id="L987">      return null;</span>
    }
<span class="nc bnc" id="L989" title="All 4 branches missed.">    if (candidates.size() == 1 || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L990">      return candidates.iterator().next();</span>
    }
<span class="nc" id="L992">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L993">    final Tuple&lt;JPanel, JList&lt;Territory&gt;&gt; comps =</span>
<span class="nc" id="L994">        Util.runInSwingEventThread(() -&gt; {</span>
<span class="nc" id="L995">          mapPanel.centerOn(currentTerritory);</span>
<span class="nc" id="L996">          final JList&lt;Territory&gt; list = new JList&lt;&gt;(new Vector&lt;&gt;(candidates));</span>
<span class="nc" id="L997">          list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L998">          list.setSelectedIndex(0);</span>
<span class="nc" id="L999">          final JPanel panel = new JPanel();</span>
<span class="nc" id="L1000">          panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1001">          final JScrollPane scroll = new JScrollPane(list);</span>
<span class="nc" id="L1002">          final JTextArea text = new JTextArea(unitMessage, 8, 30);</span>
<span class="nc" id="L1003">          text.setLineWrap(true);</span>
<span class="nc" id="L1004">          text.setEditable(false);</span>
<span class="nc" id="L1005">          text.setWrapStyleWord(true);</span>
<span class="nc" id="L1006">          panel.add(text, BorderLayout.NORTH);</span>
<span class="nc" id="L1007">          panel.add(scroll, BorderLayout.CENTER);</span>
<span class="nc" id="L1008">          return Tuple.of(panel, list);</span>
        });
<span class="nc" id="L1010">    final JPanel panel = comps.getFirst();</span>
<span class="nc" id="L1011">    final JList&lt;?&gt; list = comps.getSecond();</span>
<span class="nc" id="L1012">    final String[] options = {&quot;OK&quot;};</span>
<span class="nc" id="L1013">    final String title = &quot;Select territory for air units to land, current territory is &quot; + currentTerritory.getName();</span>
<span class="nc" id="L1014">    EventThreadJOptionPane.showOptionDialog(this, panel, title, JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE,</span>
<span class="nc" id="L1015">        null, options, null, getUIContext().getCountDownLatchHandler());</span>
<span class="nc" id="L1016">    final Territory selected = (Territory) list.getSelectedValue();</span>
<span class="nc" id="L1017">    return selected;</span>
  }

  public Tuple&lt;Territory, Set&lt;Unit&gt;&gt; pickTerritoryAndUnits(final PlayerID player,
      final List&lt;Territory&gt; territoryChoices, final List&lt;Unit&gt; unitChoices, final int unitsPerPick) {
<span class="nc bnc" id="L1022" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1023">      return Tuple.of(territoryChoices.iterator().next(),</span>
<span class="nc" id="L1024">          new HashSet&lt;&gt;(Match.getNMatches(unitChoices, unitsPerPick, Match.getAlwaysMatch())));</span>
    }
    // total hacks
<span class="nc" id="L1027">    messageAndDialogThreadPool.waitForAll();</span>
    {
<span class="nc" id="L1029">      final CountDownLatch latch1 = new CountDownLatch(1);</span>
<span class="nc" id="L1030">      SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">        if (!inGame) {</span>
<span class="nc" id="L1032">          showGame();</span>
        }
<span class="nc bnc" id="L1034" title="All 2 branches missed.">        if (tabsPanel.indexOfTab(&quot;Actions&quot;) == -1) {</span>
          // add actions tab
<span class="nc" id="L1036">          tabsPanel.insertTab(&quot;Actions&quot;, null, actionButtons, null, 0);</span>
        }
<span class="nc" id="L1038">        tabsPanel.setSelectedIndex(0);</span>
<span class="nc" id="L1039">        latch1.countDown();</span>
<span class="nc" id="L1040">      });</span>
      try {
<span class="nc" id="L1042">        latch1.await();</span>
<span class="nc" id="L1043">      } catch (final InterruptedException e) {</span>
<span class="nc" id="L1044">        ClientLogger.logQuietly(e);</span>
      }
    }
<span class="nc" id="L1047">    actionButtons.changeToPickTerritoryAndUnits(player);</span>
<span class="nc" id="L1048">    final Tuple&lt;Territory, Set&lt;Unit&gt;&gt; rVal =</span>
<span class="nc" id="L1049">        actionButtons.waitForPickTerritoryAndUnits(territoryChoices, unitChoices, unitsPerPick);</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">    final int index = tabsPanel == null ? -1 : tabsPanel.indexOfTab(&quot;Actions&quot;);</span>
<span class="nc bnc" id="L1051" title="All 4 branches missed.">    if (index != -1 &amp;&amp; inHistory) {</span>
<span class="nc" id="L1052">      final CountDownLatch latch2 = new CountDownLatch(1);</span>
<span class="nc" id="L1053">      SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">        if (tabsPanel != null) {</span>
          // remove actions tab
<span class="nc" id="L1056">          tabsPanel.remove(index);</span>
        }
<span class="nc" id="L1058">        latch2.countDown();</span>
<span class="nc" id="L1059">      });</span>
      try {
<span class="nc" id="L1061">        latch2.await();</span>
<span class="nc" id="L1062">      } catch (final InterruptedException e) {</span>
<span class="nc" id="L1063">        ClientLogger.logQuietly(e);</span>
      }
    }
<span class="nc bnc" id="L1066" title="All 4 branches missed.">    if (actionButtons != null &amp;&amp; actionButtons.getCurrent() != null) {</span>
<span class="nc" id="L1067">      actionButtons.getCurrent().setActive(false);</span>
    }
<span class="nc" id="L1069">    return rVal;</span>
  }

  public HashMap&lt;Territory, IntegerMap&lt;Unit&gt;&gt; selectKamikazeSuicideAttacks(
      final HashMap&lt;Territory, Collection&lt;Unit&gt;&gt; possibleUnitsToAttack, final Resource attackResourceToken,
      final int maxNumberOfAttacksAllowed) {
<span class="nc bnc" id="L1075" title="All 2 branches missed.">    if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1076">      throw new IllegalStateException(&quot;Should not be called from dispatch thread&quot;);</span>
    }
<span class="nc" id="L1078">    final HashMap&lt;Territory, IntegerMap&lt;Unit&gt;&gt; selection = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1079" title="All 6 branches missed.">    if (possibleUnitsToAttack == null || possibleUnitsToAttack.isEmpty() || attackResourceToken == null</span>
<span class="nc bnc" id="L1080" title="All 4 branches missed.">        || maxNumberOfAttacksAllowed &lt;= 0 || messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1081">      return selection;</span>
    }
<span class="nc" id="L1083">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L1084">    final CountDownLatch continueLatch = new CountDownLatch(1);</span>
<span class="nc" id="L1085">    final Collection&lt;IndividualUnitPanelGrouped&gt; unitPanels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1086">    SwingUtilities.invokeLater(new Runnable() {</span>
      @Override
      public void run() {
<span class="nc" id="L1089">        final HashMap&lt;String, Collection&lt;Unit&gt;&gt; possibleUnitsToAttackStringForm =</span>
<span class="nc" id="L1090">            new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">        for (final Entry&lt;Territory, Collection&lt;Unit&gt;&gt; entry : possibleUnitsToAttack.entrySet()) {</span>
<span class="nc" id="L1092">          final List&lt;Unit&gt; units = new ArrayList&lt;&gt;(entry.getValue());</span>
<span class="nc" id="L1093">          Collections.sort(units,</span>
<span class="nc" id="L1094">              new UnitBattleComparator(false, BattleCalculator.getCostsForTuvForAllPlayersMergedAndAveraged(data),</span>
<span class="nc" id="L1095">                  TerritoryEffectHelper.getEffects(entry.getKey()), data, true, false));</span>
<span class="nc" id="L1096">          Collections.reverse(units);</span>
<span class="nc" id="L1097">          possibleUnitsToAttackStringForm.put(entry.getKey().getName(), units);</span>
        }
<span class="nc" id="L1099">        mapPanel.centerOn(data.getMap().getTerritory(possibleUnitsToAttackStringForm.keySet().iterator().next()));</span>
<span class="nc" id="L1100">        final IndividualUnitPanelGrouped unitPanel = new IndividualUnitPanelGrouped(possibleUnitsToAttackStringForm,</span>
<span class="nc" id="L1101">            data, uiContext, &quot;Select Units to Suicide Attack using &quot; + attackResourceToken.getName(),</span>
<span class="nc" id="L1102">            maxNumberOfAttacksAllowed, true, false);</span>
<span class="nc" id="L1103">        unitPanels.add(unitPanel);</span>
<span class="nc" id="L1104">        final String optionAttack = &quot;Attack&quot;;</span>
<span class="nc" id="L1105">        final String optionNone = &quot;None&quot;;</span>
<span class="nc" id="L1106">        final String optionWait = &quot;Wait&quot;;</span>
<span class="nc" id="L1107">        final Object[] options = {optionAttack, optionNone, optionWait};</span>
<span class="nc" id="L1108">        final JOptionPane optionPane = new JOptionPane(unitPanel, JOptionPane.PLAIN_MESSAGE,</span>
<span class="nc" id="L1109">            JOptionPane.YES_NO_CANCEL_OPTION, null, options, options[2]);</span>
<span class="nc" id="L1110">        final JDialog dialog =</span>
<span class="nc" id="L1111">            new JDialog((Frame) getParent(), &quot;Select units to Suicide Attack using &quot; + attackResourceToken.getName());</span>
<span class="nc" id="L1112">        dialog.setContentPane(optionPane);</span>
<span class="nc" id="L1113">        dialog.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L1114">        dialog.setLocationRelativeTo(getParent());</span>
<span class="nc" id="L1115">        dialog.setAlwaysOnTop(true);</span>
<span class="nc" id="L1116">        dialog.pack();</span>
<span class="nc" id="L1117">        dialog.setVisible(true);</span>
<span class="nc" id="L1118">        dialog.requestFocusInWindow();</span>
<span class="nc" id="L1119">        optionPane.addPropertyChangeListener(e -&gt; {</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">          if (!dialog.isVisible()) {</span>
<span class="nc" id="L1121">            return;</span>
          }
<span class="nc" id="L1123">          final String option = ((String) optionPane.getValue());</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">          if (option.equals(optionNone)) {</span>
<span class="nc" id="L1125">            unitPanels.clear();</span>
<span class="nc" id="L1126">            selection.clear();</span>
<span class="nc" id="L1127">            dialog.setVisible(false);</span>
<span class="nc" id="L1128">            dialog.removeAll();</span>
<span class="nc" id="L1129">            dialog.dispose();</span>
<span class="nc" id="L1130">            continueLatch.countDown();</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">          } else if (option.equals(optionAttack)) {</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">            if (unitPanels.size() != 1) {</span>
<span class="nc" id="L1133">              throw new IllegalStateException(&quot;unitPanels should only contain 1 entry&quot;);</span>
            }
<span class="nc bnc" id="L1135" title="All 2 branches missed.">            for (final IndividualUnitPanelGrouped terrChooser : unitPanels) {</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">              for (final Entry&lt;String, IntegerMap&lt;Unit&gt;&gt; entry : terrChooser.getSelected().entrySet()) {</span>
<span class="nc" id="L1137">                selection.put(data.getMap().getTerritory(entry.getKey()), entry.getValue());</span>
              }
            }
<span class="nc" id="L1140">            dialog.setVisible(false);</span>
<span class="nc" id="L1141">            dialog.removeAll();</span>
<span class="nc" id="L1142">            dialog.dispose();</span>
<span class="nc" id="L1143">            continueLatch.countDown();</span>
<span class="nc" id="L1144">          } else {</span>
<span class="nc" id="L1145">            unitPanels.clear();</span>
<span class="nc" id="L1146">            selection.clear();</span>
<span class="nc" id="L1147">            dialog.setVisible(false);</span>
<span class="nc" id="L1148">            dialog.removeAll();</span>
<span class="nc" id="L1149">            dialog.dispose();</span>
<span class="nc" id="L1150">            ThreadUtil.sleep(500);</span>
<span class="nc" id="L1151">            run();</span>
          }
<span class="nc" id="L1153">        });</span>
<span class="nc" id="L1154">      }</span>
    });
<span class="nc" id="L1156">    mapPanel.getUIContext().addShutdownLatch(continueLatch);</span>
    try {
<span class="nc" id="L1158">      continueLatch.await();</span>
<span class="nc" id="L1159">    } catch (final InterruptedException ex) {</span>
      // ignore interrupted exception
<span class="nc" id="L1161">    } finally {</span>
<span class="nc" id="L1162">      mapPanel.getUIContext().removeShutdownLatch(continueLatch);</span>
<span class="nc" id="L1163">    }</span>
<span class="nc" id="L1164">    return selection;</span>
  }

  public HashMap&lt;Territory, Collection&lt;Unit&gt;&gt; scrambleUnitsQuery(final Territory scrambleTo,
      final Map&lt;Territory, Tuple&lt;Collection&lt;Unit&gt;, Collection&lt;Unit&gt;&gt;&gt; possibleScramblers) {
<span class="nc bnc" id="L1169" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1170">      return null;</span>
    }
<span class="nc" id="L1172">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">    if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1174">      throw new IllegalStateException(&quot;Should not be called from dispatch thread&quot;);</span>
    }
<span class="nc" id="L1176">    final CountDownLatch continueLatch = new CountDownLatch(1);</span>
<span class="nc" id="L1177">    final HashMap&lt;Territory, Collection&lt;Unit&gt;&gt; selection = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1178">    final Collection&lt;Tuple&lt;Territory, UnitChooser&gt;&gt; choosers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1179">    SwingUtilities.invokeLater(new Runnable() {</span>
      @Override
      public void run() {
<span class="nc" id="L1182">        mapPanel.centerOn(scrambleTo);</span>
<span class="nc" id="L1183">        final JPanel panel = new JPanel();</span>
<span class="nc" id="L1184">        panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1185">        final JLabel whereTo = new JLabel(&quot;Scramble To: &quot; + scrambleTo.getName());</span>
<span class="nc" id="L1186">        whereTo.setFont(new Font(&quot;Arial&quot;, Font.ITALIC, 12));</span>
<span class="nc" id="L1187">        panel.add(whereTo, BorderLayout.NORTH);</span>
<span class="nc" id="L1188">        final JPanel panel2 = new JPanel();</span>
<span class="nc" id="L1189">        panel2.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L1190">        panel2.setLayout(new FlowLayout());</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">        for (final Territory from : possibleScramblers.keySet()) {</span>
          JScrollPane chooserScrollPane;
<span class="nc" id="L1193">          final JPanel panelChooser = new JPanel();</span>
<span class="nc" id="L1194">          panelChooser.setLayout(new BoxLayout(panelChooser, BoxLayout.Y_AXIS));</span>
<span class="nc" id="L1195">          panelChooser.setBorder(BorderFactory.createLineBorder(getBackground()));</span>
<span class="nc" id="L1196">          final JLabel whereFrom = new JLabel(&quot;From: &quot; + from.getName());</span>
<span class="nc" id="L1197">          whereFrom.setHorizontalAlignment(SwingConstants.LEFT);</span>
<span class="nc" id="L1198">          whereFrom.setFont(new Font(&quot;Arial&quot;, Font.BOLD, 12));</span>
<span class="nc" id="L1199">          panelChooser.add(whereFrom);</span>
<span class="nc" id="L1200">          panelChooser.add(new JLabel(&quot; &quot;));</span>
<span class="nc" id="L1201">          final Collection&lt;Unit&gt; possible = possibleScramblers.get(from).getSecond();</span>
<span class="nc" id="L1202">          final int maxAllowed =</span>
<span class="nc" id="L1203">              Math.min(BattleDelegate.getMaxScrambleCount(possibleScramblers.get(from).getFirst()), possible.size());</span>
<span class="nc" id="L1204">          final UnitChooser chooser =</span>
<span class="nc" id="L1205">              new UnitChooser(possible, Collections.emptyMap(), data, false, uiContext);</span>
<span class="nc" id="L1206">          chooser.setMaxAndShowMaxButton(maxAllowed);</span>
<span class="nc" id="L1207">          choosers.add(Tuple.of(from, chooser));</span>
<span class="nc" id="L1208">          panelChooser.add(chooser);</span>
<span class="nc" id="L1209">          chooserScrollPane = new JScrollPane(panelChooser);</span>
<span class="nc" id="L1210">          panel2.add(chooserScrollPane);</span>
        }
<span class="nc" id="L1212">        panel.add(panel2, BorderLayout.CENTER);</span>
<span class="nc" id="L1213">        final String optionScramble = &quot;Scramble&quot;;</span>
<span class="nc" id="L1214">        final String optionNone = &quot;None&quot;;</span>
<span class="nc" id="L1215">        final String optionWait = &quot;Wait&quot;;</span>
<span class="nc" id="L1216">        final Object[] options = {optionScramble, optionNone, optionWait};</span>
<span class="nc" id="L1217">        final JOptionPane optionPane = new JOptionPane(panel, JOptionPane.PLAIN_MESSAGE,</span>
<span class="nc" id="L1218">            JOptionPane.YES_NO_CANCEL_OPTION, null, options, options[2]);</span>
<span class="nc" id="L1219">        final JDialog dialog = new JDialog((Frame) getParent(), &quot;Select units to scramble to &quot; + scrambleTo.getName());</span>
<span class="nc" id="L1220">        dialog.setContentPane(optionPane);</span>
<span class="nc" id="L1221">        dialog.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L1222">        dialog.setLocationRelativeTo(getParent());</span>
<span class="nc" id="L1223">        dialog.setAlwaysOnTop(true);</span>
<span class="nc" id="L1224">        dialog.pack();</span>
<span class="nc" id="L1225">        dialog.setVisible(true);</span>
<span class="nc" id="L1226">        dialog.requestFocusInWindow();</span>
<span class="nc" id="L1227">        optionPane.addPropertyChangeListener(e -&gt; {</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">          if (!dialog.isVisible()) {</span>
<span class="nc" id="L1229">            return;</span>
          }
<span class="nc" id="L1231">          final String option = ((String) optionPane.getValue());</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">          if (option.equals(optionNone)) {</span>
<span class="nc" id="L1233">            choosers.clear();</span>
<span class="nc" id="L1234">            selection.clear();</span>
<span class="nc" id="L1235">            dialog.setVisible(false);</span>
<span class="nc" id="L1236">            dialog.removeAll();</span>
<span class="nc" id="L1237">            dialog.dispose();</span>
<span class="nc" id="L1238">            continueLatch.countDown();</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">          } else if (option.equals(optionScramble)) {</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">            for (final Tuple&lt;Territory, UnitChooser&gt; terrChooser : choosers) {</span>
<span class="nc" id="L1241">              selection.put(terrChooser.getFirst(), terrChooser.getSecond().getSelected());</span>
            }
<span class="nc" id="L1243">            dialog.setVisible(false);</span>
<span class="nc" id="L1244">            dialog.removeAll();</span>
<span class="nc" id="L1245">            dialog.dispose();</span>
<span class="nc" id="L1246">            continueLatch.countDown();</span>
<span class="nc" id="L1247">          } else {</span>
<span class="nc" id="L1248">            choosers.clear();</span>
<span class="nc" id="L1249">            selection.clear();</span>
<span class="nc" id="L1250">            dialog.setVisible(false);</span>
<span class="nc" id="L1251">            dialog.removeAll();</span>
<span class="nc" id="L1252">            dialog.dispose();</span>
<span class="nc" id="L1253">            ThreadUtil.sleep(500);</span>
<span class="nc" id="L1254">            run();</span>
          }
<span class="nc" id="L1256">        });</span>
<span class="nc" id="L1257">      }</span>
    });
<span class="nc" id="L1259">    mapPanel.getUIContext().addShutdownLatch(continueLatch);</span>
    try {
<span class="nc" id="L1261">      continueLatch.await();</span>
<span class="nc" id="L1262">    } catch (final InterruptedException ex) {</span>
      // ignore interrupted exception
<span class="nc" id="L1264">    } finally {</span>
<span class="nc" id="L1265">      mapPanel.getUIContext().removeShutdownLatch(continueLatch);</span>
<span class="nc" id="L1266">    }</span>
<span class="nc" id="L1267">    return selection;</span>
  }

  public Collection&lt;Unit&gt; selectUnitsQuery(final Territory current, final Collection&lt;Unit&gt; possible,
      final String message) {
<span class="nc bnc" id="L1272" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1273">      return null;</span>
    }
<span class="nc" id="L1275">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">    if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1277">      throw new IllegalStateException(&quot;Should not be called from dispatch thread&quot;);</span>
    }
<span class="nc" id="L1279">    final CountDownLatch continueLatch = new CountDownLatch(1);</span>
<span class="nc" id="L1280">    final Collection&lt;Unit&gt; selection = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1281">    SwingUtilities.invokeLater(new Runnable() {</span>
      @Override
      public void run() {
<span class="nc" id="L1284">        mapPanel.centerOn(current);</span>
<span class="nc" id="L1285">        final JPanel panel = new JPanel();</span>
<span class="nc" id="L1286">        panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1287">        final JLabel messageLabel = new JLabel(message);</span>
<span class="nc" id="L1288">        messageLabel.setFont(new Font(&quot;Arial&quot;, Font.ITALIC, 12));</span>
<span class="nc" id="L1289">        panel.add(messageLabel, BorderLayout.NORTH);</span>
        JScrollPane chooserScrollPane;
<span class="nc" id="L1291">        final JPanel panelChooser = new JPanel();</span>
<span class="nc" id="L1292">        panelChooser.setLayout(new BoxLayout(panelChooser, BoxLayout.Y_AXIS));</span>
<span class="nc" id="L1293">        panelChooser.setBorder(BorderFactory.createLineBorder(getBackground()));</span>
<span class="nc" id="L1294">        final JLabel whereFrom = new JLabel(&quot;From: &quot; + current.getName());</span>
<span class="nc" id="L1295">        whereFrom.setHorizontalAlignment(SwingConstants.LEFT);</span>
<span class="nc" id="L1296">        whereFrom.setFont(new Font(&quot;Arial&quot;, Font.BOLD, 12));</span>
<span class="nc" id="L1297">        panelChooser.add(whereFrom);</span>
<span class="nc" id="L1298">        panelChooser.add(new JLabel(&quot; &quot;));</span>
<span class="nc" id="L1299">        final int maxAllowed = possible.size();</span>
<span class="nc" id="L1300">        final UnitChooser chooser =</span>
<span class="nc" id="L1301">            new UnitChooser(possible, Collections.emptyMap(), data, false, uiContext);</span>
<span class="nc" id="L1302">        chooser.setMaxAndShowMaxButton(maxAllowed);</span>
<span class="nc" id="L1303">        panelChooser.add(chooser);</span>
<span class="nc" id="L1304">        chooserScrollPane = new JScrollPane(panelChooser);</span>
<span class="nc" id="L1305">        panel.add(chooserScrollPane, BorderLayout.CENTER);</span>
<span class="nc" id="L1306">        final String optionSelect = &quot;Select&quot;;</span>
<span class="nc" id="L1307">        final String optionNone = &quot;None&quot;;</span>
<span class="nc" id="L1308">        final String optionWait = &quot;Wait&quot;;</span>
<span class="nc" id="L1309">        final Object[] options = {optionSelect, optionNone, optionWait};</span>
<span class="nc" id="L1310">        final JOptionPane optionPane = new JOptionPane(panel, JOptionPane.PLAIN_MESSAGE,</span>
<span class="nc" id="L1311">            JOptionPane.YES_NO_CANCEL_OPTION, null, options, options[2]);</span>
<span class="nc" id="L1312">        final JDialog dialog = new JDialog((Frame) getParent(), message);</span>
<span class="nc" id="L1313">        dialog.setContentPane(optionPane);</span>
<span class="nc" id="L1314">        dialog.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L1315">        dialog.setLocationRelativeTo(getParent());</span>
<span class="nc" id="L1316">        dialog.setAlwaysOnTop(true);</span>
<span class="nc" id="L1317">        dialog.pack();</span>
<span class="nc" id="L1318">        dialog.setVisible(true);</span>
<span class="nc" id="L1319">        dialog.requestFocusInWindow();</span>
<span class="nc" id="L1320">        optionPane.addPropertyChangeListener(e -&gt; {</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">          if (!dialog.isVisible()) {</span>
<span class="nc" id="L1322">            return;</span>
          }
<span class="nc" id="L1324">          final String option = ((String) optionPane.getValue());</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">          if (option.equals(optionNone)) {</span>
<span class="nc" id="L1326">            selection.clear();</span>
<span class="nc" id="L1327">            dialog.setVisible(false);</span>
<span class="nc" id="L1328">            dialog.removeAll();</span>
<span class="nc" id="L1329">            dialog.dispose();</span>
<span class="nc" id="L1330">            continueLatch.countDown();</span>
<span class="nc bnc" id="L1331" title="All 2 branches missed.">          } else if (option.equals(optionSelect)) {</span>
<span class="nc" id="L1332">            selection.addAll(chooser.getSelected());</span>
<span class="nc" id="L1333">            dialog.setVisible(false);</span>
<span class="nc" id="L1334">            dialog.removeAll();</span>
<span class="nc" id="L1335">            dialog.dispose();</span>
<span class="nc" id="L1336">            continueLatch.countDown();</span>
<span class="nc" id="L1337">          } else {</span>
<span class="nc" id="L1338">            selection.clear();</span>
<span class="nc" id="L1339">            dialog.setVisible(false);</span>
<span class="nc" id="L1340">            dialog.removeAll();</span>
<span class="nc" id="L1341">            dialog.dispose();</span>
<span class="nc" id="L1342">            ThreadUtil.sleep(500);</span>
<span class="nc" id="L1343">            run();</span>
          }
<span class="nc" id="L1345">        });</span>
<span class="nc" id="L1346">      }</span>
    });
<span class="nc" id="L1348">    mapPanel.getUIContext().addShutdownLatch(continueLatch);</span>
    try {
<span class="nc" id="L1350">      continueLatch.await();</span>
<span class="nc" id="L1351">    } catch (final InterruptedException ex) {</span>
<span class="nc" id="L1352">      ex.printStackTrace();</span>
<span class="nc" id="L1353">    } finally {</span>
<span class="nc" id="L1354">      mapPanel.getUIContext().removeShutdownLatch(continueLatch);</span>
<span class="nc" id="L1355">    }</span>
<span class="nc" id="L1356">    return selection;</span>
  }

  public PoliticalActionAttachment getPoliticalActionChoice(final PlayerID player, final boolean firstRun,
      final IPoliticsDelegate iPoliticsDelegate) {
<span class="nc bnc" id="L1361" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1362">      return null;</span>
    }
<span class="nc" id="L1364">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L1365">    actionButtons.changeToPolitics(player);</span>
<span class="nc" id="L1366">    requestWindowFocus();</span>
<span class="nc" id="L1367">    return actionButtons.waitForPoliticalAction(firstRun, iPoliticsDelegate);</span>
  }

  public UserActionAttachment getUserActionChoice(final PlayerID player, final boolean firstRun,
      final IUserActionDelegate iUserActionDelegate) {
<span class="nc bnc" id="L1372" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1373">      return null;</span>
    }
<span class="nc" id="L1375">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L1376">    actionButtons.changeToUserActions(player);</span>
<span class="nc" id="L1377">    requestWindowFocus();</span>
<span class="nc" id="L1378">    return actionButtons.waitForUserActionAction(firstRun, iUserActionDelegate);</span>
  }

  public TechRoll getTechRolls(final PlayerID id) {
<span class="nc bnc" id="L1382" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1383">      return null;</span>
    }
<span class="nc" id="L1385">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L1386">    actionButtons.changeToTech(id);</span>
    // workaround for panel not receiving focus at beginning of tech phase
<span class="nc" id="L1388">    requestWindowFocus();</span>
<span class="nc" id="L1389">    return actionButtons.waitForTech();</span>
  }

  public Territory getRocketAttack(final Collection&lt;Territory&gt; candidates, final Territory from) {
<span class="nc bnc" id="L1393" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L1394">      return null;</span>
    }
<span class="nc" id="L1396">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L1397">    mapPanel.centerOn(from);</span>
<span class="nc" id="L1398">    final AtomicReference&lt;Territory&gt; selected = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L1399">    SwingAction.invokeAndWait(() -&gt; {</span>
<span class="nc" id="L1400">      final JList&lt;Territory&gt; list = new JList&lt;&gt;(new Vector&lt;&gt;(candidates));</span>
<span class="nc" id="L1401">      list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1402">      list.setSelectedIndex(0);</span>
<span class="nc" id="L1403">      final JPanel panel = new JPanel();</span>
<span class="nc" id="L1404">      panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1405">      final JScrollPane scroll = new JScrollPane(list);</span>
<span class="nc" id="L1406">      panel.add(scroll, BorderLayout.CENTER);</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">      if (from != null) {</span>
<span class="nc" id="L1408">        panel.add(BorderLayout.NORTH, new JLabel(&quot;Targets for rocket in &quot; + from.getName()));</span>
      }
<span class="nc" id="L1410">      final String[] options = {&quot;OK&quot;, &quot;Dont attack&quot;};</span>
<span class="nc" id="L1411">      final String message = &quot;Select Rocket Target&quot;;</span>
<span class="nc" id="L1412">      final int selection = JOptionPane.showOptionDialog(TripleAFrame.this, panel, message,</span>
<span class="nc" id="L1413">          JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE, null, options, null);</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">      if (selection == 0) {</span>
<span class="nc" id="L1415">        selected.set(list.getSelectedValue());</span>
      }
<span class="nc" id="L1417">    });</span>
<span class="nc" id="L1418">    return selected.get();</span>
  }

  public static int save(final String filename, final GameData m_data) {
<span class="nc" id="L1422">    try (FileOutputStream fos = new FileOutputStream(filename);</span>
<span class="nc" id="L1423">        ObjectOutputStream oos = new ObjectOutputStream(fos);) {</span>
<span class="nc" id="L1424">      oos.writeObject(m_data);</span>
<span class="nc" id="L1425">      return 0;</span>
<span class="nc bnc" id="L1426" title="All 16 branches missed.">    } catch (final Throwable t) {</span>
<span class="nc" id="L1427">      System.err.println(t.getMessage());</span>
<span class="nc" id="L1428">      return -1;</span>
    }
  }

<span class="nc" id="L1432">  GameStepListener m_stepListener = (stepName, delegateName, player1, round1, stepDisplayName) -&gt; updateStep();</span>

  private void updateStep() {
<span class="nc" id="L1435">    final IUIContext context = uiContext;</span>
<span class="nc bnc" id="L1436" title="All 4 branches missed.">    if (context == null || context.isShutDown()) {</span>
<span class="nc" id="L1437">      return;</span>
    }
<span class="nc" id="L1439">    data.acquireReadLock();</span>
    try {
<span class="nc bnc" id="L1441" title="All 2 branches missed.">      if (data.getSequence().getStep() == null) {</span>
<span class="nc" id="L1442">        return;</span>
      }
<span class="nc" id="L1444">    } finally {</span>
<span class="nc" id="L1445">      data.releaseReadLock();</span>
<span class="nc" id="L1446">    }</span>
    // we need to invoke and wait here since
    // if we switch to the history as a result of a history
    // change, we need to ensure that no further history
    // events are run until our historySynchronizer is set up
<span class="nc bnc" id="L1451" title="All 2 branches missed.">    if (!SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1452">      SwingAction.invokeAndWait(() -&gt; updateStep());</span>
<span class="nc" id="L1453">      return;</span>
    }
    int round;
    String stepDisplayName;
    PlayerID player;
<span class="nc" id="L1458">    data.acquireReadLock();</span>
    try {
<span class="nc" id="L1460">      round = data.getSequence().getRound();</span>
<span class="nc" id="L1461">      stepDisplayName = data.getSequence().getStep().getDisplayName();</span>
<span class="nc" id="L1462">      player = data.getSequence().getStep().getPlayerID();</span>
<span class="nc" id="L1463">    } finally {</span>
<span class="nc" id="L1464">      data.releaseReadLock();</span>
<span class="nc" id="L1465">    }</span>
<span class="nc" id="L1466">    this.round.setText(&quot;Round:&quot; + round + &quot; &quot;);</span>
<span class="nc" id="L1467">    step.setText(stepDisplayName);</span>
<span class="nc" id="L1468">    final boolean isPlaying = localPlayers.playing(player);</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">    if (player != null) {</span>
<span class="nc bnc" id="L1470" title="All 2 branches missed.">      this.player.setText((isPlaying ? &quot;&quot; : &quot;REMOTE: &quot;) + player.getName());</span>
    }
<span class="nc bnc" id="L1472" title="All 4 branches missed.">    if (player != null &amp;&amp; !player.isNull()) {</span>
<span class="nc" id="L1473">      this.round.setIcon(new ImageIcon(uiContext.getFlagImageFactory().getFlag(player)));</span>
<span class="nc" id="L1474">      lastStepPlayer = currentStepPlayer;</span>
<span class="nc" id="L1475">      currentStepPlayer = player;</span>
    }
    // if the game control has passed to someone else and we are not just showing the map
    // show the history
<span class="nc bnc" id="L1479" title="All 4 branches missed.">    if (player != null &amp;&amp; !player.isNull()) {</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">      if (isPlaying) {</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">        if (inHistory) {</span>
<span class="nc" id="L1482">          requiredTurnSeries.put(player, true);</span>
          // if the game control is with us
          // show the current game
<span class="nc" id="L1485">          showGame();</span>
          // System.out.println(&quot;Changing step to &quot; + stepDisplayName + &quot; for &quot; + player.getName());
        }
<span class="nc" id="L1488">      } else {</span>
<span class="nc bnc" id="L1489" title="All 4 branches missed.">        if (!inHistory &amp;&amp; !uiContext.getShowMapOnly()) {</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">          if (!SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1491">            throw new IllegalStateException(&quot;We should be in dispatch thread&quot;);</span>
          }
<span class="nc" id="L1493">          showHistory();</span>
        }
      }
    }
<span class="nc" id="L1497">  }</span>

  public void requiredTurnSeries(final PlayerID player) {
<span class="nc bnc" id="L1500" title="All 2 branches missed.">    if (player == null) {</span>
<span class="nc" id="L1501">      return;</span>
    }
<span class="nc" id="L1503">    ThreadUtil.sleep(300);</span>
<span class="nc" id="L1504">    SwingAction.invokeAndWait(() -&gt; {</span>
<span class="nc" id="L1505">      final Boolean play = requiredTurnSeries.get(player);</span>
<span class="nc bnc" id="L1506" title="All 4 branches missed.">      if (play != null &amp;&amp; play) {</span>
<span class="nc" id="L1507">        ClipPlayer.play(SoundPath.CLIP_REQUIRED_YOUR_TURN_SERIES, player);</span>
<span class="nc" id="L1508">        requiredTurnSeries.put(player, false);</span>
      }
      // center on capital of player, if it is a new player
<span class="nc bnc" id="L1511" title="All 2 branches missed.">      if (!player.equals(lastStepPlayer)) {</span>
<span class="nc" id="L1512">        lastStepPlayer = player;</span>
<span class="nc" id="L1513">        data.acquireReadLock();</span>
        try {
<span class="nc" id="L1515">          mapPanel.centerOn(TerritoryAttachment.getFirstOwnedCapitalOrFirstUnownedCapital(player, data));</span>
<span class="nc" id="L1516">        } finally {</span>
<span class="nc" id="L1517">          data.releaseReadLock();</span>
<span class="nc" id="L1518">        }</span>
      }
<span class="nc" id="L1520">    });</span>
<span class="nc" id="L1521">  }</span>

<span class="nc" id="L1523">  GameDataChangeListener m_dataChangeListener = new GameDataChangeListener() {</span>
    @Override
    public void gameDataChanged(final Change change) {
      try {
<span class="nc" id="L1527">        SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">          if (uiContext == null) {</span>
<span class="nc" id="L1529">            return;</span>
          }
<span class="nc bnc" id="L1531" title="All 2 branches missed.">          if (getEditMode()) {</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">            if (tabsPanel.indexOfComponent(editPanel) == -1) {</span>
<span class="nc" id="L1533">              showEditMode();</span>
            }
<span class="nc" id="L1535">          } else {</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">            if (tabsPanel.indexOfComponent(editPanel) != -1) {</span>
<span class="nc" id="L1537">              hideEditMode();</span>
            }
          }
<span class="nc bnc" id="L1540" title="All 2 branches missed.">          if (uiContext.getShowMapOnly()) {</span>
<span class="nc" id="L1541">            hideRightHandSidePanel();</span>
            // display troop movement
<span class="nc" id="L1543">            final HistoryNode node = data.getHistory().getLastNode();</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">            if (node instanceof Renderable) {</span>
<span class="nc" id="L1545">              final Object details1 = ((Renderable) node).getRenderingData();</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">              if (details1 instanceof MoveDescription) {</span>
<span class="nc" id="L1547">                final MoveDescription moveMessage = (MoveDescription) details1;</span>
<span class="nc" id="L1548">                final Route route = moveMessage.getRoute();</span>
<span class="nc" id="L1549">                mapPanel.setRoute(null);</span>
<span class="nc" id="L1550">                mapPanel.setRoute(route);</span>
<span class="nc" id="L1551">                final Territory terr = route.getEnd();</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">                if (!mapPanel.isShowing(terr)) {</span>
<span class="nc" id="L1553">                  mapPanel.centerOn(terr);</span>
                }
              }
            }
<span class="nc" id="L1557">          } else {</span>
<span class="nc" id="L1558">            showRightHandSidePanel();</span>
          }
<span class="nc" id="L1560">        });</span>
<span class="nc" id="L1561">      } catch (final Exception e) {</span>
<span class="nc" id="L1562">        ClientLogger.logQuietly(e);</span>
      }
<span class="nc" id="L1564">    }</span>
  };

  private KeyListener getArrowKeyListener() {
<span class="nc" id="L1568">    return new KeyListener() {</span>
      @Override
      public void keyPressed(final KeyEvent e) {

        // scroll map according to wasd/arrowkeys
<span class="nc" id="L1573">        final int diffPixel = computeScrollSpeed(e);</span>
<span class="nc" id="L1574">        final int x = mapPanel.getXOffset();</span>
<span class="nc" id="L1575">        final int y = mapPanel.getYOffset();</span>
<span class="nc" id="L1576">        final int keyCode = e.getKeyCode();</span>

<span class="nc bnc" id="L1578" title="All 4 branches missed.">        if (keyCode == KeyEvent.VK_RIGHT || keyCode == KeyEvent.VK_D) {</span>
<span class="nc" id="L1579">          getMapPanel().setTopLeft(x + diffPixel, y);</span>
<span class="nc bnc" id="L1580" title="All 4 branches missed.">        } else if (keyCode == KeyEvent.VK_LEFT || keyCode == KeyEvent.VK_A) {</span>
<span class="nc" id="L1581">          getMapPanel().setTopLeft(x - diffPixel, y);</span>
<span class="nc bnc" id="L1582" title="All 4 branches missed.">        } else if (keyCode == KeyEvent.VK_DOWN || keyCode == KeyEvent.VK_S) {</span>
<span class="nc" id="L1583">          getMapPanel().setTopLeft(x, y + diffPixel);</span>
<span class="nc bnc" id="L1584" title="All 4 branches missed.">        } else if (keyCode == KeyEvent.VK_UP || keyCode == KeyEvent.VK_W) {</span>
<span class="nc" id="L1585">          getMapPanel().setTopLeft(x, y - diffPixel);</span>
        }
        // I for info
<span class="nc bnc" id="L1588" title="All 4 branches missed.">        if (keyCode == KeyEvent.VK_I || keyCode == KeyEvent.VK_V) {</span>
<span class="nc" id="L1589">          String unitInfo = &quot;&quot;;</span>
<span class="nc bnc" id="L1590" title="All 4 branches missed.">          if (unitsBeingMousedOver != null &amp;&amp; !unitsBeingMousedOver.isEmpty()) {</span>
<span class="nc" id="L1591">            final Unit unit = unitsBeingMousedOver.get(0);</span>
<span class="nc" id="L1592">            final UnitAttachment ua = UnitAttachment.get(unit.getType());</span>
<span class="nc bnc" id="L1593" title="All 2 branches missed.">            if (ua != null) {</span>
<span class="nc" id="L1594">              unitInfo = &quot;&lt;b&gt;Unit:&lt;/b&gt;&lt;br&gt;&quot; + unit.getType().getName() + &quot;: &quot;</span>
<span class="nc" id="L1595">                  + ua.toStringShortAndOnlyImportantDifferences(unit.getOwner(), true, false);</span>
            }
          }
<span class="nc" id="L1598">          String terrInfo = &quot;&quot;;</span>
<span class="nc bnc" id="L1599" title="All 2 branches missed.">          if (territoryLastEntered != null) {</span>
<span class="nc" id="L1600">            final TerritoryAttachment ta = TerritoryAttachment.get(territoryLastEntered);</span>
<span class="nc bnc" id="L1601" title="All 2 branches missed.">            if (ta != null) {</span>
<span class="nc" id="L1602">              terrInfo = &quot;&lt;b&gt;Territory:&lt;/b&gt;&lt;br&gt;&quot; + ta.toStringForInfo(true, true) + &quot;&lt;br&gt;&quot;;</span>
<span class="nc" id="L1603">            } else {</span>
<span class="nc" id="L1604">              terrInfo = &quot;&lt;b&gt;Territory:&lt;/b&gt;&lt;br&gt;&quot; + territoryLastEntered.getName() + &quot;&lt;br&gt;Water Territory&quot;;</span>
            }
          }
<span class="nc" id="L1607">          String tipText = unitInfo;</span>
<span class="nc bnc" id="L1608" title="All 4 branches missed.">          if (unitInfo.length() &gt; 0 &amp;&amp; terrInfo.length() &gt; 0) {</span>
<span class="nc" id="L1609">            tipText = tipText + &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;</span>
          }
<span class="nc" id="L1611">          tipText = tipText + terrInfo;</span>
<span class="nc bnc" id="L1612" title="All 2 branches missed.">          if (tipText.length() &gt; 0) {</span>
<span class="nc" id="L1613">            final Point currentPoint = MouseInfo.getPointerInfo().getLocation();</span>
<span class="nc" id="L1614">            final PopupFactory popupFactory = PopupFactory.getSharedInstance();</span>
<span class="nc" id="L1615">            final JToolTip info = new JToolTip();</span>
<span class="nc" id="L1616">            info.setTipText(&quot;&lt;html&gt;&quot; + tipText + &quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L1617">            final Popup popup = popupFactory.getPopup(mapPanel, info, currentPoint.x, currentPoint.y);</span>
<span class="nc" id="L1618">            popup.show();</span>
<span class="nc" id="L1619">            final Runnable disposePopup = () -&gt; {</span>
<span class="nc" id="L1620">              ThreadUtil.sleep(5000);</span>
<span class="nc" id="L1621">              popup.hide();</span>
<span class="nc" id="L1622">            };</span>
<span class="nc" id="L1623">            new Thread(disposePopup, &quot;popup waiter&quot;).start();</span>
          }
        }
<span class="nc" id="L1626">      }</span>

      @Override
<span class="nc" id="L1629">      public void keyTyped(final KeyEvent e) {}</span>

      @Override
<span class="nc" id="L1632">      public void keyReleased(final KeyEvent e) {}</span>
    };
  }

  private int computeScrollSpeed(final KeyEvent e) {
<span class="nc" id="L1637">    int multiplier = 1;</span>

<span class="nc bnc" id="L1639" title="All 2 branches missed.">    if (e.isControlDown()) {</span>
<span class="nc" id="L1640">      multiplier = scrollSettings.getFasterArrowKeyScrollMultiplier();</span>
    }


<span class="nc" id="L1644">    final int starterDiffPixel = scrollSettings.getArrowKeyScrollSpeed();</span>
<span class="nc" id="L1645">    return (starterDiffPixel * multiplier);</span>
  }

  private void showEditMode() {
<span class="nc" id="L1649">    tabsPanel.addTab(&quot;Edit&quot;, editPanel);</span>
<span class="nc bnc" id="L1650" title="All 2 branches missed.">    if (editDelegate != null) {</span>
<span class="nc" id="L1651">      tabsPanel.setSelectedComponent(editPanel);</span>
    }
<span class="nc" id="L1653">    editModeButtonModel.setSelected(true);</span>
<span class="nc" id="L1654">    getGlassPane().setVisible(true);</span>
<span class="nc" id="L1655">  }</span>

  private void hideEditMode() {
<span class="nc bnc" id="L1658" title="All 2 branches missed.">    if (tabsPanel.getSelectedComponent() == editPanel) {</span>
<span class="nc" id="L1659">      tabsPanel.setSelectedIndex(0);</span>
    }
<span class="nc" id="L1661">    tabsPanel.remove(editPanel);</span>
<span class="nc" id="L1662">    editModeButtonModel.setSelected(false);</span>
<span class="nc" id="L1663">    getGlassPane().setVisible(false);</span>
<span class="nc" id="L1664">  }</span>

  public void showActionPanelTab() {
<span class="nc" id="L1667">    tabsPanel.setSelectedIndex(0);</span>
<span class="nc" id="L1668">  }</span>

  public void showRightHandSidePanel() {
<span class="nc" id="L1671">    rightHandSidePanel.setVisible(true);</span>
<span class="nc" id="L1672">  }</span>

  public void hideRightHandSidePanel() {
<span class="nc" id="L1675">    rightHandSidePanel.setVisible(false);</span>
<span class="nc" id="L1676">  }</span>

  public HistoryPanel getHistoryPanel() {
<span class="nc" id="L1679">    return historyPanel;</span>
  }

  private void showHistory() {
<span class="nc" id="L1683">    inHistory = true;</span>
<span class="nc" id="L1684">    inGame = false;</span>
<span class="nc" id="L1685">    setWidgetActivation();</span>
    final GameData clonedGameData;
<span class="nc" id="L1687">    data.acquireReadLock();</span>
    try {
      // we want to use a clone of the data, so we can make changes to it
      // as we walk up and down the history
<span class="nc" id="L1691">      clonedGameData = GameDataUtils.cloneGameData(data);</span>
<span class="nc bnc" id="L1692" title="All 2 branches missed.">      if (clonedGameData == null) {</span>
<span class="nc" id="L1693">        return;</span>
      }
<span class="nc" id="L1695">      data.removeDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L1696">      clonedGameData.testLocksOnRead();</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">      if (historySyncher != null) {</span>
<span class="nc" id="L1698">        throw new IllegalStateException(&quot;Two history synchers?&quot;);</span>
      }
<span class="nc" id="L1700">      historySyncher = new HistorySynchronizer(clonedGameData, game);</span>
<span class="nc" id="L1701">      clonedGameData.addDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L1702">    } finally {</span>
<span class="nc" id="L1703">      data.releaseReadLock();</span>
<span class="nc" id="L1704">    }</span>
<span class="nc" id="L1705">    statsPanel.setGameData(clonedGameData);</span>
<span class="nc" id="L1706">    economyPanel.setGameData(clonedGameData);</span>
<span class="nc bnc" id="L1707" title="All 4 branches missed.">    if (objectivePanel != null &amp;&amp; !objectivePanel.isEmpty()) {</span>
<span class="nc" id="L1708">      objectivePanel.setGameData(clonedGameData);</span>
    }
<span class="nc" id="L1710">    details.setGameData(clonedGameData);</span>
<span class="nc" id="L1711">    mapPanel.setGameData(clonedGameData);</span>
<span class="nc" id="L1712">    final HistoryDetailsPanel historyDetailPanel = new HistoryDetailsPanel(clonedGameData, mapPanel);</span>
<span class="nc" id="L1713">    tabsPanel.removeAll();</span>
<span class="nc" id="L1714">    tabsPanel.add(&quot;History&quot;, historyDetailPanel);</span>
<span class="nc" id="L1715">    tabsPanel.add(&quot;Stats&quot;, statsPanel);</span>
<span class="nc" id="L1716">    tabsPanel.add(&quot;Economy&quot;, economyPanel);</span>
<span class="nc bnc" id="L1717" title="All 4 branches missed.">    if (objectivePanel != null &amp;&amp; !objectivePanel.isEmpty()) {</span>
<span class="nc" id="L1718">      tabsPanel.add(objectivePanel.getName(), objectivePanel);</span>
    }
<span class="nc" id="L1720">    tabsPanel.add(&quot;Notes&quot;, notesPanel);</span>
<span class="nc" id="L1721">    tabsPanel.add(&quot;Territory&quot;, details);</span>
<span class="nc bnc" id="L1722" title="All 2 branches missed.">    if (getEditMode()) {</span>
<span class="nc" id="L1723">      tabsPanel.add(&quot;Edit&quot;, editPanel);</span>
    }
<span class="nc bnc" id="L1725" title="All 2 branches missed.">    if (actionButtons.getCurrent() != null) {</span>
<span class="nc" id="L1726">      actionButtons.getCurrent().setActive(false);</span>
    }
<span class="nc" id="L1728">    historyComponent.removeAll();</span>
<span class="nc" id="L1729">    historyComponent.setLayout(new BorderLayout());</span>
    // create history tree context menu
    // actions need to clear the history panel popup state when done
<span class="nc" id="L1732">    final JPopupMenu popup = new JPopupMenu();</span>
<span class="nc" id="L1733">    popup.add(new AbstractAction(&quot;Show Summary Log&quot;) {</span>
      private static final long serialVersionUID = -6730966512179268157L;

      @Override
      public void actionPerformed(final ActionEvent ae) {
<span class="nc" id="L1738">        final HistoryLog historyLog = new HistoryLog();</span>
<span class="nc" id="L1739">        historyLog.printRemainingTurn(historyPanel.getCurrentPopupNode(), false, data.getDiceSides(), null);</span>
<span class="nc" id="L1740">        historyLog.printTerritorySummary(historyPanel.getCurrentPopupNode(), clonedGameData);</span>
<span class="nc" id="L1741">        historyLog.printProductionSummary(clonedGameData);</span>
<span class="nc" id="L1742">        historyPanel.clearCurrentPopupNode();</span>
<span class="nc" id="L1743">        historyLog.setVisible(true);</span>
<span class="nc" id="L1744">      }</span>
    });
<span class="nc" id="L1746">    popup.add(new AbstractAction(&quot;Show Detailed Log&quot;) {</span>
      private static final long serialVersionUID = -8709762764495294671L;

      @Override
      public void actionPerformed(final ActionEvent ae) {
<span class="nc" id="L1751">        final HistoryLog historyLog = new HistoryLog();</span>
<span class="nc" id="L1752">        historyLog.printRemainingTurn(historyPanel.getCurrentPopupNode(), true, data.getDiceSides(), null);</span>
<span class="nc" id="L1753">        historyLog.printTerritorySummary(historyPanel.getCurrentPopupNode(), clonedGameData);</span>
<span class="nc" id="L1754">        historyLog.printProductionSummary(clonedGameData);</span>
<span class="nc" id="L1755">        historyPanel.clearCurrentPopupNode();</span>
<span class="nc" id="L1756">        historyLog.setVisible(true);</span>
<span class="nc" id="L1757">      }</span>
    });
<span class="nc" id="L1759">    popup.add(new AbstractAction(&quot;Save Screenshot&quot;) {</span>
      private static final long serialVersionUID = 1222760138263428443L;

      @Override
      public void actionPerformed(final ActionEvent ae) {
<span class="nc" id="L1764">        ExportMenu.saveScreenshot(historyPanel.getCurrentPopupNode(), TripleAFrame.this, data);</span>
<span class="nc" id="L1765">        historyPanel.clearCurrentPopupNode();</span>
<span class="nc" id="L1766">      }</span>
    });
<span class="nc" id="L1768">    popup.add(new AbstractAction(&quot;Save Game at this point (BETA)&quot;) {</span>
      private static final long serialVersionUID = 1430512376199927896L;

      @Override
      public void actionPerformed(final ActionEvent ae) {
<span class="nc" id="L1773">        JOptionPane.showMessageDialog(TripleAFrame.this,</span>
<span class="nc" id="L1774">            &quot;Please first left click on the spot you want to save from, Then right click and select 'Save Game From History'&quot;</span>
                + &quot;\n\nIt is recommended that when saving the game from the History panel:&quot;
                + &quot;\n * Your CURRENT GAME is at the start of some player's turn, and that no moves have been made and no actions taken yet.&quot;
                + &quot;\n * The point in HISTORY that you are trying to save at, is at the beginning of a player's turn, or the beginning of a round.&quot;
                + &quot;\nSaving at any other point, could potentially create errors.&quot;
                + &quot;\nFor example, saving while your current game is in the middle of a move or battle phase will always create errors in the savegame.&quot;
                + &quot;\nAnd you will also get errors in the savegame if you try to create a save at a point in history such as a move or battle phase.&quot;,
<span class="nc" id="L1781">            &quot;Save Game from History&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
<span class="nc" id="L1782">        data.acquireReadLock();</span>
        // m_data.acquireWriteLock();
        try {
<span class="nc" id="L1785">          final File f = TripleAMenuBar.getSaveGameLocationDialog(TripleAFrame.this);</span>
<span class="nc bnc" id="L1786" title="All 2 branches missed.">          if (f != null) {</span>
<span class="nc" id="L1787">            try (FileOutputStream fout = new FileOutputStream(f)) {</span>
<span class="nc" id="L1788">              final GameData datacopy = GameDataUtils.cloneGameData(data, true);</span>
<span class="nc" id="L1789">              datacopy.getHistory().gotoNode(historyPanel.getCurrentPopupNode());</span>
<span class="nc" id="L1790">              datacopy.getHistory().removeAllHistoryAfterNode(historyPanel.getCurrentPopupNode());</span>
              // TODO: the saved current delegate is still the current delegate,
              // rather than the delegate at that history popup node
              // TODO: it still shows the current round number, rather than the round at the history popup node
              // TODO: this could be solved easily if rounds/steps were changes,
              // but that could greatly increase the file size :(
              // TODO: this also does not undo the runcount of each delegate step
              @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L1798">              final Enumeration&lt;HistoryNode&gt; enumeration =</span>
<span class="nc" id="L1799">                  ((DefaultMutableTreeNode) datacopy.getHistory().getRoot()).preorderEnumeration();</span>
<span class="nc" id="L1800">              enumeration.nextElement();</span>
<span class="nc" id="L1801">              int round = 0;</span>
<span class="nc" id="L1802">              String stepDisplayName = datacopy.getSequence().getStep(0).getDisplayName();</span>
<span class="nc" id="L1803">              PlayerID currentPlayer = datacopy.getSequence().getStep(0).getPlayerID();</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">              while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L1805">                final HistoryNode node = enumeration.nextElement();</span>
<span class="nc bnc" id="L1806" title="All 2 branches missed.">                if (node instanceof Round) {</span>
<span class="nc" id="L1807">                  round = Math.max(0, ((Round) node).getRoundNo() - datacopy.getSequence().getRoundOffset());</span>
<span class="nc" id="L1808">                  currentPlayer = null;</span>
<span class="nc" id="L1809">                  stepDisplayName = node.getTitle();</span>
<span class="nc bnc" id="L1810" title="All 2 branches missed.">                } else if (node instanceof Step) {</span>
<span class="nc" id="L1811">                  currentPlayer = ((Step) node).getPlayerID();</span>
<span class="nc" id="L1812">                  stepDisplayName = node.getTitle();</span>
                }
              }
<span class="nc" id="L1815">              datacopy.getSequence().setRoundAndStep(round, stepDisplayName, currentPlayer);</span>
<span class="nc" id="L1816">              new GameDataManager().saveGame(fout, datacopy);</span>
<span class="nc" id="L1817">              JOptionPane.showMessageDialog(TripleAFrame.this, &quot;Game Saved&quot;, &quot;Game Saved&quot;,</span>
<span class="nc" id="L1818">                  JOptionPane.INFORMATION_MESSAGE);</span>
<span class="nc bnc" id="L1819" title="All 8 branches missed.">            } catch (final IOException e) {</span>
<span class="nc" id="L1820">              ClientLogger.logQuietly(e);</span>
            }
          }
<span class="nc" id="L1823">        } finally {</span>
<span class="nc" id="L1824">          data.releaseReadLock();</span>
<span class="nc" id="L1825">        }</span>
<span class="nc" id="L1826">        historyPanel.clearCurrentPopupNode();</span>
<span class="nc" id="L1827">      }</span>
    });
<span class="nc" id="L1829">    final JSplitPane split = new JSplitPane();</span>
<span class="nc" id="L1830">    split.setOneTouchExpandable(true);</span>
<span class="nc" id="L1831">    split.setDividerSize(8);</span>
<span class="nc" id="L1832">    historyPanel = new HistoryPanel(clonedGameData, historyDetailPanel, popup, uiContext);</span>
<span class="nc" id="L1833">    split.setLeftComponent(historyPanel);</span>
<span class="nc" id="L1834">    split.setRightComponent(gameCenterPanel);</span>
<span class="nc" id="L1835">    split.setDividerLocation(150);</span>
<span class="nc" id="L1836">    historyComponent.add(split, BorderLayout.CENTER);</span>
<span class="nc" id="L1837">    historyComponent.add(gameSouthPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L1838">    getContentPane().removeAll();</span>
<span class="nc" id="L1839">    getContentPane().add(historyComponent, BorderLayout.CENTER);</span>
<span class="nc" id="L1840">    validate();</span>
<span class="nc" id="L1841">  }</span>

  public void showGame() {
<span class="nc" id="L1844">    inGame = true;</span>
<span class="nc" id="L1845">    uiContext.setShowMapOnly(false);</span>
    // Are we coming from showHistory mode or showMapOnly mode?
<span class="nc bnc" id="L1847" title="All 2 branches missed.">    if (inHistory) {</span>
<span class="nc" id="L1848">      inHistory = false;</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">      if (historySyncher != null) {</span>
<span class="nc" id="L1850">        historySyncher.deactivate();</span>
<span class="nc" id="L1851">        historySyncher = null;</span>
      }
<span class="nc" id="L1853">      historyPanel.goToEnd();</span>
<span class="nc" id="L1854">      historyPanel = null;</span>
<span class="nc" id="L1855">      mapPanel.getData().removeDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L1856">      statsPanel.setGameData(data);</span>
<span class="nc" id="L1857">      economyPanel.setGameData(data);</span>
<span class="nc bnc" id="L1858" title="All 4 branches missed.">      if (objectivePanel != null &amp;&amp; !objectivePanel.isEmpty()) {</span>
<span class="nc" id="L1859">        objectivePanel.setGameData(data);</span>
      }
<span class="nc" id="L1861">      details.setGameData(data);</span>
<span class="nc" id="L1862">      mapPanel.setGameData(data);</span>
<span class="nc" id="L1863">      data.addDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L1864">      tabsPanel.removeAll();</span>
    }
<span class="nc" id="L1866">    setWidgetActivation();</span>
<span class="nc" id="L1867">    tabsPanel.add(&quot;Action&quot;, actionButtons);</span>
<span class="nc" id="L1868">    tabsPanel.add(&quot;Stats&quot;, statsPanel);</span>
<span class="nc" id="L1869">    tabsPanel.add(&quot;Economy&quot;, economyPanel);</span>
<span class="nc bnc" id="L1870" title="All 4 branches missed.">    if (objectivePanel != null &amp;&amp; !objectivePanel.isEmpty()) {</span>
<span class="nc" id="L1871">      tabsPanel.add(objectivePanel.getName(), objectivePanel);</span>
    }
<span class="nc" id="L1873">    tabsPanel.add(&quot;Notes&quot;, notesPanel);</span>
<span class="nc" id="L1874">    tabsPanel.add(&quot;Territory&quot;, details);</span>
<span class="nc bnc" id="L1875" title="All 2 branches missed.">    if (getEditMode()) {</span>
<span class="nc" id="L1876">      tabsPanel.add(&quot;Edit&quot;, editPanel);</span>
    }
<span class="nc bnc" id="L1878" title="All 2 branches missed.">    if (actionButtons.getCurrent() != null) {</span>
<span class="nc" id="L1879">      actionButtons.getCurrent().setActive(true);</span>
    }
<span class="nc" id="L1881">    gameMainPanel.removeAll();</span>
<span class="nc" id="L1882">    gameMainPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1883">    gameMainPanel.add(gameCenterPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L1884">    gameMainPanel.add(gameSouthPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L1885">    getContentPane().removeAll();</span>
<span class="nc" id="L1886">    getContentPane().add(gameMainPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L1887">    mapPanel.setRoute(null);</span>
<span class="nc" id="L1888">    validate();</span>
<span class="nc" id="L1889">  }</span>

  public void showMapOnly() {
    // Are we coming from showHistory mode or showGame mode?
<span class="nc bnc" id="L1893" title="All 2 branches missed.">    if (inHistory) {</span>
<span class="nc" id="L1894">      inHistory = false;</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">      if (historySyncher != null) {</span>
<span class="nc" id="L1896">        historySyncher.deactivate();</span>
<span class="nc" id="L1897">        historySyncher = null;</span>
      }
<span class="nc" id="L1899">      historyPanel.goToEnd();</span>
<span class="nc" id="L1900">      historyPanel = null;</span>
<span class="nc" id="L1901">      mapPanel.getData().removeDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L1902">      mapPanel.setGameData(data);</span>
<span class="nc" id="L1903">      data.addDataChangeListener(m_dataChangeListener);</span>
<span class="nc" id="L1904">      gameMainPanel.removeAll();</span>
<span class="nc" id="L1905">      gameMainPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1906">      gameMainPanel.add(mapAndChatPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L1907">      gameMainPanel.add(rightHandSidePanel, BorderLayout.EAST);</span>
<span class="nc" id="L1908">      gameMainPanel.add(gameSouthPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L1909">      getContentPane().removeAll();</span>
<span class="nc" id="L1910">      getContentPane().add(gameMainPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L1911">      mapPanel.setRoute(null);</span>
<span class="nc" id="L1912">    } else {</span>
<span class="nc" id="L1913">      inGame = false;</span>
    }
<span class="nc" id="L1915">    uiContext.setShowMapOnly(true);</span>
<span class="nc" id="L1916">    setWidgetActivation();</span>
<span class="nc" id="L1917">    validate();</span>
<span class="nc" id="L1918">  }</span>



  private void setWidgetActivation() {
<span class="nc bnc" id="L1923" title="All 2 branches missed.">    if (!SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1924">      SwingUtilities.invokeLater(() -&gt; setWidgetActivation());</span>
<span class="nc" id="L1925">      return;</span>
    }
<span class="nc bnc" id="L1927" title="All 2 branches missed.">    if (m_showHistoryAction != null) {</span>
<span class="nc bnc" id="L1928" title="All 4 branches missed.">      m_showHistoryAction.setEnabled(!(inHistory || uiContext.getShowMapOnly()));</span>
    }
<span class="nc bnc" id="L1930" title="All 2 branches missed.">    if (m_showGameAction != null) {</span>
<span class="nc bnc" id="L1931" title="All 2 branches missed.">      m_showGameAction.setEnabled(!inGame);</span>
    }
<span class="nc bnc" id="L1933" title="All 2 branches missed.">    if (m_showMapOnlyAction != null) {</span>
      // We need to check and make sure there are no local human players
<span class="nc" id="L1935">      boolean foundHuman = false;</span>
<span class="nc bnc" id="L1936" title="All 2 branches missed.">      for (final IGamePlayer gamePlayer : localPlayers.getLocalPlayers()) {</span>
<span class="nc bnc" id="L1937" title="All 2 branches missed.">        if (gamePlayer instanceof TripleAPlayer) {</span>
<span class="nc" id="L1938">          foundHuman = true;</span>
        }
      }
<span class="nc bnc" id="L1941" title="All 2 branches missed.">      if (!foundHuman) {</span>
<span class="nc bnc" id="L1942" title="All 4 branches missed.">        m_showMapOnlyAction.setEnabled(inGame || inHistory);</span>
<span class="nc" id="L1943">      } else {</span>
<span class="nc" id="L1944">        m_showMapOnlyAction.setEnabled(false);</span>
      }
    }
<span class="nc bnc" id="L1947" title="All 2 branches missed.">    if (editModeButtonModel != null) {</span>
<span class="nc bnc" id="L1948" title="All 4 branches missed.">      if (editDelegate == null || uiContext.getShowMapOnly()) {</span>
<span class="nc" id="L1949">        editModeButtonModel.setEnabled(false);</span>
<span class="nc" id="L1950">      } else {</span>
<span class="nc" id="L1951">        editModeButtonModel.setEnabled(true);</span>
      }
    }
<span class="nc" id="L1954">  }</span>

  // setEditDelegate is called by TripleAPlayer at the start and end of a turn
  public void setEditDelegate(final IEditDelegate editDelegate) {
<span class="nc" id="L1958">    this.editDelegate = editDelegate;</span>
    // force a data change event to update the UI for edit mode
<span class="nc" id="L1960">    m_dataChangeListener.gameDataChanged(ChangeFactory.EMPTY_CHANGE);</span>
<span class="nc" id="L1961">    setWidgetActivation();</span>
<span class="nc" id="L1962">  }</span>

  public IEditDelegate getEditDelegate() {
<span class="nc" id="L1965">    return editDelegate;</span>
  }

  public ButtonModel getEditModeButtonModel() {
<span class="nc" id="L1969">    return editModeButtonModel;</span>
  }

  public ButtonModel getShowCommentLogButtonModel() {
<span class="nc" id="L1973">    return showCommentLogButtonModel;</span>
  }

  public boolean getEditMode() {
<span class="nc" id="L1977">    boolean isEditMode = false;</span>
    // use GameData from mapPanel since it will follow current history node
<span class="nc" id="L1979">    mapPanel.getData().acquireReadLock();</span>
    try {
<span class="nc" id="L1981">      isEditMode = BaseEditDelegate.getEditMode(mapPanel.getData());</span>
<span class="nc" id="L1982">    } finally {</span>
<span class="nc" id="L1983">      mapPanel.getData().releaseReadLock();</span>
<span class="nc" id="L1984">    }</span>
<span class="nc" id="L1985">    return isEditMode;</span>
  }

<span class="nc" id="L1988">  private final AbstractAction m_showHistoryAction = new AbstractAction(&quot;Show history&quot;) {</span>
    private static final long serialVersionUID = -3960551522512897374L;

    @Override
    public void actionPerformed(final ActionEvent e) {
<span class="nc" id="L1993">      showHistory();</span>
<span class="nc" id="L1994">      m_dataChangeListener.gameDataChanged(ChangeFactory.EMPTY_CHANGE);</span>
<span class="nc" id="L1995">    }</span>
  };
<span class="nc" id="L1997">  private final AbstractAction m_showGameAction = new AbstractAction(&quot;Show current game&quot;) {</span>
    private static final long serialVersionUID = -7551760679570164254L;

    {
<span class="nc" id="L2001">      setEnabled(false);</span>
    }

    @Override
    public void actionPerformed(final ActionEvent e) {
<span class="nc" id="L2006">      showGame();</span>
<span class="nc" id="L2007">      m_dataChangeListener.gameDataChanged(ChangeFactory.EMPTY_CHANGE);</span>
<span class="nc" id="L2008">    }</span>
  };
<span class="nc" id="L2010">  private final AbstractAction m_showMapOnlyAction = new AbstractAction(&quot;Show map only&quot;) {</span>
    private static final long serialVersionUID = -6621157075878333141L;

    @Override
    public void actionPerformed(final ActionEvent e) {
<span class="nc" id="L2015">      showMapOnly();</span>
<span class="nc" id="L2016">      m_dataChangeListener.gameDataChanged(ChangeFactory.EMPTY_CHANGE);</span>
<span class="nc" id="L2017">    }</span>
  };

  public Collection&lt;Unit&gt; moveFightersToCarrier(final Collection&lt;Unit&gt; fighters, final Territory where) {
<span class="nc bnc" id="L2021" title="All 2 branches missed.">    if (messageAndDialogThreadPool == null) {</span>
<span class="nc" id="L2022">      return null;</span>
    }
<span class="nc" id="L2024">    messageAndDialogThreadPool.waitForAll();</span>
<span class="nc" id="L2025">    mapPanel.centerOn(where);</span>
<span class="nc" id="L2026">    final AtomicReference&lt;ScrollableTextField&gt; textRef = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L2027">    final AtomicReference&lt;JPanel&gt; panelRef = new AtomicReference&lt;&gt;();</span>
<span class="nc" id="L2028">    SwingAction.invokeAndWait(() -&gt; {</span>
<span class="nc" id="L2029">      final JPanel panel = new JPanel();</span>
<span class="nc" id="L2030">      panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L2031">      final ScrollableTextField text = new ScrollableTextField(0, fighters.size());</span>
<span class="nc" id="L2032">      text.setBorder(new EmptyBorder(8, 8, 8, 8));</span>
<span class="nc" id="L2033">      panel.add(text, BorderLayout.CENTER);</span>
<span class="nc" id="L2034">      panel.add(new JLabel(&quot;How many fighters do you want to move from &quot; + where.getName() + &quot; to new carrier?&quot;),</span>
<span class="nc" id="L2035">          BorderLayout.NORTH);</span>
<span class="nc" id="L2036">      panelRef.set(panel);</span>
<span class="nc" id="L2037">      textRef.set(text);</span>
<span class="nc" id="L2038">      panelRef.set(panel);</span>
<span class="nc" id="L2039">    });</span>
<span class="nc" id="L2040">    final int choice = EventThreadJOptionPane.showOptionDialog(this, panelRef.get(), &quot;Place fighters on new carrier?&quot;,</span>
<span class="nc" id="L2041">        JOptionPane.PLAIN_MESSAGE, JOptionPane.OK_CANCEL_OPTION, null, new String[] {&quot;OK&quot;, &quot;Cancel&quot;}, &quot;OK&quot;,</span>
<span class="nc" id="L2042">        getUIContext().getCountDownLatchHandler());</span>
<span class="nc bnc" id="L2043" title="All 2 branches missed.">    if (choice == 0) {</span>
      // arrayList.subList() is not serializable
<span class="nc" id="L2045">      return new ArrayList&lt;&gt;(new ArrayList&lt;&gt;(fighters).subList(0, textRef.get().getValue()));</span>
    } else {
<span class="nc" id="L2047">      return new ArrayList&lt;&gt;(0);</span>
    }
  }

  public BattlePanel getBattlePanel() {
<span class="nc" id="L2052">    return actionButtons.getBattlePanel();</span>
  }

  public Action getShowGameAction() {
<span class="nc" id="L2056">    return m_showGameAction;</span>
  }

  public Action getShowHistoryAction() {
<span class="nc" id="L2060">    return m_showHistoryAction;</span>
  }

  public Action getShowMapOnlyAction() {
<span class="nc" id="L2064">    return m_showMapOnlyAction;</span>
  }

  public IUIContext getUIContext() {
<span class="nc" id="L2068">    return uiContext;</span>
  }

  public MapPanel getMapPanel() {
<span class="nc" id="L2072">    return mapPanel;</span>
  }

  @Override
  public JComponent getMainPanel() {
<span class="nc" id="L2077">    return mapPanel;</span>
  }

  // Beagle Code Called to Change Mapskin
  public void updateMap(final String mapdir) throws IOException {
<span class="nc" id="L2082">    uiContext.setMapDir(data, mapdir);</span>
    // when changing skins, always show relief images
<span class="nc bnc" id="L2084" title="All 2 branches missed.">    if (uiContext.getMapData().getHasRelief()) {</span>
<span class="nc" id="L2085">      TileImageFactory.setShowReliefImages(true);</span>
    }
<span class="nc" id="L2087">    mapPanel.setGameData(data);</span>
    // update mappanels to use new image
<span class="nc" id="L2089">    mapPanel.changeImage(uiContext.getMapData().getMapDimensions());</span>
<span class="nc" id="L2090">    final Image small = uiContext.getMapImage().getSmallMapImage();</span>
<span class="nc" id="L2091">    smallView.changeImage(small);</span>
<span class="nc" id="L2092">    mapPanel.changeSmallMapOffscreenMap();</span>
    // redraw territories
<span class="nc" id="L2094">    mapPanel.resetMap();</span>
<span class="nc" id="L2095">  }</span>

  @Override
  public IGame getGame() {
<span class="nc" id="L2099">    return game;</span>
  }

  public StatPanel getStatPanel() {
<span class="nc" id="L2103">    return statsPanel;</span>
  }

  @Override
  public void setShowChatTime(final boolean showTime) {
<span class="nc" id="L2108">    chatPanel.setShowChatTime(showTime);</span>
<span class="nc" id="L2109">  }</span>

  public Optional&lt;InGameLobbyWatcherWrapper&gt; getInGameLobbyWatcher() {
<span class="nc bnc" id="L2112" title="All 2 branches missed.">    if (ServerGame.class.isAssignableFrom(getGame().getClass())) {</span>
<span class="nc" id="L2113">      final ServerGame serverGame = (ServerGame) getGame();</span>
<span class="nc" id="L2114">      return Optional.ofNullable(serverGame.getInGameLobbyWatcher());</span>
    } else {
<span class="nc" id="L2116">      return Optional.empty();</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>test (25/nov/2016 10:16:58)</div></body></html>