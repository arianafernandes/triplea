<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>WW2V3_41_Test.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (25/nov/2016 10:16:58)</a> &gt; <a href="../../index.html" class="el_group">triplea</a> &gt; <a href="../index.html" class="el_bundle">test</a> &gt; <a href="index.source.html" class="el_package">games.strategy.triplea.delegate</a> &gt; <span class="el_source">WW2V3_41_Test.java</span></div><h1>WW2V3_41_Test.java</h1><pre class="source lang-java linenums"><span class="fc" id="L1">package games.strategy.triplea.delegate;</span>

import static games.strategy.triplea.delegate.BattleStepStrings.ATTACKER_WITHDRAW;
import static games.strategy.triplea.delegate.BattleStepStrings.FIRE;
import static games.strategy.triplea.delegate.BattleStepStrings.REMOVE_CASUALTIES;
import static games.strategy.triplea.delegate.BattleStepStrings.REMOVE_SNEAK_ATTACK_CASUALTIES;
import static games.strategy.triplea.delegate.BattleStepStrings.SELECT_CASUALTIES;
import static games.strategy.triplea.delegate.BattleStepStrings.SELECT_SUB_CASUALTIES;
import static games.strategy.triplea.delegate.BattleStepStrings.SUBS_FIRE;
import static games.strategy.triplea.delegate.BattleStepStrings.SUBS_SUBMERGE;
import static games.strategy.triplea.delegate.GameDataTestUtil.aaGun;
import static games.strategy.triplea.delegate.GameDataTestUtil.addTo;
import static games.strategy.triplea.delegate.GameDataTestUtil.americans;
import static games.strategy.triplea.delegate.GameDataTestUtil.armour;
import static games.strategy.triplea.delegate.GameDataTestUtil.battleDelegate;
import static games.strategy.triplea.delegate.GameDataTestUtil.bidPlaceDelegate;
import static games.strategy.triplea.delegate.GameDataTestUtil.bomber;
import static games.strategy.triplea.delegate.GameDataTestUtil.british;
import static games.strategy.triplea.delegate.GameDataTestUtil.carrier;
import static games.strategy.triplea.delegate.GameDataTestUtil.chinese;
import static games.strategy.triplea.delegate.GameDataTestUtil.destroyer;
import static games.strategy.triplea.delegate.GameDataTestUtil.factory;
import static games.strategy.triplea.delegate.GameDataTestUtil.fighter;
import static games.strategy.triplea.delegate.GameDataTestUtil.germans;
import static games.strategy.triplea.delegate.GameDataTestUtil.givePlayerRadar;
import static games.strategy.triplea.delegate.GameDataTestUtil.infantry;
import static games.strategy.triplea.delegate.GameDataTestUtil.italians;
import static games.strategy.triplea.delegate.GameDataTestUtil.load;
import static games.strategy.triplea.delegate.GameDataTestUtil.makeGameLowLuck;
import static games.strategy.triplea.delegate.GameDataTestUtil.move;
import static games.strategy.triplea.delegate.GameDataTestUtil.moveDelegate;
import static games.strategy.triplea.delegate.GameDataTestUtil.placeDelegate;
import static games.strategy.triplea.delegate.GameDataTestUtil.purchaseDelegate;
import static games.strategy.triplea.delegate.GameDataTestUtil.removeFrom;
import static games.strategy.triplea.delegate.GameDataTestUtil.russians;
import static games.strategy.triplea.delegate.GameDataTestUtil.submarine;
import static games.strategy.triplea.delegate.GameDataTestUtil.techDelegate;
import static games.strategy.triplea.delegate.GameDataTestUtil.territory;
import static games.strategy.triplea.delegate.GameDataTestUtil.transport;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNotSame;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.anyBoolean;
import static org.mockito.Matchers.anyInt;
import static org.mockito.Matchers.argThat;
import static org.mockito.Matchers.contains;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;

import org.junit.Before;
import org.junit.Test;
import org.mockito.invocation.InvocationOnMock;
import org.mockito.stubbing.Answer;

import games.strategy.debug.ClientLogger;
import games.strategy.engine.data.Change;
import games.strategy.engine.data.GameData;
import games.strategy.engine.data.GameParseException;
import games.strategy.engine.data.ITestDelegateBridge;
import games.strategy.engine.data.PlayerID;
import games.strategy.engine.data.RepairRule;
import games.strategy.engine.data.Route;
import games.strategy.engine.data.TechnologyFrontier;
import games.strategy.engine.data.Territory;
import games.strategy.engine.data.TerritoryEffect;
import games.strategy.engine.data.Unit;
import games.strategy.engine.data.UnitType;
import games.strategy.engine.data.changefactory.ChangeFactory;
import games.strategy.engine.random.ScriptedRandomSource;
import games.strategy.test.TestUtil;
import games.strategy.triplea.Constants;
import games.strategy.triplea.TripleAUnit;
import games.strategy.triplea.attachments.TechAttachment;
import games.strategy.triplea.attachments.TerritoryAttachment;
import games.strategy.triplea.attachments.UnitAttachment;
import games.strategy.triplea.delegate.IBattle.BattleType;
import games.strategy.triplea.delegate.dataObjects.CasualtyDetails;
import games.strategy.triplea.delegate.dataObjects.CasualtyList;
import games.strategy.triplea.delegate.dataObjects.MoveValidationResult;
import games.strategy.triplea.delegate.dataObjects.PlaceableUnits;
import games.strategy.triplea.delegate.dataObjects.TechResults;
import games.strategy.triplea.player.ITripleAPlayer;
import games.strategy.triplea.ui.display.ITripleADisplay;
import games.strategy.triplea.xml.LoadGameUtil;
import games.strategy.util.IntegerMap;
import games.strategy.util.Match;

<span class="fc" id="L105">public class WW2V3_41_Test {</span>
  private GameData m_data;
<span class="fc" id="L107">  private final ITripleAPlayer dummyPlayer = mock(ITripleAPlayer.class);</span>

  @Before
  public void setUp() throws Exception {
<span class="fc" id="L111">    when(dummyPlayer.selectCasualties(any(), any(), anyInt(), any(), any(), any(), any(), any(), any(),</span>
<span class="fc" id="L112">        anyBoolean(), any(), any(), any(), any(), anyBoolean())).thenAnswer(new Answer&lt;CasualtyDetails&gt;() {</span>
          @Override
          public CasualtyDetails answer(final InvocationOnMock invocation) throws Throwable {
<span class="fc" id="L115">            final CasualtyList defaultCasualties = invocation.getArgument(11);</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">            if (defaultCasualties != null) {</span>
<span class="fc" id="L117">              return new CasualtyDetails(defaultCasualties.getKilled(), defaultCasualties.getDamaged(), true);</span>
            }
<span class="fc" id="L119">            return null;</span>
          }
        });
<span class="fc" id="L122">    m_data = LoadGameUtil.loadTestGame(LoadGameUtil.TestMapXml.WW2V3_1941);</span>
<span class="fc" id="L123">  }</span>

  private ITestDelegateBridge getDelegateBridge(final PlayerID player) {
<span class="fc" id="L126">    return GameDataTestUtil.getDelegateBridge(player, m_data);</span>
  }

  public static String fight(final BattleDelegate battle, final Territory territory) {
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">    for (final Entry&lt;BattleType, Collection&lt;Territory&gt;&gt; entry : battle.getBattles().getBattles().entrySet()) {</span>
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">      if (!entry.getKey().isBombingRun() &amp;&amp; entry.getValue().contains(territory)) {</span>
<span class="fc" id="L132">        return battle.fightBattle(territory, false, entry.getKey());</span>
      }
    }
<span class="nc" id="L135">    throw new IllegalStateException(&quot;Could not find battle in: &quot; + territory.getName());</span>
  }

  @Test
  public void testAACasualtiesLowLuckMixedRadar() {
    // moved from BattleCalculatorTest because &quot;revised&quot; does not have &quot;radar&quot;
<span class="fc" id="L141">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L142">    final ITestDelegateBridge m_bridge = getDelegateBridge(british);</span>
<span class="fc" id="L143">    makeGameLowLuck(m_data);</span>
    // setSelectAACasualties(data, false);
<span class="fc" id="L145">    givePlayerRadar(germans(m_data));</span>
    // 3 bombers and 3 fighters
<span class="fc" id="L147">    final Collection&lt;Unit&gt; planes = bomber(m_data).create(3, british(m_data));</span>
<span class="fc" id="L148">    planes.addAll(fighter(m_data).create(3, british(m_data)));</span>
<span class="fc" id="L149">    final Collection&lt;Unit&gt; defendingAA =</span>
<span class="fc" id="L150">        territory(&quot;Germany&quot;, m_data).getUnits().getMatches(Matches.UnitIsAAforAnything);</span>
    // don't allow rolling, 6 of each is deterministic
<span class="fc" id="L152">    m_bridge.setRandomSource(new ScriptedRandomSource(new int[] {ScriptedRandomSource.ERROR}));</span>
<span class="fc" id="L153">    final DiceRoll roll =</span>
        DiceRoll
<span class="fc" id="L155">            .rollAA(</span>
<span class="fc" id="L156">                Match.getMatches(planes,</span>
<span class="fc" id="L157">                    Matches.unitIsOfTypes(</span>
<span class="fc" id="L158">                        UnitAttachment.get(defendingAA.iterator().next().getType()).getTargetsAA(m_data))),</span>
<span class="fc" id="L159">                defendingAA, m_bridge, territory(&quot;Germany&quot;, m_data), true);</span>
<span class="fc" id="L160">    final Collection&lt;Unit&gt; casualties = BattleCalculator.getAACasualties(false, planes, planes, defendingAA,</span>
<span class="fc" id="L161">        defendingAA, roll, m_bridge, null, null, null, territory(&quot;Germany&quot;, m_data), null, false, null).getKilled();</span>
<span class="fc" id="L162">    assertEquals(casualties.size(), 2);</span>
    // should be 1 fighter and 1 bomber
<span class="fc" id="L164">    assertEquals(Match.countMatches(casualties, Matches.UnitIsStrategicBomber), 1);</span>
<span class="fc" id="L165">    assertEquals(Match.countMatches(casualties, Matches.UnitIsStrategicBomber.invert()), 1);</span>
<span class="fc" id="L166">  }</span>

  @Test
  public void testAACasualtiesLowLuckMixedWithRollingRadar() {
    // moved from BattleCalculatorTest because &quot;revised&quot; does not have &quot;radar&quot;
<span class="fc" id="L171">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L172">    final ITestDelegateBridge m_bridge = getDelegateBridge(british);</span>
<span class="fc" id="L173">    makeGameLowLuck(m_data);</span>
    // setSelectAACasualties(data, false);
<span class="fc" id="L175">    givePlayerRadar(germans(m_data));</span>
    // 4 bombers and 4 fighters
<span class="fc" id="L177">    final Collection&lt;Unit&gt; planes = bomber(m_data).create(4, british(m_data));</span>
<span class="fc" id="L178">    planes.addAll(fighter(m_data).create(4, british(m_data)));</span>
<span class="fc" id="L179">    final Collection&lt;Unit&gt; defendingAA =</span>
<span class="fc" id="L180">        territory(&quot;Germany&quot;, m_data).getUnits().getMatches(Matches.UnitIsAAforAnything);</span>
    // 1 roll, a hit
    // then a dice to select the casualty
<span class="fc" id="L183">    final ScriptedRandomSource randomSource = new ScriptedRandomSource(new int[] {0, 1});</span>
<span class="fc" id="L184">    m_bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L185">    final DiceRoll roll =</span>
        DiceRoll
<span class="fc" id="L187">            .rollAA(</span>
<span class="fc" id="L188">                Match.getMatches(planes,</span>
<span class="fc" id="L189">                    Matches.unitIsOfTypes(</span>
<span class="fc" id="L190">                        UnitAttachment.get(defendingAA.iterator().next().getType()).getTargetsAA(m_data))),</span>
<span class="fc" id="L191">                defendingAA, m_bridge, territory(&quot;Germany&quot;, m_data), true);</span>
    // make sure we rolled once
<span class="fc" id="L193">    assertEquals(1, randomSource.getTotalRolled());</span>
<span class="fc" id="L194">    final Collection&lt;Unit&gt; casualties = BattleCalculator.getAACasualties(false, planes, planes, defendingAA,</span>
<span class="fc" id="L195">        defendingAA, roll, m_bridge, null, null, null, territory(&quot;Germany&quot;, m_data), null, false, null).getKilled();</span>
<span class="fc" id="L196">    assertEquals(casualties.size(), 3);</span>
    // should be 1 fighter and 2 bombers
<span class="fc" id="L198">    assertEquals(Match.countMatches(casualties, Matches.UnitIsStrategicBomber), 2);</span>
<span class="fc" id="L199">    assertEquals(Match.countMatches(casualties, Matches.UnitIsStrategicBomber.invert()), 1);</span>
<span class="fc" id="L200">  }</span>

  @Test
  public void testAACasualtiesLowLuckMixedWithRollingMissRadar() {
    // moved from BattleCalculatorTest because &quot;revised&quot; does not have &quot;radar&quot;
<span class="fc" id="L205">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L206">    final ITestDelegateBridge m_bridge = getDelegateBridge(british);</span>
<span class="fc" id="L207">    makeGameLowLuck(m_data);</span>
    // setSelectAACasualties(data, false);
<span class="fc" id="L209">    givePlayerRadar(germans(m_data));</span>
    // 4 bombers and 4 fighters
<span class="fc" id="L211">    final Collection&lt;Unit&gt; planes = bomber(m_data).create(4, british(m_data));</span>
<span class="fc" id="L212">    planes.addAll(fighter(m_data).create(4, british(m_data)));</span>
<span class="fc" id="L213">    final Collection&lt;Unit&gt; defendingAA =</span>
<span class="fc" id="L214">        territory(&quot;Germany&quot;, m_data).getUnits().getMatches(Matches.UnitIsAAforAnything);</span>
    // 1 roll, a miss
    // then a dice to select the casualty
<span class="fc" id="L217">    final ScriptedRandomSource randomSource =</span>
<span class="fc" id="L218">        new ScriptedRandomSource(new int[] {5, 0, 0, 0, ScriptedRandomSource.ERROR});</span>
<span class="fc" id="L219">    m_bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L220">    final DiceRoll roll =</span>
        DiceRoll
<span class="fc" id="L222">            .rollAA(</span>
<span class="fc" id="L223">                Match.getMatches(planes,</span>
<span class="fc" id="L224">                    Matches.unitIsOfTypes(</span>
<span class="fc" id="L225">                        UnitAttachment.get(defendingAA.iterator().next().getType()).getTargetsAA(m_data))),</span>
<span class="fc" id="L226">                defendingAA, m_bridge, territory(&quot;Germany&quot;, m_data), true);</span>
<span class="fc" id="L227">    assertEquals(roll.getHits(), 2);</span>
    // make sure we rolled once
<span class="fc" id="L229">    assertEquals(1, randomSource.getTotalRolled());</span>
<span class="fc" id="L230">    final Collection&lt;Unit&gt; casualties = BattleCalculator.getAACasualties(false, planes, planes, defendingAA,</span>
<span class="fc" id="L231">        defendingAA, roll, m_bridge, null, null, null, territory(&quot;Germany&quot;, m_data), null, false, null).getKilled();</span>
<span class="fc" id="L232">    assertEquals(casualties.size(), 2);</span>
<span class="fc" id="L233">    assertEquals(4, randomSource.getTotalRolled());</span>
    // should be 1 fighter and 2 bombers
<span class="fc" id="L235">    assertEquals(Match.countMatches(casualties, Matches.UnitIsStrategicBomber), 1);</span>
<span class="fc" id="L236">    assertEquals(Match.countMatches(casualties, Matches.UnitIsStrategicBomber.invert()), 1);</span>
<span class="fc" id="L237">  }</span>

  @Test
  public void testDefendingTrasnportsAutoKilled() {
<span class="fc" id="L241">    final Territory sz13 = m_data.getMap().getTerritory(&quot;13 Sea Zone&quot;);</span>
<span class="fc" id="L242">    final Territory sz12 = m_data.getMap().getTerritory(&quot;12 Sea Zone&quot;);</span>
<span class="fc" id="L243">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L244">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L245">    final ITestDelegateBridge bridge = getDelegateBridge(british);</span>
<span class="fc" id="L246">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L247">    moveDelegate.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L248">    moveDelegate.start();</span>
<span class="fc" id="L249">    final Route sz12To13 = new Route();</span>
<span class="fc" id="L250">    sz12To13.setStart(sz12);</span>
<span class="fc" id="L251">    sz12To13.add(sz13);</span>
<span class="fc" id="L252">    final String error = moveDelegate.move(sz12.getUnits().getUnits(), sz12To13);</span>
<span class="fc" id="L253">    assertEquals(error, null);</span>
<span class="fc" id="L254">    assertEquals(sz13.getUnits().size(), 3);</span>
<span class="fc" id="L255">    moveDelegate.end();</span>
    // the transport was not removed automatically
<span class="fc" id="L257">    assertEquals(sz13.getUnits().size(), 3);</span>
<span class="fc" id="L258">    final BattleDelegate bd = battleDelegate(m_data);</span>
<span class="fc" id="L259">    assertFalse(bd.getBattleTracker().getPendingBattleSites(false).isEmpty());</span>
<span class="fc" id="L260">  }</span>

  @Test
  public void testUnplacedDie() {
<span class="fc" id="L264">    final PlaceDelegate del = placeDelegate(m_data);</span>
<span class="fc" id="L265">    del.setDelegateBridgeAndPlayer(getDelegateBridge(british(m_data)));</span>
<span class="fc" id="L266">    del.start();</span>
<span class="fc" id="L267">    addTo(british(m_data), transport(m_data).create(1, british(m_data)), m_data);</span>
<span class="fc" id="L268">    del.end();</span>
    // unplaced units die
<span class="fc" id="L270">    assertEquals(1, british(m_data).getUnits().size());</span>
<span class="fc" id="L271">  }</span>

  @Test
  public void testPlaceEmpty() {
<span class="fc" id="L275">    final PlaceDelegate del = placeDelegate(m_data);</span>
<span class="fc" id="L276">    del.setDelegateBridgeAndPlayer(getDelegateBridge(british(m_data)));</span>
<span class="fc" id="L277">    del.start();</span>
<span class="fc" id="L278">    addTo(british(m_data), transport(m_data).create(1, british(m_data)), m_data);</span>
<span class="fc" id="L279">    final String error = del.placeUnits(Collections.&lt;Unit&gt;emptyList(), territory(&quot;United Kingdom&quot;, m_data));</span>
<span class="fc" id="L280">    assertNull(error);</span>
<span class="fc" id="L281">  }</span>

  @Test
  public void testTechTokens() {
    // Set up the test
<span class="fc" id="L286">    final PlayerID germans = GameDataTestUtil.germans(m_data);</span>
<span class="fc" id="L287">    final ITestDelegateBridge delegateBridge = getDelegateBridge(germans);</span>
<span class="fc" id="L288">    delegateBridge.setStepName(&quot;germanTech&quot;);</span>
<span class="fc" id="L289">    final TechnologyDelegate techDelegate = techDelegate(m_data);</span>
<span class="fc" id="L290">    techDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L291">    techDelegate.start();</span>
<span class="fc" id="L292">    final TechnologyFrontier mech = new TechnologyFrontier(&quot;&quot;, m_data);</span>
<span class="fc" id="L293">    mech.addAdvance(TechAdvance.findAdvance(TechAdvance.TECH_PROPERTY_MECHANIZED_INFANTRY, m_data, null));</span>
    // Add tech token
<span class="fc" id="L295">    m_data.performChange(</span>
<span class="fc" id="L296">        ChangeFactory.changeResourcesChange(germans, m_data.getResourceList().getResource(Constants.TECH_TOKENS), 1));</span>
    // Check to make sure it was successful
<span class="fc" id="L298">    final int initTokens = germans.getResources().getQuantity(&quot;techTokens&quot;);</span>
<span class="fc" id="L299">    assertEquals(1, initTokens);</span>
    // Fail the roll
<span class="fc" id="L301">    delegateBridge.setRandomSource(new ScriptedRandomSource(new int[] {3}));</span>
<span class="fc" id="L302">    final TechResults roll = techDelegate.rollTech(1, mech, 0, null);</span>
    // Check to make sure it failed
<span class="fc" id="L304">    assertEquals(0, roll.getHits());</span>
<span class="fc" id="L305">    final int midTokens = germans.getResources().getQuantity(&quot;techTokens&quot;);</span>
<span class="fc" id="L306">    assertEquals(1, midTokens);</span>
    // Make a Successful roll
<span class="fc" id="L308">    delegateBridge.setRandomSource(new ScriptedRandomSource(new int[] {5}));</span>
<span class="fc" id="L309">    final TechResults roll2 = techDelegate.rollTech(1, mech, 0, null);</span>
    // Check to make sure it succeeded and all tokens were removed
<span class="fc" id="L311">    assertEquals(1, roll2.getHits());</span>
<span class="fc" id="L312">    final int finalTokens = germans.getResources().getQuantity(&quot;techTokens&quot;);</span>
<span class="fc" id="L313">    assertEquals(0, finalTokens);</span>
<span class="fc" id="L314">  }</span>

  @Test
  public void testInfantryLoadOnlyTransports() {
<span class="fc" id="L318">    final Territory gibraltar = territory(&quot;Gibraltar&quot;, m_data);</span>
    // add a tank to gibralter
<span class="fc" id="L320">    final PlayerID british = british(m_data);</span>
<span class="fc" id="L321">    addTo(gibraltar, infantry(m_data).create(1, british));</span>
<span class="fc" id="L322">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L323">    final ITestDelegateBridge bridge = getDelegateBridge(british);</span>
<span class="fc" id="L324">    bridge.setStepName(&quot;britishCombatMove&quot;);</span>
<span class="fc" id="L325">    moveDelegate.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L326">    moveDelegate.start();</span>
<span class="fc" id="L327">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L328">    final Territory sz9 = territory(&quot;9 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L329">    final Territory sz13 = territory(&quot;13 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L330">    final Route sz9ToSz13 = new Route(sz9, territory(&quot;12 Sea Zone&quot;, m_data), sz13);</span>
    // move the transport to attack, this is suicide but valid
<span class="fc" id="L332">    move(sz9.getUnits().getMatches(Matches.UnitIsTransport), sz9ToSz13);</span>
    // load the transport
<span class="fc" id="L334">    load(gibraltar.getUnits().getUnits(), new Route(gibraltar, sz13));</span>
<span class="fc" id="L335">    moveDelegate.end();</span>
<span class="fc" id="L336">    bridge.setStepName(&quot;britishBattle&quot;);</span>
<span class="fc" id="L337">    final BattleDelegate battleDelegate = battleDelegate(m_data);</span>
<span class="fc" id="L338">    battleDelegate.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L339">    battleDelegate.start();</span>
<span class="fc" id="L340">    assertTrue(battleDelegate.getBattles().isEmpty());</span>
<span class="fc" id="L341">  }</span>

  @Test
  public void testLoadedTransportAttackKillsLoadedUnits() {
<span class="fc" id="L345">    final PlayerID british = british(m_data);</span>
<span class="fc" id="L346">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L347">    final ITestDelegateBridge bridge = getDelegateBridge(british);</span>
<span class="fc" id="L348">    bridge.setStepName(&quot;britishCombatMove&quot;);</span>
<span class="fc" id="L349">    when(dummyPlayer.selectAttackSubs(any())).thenReturn(true);</span>
<span class="fc" id="L350">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L351">    moveDelegate.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L352">    moveDelegate.start();</span>
<span class="fc" id="L353">    final Territory sz9 = territory(&quot;9 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L354">    final Territory sz7 = territory(&quot;7 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L355">    final Territory uk = territory(&quot;United Kingdom&quot;, m_data);</span>
<span class="fc" id="L356">    final Route sz9ToSz7 = new Route(sz9, territory(&quot;8 Sea Zone&quot;, m_data), sz7);</span>
    // move the transport to attack, this is suicide but valid
<span class="fc" id="L358">    final List&lt;Unit&gt; transports = sz9.getUnits().getMatches(Matches.UnitIsTransport);</span>
<span class="fc" id="L359">    move(transports, sz9ToSz7);</span>
    // load the transport
<span class="fc" id="L361">    load(uk.getUnits().getMatches(Matches.UnitIsInfantry), new Route(uk, sz7));</span>
<span class="fc" id="L362">    moveDelegate(m_data).end();</span>
<span class="fc" id="L363">    final ScriptedRandomSource randomSource = new ScriptedRandomSource(new int[] {0, 1});</span>
<span class="fc" id="L364">    bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L365">    bridge.setStepName(&quot;britishBattle&quot;);</span>
<span class="fc" id="L366">    final BattleDelegate battleDelegate = battleDelegate(m_data);</span>
<span class="fc" id="L367">    battleDelegate.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L368">    battleDelegate.start();</span>
<span class="fc" id="L369">    assertEquals(2, TransportTracker.transporting(transports.get(0)).size());</span>
    // fight the battle
<span class="fc" id="L371">    assertValid(fight(battleDelegate, sz7));</span>
    // make sure the infantry die with the transport
<span class="fc" id="L373">    assertTrue(sz7.getUnits().toString(), sz7.getUnits().getMatches(Matches.unitOwnedBy(british)).isEmpty());</span>
<span class="fc" id="L374">  }</span>

  @Test
  public void testCanRetreatIntoEmptyEnemyTerritory() {
<span class="fc" id="L378">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L379">    final Territory ukraine = territory(&quot;Ukraine&quot;, m_data);</span>
<span class="fc" id="L380">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
    // remove all units from east poland
<span class="fc" id="L382">    removeFrom(eastPoland, eastPoland.getUnits().getUnits());</span>
<span class="fc" id="L383">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L384">    final ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L385">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L386">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L387">    moveDelegate.start();</span>
<span class="fc" id="L388">    final Territory bulgaria = territory(&quot;Bulgaria Romania&quot;, m_data);</span>
    // attack from bulgraia
<span class="fc" id="L390">    move(bulgaria.getUnits().getUnits(), new Route(bulgaria, ukraine));</span>
    // add an air attack from east poland
<span class="fc" id="L392">    move(poland.getUnits().getMatches(Matches.UnitIsAir), new Route(poland, eastPoland, ukraine));</span>
    // we should not be able to retreat to east poland!
    // that territory is still owned by the enemy
<span class="fc" id="L395">    final MustFightBattle battle =</span>
<span class="fc" id="L396">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(ukraine, false, null);</span>
<span class="fc" id="L397">    assertFalse(battle.getAttackerRetreatTerritories().contains(eastPoland));</span>
<span class="fc" id="L398">  }</span>

  @Test
  public void testCanRetreatIntoBlitzedTerritory() {
<span class="fc" id="L402">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L403">    final Territory ukraine = territory(&quot;Ukraine&quot;, m_data);</span>
<span class="fc" id="L404">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
    // remove all units from east poland
<span class="fc" id="L406">    removeFrom(eastPoland, eastPoland.getUnits().getUnits());</span>
<span class="fc" id="L407">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L408">    final ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L409">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L410">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L411">    moveDelegate.start();</span>
<span class="fc" id="L412">    final Territory bulgaria = territory(&quot;Bulgaria Romania&quot;, m_data);</span>
    // attack from bulgraia
<span class="fc" id="L414">    move(bulgaria.getUnits().getUnits(), new Route(bulgaria, ukraine));</span>
    // add a blitz attack
<span class="fc" id="L416">    move(poland.getUnits().getMatches(Matches.UnitCanBlitz), new Route(poland, eastPoland, ukraine));</span>
    // we should not be able to retreat to east poland!
    // that territory was just conquered
<span class="fc" id="L419">    final MustFightBattle battle =</span>
<span class="fc" id="L420">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(ukraine, false, null);</span>
<span class="fc" id="L421">    assertTrue(battle.getAttackerRetreatTerritories().contains(eastPoland));</span>
<span class="fc" id="L422">  }</span>

  @Test
  public void testCantBlitzFactoryOrAA() {
    // Set up territories
<span class="fc" id="L427">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L428">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L429">    final Territory ukraine = territory(&quot;Ukraine&quot;, m_data);</span>
    // remove all units from east poland
<span class="fc" id="L431">    removeFrom(eastPoland, eastPoland.getUnits().getUnits());</span>
    // Add a russian factory
<span class="fc" id="L433">    addTo(eastPoland, factory(m_data).create(1, russians(m_data)));</span>
<span class="fc" id="L434">    MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L435">    ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L436">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L437">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L438">    moveDelegate.start();</span>
    // add a blitz attack
<span class="fc" id="L440">    String errorResults =</span>
<span class="fc" id="L441">        moveDelegate.move(poland.getUnits().getMatches(Matches.UnitCanBlitz), new Route(poland, eastPoland, ukraine));</span>
<span class="fc" id="L442">    assertError(errorResults);</span>
    /*
     * Now try with an AA
     */
    // remove all units from east poland
<span class="fc" id="L447">    removeFrom(eastPoland, eastPoland.getUnits().getUnits());</span>
    // Add a russian factory
<span class="fc" id="L449">    addTo(eastPoland, aaGun(m_data).create(1, russians(m_data)));</span>
<span class="fc" id="L450">    moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L451">    delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L452">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L453">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L454">    moveDelegate.start();</span>
    // add a blitz attack
<span class="fc" id="L456">    errorResults =</span>
<span class="fc" id="L457">        moveDelegate.move(poland.getUnits().getMatches(Matches.UnitCanBlitz), new Route(poland, eastPoland, ukraine));</span>
<span class="fc" id="L458">    assertError(errorResults);</span>
<span class="fc" id="L459">  }</span>

  @Test
  public void testMultipleAAInTerritory() {
    // Set up territories
<span class="fc" id="L464">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
    // Add a russian factory
<span class="fc" id="L466">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L467">    addTo(poland, aaGun(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L468">    MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L469">    ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L470">    delegateBridge.setStepName(&quot;NonCombatMove&quot;);</span>
<span class="fc" id="L471">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L472">    moveDelegate.start();</span>
<span class="fc" id="L473">    final int preCount = germany.getUnits().getUnitCount();</span>
    /*
     * Move one
     */
<span class="fc" id="L477">    String errorResults =</span>
<span class="fc" id="L478">        moveDelegate.move(poland.getUnits().getMatches(Matches.UnitIsAAforAnything), new Route(poland, germany));</span>
<span class="fc" id="L479">    assertValid(errorResults);</span>
<span class="fc" id="L480">    assertEquals(germany.getUnits().getUnitCount(), preCount + 1);</span>
    /*
     * Test unloading TRN
     */
<span class="fc" id="L484">    final Territory finland = territory(&quot;Finland&quot;, m_data);</span>
<span class="fc" id="L485">    final Territory sz5 = territory(&quot;5 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L486">    addTo(finland, aaGun(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L487">    moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L488">    delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L489">    delegateBridge.setStepName(&quot;NonCombatMove&quot;);</span>
<span class="fc" id="L490">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L491">    moveDelegate.start();</span>
    // load the trn
<span class="fc" id="L493">    errorResults = moveDelegate.move(finland.getUnits().getMatches(Matches.UnitIsAAforAnything),</span>
<span class="fc" id="L494">        new Route(finland, sz5), sz5.getUnits().getMatches(Matches.UnitIsTransport));</span>
<span class="fc" id="L495">    assertValid(errorResults);</span>
    // unload the trn
<span class="fc" id="L497">    errorResults = moveDelegate.move(sz5.getUnits().getMatches(Matches.UnitIsAAforAnything), new Route(sz5, germany));</span>
<span class="fc" id="L498">    assertValid(errorResults);</span>
<span class="fc" id="L499">    assertEquals(germany.getUnits().getUnitCount(), preCount + 2);</span>
    /*
     * Test Building one
     */
<span class="fc" id="L503">    final UnitType aaGun = GameDataTestUtil.aaGun(m_data);</span>
<span class="fc" id="L504">    final IntegerMap&lt;UnitType&gt; map = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L505">    map.add(aaGun, 1);</span>
    // Set up the test
<span class="fc" id="L507">    final PlayerID germans = GameDataTestUtil.germans(m_data);</span>
<span class="fc" id="L508">    final PlaceDelegate placeDelegate = placeDelegate(m_data);</span>
<span class="fc" id="L509">    delegateBridge.setStepName(&quot;Place&quot;);</span>
<span class="fc" id="L510">    delegateBridge.setPlayerID(germans);</span>
<span class="fc" id="L511">    placeDelegate.setDelegateBridgeAndPlayer(getDelegateBridge(germans(m_data)));</span>
<span class="fc" id="L512">    placeDelegate.start();</span>
<span class="fc" id="L513">    addTo(germans(m_data), aaGun(m_data).create(1, germans(m_data)), m_data);</span>
<span class="fc" id="L514">    errorResults = placeDelegate.placeUnits(getUnits(map, germans), germany);</span>
<span class="fc" id="L515">    assertValid(errorResults);</span>
<span class="fc" id="L516">    assertEquals(germany.getUnits().getUnitCount(), preCount + 3);</span>
<span class="fc" id="L517">  }</span>

  @Test
  public void testMechanizedInfantry() {
    // Set up tech
<span class="fc" id="L522">    final PlayerID germans = GameDataTestUtil.germans(m_data);</span>
<span class="fc" id="L523">    final ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L524">    TechTracker.addAdvance(germans, delegateBridge,</span>
<span class="fc" id="L525">        TechAdvance.findAdvance(TechAdvance.TECH_PROPERTY_MECHANIZED_INFANTRY, m_data, germans));</span>
    // Set up the move delegate
<span class="fc" id="L527">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L528">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L529">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L530">    moveDelegate.start();</span>
    // Set up the territories
<span class="fc" id="L532">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L533">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L534">    final Territory belorussia = territory(&quot;Belorussia&quot;, m_data);</span>
    // Set up the unit types
<span class="fc" id="L536">    final UnitType infantryType = GameDataTestUtil.infantry(m_data);</span>
    // Remove all units from east poland
<span class="fc" id="L538">    removeFrom(eastPoland, eastPoland.getUnits().getUnits());</span>
    // Get total number of units in territories to start
<span class="fc" id="L540">    final int preCountIntPoland = poland.getUnits().size();</span>
<span class="fc" id="L541">    final int preCountIntBelorussia = belorussia.getUnits().size();</span>
    // Get units
<span class="fc" id="L543">    final Collection&lt;Unit&gt; moveUnits = poland.getUnits().getUnits(infantryType, 3);</span>
<span class="fc" id="L544">    moveUnits.addAll(poland.getUnits().getMatches(Matches.UnitCanBlitz));</span>
    // add a INVALID blitz attack
<span class="fc" id="L546">    final String errorResults = moveDelegate.move(moveUnits, new Route(poland, eastPoland, belorussia));</span>
<span class="fc" id="L547">    assertError(errorResults);</span>
    // Fix the number of units
<span class="fc" id="L549">    moveUnits.clear();</span>
<span class="fc" id="L550">    moveUnits.addAll(poland.getUnits().getUnits(infantryType, 2));</span>
<span class="fc" id="L551">    moveUnits.addAll(poland.getUnits().getMatches(Matches.UnitCanBlitz));</span>
    // add a VALID blitz attack
<span class="fc" id="L553">    final String validResults = moveDelegate.move(moveUnits, new Route(poland, eastPoland, belorussia));</span>
<span class="fc" id="L554">    assertValid(validResults);</span>
    // Get number of units in territories after move (adjusted for movement)
<span class="fc" id="L556">    final int postCountIntPoland = poland.getUnits().size() + 4;</span>
<span class="fc" id="L557">    final int postCountIntBelorussia = belorussia.getUnits().size() - 4;</span>
    // Compare the number of units before and after
<span class="fc" id="L559">    assertEquals(preCountIntPoland, postCountIntPoland);</span>
<span class="fc" id="L560">    assertEquals(preCountIntBelorussia, postCountIntBelorussia);</span>
<span class="fc" id="L561">  }</span>

  @Test
  public void testJetPower() {
    // Set up tech
<span class="fc" id="L566">    final PlayerID germans = GameDataTestUtil.germans(m_data);</span>
<span class="fc" id="L567">    final ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L568">    TechTracker.addAdvance(germans, delegateBridge,</span>
<span class="fc" id="L569">        TechAdvance.findAdvance(TechAdvance.TECH_PROPERTY_JET_POWER, m_data, germans));</span>
    // Set up the territories
<span class="fc" id="L571">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L572">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
    // Set up the unit types
<span class="fc" id="L574">    final UnitType fighterType = GameDataTestUtil.fighter(m_data);</span>
<span class="fc" id="L575">    delegateBridge.setStepName(&quot;germanBattle&quot;);</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">    while (!m_data.getSequence().getStep().getName().equals(&quot;germanBattle&quot;)) {</span>
<span class="nc" id="L577">      m_data.getSequence().next();</span>
    }
<span class="fc" id="L579">    final Collection&lt;TerritoryEffect&gt; territoryEffects = TerritoryEffectHelper.getEffects(eastPoland);</span>
    // With JET_POWER attacking fighter hits on 4 (0 base)
<span class="fc" id="L581">    final List&lt;Unit&gt; germanFighter = (List&lt;Unit&gt;) poland.getUnits().getUnits(fighterType, 1);</span>
<span class="fc" id="L582">    delegateBridge.setRandomSource(new ScriptedRandomSource(new int[] {3}));</span>
<span class="fc" id="L583">    final DiceRoll roll1 = DiceRoll.rollDice(germanFighter, false, germans, delegateBridge, new MockBattle(eastPoland),</span>
<span class="fc" id="L584">        &quot;&quot;, territoryEffects, null);</span>
<span class="fc" id="L585">    assertEquals(1, roll1.getHits());</span>
    // With JET_POWER defending fighter misses on 5 (0 base)
<span class="fc" id="L587">    delegateBridge.setRandomSource(new ScriptedRandomSource(new int[] {4}));</span>
<span class="fc" id="L588">    final DiceRoll roll2 = DiceRoll.rollDice(germanFighter, true, germans, delegateBridge, new MockBattle(eastPoland),</span>
<span class="fc" id="L589">        &quot;&quot;, territoryEffects, null);</span>
<span class="fc" id="L590">    assertEquals(0, roll2.getHits());</span>
<span class="fc" id="L591">  }</span>

  @Test
  public void testBidPlace() {
<span class="fc" id="L595">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L596">    bridge.setStepName(&quot;BidPlace&quot;);</span>
<span class="fc" id="L597">    bidPlaceDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L598">    bidPlaceDelegate(m_data).start();</span>
    // create 20 british infantry
<span class="fc" id="L600">    addTo(british(m_data), infantry(m_data).create(20, british(m_data)), m_data);</span>
<span class="fc" id="L601">    final Territory uk = territory(&quot;United Kingdom&quot;, m_data);</span>
<span class="fc" id="L602">    final Collection&lt;Unit&gt; units = british(m_data).getUnits().getUnits();</span>
<span class="fc" id="L603">    final PlaceableUnits placeable = bidPlaceDelegate(m_data).getPlaceableUnits(units, uk);</span>
<span class="fc" id="L604">    assertEquals(20, placeable.getMaxUnits());</span>
<span class="fc" id="L605">    assertNull(placeable.getErrorMessage());</span>
<span class="fc" id="L606">    final String error = bidPlaceDelegate(m_data).placeUnits(units, uk);</span>
<span class="fc" id="L607">    assertNull(error);</span>
<span class="fc" id="L608">  }</span>

  @Test
  public void testFactoryPlace() {
    // Set up game
<span class="fc" id="L613">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L614">    final ITestDelegateBridge delegateBridge = getDelegateBridge(british(m_data));</span>
    // Set up the territories
<span class="fc" id="L616">    final Territory egypt = territory(&quot;Union of South Africa&quot;, m_data);</span>
    // Set up the unit types
<span class="fc" id="L618">    final UnitType factoryType = GameDataTestUtil.factory(m_data);</span>
    // Set up the move delegate
<span class="fc" id="L620">    final PlaceDelegate placeDelegate = placeDelegate(m_data);</span>
<span class="fc" id="L621">    delegateBridge.setStepName(&quot;Place&quot;);</span>
<span class="fc" id="L622">    delegateBridge.setPlayerID(british);</span>
<span class="fc" id="L623">    placeDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L624">    placeDelegate.start();</span>
    // Add the factory
<span class="fc" id="L626">    final IntegerMap&lt;UnitType&gt; map = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L627">    map.add(factoryType, 1);</span>
<span class="fc" id="L628">    addTo(british(m_data), factory(m_data).create(1, british(m_data)), m_data);</span>
    // Place the factory
<span class="fc" id="L630">    final String response = placeDelegate.placeUnits(getUnits(map, british), egypt);</span>
<span class="fc" id="L631">    assertValid(response);</span>
    // placeUnits performPlace
    // get production and unit production values
<span class="fc" id="L634">    final TerritoryAttachment ta = TerritoryAttachment.get(egypt);</span>
<span class="fc" id="L635">    assertEquals(ta.getUnitProduction(), ta.getProduction());</span>
<span class="fc" id="L636">  }</span>

  @Test
  public void testChinesePlacement() {
    /*
     * This tests that Chinese can place units in any territory, that they can
     * place in just conquered territories, and that they can place in territories
     * with up to 3 Chinese units in them.
     */
    // Set up game
<span class="fc" id="L646">    final PlayerID chinese = GameDataTestUtil.chinese(m_data);</span>
<span class="fc" id="L647">    final ITestDelegateBridge delegateBridge = getDelegateBridge(chinese(m_data));</span>
<span class="fc" id="L648">    delegateBridge.setPlayerID(chinese);</span>
<span class="fc" id="L649">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L650">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L651">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L652">    moveDelegate.start();</span>
    // Set up the territories
<span class="fc" id="L654">    final Territory yunnan = territory(&quot;Yunnan&quot;, m_data);</span>
<span class="fc" id="L655">    final Territory kiangsu = territory(&quot;Kiangsu&quot;, m_data);</span>
<span class="fc" id="L656">    final Territory hupeh = territory(&quot;Hupeh&quot;, m_data);</span>
    // Set up the unit types
<span class="fc" id="L658">    final UnitType infantryType = GameDataTestUtil.infantry(m_data);</span>
    // Remove all units
<span class="fc" id="L660">    removeFrom(kiangsu, kiangsu.getUnits().getUnits());</span>
    // add a VALID attack
<span class="fc" id="L662">    final Collection&lt;Unit&gt; moveUnits = hupeh.getUnits().getUnits();</span>
<span class="fc" id="L663">    final String validResults = moveDelegate.move(moveUnits, new Route(hupeh, kiangsu));</span>
<span class="fc" id="L664">    assertValid(validResults);</span>
    /*
     * Place units in just captured territory
     */
<span class="fc" id="L668">    final PlaceDelegate placeDelegate = placeDelegate(m_data);</span>
<span class="fc" id="L669">    delegateBridge.setStepName(&quot;Place&quot;);</span>
<span class="fc" id="L670">    placeDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L671">    placeDelegate.start();</span>
    // Add the infantry
<span class="fc" id="L673">    IntegerMap&lt;UnitType&gt; map = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L674">    map.add(infantryType, 3);</span>
<span class="fc" id="L675">    addTo(chinese(m_data), infantry(m_data).create(1, chinese(m_data)), m_data);</span>
    // Get the number of units before placing
<span class="fc" id="L677">    int preCount = kiangsu.getUnits().getUnitCount();</span>
    // Place the infantry
<span class="fc" id="L679">    String response = placeDelegate.placeUnits(getUnits(map, chinese), kiangsu);</span>
<span class="fc" id="L680">    assertValid(response);</span>
<span class="fc" id="L681">    assertEquals(preCount + 1, kiangsu.getUnits().getUnitCount());</span>
    /*
     * Place units in a territory with up to 3 Chinese units
     */
    // Add the infantry
<span class="fc" id="L686">    map = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L687">    map.add(infantryType, 3);</span>
<span class="fc" id="L688">    addTo(chinese(m_data), infantry(m_data).create(3, chinese(m_data)), m_data);</span>
    // Get the number of units before placing
<span class="fc" id="L690">    preCount = yunnan.getUnits().getUnitCount();</span>
    // Place the infantry
<span class="fc" id="L692">    response = placeDelegate.placeUnits(getUnits(map, chinese), yunnan);</span>
<span class="fc" id="L693">    assertValid(response);</span>
<span class="fc" id="L694">    final int midCount = yunnan.getUnits().getUnitCount();</span>
    // Make sure they were all placed
<span class="fc" id="L696">    assertEquals(preCount, midCount - 3);</span>
    /*
     * Place units in a territory with 3 or more Chinese units
     */
<span class="fc" id="L700">    map = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L701">    map.add(infantryType, 1);</span>
<span class="fc" id="L702">    addTo(chinese(m_data), infantry(m_data).create(1, chinese(m_data)), m_data);</span>
<span class="fc" id="L703">    response = placeDelegate.placeUnits(getUnits(map, chinese), yunnan);</span>
<span class="fc" id="L704">    assertError(response);</span>
    // Make sure none were placed
<span class="fc" id="L706">    final int postCount = yunnan.getUnits().getUnitCount();</span>
<span class="fc" id="L707">    assertEquals(midCount, postCount);</span>
<span class="fc" id="L708">  }</span>

  @Test
  public void testPlaceInOccupiedSZ() {
    // Set up game
<span class="fc" id="L713">    final PlayerID germans = GameDataTestUtil.germans(m_data);</span>
<span class="fc" id="L714">    final ITestDelegateBridge delegateBridge = getDelegateBridge(british(m_data));</span>
    // Clear all units from the SZ and add an enemy unit
<span class="fc" id="L716">    final Territory sz5 = territory(&quot;5 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L717">    removeFrom(sz5, sz5.getUnits().getUnits());</span>
<span class="fc" id="L718">    addTo(sz5, destroyer(m_data).create(1, british(m_data)));</span>
    // Set up the unit types
<span class="fc" id="L720">    final UnitType transportType = GameDataTestUtil.transport(m_data);</span>
    // Set up the move delegate
<span class="fc" id="L722">    final PlaceDelegate placeDelegate = placeDelegate(m_data);</span>
<span class="fc" id="L723">    delegateBridge.setStepName(&quot;Place&quot;);</span>
<span class="fc" id="L724">    delegateBridge.setPlayerID(germans);</span>
<span class="fc" id="L725">    placeDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L726">    placeDelegate.start();</span>
    // Add the transport
<span class="fc" id="L728">    final IntegerMap&lt;UnitType&gt; map = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L729">    map.add(transportType, 1);</span>
<span class="fc" id="L730">    addTo(germans(m_data), transport(m_data).create(1, germans(m_data)), m_data);</span>
    // Place it
<span class="fc" id="L732">    final String response = placeDelegate.placeUnits(getUnits(map, germans), sz5);</span>
<span class="fc" id="L733">    assertValid(response);</span>
<span class="fc" id="L734">  }</span>

  @Test
  public void testMoveUnitsThroughSubs() {
<span class="fc" id="L738">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L739">    bridge.setStepName(&quot;britishNonCombatMove&quot;);</span>
<span class="fc" id="L740">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L741">    moveDelegate(m_data).start();</span>
<span class="fc" id="L742">    final Territory sz6 = territory(&quot;6 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L743">    final Route route = new Route(sz6, territory(&quot;7 Sea Zone&quot;, m_data), territory(&quot;8 Sea Zone&quot;, m_data));</span>
<span class="fc" id="L744">    final String error = moveDelegate(m_data).move(sz6.getUnits().getUnits(), route);</span>
<span class="fc" id="L745">    assertNull(error, error);</span>
<span class="fc" id="L746">  }</span>

  @Test
  public void testMoveUnitsThroughTransports() {
<span class="fc" id="L750">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L751">    bridge.setStepName(&quot;britishCombatMove&quot;);</span>
<span class="fc" id="L752">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L753">    moveDelegate(m_data).start();</span>
<span class="fc" id="L754">    final Territory sz12 = territory(&quot;12 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L755">    final Route route = new Route(sz12, territory(&quot;13 Sea Zone&quot;, m_data), territory(&quot;14 Sea Zone&quot;, m_data));</span>
<span class="fc" id="L756">    final String error = moveDelegate(m_data).move(sz12.getUnits().getUnits(), route);</span>
<span class="fc" id="L757">    assertNull(error, error);</span>
<span class="fc" id="L758">  }</span>

  @Test
  public void testMoveUnitsThroughTransports2() {
<span class="fc" id="L762">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L763">    bridge.setStepName(&quot;britishNonCombatMove&quot;);</span>
<span class="fc" id="L764">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L765">    moveDelegate(m_data).start();</span>
<span class="fc" id="L766">    final Territory sz12 = territory(&quot;12 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L767">    final Territory sz14 = territory(&quot;14 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L768">    removeFrom(sz14, sz14.getUnits().getUnits());</span>
<span class="fc" id="L769">    final Route route = new Route(sz12, territory(&quot;13 Sea Zone&quot;, m_data), sz14);</span>
<span class="fc" id="L770">    final String error = moveDelegate(m_data).move(sz12.getUnits().getUnits(), route);</span>
<span class="fc" id="L771">    assertNull(error, error);</span>
<span class="fc" id="L772">  }</span>

  @Test
  public void testLoadThroughSubs() {
<span class="fc" id="L776">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L777">    bridge.setStepName(&quot;britishNonCombatMove&quot;);</span>
<span class="fc" id="L778">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L779">    moveDelegate.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L780">    moveDelegate.start();</span>
<span class="fc" id="L781">    final Territory sz8 = territory(&quot;8 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L782">    final Territory sz7 = territory(&quot;7 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L783">    final Territory sz6 = territory(&quot;6 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L784">    final Territory uk = territory(&quot;United Kingdom&quot;, m_data);</span>
    // add a transport
<span class="fc" id="L786">    addTo(sz8, transport(m_data).create(1, british(m_data)));</span>
    // move the transport where to the sub is
<span class="fc" id="L788">    assertValid(moveDelegate.move(sz8.getUnits().getUnits(), new Route(sz8, sz7)));</span>
    // load the transport
<span class="fc" id="L790">    load(uk.getUnits().getMatches(Matches.UnitIsInfantry), new Route(uk, sz7));</span>
    // move the transport out
<span class="fc" id="L792">    assertValid(</span>
<span class="fc" id="L793">        moveDelegate.move(sz7.getUnits().getMatches(Matches.unitOwnedBy(british(m_data))), new Route(sz7, sz6)));</span>
<span class="fc" id="L794">  }</span>

  @Test
  public void testAttackUndoAndAttackAgain() {
<span class="fc" id="L798">    final MoveDelegate move = moveDelegate(m_data);</span>
<span class="fc" id="L799">    final ITestDelegateBridge bridge = getDelegateBridge(italians(m_data));</span>
<span class="fc" id="L800">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L801">    move.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L802">    move.start();</span>
<span class="fc" id="L803">    final Territory sz14 = territory(&quot;14 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L804">    final Territory sz13 = territory(&quot;13 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L805">    final Territory sz12 = territory(&quot;12 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L806">    final Route r = new Route(sz14, sz13, sz12);</span>
    // move the battleship
<span class="fc" id="L808">    move(sz14.getUnits().getMatches(Matches.UnitHasMoreThanOneHitPointTotal), r);</span>
    // move everything
<span class="fc" id="L810">    move(sz14.getUnits().getMatches(Matches.UnitIsNotTransport), r);</span>
    // undo it
<span class="fc" id="L812">    move.undoMove(1);</span>
    // move again
<span class="fc" id="L814">    move(sz14.getUnits().getMatches(Matches.UnitIsNotTransport), r);</span>
<span class="fc" id="L815">    final MustFightBattle mfb =</span>
<span class="fc" id="L816">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(sz12, false, null);</span>
    // only 3 attacking units
    // the battleship and the two cruisers
<span class="fc" id="L819">    assertEquals(3, mfb.getAttackingUnits().size());</span>
<span class="fc" id="L820">  }</span>

  @Test
  public void testAttackSubsOnSubs() {
<span class="fc" id="L824">    final String defender = &quot;Germans&quot;;</span>
<span class="fc" id="L825">    final String attacker = &quot;British&quot;;</span>
<span class="fc" id="L826">    final Territory attacked = territory(&quot;31 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L827">    final Territory from = territory(&quot;32 Sea Zone&quot;, m_data);</span>
    // 1 sub attacks 1 sub
<span class="fc" id="L829">    addTo(from, submarine(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L830">    addTo(attacked, submarine(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L831">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L832">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L833">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L834">    moveDelegate(m_data).start();</span>
<span class="fc" id="L835">    move(from.getUnits().getUnits(), new Route(from, attacked));</span>
<span class="fc" id="L836">    moveDelegate(m_data).end();</span>
<span class="fc" id="L837">    final MustFightBattle battle =</span>
<span class="fc" id="L838">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(attacked, false, null);</span>
<span class="fc" id="L839">    final List&lt;String&gt; steps = battle.determineStepStrings(true, bridge);</span>
<span class="fc" id="L840">    assertEquals(</span>
<span class="fc" id="L841">        Arrays.asList(attacker + SUBS_SUBMERGE, defender + SUBS_SUBMERGE, attacker + SUBS_FIRE,</span>
<span class="fc" id="L842">            defender + SELECT_SUB_CASUALTIES, defender + SUBS_FIRE, attacker + SELECT_SUB_CASUALTIES,</span>
<span class="fc" id="L843">            REMOVE_SNEAK_ATTACK_CASUALTIES, REMOVE_CASUALTIES, attacker + ATTACKER_WITHDRAW).toString(),</span>
<span class="fc" id="L844">        steps.toString());</span>
<span class="fc" id="L845">    bridge.setRemote(dummyPlayer);</span>
    // fight, each sub should fire
    // and hit
<span class="fc" id="L848">    final ScriptedRandomSource randomSource = new ScriptedRandomSource(0, 0, ScriptedRandomSource.ERROR);</span>
<span class="fc" id="L849">    bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L850">    battle.fight(bridge);</span>
<span class="fc" id="L851">    assertEquals(2, randomSource.getTotalRolled());</span>
<span class="fc" id="L852">    assertTrue(attacked.getUnits().isEmpty());</span>
<span class="fc" id="L853">  }</span>

  @Test
  public void testAttackSubsOnDestroyer() {
<span class="fc" id="L857">    final String defender = &quot;Germans&quot;;</span>
<span class="fc" id="L858">    final String attacker = &quot;British&quot;;</span>
<span class="fc" id="L859">    final Territory attacked = territory(&quot;31 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L860">    final Territory from = territory(&quot;32 Sea Zone&quot;, m_data);</span>
    // 1 sub attacks 1 sub and 1 destroyer
    // defender sneak attacks, not attacker
<span class="fc" id="L863">    addTo(from, submarine(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L864">    addTo(attacked, submarine(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L865">    addTo(attacked, destroyer(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L866">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L867">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L868">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L869">    moveDelegate(m_data).start();</span>
<span class="fc" id="L870">    move(from.getUnits().getUnits(), new Route(from, attacked));</span>
<span class="fc" id="L871">    moveDelegate(m_data).end();</span>
<span class="fc" id="L872">    final MustFightBattle battle =</span>
<span class="fc" id="L873">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(attacked, false, null);</span>
<span class="fc" id="L874">    final List&lt;String&gt; steps = battle.determineStepStrings(true, bridge);</span>
<span class="fc" id="L875">    assertEquals(</span>
<span class="fc" id="L876">        Arrays.asList(defender + SUBS_SUBMERGE, defender + SUBS_FIRE, attacker + SELECT_SUB_CASUALTIES,</span>
<span class="fc" id="L877">            REMOVE_SNEAK_ATTACK_CASUALTIES, attacker + SUBS_FIRE, defender + SELECT_SUB_CASUALTIES, defender + FIRE,</span>
<span class="fc" id="L878">            attacker + SELECT_CASUALTIES, REMOVE_CASUALTIES, attacker + ATTACKER_WITHDRAW).toString(),</span>
<span class="fc" id="L879">        steps.toString());</span>
<span class="fc" id="L880">    bridge.setRemote(dummyPlayer);</span>
    // defending subs sneak attack and hit
    // no chance to return fire
<span class="fc" id="L883">    final ScriptedRandomSource randomSource = new ScriptedRandomSource(0, ScriptedRandomSource.ERROR);</span>
<span class="fc" id="L884">    bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L885">    battle.fight(bridge);</span>
<span class="fc" id="L886">    assertEquals(1, randomSource.getTotalRolled());</span>
<span class="fc" id="L887">    assertTrue(attacked.getUnits().getMatches(Matches.unitIsOwnedBy(british(m_data))).isEmpty());</span>
<span class="fc" id="L888">    assertEquals(2, attacked.getUnits().size());</span>
<span class="fc" id="L889">  }</span>

  @Test
  public void testAttackDestroyerAndSubsAgainstSub() {
<span class="fc" id="L893">    final String defender = &quot;Germans&quot;;</span>
<span class="fc" id="L894">    final String attacker = &quot;British&quot;;</span>
<span class="fc" id="L895">    final Territory attacked = territory(&quot;31 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L896">    final Territory from = territory(&quot;32 Sea Zone&quot;, m_data);</span>
    // 1 sub and 1 destroyer attack 1 sub
    // defender sneak attacks, not attacker
<span class="fc" id="L899">    addTo(from, submarine(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L900">    addTo(from, destroyer(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L901">    addTo(attacked, submarine(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L902">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L903">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L904">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L905">    moveDelegate(m_data).start();</span>
<span class="fc" id="L906">    move(from.getUnits().getUnits(), new Route(from, attacked));</span>
<span class="fc" id="L907">    moveDelegate(m_data).end();</span>
<span class="fc" id="L908">    final MustFightBattle battle =</span>
<span class="fc" id="L909">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(attacked, false, null);</span>
<span class="fc" id="L910">    final List&lt;String&gt; steps = battle.determineStepStrings(true, bridge);</span>
<span class="fc" id="L911">    assertEquals(</span>
<span class="fc" id="L912">        Arrays.asList(attacker + SUBS_SUBMERGE, attacker + SUBS_FIRE, defender + SELECT_SUB_CASUALTIES,</span>
<span class="fc" id="L913">            REMOVE_SNEAK_ATTACK_CASUALTIES, attacker + FIRE, defender + SELECT_CASUALTIES, defender + SUBS_FIRE,</span>
<span class="fc" id="L914">            attacker + SELECT_SUB_CASUALTIES, REMOVE_CASUALTIES, attacker + ATTACKER_WITHDRAW).toString(),</span>
<span class="fc" id="L915">        steps.toString());</span>
<span class="fc" id="L916">    bridge.setRemote(dummyPlayer);</span>
    // attacking subs sneak attack and hit
    // no chance to return fire
<span class="fc" id="L919">    final ScriptedRandomSource randomSource = new ScriptedRandomSource(0, ScriptedRandomSource.ERROR);</span>
<span class="fc" id="L920">    bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L921">    battle.fight(bridge);</span>
<span class="fc" id="L922">    assertEquals(1, randomSource.getTotalRolled());</span>
<span class="fc" id="L923">    assertTrue(attacked.getUnits().getMatches(Matches.unitIsOwnedBy(germans(m_data))).isEmpty());</span>
<span class="fc" id="L924">    assertEquals(2, attacked.getUnits().size());</span>
<span class="fc" id="L925">  }</span>

  @Test
  public void testAttackDestroyerAndSubsAgainstSubAndDestroyer() {
<span class="fc" id="L929">    final String defender = &quot;Germans&quot;;</span>
<span class="fc" id="L930">    final String attacker = &quot;British&quot;;</span>
<span class="fc" id="L931">    final Territory attacked = territory(&quot;31 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L932">    final Territory from = territory(&quot;32 Sea Zone&quot;, m_data);</span>
    // 1 sub and 1 destroyer attack 1 sub and 1 destroyer
    // no sneak attacks
<span class="fc" id="L935">    addTo(from, submarine(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L936">    addTo(from, destroyer(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L937">    addTo(attacked, submarine(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L938">    addTo(attacked, destroyer(m_data).create(1, germans(m_data)));</span>
<span class="fc" id="L939">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L940">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L941">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L942">    moveDelegate(m_data).start();</span>
<span class="fc" id="L943">    move(from.getUnits().getUnits(), new Route(from, attacked));</span>
<span class="fc" id="L944">    moveDelegate(m_data).end();</span>
<span class="fc" id="L945">    final MustFightBattle battle =</span>
<span class="fc" id="L946">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(attacked, false, null);</span>
<span class="fc" id="L947">    final List&lt;String&gt; steps = battle.determineStepStrings(true, bridge);</span>
<span class="fc" id="L948">    assertEquals(</span>
<span class="fc" id="L949">        Arrays.asList(attacker + SUBS_FIRE, defender + SELECT_SUB_CASUALTIES, attacker + FIRE,</span>
<span class="fc" id="L950">            defender + SELECT_CASUALTIES, defender + SUBS_FIRE, attacker + SELECT_SUB_CASUALTIES, defender + FIRE,</span>
<span class="fc" id="L951">            attacker + SELECT_CASUALTIES, REMOVE_CASUALTIES, attacker + ATTACKER_WITHDRAW).toString(),</span>
<span class="fc" id="L952">        steps.toString());</span>
<span class="fc" id="L953">    when(dummyPlayer.selectCasualties(any(), any(), anyInt(), any(), any(), any(), any(), any(), any(), anyBoolean(),</span>
<span class="fc" id="L954">        any(),</span>
<span class="fc" id="L955">        any(), any(), any(), anyBoolean())).thenAnswer(new Answer&lt;CasualtyDetails&gt;() {</span>
          @Override
          public CasualtyDetails answer(final InvocationOnMock invocation) {
<span class="fc" id="L958">            final Collection&lt;Unit&gt; selectFrom = invocation.getArgument(0);</span>
<span class="fc" id="L959">            return new CasualtyDetails(Arrays.asList(selectFrom.iterator().next()), new ArrayList&lt;&gt;(), false);</span>
          }
        });
<span class="fc" id="L962">    bridge.setRemote(dummyPlayer);</span>
    // attacking subs sneak attack and hit
    // no chance to return fire
<span class="fc" id="L965">    final ScriptedRandomSource randomSource = new ScriptedRandomSource(0, 0, 0, 0, ScriptedRandomSource.ERROR);</span>
<span class="fc" id="L966">    bridge.setRandomSource(randomSource);</span>
<span class="fc" id="L967">    battle.fight(bridge);</span>
<span class="fc" id="L968">    assertEquals(4, randomSource.getTotalRolled());</span>
<span class="fc" id="L969">    assertEquals(0, attacked.getUnits().size());</span>
<span class="fc" id="L970">  }</span>

  @Test
  public void testLimitBombardtoNumberOfUnloaded() {
<span class="fc" id="L974">    final MoveDelegate move = moveDelegate(m_data);</span>
<span class="fc" id="L975">    final ITestDelegateBridge bridge = getDelegateBridge(italians(m_data));</span>

<span class="fc" id="L977">    when(dummyPlayer.selectShoreBombard(any())).thenReturn(true);</span>
<span class="fc" id="L978">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L979">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L980">    move.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L981">    move.start();</span>
<span class="fc" id="L982">    final Territory sz14 = territory(&quot;14 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L983">    final Territory sz15 = territory(&quot;15 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L984">    final Territory eg = territory(&quot;Egypt&quot;, m_data);</span>
<span class="fc" id="L985">    final Territory li = territory(&quot;Libya&quot;, m_data);</span>
<span class="fc" id="L986">    final Territory balkans = territory(&quot;Balkans&quot;, m_data);</span>
    // Clear all units from the attacked terr
<span class="fc" id="L988">    removeFrom(eg, eg.getUnits().getUnits());</span>
    // Add 2 inf
<span class="fc" id="L990">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L991">    addTo(eg, infantry(m_data).create(2, british));</span>
    // load the transports
<span class="fc" id="L993">    load(balkans.getUnits().getMatches(Matches.UnitIsInfantry), new Route(balkans, sz14));</span>
    // move the fleet
<span class="fc" id="L995">    move(sz14.getUnits().getUnits(), new Route(sz14, sz15));</span>
    // move troops from Libya
<span class="fc" id="L997">    move(li.getUnits().getMatches(Matches.unitOwnedBy(italians(m_data))), new Route(li, eg));</span>
    // unload the transports
<span class="fc" id="L999">    move(sz15.getUnits().getMatches(Matches.UnitIsLand), new Route(sz15, eg));</span>
<span class="fc" id="L1000">    move.end();</span>
    // start the battle phase, this will ask the user to bombard
<span class="fc" id="L1002">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1003">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1004">    final MustFightBattle mfb =</span>
<span class="fc" id="L1005">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(eg, false, null);</span>
    // only 2 ships are allowed to bombard (there are 1 battleship and 2 cruisers that COULD bombard, but only 2 ships
    // may bombard total)
<span class="fc" id="L1008">    assertEquals(2, mfb.getBombardingUnits().size());</span>
    // Show that bombard casualties can return fire
    // Note- the 3 &amp; 2 hits below show default behavior of bombarding at attack strength
    // 3= Battleship hitting a 4, 2=Cruiser hitting a 3, 5555=italian infantry missing on 6s, 00= british getting return
    // fire on 1.
<span class="fc" id="L1013">    bridge.setRandomSource(new ScriptedRandomSource(3, 2, 5, 5, 5, 5, 0, 0));</span>
<span class="fc" id="L1014">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1015">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1016">    fight(battleDelegate(m_data), eg);</span>
    // end result should be 2 italian infantry.
<span class="fc" id="L1018">    assertEquals(2, eg.getUnits().size());</span>
<span class="fc" id="L1019">  }</span>

  @Test
  public void testBombardStrengthVariable() {
<span class="fc" id="L1023">    final MoveDelegate move = moveDelegate(m_data);</span>
<span class="fc" id="L1024">    final ITestDelegateBridge bridge = getDelegateBridge(italians(m_data));</span>
<span class="fc" id="L1025">    when(dummyPlayer.selectShoreBombard(any())).thenReturn(true);</span>
<span class="fc" id="L1026">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L1027">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1028">    move.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1029">    move.start();</span>
<span class="fc" id="L1030">    final Territory sz14 = territory(&quot;14 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1031">    final Territory sz15 = territory(&quot;15 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1032">    final Territory eg = territory(&quot;Egypt&quot;, m_data);</span>
<span class="fc" id="L1033">    final Territory balkans = territory(&quot;Balkans&quot;, m_data);</span>
    // Clear all units
<span class="fc" id="L1035">    removeFrom(eg, eg.getUnits().getUnits());</span>
<span class="fc" id="L1036">    removeFrom(sz14, sz14.getUnits().getUnits());</span>
    // Add 2 inf to the attacked terr
<span class="fc" id="L1038">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L1039">    addTo(eg, infantry(m_data).create(2, british));</span>
    // create/load the destroyers and transports
<span class="fc" id="L1041">    final PlayerID italians = GameDataTestUtil.italians(m_data);</span>
<span class="fc" id="L1042">    addTo(sz14, transport(m_data).create(1, italians));</span>
<span class="fc" id="L1043">    addTo(sz14, destroyer(m_data).create(2, italians));</span>
    // load the transports
<span class="fc" id="L1045">    load(balkans.getUnits().getMatches(Matches.UnitIsInfantry), new Route(balkans, sz14));</span>
    // move the fleet
<span class="fc" id="L1047">    move(sz14.getUnits().getUnits(), new Route(sz14, sz15));</span>
    // unload the transports
<span class="fc" id="L1049">    move(sz15.getUnits().getMatches(Matches.UnitIsLand), new Route(sz15, eg));</span>
<span class="fc" id="L1050">    move.end();</span>
    // Set the tech for DDs bombard
    // ww2v3 doesn't have this tech, so this does nothing...
    // TechAttachment.get(italians).setDestroyerBombard(&quot;true&quot;);
<span class="fc" id="L1054">    UnitAttachment.get(destroyer(m_data)).setCanBombard(&quot;true&quot;);</span>
    // Set the bombard strength for the DDs
<span class="fc" id="L1056">    final Collection&lt;Unit&gt; dds = Match.getMatches(sz15.getUnits().getUnits(), Matches.UnitIsDestroyer);</span>
<span class="fc" id="L1057">    final Iterator&lt;Unit&gt; ddIter = dds.iterator();</span>
<span class="fc bfc" id="L1058" title="All 2 branches covered.">    while (ddIter.hasNext()) {</span>
<span class="fc" id="L1059">      final Unit unit = ddIter.next();</span>
<span class="fc" id="L1060">      final UnitAttachment ua = UnitAttachment.get(unit.getType());</span>
<span class="fc" id="L1061">      ua.setBombard(&quot;3&quot;);</span>
    }
    // start the battle phase, this will ask the user to bombard
<span class="fc" id="L1064">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1065">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1066">    final MustFightBattle mfb =</span>
<span class="fc" id="L1067">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(eg, false, null);</span>
<span class="fc" id="L1068">    assertNotNull(mfb);</span>
    // Show that bombard casualties can return fire
    // destroyer bombard hit/miss on rolls of 4 &amp; 3
    // landing inf miss
    // defending inf hit
<span class="fc" id="L1073">    bridge.setRandomSource(new ScriptedRandomSource(3, 2, 6, 6, 1, 1));</span>
<span class="fc" id="L1074">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1075">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1076">    fight(battleDelegate(m_data), eg);</span>
    // 1 defending inf remaining
<span class="fc" id="L1078">    assertEquals(1, eg.getUnits().size());</span>
<span class="fc" id="L1079">  }</span>

  @Test
  public void testAmphAttackUndoAndAttackAgainBombard() {
<span class="fc" id="L1083">    final MoveDelegate move = moveDelegate(m_data);</span>
<span class="fc" id="L1084">    final ITestDelegateBridge bridge = getDelegateBridge(italians(m_data));</span>
<span class="fc" id="L1085">    when(dummyPlayer.selectShoreBombard(any())).thenReturn(true);</span>
<span class="fc" id="L1086">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L1087">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1088">    move.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1089">    move.start();</span>
<span class="fc" id="L1090">    final Territory sz14 = territory(&quot;14 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1091">    final Territory sz15 = territory(&quot;15 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1092">    final Territory eg = territory(&quot;Egypt&quot;, m_data);</span>
<span class="fc" id="L1093">    final Territory li = territory(&quot;Libya&quot;, m_data);</span>
<span class="fc" id="L1094">    final Territory balkans = territory(&quot;Balkans&quot;, m_data);</span>
    // load the transports
<span class="fc" id="L1096">    load(balkans.getUnits().getMatches(Matches.UnitIsInfantry), new Route(balkans, sz14));</span>
    // move the fleet
<span class="fc" id="L1098">    move(sz14.getUnits().getUnits(), new Route(sz14, sz15));</span>
    // move troops from Libya
<span class="fc" id="L1100">    move(li.getUnits().getMatches(Matches.unitOwnedBy(italians(m_data))), new Route(li, eg));</span>
    // unload the transports
<span class="fc" id="L1102">    move(sz15.getUnits().getMatches(Matches.UnitIsLand), new Route(sz15, eg));</span>
    // undo amphibious landing
<span class="fc" id="L1104">    move.undoMove(move.getMovesMade().size() - 1);</span>
    // move again
<span class="fc" id="L1106">    move(sz15.getUnits().getMatches(Matches.UnitIsLand), new Route(sz15, eg));</span>
<span class="fc" id="L1107">    move.end();</span>
    // start the battle phase, this will ask the user to bombard
<span class="fc" id="L1109">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1110">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1111">    final MustFightBattle mfb =</span>
<span class="fc" id="L1112">        (MustFightBattle) AbstractMoveDelegate.getBattleTracker(m_data).getPendingBattle(eg, false, null);</span>
    // only 2 battleships are allowed to bombard
<span class="fc" id="L1114">    assertEquals(2, mfb.getBombardingUnits().size());</span>
<span class="fc" id="L1115">  }</span>

  // TODO this test needs work kev
  @Test
  public void testAAFireWithRadar() {
<span class="fc" id="L1120">    final PlayerID russians = russians(m_data);</span>
<span class="fc" id="L1121">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1122">    TechAttachment.get(russians).setAARadar(&quot;true&quot;);</span>
<span class="fc" id="L1123">    final MoveDelegate move = moveDelegate(m_data);</span>
<span class="fc" id="L1124">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1125">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1126">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1127">    final Territory russia = territory(&quot;Russia&quot;, m_data);</span>
    // Add bomber to Poland and attack
<span class="fc" id="L1129">    addTo(poland, bomber(m_data).create(1, germans));</span>
    // The game will ask us if we want to move bomb, say yes.
<span class="fc" id="L1131">    final InvocationHandler handler = new InvocationHandler() {</span>
      @Override
      public Object invoke(final Object proxy, final Method method, final Object[] args) throws Throwable {
<span class="fc" id="L1134">        return true;</span>
      }
    };
<span class="fc" id="L1137">    final ITripleAPlayer player = (ITripleAPlayer) Proxy</span>
<span class="fc" id="L1138">        .newProxyInstance(Thread.currentThread().getContextClassLoader(),</span>
<span class="fc" id="L1139">            TestUtil.getClassArrayFrom(ITripleAPlayer.class), handler);</span>
<span class="fc" id="L1140">    bridge.setRemote(player);</span>
    // Perform the combat movement
<span class="fc" id="L1142">    move.setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1143">    move.start();</span>
<span class="fc" id="L1144">    move(poland.getUnits().getMatches(Matches.UnitIsStrategicBomber), m_data.getMap().getRoute(poland, russia));</span>
<span class="fc" id="L1145">    move.end();</span>
    // start the battle phase
<span class="fc" id="L1147">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1148">    battleDelegate(m_data).start();</span>
    // aa guns rolls 1, hits
<span class="fc" id="L1150">    bridge.setRandomSource(new ScriptedRandomSource(new int[] {0, ScriptedRandomSource.ERROR}));</span>
<span class="fc" id="L1151">    final StrategicBombingRaidBattle battle =</span>
<span class="fc" id="L1152">        (StrategicBombingRaidBattle) battleDelegate(m_data).getBattleTracker().getPendingBattle(russia, true, null);</span>
    // aa guns rolls 1, hits
    // bridge.setRandomSource(new ScriptedRandomSource( new int[] {0, 6} ));
<span class="fc" id="L1155">    final int PUsBeforeRaid = russians.getResources().getQuantity(m_data.getResourceList().getResource(Constants.PUS));</span>
<span class="fc" id="L1156">    battle.fight(bridge);</span>
<span class="fc" id="L1157">    final int PUsAfterRaid = russians.getResources().getQuantity(m_data.getResourceList().getResource(Constants.PUS));</span>
    // Changed to match StrategicBombingRaidBattle changes
<span class="fc" id="L1159">    assertEquals(PUsBeforeRaid, PUsAfterRaid);</span>
<span class="fc" id="L1160">  }</span>

  @Test
  public void testCarrierWithAlliedPlanes() {
<span class="fc" id="L1164">    final Territory sz8 = territory(&quot;8 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1165">    final Territory sz1 = territory(&quot;1 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1166">    addTo(sz8, carrier(m_data).create(1, british(m_data)));</span>
<span class="fc" id="L1167">    addTo(sz8, fighter(m_data).create(1, americans(m_data)));</span>
<span class="fc" id="L1168">    final Route route = new Route(sz8, sz1);</span>
<span class="fc" id="L1169">    final ITestDelegateBridge bridge = getDelegateBridge(british(m_data));</span>
<span class="fc" id="L1170">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1171">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1172">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1173">    move(sz8.getUnits().getUnits(), route);</span>
    // make sure the fighter moved
<span class="fc" id="L1175">    assertTrue(sz8.getUnits().getUnits().isEmpty());</span>
<span class="fc" id="L1176">    assertFalse(sz1.getUnits().getMatches(Matches.UnitIsAir).isEmpty());</span>
<span class="fc" id="L1177">  }</span>

  @Test
  public void testAirCanLandWithAlliedFighters() {
    // germany owns madagascar, with 2 fighters in it
    // also 1 carrier, and 1 allied fighter in sz 40
    // the fighters should not be able to move from madagascar
    // to sz 40, since with the allied fighter, their is no room
    // on the carrier
<span class="fc" id="L1186">    final Territory madagascar = territory(&quot;French Madagascar&quot;, m_data);</span>
<span class="fc" id="L1187">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1188">    madagascar.setOwner(germans);</span>
<span class="fc" id="L1189">    final Territory sz40 = territory(&quot;40 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1190">    addTo(sz40, carrier(m_data).create(1, germans));</span>
<span class="fc" id="L1191">    addTo(sz40, fighter(m_data).create(1, italians(m_data)));</span>
<span class="fc" id="L1192">    addTo(madagascar, fighter(m_data).create(2, germans));</span>
<span class="fc" id="L1193">    final Route route = m_data.getMap().getRoute(madagascar, sz40);</span>
<span class="fc" id="L1194">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1195">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1196">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1197">    moveDelegate(m_data).start();</span>
    // don't allow kamikaze
<span class="fc" id="L1199">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L1200">    final String error = moveDelegate(m_data).move(madagascar.getUnits().getUnits(), route);</span>
<span class="fc" id="L1201">    assertError(error);</span>
<span class="fc" id="L1202">  }</span>

  @Test
  public void testMechInfSimple() {
<span class="fc" id="L1206">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1207">    final Territory france = territory(&quot;France&quot;, m_data);</span>
<span class="fc" id="L1208">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1209">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1210">    TechAttachment.get(germans).setMechanizedInfantry(&quot;true&quot;);</span>
<span class="fc" id="L1211">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1212">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1213">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1214">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1215">    final Route r = new Route(france, germany, poland);</span>
<span class="fc" id="L1216">    final List&lt;Unit&gt; toMove = new ArrayList&lt;&gt;();</span>
    // 1 armour and 1 infantry
<span class="fc" id="L1218">    toMove.addAll(france.getUnits().getMatches(Matches.UnitCanBlitz));</span>
<span class="fc" id="L1219">    toMove.add(france.getUnits().getMatches(Matches.UnitIsInfantry).get(0));</span>
<span class="fc" id="L1220">    move(toMove, r);</span>
<span class="fc" id="L1221">  }</span>

  @Test
  public void testMechInfUnitAlreadyMovedSimple() {
<span class="fc" id="L1225">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1226">    final Territory france = territory(&quot;France&quot;, m_data);</span>
<span class="fc" id="L1227">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1228">    TechAttachment.get(germans).setMechanizedInfantry(&quot;true&quot;);</span>
<span class="fc" id="L1229">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1230">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1231">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1232">    moveDelegate(m_data).start();</span>
    // get rid of the infantry in france
<span class="fc" id="L1234">    removeFrom(france, france.getUnits().getMatches(Matches.UnitIsInfantry));</span>
    // move an infantry from germany to france
<span class="fc" id="L1236">    move(germany.getUnits().getMatches(Matches.UnitIsInfantry).subList(0, 1), new Route(germany, france));</span>
    // try to move all the units in france, the infantry should not be able to move
<span class="fc" id="L1238">    final Route r = new Route(france, germany);</span>
<span class="fc" id="L1239">    final String error = moveDelegate(m_data).move(france.getUnits().getUnits(), r);</span>
<span class="pc bpc" id="L1240" title="1 of 2 branches missed.">    assertFalse(error == null);</span>
<span class="fc" id="L1241">  }</span>

  @Test
  public void testParatroopsWalkOnWater() {
<span class="fc" id="L1245">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1246">    final Territory france = territory(&quot;France&quot;, m_data);</span>
<span class="fc" id="L1247">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1248">    final Route r = m_data.getMap().getRoute(france, territory(&quot;7 Sea Zone&quot;, m_data));</span>
<span class="fc" id="L1249">    final Collection&lt;Unit&gt; paratroopers = france.getUnits().getMatches(Matches.UnitIsAirTransportable);</span>
<span class="fc" id="L1250">    assertFalse(paratroopers.isEmpty());</span>
<span class="fc" id="L1251">    final MoveValidationResult results = MoveValidator.validateMove(paratroopers, r, germans,</span>
<span class="fc" id="L1252">        Collections.&lt;Unit&gt;emptyList(), new HashMap&lt;&gt;(), false, null, m_data);</span>
<span class="fc" id="L1253">    assertFalse(results.isMoveValid());</span>
<span class="fc" id="L1254">  }</span>

  @Test
  public void testBomberWithTankOverWaterParatroopers() {
<span class="fc" id="L1258">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1259">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1260">    final Territory sz5 = territory(&quot;5 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1261">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1262">    final Territory karelia = territory(&quot;Karelia S.S.R.&quot;, m_data);</span>
<span class="fc" id="L1263">    addTo(germany, armour(m_data).create(1, germans));</span>
<span class="fc" id="L1264">    final Route r = new Route(germany, sz5, karelia);</span>
<span class="fc" id="L1265">    final Collection&lt;Unit&gt; toMove = germany.getUnits().getMatches(Matches.UnitCanBlitz);</span>
<span class="fc" id="L1266">    toMove.addAll(germany.getUnits().getMatches(Matches.UnitIsStrategicBomber));</span>
<span class="fc" id="L1267">    assertEquals(2, toMove.size());</span>
<span class="fc" id="L1268">    final MoveValidationResult results = MoveValidator.validateMove(toMove, r, germans, Collections.&lt;Unit&gt;emptyList(),</span>
<span class="fc" id="L1269">        new HashMap&lt;&gt;(), false, null, m_data);</span>
<span class="fc" id="L1270">    assertFalse(results.isMoveValid());</span>
<span class="fc" id="L1271">  }</span>

  @Test
  public void testBomberTankOverWater() {
    // can't transport a tank over water using a bomber
<span class="fc" id="L1276">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1277">    final Territory sz5 = territory(&quot;5 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1278">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1279">    final Territory karelia = territory(&quot;Karelia S.S.R.&quot;, m_data);</span>
<span class="fc" id="L1280">    addTo(germany, armour(m_data).create(1, germans));</span>
<span class="fc" id="L1281">    final Route r = new Route(germany, sz5, karelia);</span>
<span class="fc" id="L1282">    final Collection&lt;Unit&gt; toMove = germany.getUnits().getMatches(Matches.UnitCanBlitz);</span>
<span class="fc" id="L1283">    toMove.addAll(germany.getUnits().getMatches(Matches.UnitIsStrategicBomber));</span>
<span class="fc" id="L1284">    assertEquals(2, toMove.size());</span>
<span class="fc" id="L1285">    final MoveValidationResult results = MoveValidator.validateMove(toMove, r, germans, Collections.&lt;Unit&gt;emptyList(),</span>
<span class="fc" id="L1286">        new HashMap&lt;&gt;(), false, null, m_data);</span>
<span class="fc" id="L1287">    assertFalse(results.isMoveValid());</span>
<span class="fc" id="L1288">  }</span>

  @Test
  public void testMoveParatroopersAsNonPartroops() {
    // move a bomber and a paratrooper
    // one step, but as a normal movement
<span class="fc" id="L1294">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1295">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1296">    final Territory nwe = territory(&quot;Northwestern Europe&quot;, m_data);</span>
<span class="fc" id="L1297">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1298">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1299">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1300">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1301">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1302">    List&lt;Unit&gt; paratrooper = germany.getUnits().getMatches(Matches.UnitIsAirTransportable);</span>
<span class="fc" id="L1303">    paratrooper = paratrooper.subList(0, 1);</span>
<span class="fc" id="L1304">    final List&lt;Unit&gt; bomberAndParatroop = new ArrayList&lt;&gt;(paratrooper);</span>
<span class="fc" id="L1305">    bomberAndParatroop.addAll(germany.getUnits().getMatches(Matches.UnitIsAirTransport));</span>
    // move to nwe, this is a valid move, and it not a partroop move
<span class="fc" id="L1307">    move(bomberAndParatroop, new Route(germany, nwe));</span>
<span class="fc" id="L1308">  }</span>

  @Test
  public void testCantMoveParatroopersThatMovedPreviously() {
    // make sure infantry can't be moved as paratroopers after moving
<span class="fc" id="L1313">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1314">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1315">    final Territory nwe = territory(&quot;Northwestern Europe&quot;, m_data);</span>
<span class="fc" id="L1316">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1317">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L1318">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1319">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1320">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1321">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1322">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1323">    final List&lt;Unit&gt; paratrooper = nwe.getUnits().getMatches(Matches.UnitIsAirTransportable);</span>
<span class="fc" id="L1324">    move(paratrooper, new Route(nwe, germany));</span>
<span class="fc" id="L1325">    final List&lt;Unit&gt; bomberAndParatroop = new ArrayList&lt;&gt;(paratrooper);</span>
<span class="fc" id="L1326">    bomberAndParatroop.addAll(germany.getUnits().getMatches(Matches.UnitIsAirTransport));</span>
    // move the units to east poland
<span class="fc" id="L1328">    final String error = moveDelegate(m_data).move(bomberAndParatroop, new Route(germany, poland, eastPoland));</span>
<span class="fc" id="L1329">    assertError(error);</span>
<span class="fc" id="L1330">  }</span>

  @Test
  public void testCantTransportParatroopersWithBombersThatMovedPreviously() {
    // make sure bombers can't move then pick up paratroopers
<span class="fc" id="L1335">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1336">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1337">    final Territory bulgaria = territory(&quot;Bulgaria Romania&quot;, m_data);</span>
<span class="fc" id="L1338">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1339">    final Territory ukraine = territory(&quot;Ukraine&quot;, m_data);</span>
<span class="fc" id="L1340">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1341">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1342">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1343">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1344">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
    // Move the bomber first
<span class="fc" id="L1346">    final List&lt;Unit&gt; bomber = germany.getUnits().getMatches(Matches.UnitIsAirTransport);</span>
<span class="fc" id="L1347">    move(bomber, new Route(germany, poland));</span>
    // Pick up a paratrooper
<span class="fc" id="L1349">    final List&lt;Unit&gt; bomberAndParatroop = new ArrayList&lt;&gt;(bomber);</span>
<span class="fc" id="L1350">    bomberAndParatroop.addAll(poland.getUnits().getUnits(GameDataTestUtil.infantry(m_data), 1));</span>
    // move them
<span class="fc" id="L1352">    final String error = moveDelegate(m_data).move(bomberAndParatroop, new Route(poland, bulgaria, ukraine));</span>
<span class="fc" id="L1353">    assertError(error);</span>
<span class="fc" id="L1354">  }</span>

  @Test
  public void testMoveOneParatrooperPerBomber() {
    // make sure only 1 paratroop per bomber can be moved
<span class="fc" id="L1359">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1360">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
    // Territory nwe = territory(&quot;Northwestern Europe&quot;, m_data);
<span class="fc" id="L1362">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1363">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L1364">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1365">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1366">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1367">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1368">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1369">    final List&lt;Unit&gt; bomberAndParatroop = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1370">    bomberAndParatroop.addAll(germany.getUnits().getMatches(Matches.UnitIsAirTransport));</span>
    // add 2 infantry
<span class="fc" id="L1372">    bomberAndParatroop.addAll(germany.getUnits().getUnits(GameDataTestUtil.infantry(m_data), 2));</span>
    // move the units to east poland
<span class="fc" id="L1374">    final String error = moveDelegate(m_data).move(bomberAndParatroop, new Route(germany, poland, eastPoland));</span>
<span class="fc" id="L1375">    assertError(error);</span>
<span class="fc" id="L1376">  }</span>

  @Test
  public void testParatroopersMoveTwice() {
    // After a battle move to put a bomber + infantry (paratroop) in a first enemy
    // territory, you can make a new move (in the same battle move round) to put
    // bomber+ infantry in a more internal enemy territory.
<span class="fc" id="L1383">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1384">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1385">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1386">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L1387">    final Territory beloRussia = territory(&quot;Belorussia&quot;, m_data);</span>
<span class="fc" id="L1388">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1389">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1390">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1391">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1392">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1393">    List&lt;Unit&gt; paratroopers = germany.getUnits().getMatches(Matches.UnitIsAirTransportable);</span>
<span class="fc" id="L1394">    paratroopers = paratroopers.subList(0, 1);</span>
<span class="fc" id="L1395">    final List&lt;Unit&gt; bomberAndParatroop = new ArrayList&lt;&gt;(paratroopers);</span>
<span class="fc" id="L1396">    bomberAndParatroop.addAll(germany.getUnits().getMatches(Matches.UnitIsAirTransport));</span>
<span class="fc" id="L1397">    final Route route = new Route(germany, poland, eastPoland);</span>
<span class="fc" id="L1398">    final List&lt;Unit&gt; airTransports = germany.getUnits().getMatches(Matches.UnitIsAirTransport);</span>
<span class="fc bfc" id="L1399" title="All 2 branches covered.">    for (final Unit airTransport : airTransports) {</span>
<span class="fc bfc" id="L1400" title="All 2 branches covered.">      for (final Unit unit : paratroopers) {</span>
<span class="fc" id="L1401">        final Change change = TransportTracker.loadTransportChange((TripleAUnit) airTransport, unit);</span>
<span class="fc" id="L1402">        bridge.addChange(change);</span>
      }
    }
    // move the units to east poland
    // airTransports
<span class="fc" id="L1407">    String error = moveDelegate(m_data).move(bomberAndParatroop, route);</span>
<span class="fc" id="L1408">    assertValid(error);</span>
    // try to move them further, this should fail
<span class="fc" id="L1410">    error = moveDelegate(m_data).move(bomberAndParatroop, new Route(eastPoland, beloRussia));</span>
<span class="fc" id="L1411">    assertError(error);</span>
<span class="fc" id="L1412">  }</span>

  @Test
  public void testParatroopersFlyOverBlitzedTerritory() {
    // We should be able to blitz a territory, then fly over it with paratroops to battle.
<span class="fc" id="L1417">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1418">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1419">    final Territory poland = territory(&quot;Poland&quot;, m_data);</span>
<span class="fc" id="L1420">    final Territory eastPoland = territory(&quot;East Poland&quot;, m_data);</span>
<span class="fc" id="L1421">    final Territory beloRussia = territory(&quot;Belorussia&quot;, m_data);</span>
    // Clear East Poland
<span class="fc" id="L1423">    removeFrom(eastPoland, eastPoland.getUnits().getUnits());</span>
    // Set up test
<span class="fc" id="L1425">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1426">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1427">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1428">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1429">    TechAttachment.get(germans).setParatroopers(&quot;true&quot;);</span>
<span class="fc" id="L1430">    List&lt;Unit&gt; paratrooper = germany.getUnits().getMatches(Matches.UnitIsAirTransportable);</span>
<span class="fc" id="L1431">    paratrooper = paratrooper.subList(0, 1);</span>
<span class="fc" id="L1432">    final List&lt;Unit&gt; bomberAndParatroop = new ArrayList&lt;&gt;(paratrooper);</span>
<span class="fc" id="L1433">    bomberAndParatroop.addAll(germany.getUnits().getMatches(Matches.UnitIsAirTransport));</span>
<span class="fc" id="L1434">    final List&lt;Unit&gt; tanks = poland.getUnits().getMatches(Matches.UnitCanBlitz);</span>
<span class="fc" id="L1435">    move(tanks, new Route(poland, eastPoland, beloRussia));</span>
<span class="fc" id="L1436">    final List&lt;Unit&gt; airTransports = Match.getMatches(bomberAndParatroop, Matches.UnitIsAirTransport);</span>
<span class="fc bfc" id="L1437" title="All 2 branches covered.">    for (final Unit airTransport : airTransports) {</span>
<span class="fc bfc" id="L1438" title="All 2 branches covered.">      for (final Unit unit : paratrooper) {</span>
<span class="fc" id="L1439">        final Change change = TransportTracker.loadTransportChange((TripleAUnit) airTransport, unit);</span>
<span class="fc" id="L1440">        bridge.addChange(change);</span>
      }
    }
    // Verify paratroops can overfly blitzed territory
<span class="fc" id="L1444">    final String error =</span>
<span class="fc" id="L1445">        moveDelegate(m_data).move(bomberAndParatroop, new Route(germany, poland, eastPoland, beloRussia));</span>
<span class="fc" id="L1446">    assertValid(error);</span>
<span class="fc" id="L1447">  }</span>

  @Test
  public void testAmphibAttackWithPlanesOnlyAskRetreatOnce() {
<span class="fc" id="L1451">    final PlayerID germans = germans(m_data);</span>
<span class="fc" id="L1452">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1453">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1454">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1455">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1456">    final Territory france = territory(&quot;France&quot;, m_data);</span>
<span class="fc" id="L1457">    final Territory egypt = territory(&quot;Egypt&quot;, m_data);</span>
<span class="fc" id="L1458">    final Territory balkans = territory(&quot;Balkans&quot;, m_data);</span>
<span class="fc" id="L1459">    final Territory libya = territory(&quot;Libya&quot;, m_data);</span>
<span class="fc" id="L1460">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1461">    final Territory sz13 = territory(&quot;13 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1462">    final Territory sz14 = territory(&quot;14 Sea Zone&quot;, m_data);</span>
<span class="fc" id="L1463">    final Territory sz15 = territory(&quot;15 Sea Zone&quot;, m_data);</span>
    ;
<span class="fc" id="L1465">    when(dummyPlayer.retreatQuery(any(), anyBoolean(), any(),</span>
<span class="fc" id="L1466">        any(), contains(BattleStepStrings.RETREAT_PLANES))).thenThrow(</span>
<span class="fc" id="L1467">            new AssertionError(&quot;The Message is not allowed to contain the BattleStepStrings.RETREAT_PLANES constant&quot;));</span>
<span class="fc" id="L1468">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L1469">    final ITripleADisplay dummyDisplay = mock(ITripleADisplay.class);</span>
<span class="fc" id="L1470">    doThrow(new AssertionError(</span>
<span class="fc" id="L1471">        &quot;None of the Battle steps is allow to contain the BattleStepStrings.PLANES_WITHDRAW constant&quot;))</span>
<span class="fc" id="L1472">            .when(dummyDisplay).listBattleSteps(any(), argThat(list -&gt; {</span>
<span class="fc bfc" id="L1473" title="All 2 branches covered.">              for (final String string : list) {</span>
<span class="pc bpc" id="L1474" title="1 of 2 branches missed.">                if (string.contains(BattleStepStrings.PLANES_WITHDRAW)) {</span>
<span class="nc" id="L1475">                  return true;</span>
                }
              }
<span class="fc" id="L1478">              return false;</span>
            }));
<span class="fc" id="L1480">    bridge.setDisplay(dummyDisplay);</span>
    // move units for amphib assault
<span class="fc" id="L1482">    load(france.getUnits().getMatches(Matches.UnitIsInfantry), new Route(france, sz13));</span>
<span class="fc" id="L1483">    move(sz13.getUnits().getUnits(), new Route(sz13, sz14, sz15));</span>
<span class="fc" id="L1484">    move(sz15.getUnits().getMatches(Matches.UnitIsInfantry), new Route(sz15, egypt));</span>
    // ground attack
<span class="fc" id="L1486">    load(libya.getUnits().getMatches(Matches.UnitIsArtillery), new Route(libya, egypt));</span>
    // air units
<span class="fc" id="L1488">    move(germany.getUnits().getMatches(Matches.UnitIsStrategicBomber), new Route(germany, balkans, sz14, sz15, egypt));</span>
<span class="fc" id="L1489">    moveDelegate(m_data).end();</span>
<span class="fc" id="L1490">    bridge.setStepName(&quot;Combat&quot;);</span>
    // cook the dice so that all miss first round,all hit second round
<span class="fc" id="L1492">    bridge.setRandomSource(new ScriptedRandomSource(5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1));</span>
<span class="fc" id="L1493">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1494">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1495">    fight(battleDelegate(m_data), egypt);</span>
<span class="fc" id="L1496">  }</span>

  @Test
  public void testDefencelessTransportsDie() {
<span class="fc" id="L1500">    final PlayerID british = british(m_data);</span>
<span class="fc" id="L1501">    final ITestDelegateBridge bridge = getDelegateBridge(british);</span>
<span class="fc" id="L1502">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1503">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1504">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1505">    final Territory uk = territory(&quot;United Kingdom&quot;, m_data);</span>
<span class="fc" id="L1506">    final Territory sz5 = territory(&quot;5 Sea Zone&quot;, m_data);</span>
    // remove the sub
<span class="fc" id="L1508">    removeFrom(sz5, sz5.getUnits().getMatches(Matches.UnitIsSub));</span>

<span class="fc" id="L1510">    when(dummyPlayer.retreatQuery(any(), anyBoolean(), any(),</span>
<span class="fc" id="L1511">        any(), any())).thenAnswer(new Answer&lt;Territory&gt;() {</span>
          @Override
          public Territory answer(final InvocationOnMock invocation) throws Throwable {
<span class="nc" id="L1514">            throw new IllegalStateException(</span>
<span class="nc" id="L1515">                &quot;Should not be asked to retreat:&quot; + invocation.getArgument(4));</span>
          }
        });
<span class="fc" id="L1518">    bridge.setRemote(dummyPlayer);</span>
<span class="fc" id="L1519">    move(uk.getUnits().getMatches(Matches.UnitIsAir), m_data.getMap().getRoute(uk, sz5));</span>
    // move units for amphib assault
<span class="fc" id="L1521">    moveDelegate(m_data).end();</span>
<span class="fc" id="L1522">    bridge.setStepName(&quot;Combat&quot;);</span>
    // cook the dice so that 1 british fighters hits, and nothing else
    // this will leave 1 transport alone in the sea zone
<span class="fc" id="L1525">    bridge.setRandomSource(new ScriptedRandomSource(1, 5, 5, 5, 5, 5, 5, 5, 5));</span>
<span class="fc" id="L1526">    battleDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1527">    battleDelegate(m_data).start();</span>
<span class="fc" id="L1528">    fight(battleDelegate(m_data), sz5);</span>
    // make sure the transports died
<span class="fc" id="L1530">    assertTrue(sz5.getUnits().getMatches(Matches.unitIsOwnedBy(germans(m_data))).isEmpty());</span>
<span class="fc" id="L1531">  }</span>

  @Test
  public void testFighterLandsWhereCarrierCanBePlaced() {
<span class="fc" id="L1535">    final PlayerID germans = germans(m_data);</span>
    // germans have 1 carrier to place
<span class="fc" id="L1537">    addTo(germans, carrier(m_data).create(1, germans), m_data);</span>
    // start the move phase
<span class="fc" id="L1539">    final ITestDelegateBridge bridge = getDelegateBridge(germans);</span>
<span class="fc" id="L1540">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1541">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1542">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1543">    bridge.setRemote(dummyPlayer);</span>
    // the fighter should be able to move and hover in the sea zone
    // the fighter has no movement left
<span class="fc" id="L1546">    final Territory neEurope = territory(&quot;Northwestern Europe&quot;, m_data);</span>
<span class="fc" id="L1547">    final Route route = new Route(neEurope, territory(&quot;Germany&quot;, m_data), territory(&quot;Poland&quot;, m_data),</span>
<span class="fc" id="L1548">        territory(&quot;Baltic States&quot;, m_data), territory(&quot;5 Sea Zone&quot;, m_data));</span>
    // the fighter should be able to move, and hover in the sea zone until the carrier is placed
<span class="fc" id="L1550">    move(neEurope.getUnits().getMatches(Matches.UnitIsAir), route);</span>
<span class="fc" id="L1551">  }</span>

  @Test
  public void testFighterCantHoverWithNoCarrierToPlace() {
    // start the move phase
<span class="fc" id="L1556">    final ITestDelegateBridge bridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L1557">    bridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1558">    moveDelegate(m_data).setDelegateBridgeAndPlayer(bridge);</span>
<span class="fc" id="L1559">    moveDelegate(m_data).start();</span>
<span class="fc" id="L1560">    bridge.setRemote(dummyPlayer);</span>
    // the fighter should not be able to move and hover in the sea zone
    // since their are no carriers to place
    // the fighter has no movement left
<span class="fc" id="L1564">    final Territory neEurope = territory(&quot;Northwestern Europe&quot;, m_data);</span>
<span class="fc" id="L1565">    final Route route = new Route(neEurope, territory(&quot;Germany&quot;, m_data), territory(&quot;Poland&quot;, m_data),</span>
<span class="fc" id="L1566">        territory(&quot;Baltic States&quot;, m_data), territory(&quot;5 Sea Zone&quot;, m_data));</span>
<span class="fc" id="L1567">    final String error = moveDelegate(m_data).move(neEurope.getUnits().getMatches(Matches.UnitIsAir), route);</span>
<span class="fc" id="L1568">    assertNotNull(error);</span>
<span class="fc" id="L1569">  }</span>

  @Test
  public void testRepair() {
<span class="fc" id="L1573">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1574">    final Unit factory = germany.getUnits().getMatches(Matches.UnitCanBeDamaged).get(0);</span>
<span class="fc" id="L1575">    final PurchaseDelegate del = purchaseDelegate(m_data);</span>
<span class="fc" id="L1576">    del.setDelegateBridgeAndPlayer(getDelegateBridge(germans(m_data)));</span>
<span class="fc" id="L1577">    del.start();</span>
    // Set up player
<span class="fc" id="L1579">    final PlayerID germans = GameDataTestUtil.germans(m_data);</span>
<span class="fc" id="L1580">    final int initPUs = germans.getResources().getQuantity(&quot;PUs&quot;);</span>
    // damage a factory
<span class="fc" id="L1582">    IntegerMap&lt;Unit&gt; startHits = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L1583">    startHits.put(factory, 1);</span>
<span class="fc" id="L1584">    m_data.performChange(ChangeFactory.bombingUnitDamage(startHits));</span>
<span class="fc" id="L1585">    assertEquals(((TripleAUnit) factory).getUnitDamage(), 1);</span>
<span class="fc" id="L1586">    RepairRule repair = germans(m_data).getRepairFrontier().getRules().get(0);</span>
<span class="fc" id="L1587">    IntegerMap&lt;RepairRule&gt; repairs = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L1588">    repairs.put(repair, 1);</span>
<span class="fc" id="L1589">    String error = del.purchaseRepair(Collections.singletonMap(</span>
<span class="fc" id="L1590">        Match.getMatches(germany.getUnits().getUnits(), Matches.UnitCanBeDamaged).iterator().next(), repairs));</span>
<span class="fc" id="L1591">    assertValid(error);</span>
<span class="fc" id="L1592">    assertEquals(((TripleAUnit) factory).getUnitDamage(), 0);</span>
    // Find cost
<span class="fc" id="L1594">    final int midPUs = germans.getResources().getQuantity(&quot;PUs&quot;);</span>
<span class="fc" id="L1595">    assertEquals(initPUs, midPUs + 1);</span>
    /*
     * INCREASED_FACTORY_PRODUCTION repairs
     */
    // Set up INCREASED_FACTORY_PRODUCTION
<span class="fc" id="L1600">    final ITestDelegateBridge delegateBridge = getDelegateBridge(germans(m_data));</span>
<span class="fc" id="L1601">    TechTracker.addAdvance(germans, delegateBridge,</span>
<span class="fc" id="L1602">        TechAdvance.findAdvance(TechAdvance.TECH_PROPERTY_INCREASED_FACTORY_PRODUCTION, m_data, germans));</span>
    // damage a factory
<span class="fc" id="L1604">    startHits = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L1605">    startHits.put(factory, 2);</span>
<span class="fc" id="L1606">    m_data.performChange(ChangeFactory.bombingUnitDamage(startHits));</span>
<span class="fc" id="L1607">    assertEquals(((TripleAUnit) factory).getUnitDamage(), 2);</span>
<span class="fc" id="L1608">    repair = germans(m_data).getRepairFrontier().getRules().get(0);</span>
<span class="fc" id="L1609">    repairs = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L1610">    repairs.put(repair, 2);</span>
<span class="fc" id="L1611">    error = del.purchaseRepair(Collections.singletonMap(</span>
<span class="fc" id="L1612">        Match.getMatches(germany.getUnits().getUnits(), Matches.UnitCanBeDamaged).iterator().next(), repairs));</span>
<span class="fc" id="L1613">    assertValid(error);</span>
<span class="fc" id="L1614">    assertEquals(((TripleAUnit) factory).getUnitDamage(), 0);</span>
    // Find cost
<span class="fc" id="L1616">    final int finalPUs = germans.getResources().getQuantity(&quot;PUs&quot;);</span>
<span class="fc" id="L1617">    assertEquals(midPUs, finalPUs + 1);</span>
<span class="fc" id="L1618">  }</span>

  @Test
  public void testRepairMoreThanDamaged() {
<span class="fc" id="L1622">    final Territory germany = territory(&quot;Germany&quot;, m_data);</span>
<span class="fc" id="L1623">    final Unit factory = germany.getUnits().getMatches(Matches.UnitCanBeDamaged).get(0);</span>
<span class="fc" id="L1624">    final PurchaseDelegate del = purchaseDelegate(m_data);</span>
<span class="fc" id="L1625">    del.setDelegateBridgeAndPlayer(getDelegateBridge(germans(m_data)));</span>
<span class="fc" id="L1626">    del.start();</span>
    // dame a factory
<span class="fc" id="L1628">    final IntegerMap&lt;Unit&gt; startHits = new IntegerMap&lt;&gt;();</span>
<span class="fc" id="L1629">    startHits.put(factory, 1);</span>
<span class="fc" id="L1630">    m_data.performChange(ChangeFactory.bombingUnitDamage(startHits));</span>
<span class="fc" id="L1631">    assertEquals(((TripleAUnit) factory).getUnitDamage(), 1);</span>
<span class="fc" id="L1632">    final RepairRule repair = germans(m_data).getRepairFrontier().getRules().get(0);</span>
<span class="fc" id="L1633">    final IntegerMap&lt;RepairRule&gt; repairs = new IntegerMap&lt;&gt;();</span>
    // we have 1 damaged marker, but trying to repair 2
<span class="fc" id="L1635">    repairs.put(repair, 2);</span>
<span class="fc" id="L1636">    final String error = del.purchaseRepair(Collections.singletonMap(</span>
<span class="fc" id="L1637">        Match.getMatches(germany.getUnits().getUnits(), Matches.UnitCanBeDamaged).iterator().next(), repairs));</span>
    // it is no longer an error, we just math max 0 it
<span class="fc" id="L1639">    assertValid(error);</span>
<span class="fc" id="L1640">    assertEquals(((TripleAUnit) factory).getUnitDamage(), 0);</span>
<span class="fc" id="L1641">  }</span>

  @Test
  public void testOccupiedTerrOfAttachment() {
    // Set up test
<span class="fc" id="L1646">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L1647">    final ITestDelegateBridge delegateBridge = getDelegateBridge(british(m_data));</span>
    // Set up the move delegate
<span class="fc" id="L1649">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L1650">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1651">    moveDelegate(m_data).setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L1652">    moveDelegate(m_data).start();</span>
    // Set up the territories
<span class="fc" id="L1654">    final Territory hupeh = territory(&quot;Hupeh&quot;, m_data);</span>
<span class="fc" id="L1655">    final Territory kiangsu = territory(&quot;Kiangsu&quot;, m_data);</span>
    // Remove all units
<span class="fc" id="L1657">    removeFrom(kiangsu, kiangsu.getUnits().getUnits());</span>
<span class="fc" id="L1658">    removeFrom(hupeh, hupeh.getUnits().getUnits());</span>
    // Set up the unit types
<span class="fc" id="L1660">    addTo(hupeh, infantry(m_data).create(1, british));</span>
    // Get units
<span class="fc" id="L1662">    final Collection&lt;Unit&gt; moveUnits = hupeh.getUnits().getUnits();</span>
    // Get Owner prior to battle
<span class="fc" id="L1664">    final String preOwner = kiangsu.getOwner().getName();</span>
<span class="fc" id="L1665">    assertEquals(preOwner, Constants.PLAYER_NAME_JAPANESE);</span>
    // add a VALID attack
<span class="fc" id="L1667">    final String validResults = moveDelegate.move(moveUnits, new Route(hupeh, kiangsu));</span>
<span class="fc" id="L1668">    assertValid(validResults);</span>
    // Ensure owner after attack doesn't match attacker
<span class="fc" id="L1670">    final String postOwner = kiangsu.getOwner().getName();</span>
<span class="fc" id="L1671">    assertNotSame(postOwner, Constants.PLAYER_NAME_BRITISH);</span>
    // Check that original owner is now owner
<span class="fc" id="L1673">    assertEquals(postOwner, Constants.PLAYER_NAME_CHINESE);</span>
<span class="fc" id="L1674">  }</span>

  @Test
  public void testOccupiedTerrOfAttachmentWithCapital() {
    // Set up test
<span class="fc" id="L1679">    final PlayerID british = GameDataTestUtil.british(m_data);</span>
<span class="fc" id="L1680">    final ITestDelegateBridge delegateBridge = getDelegateBridge(british(m_data));</span>
    // Set up the move delegate
<span class="fc" id="L1682">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L1683">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1684">    moveDelegate(m_data).setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L1685">    moveDelegate(m_data).start();</span>
    // Set up the territories
<span class="fc" id="L1687">    final Territory hupeh = territory(&quot;Hupeh&quot;, m_data);</span>
<span class="fc" id="L1688">    final Territory kiangsu = territory(&quot;Kiangsu&quot;, m_data);</span>
<span class="fc" id="L1689">    final Territory mongolia = territory(&quot;Mongolia&quot;, m_data);</span>
    // Remove original capital
<span class="fc" id="L1691">    final TerritoryAttachment taMongolia = TerritoryAttachment.get(mongolia);</span>
<span class="fc" id="L1692">    final TerritoryAttachment taKiangsu = TerritoryAttachment.get(kiangsu);</span>
    try {
<span class="fc" id="L1694">      final String noVal = null;</span>
<span class="fc" id="L1695">      taMongolia.setCapital(noVal);</span>
      // Set as NEW capital
<span class="fc" id="L1697">      taKiangsu.setCapital(Constants.PLAYER_NAME_CHINESE);</span>
<span class="pc" id="L1698">    } catch (final GameParseException e) {</span>
<span class="nc" id="L1699">      ClientLogger.logError(e);</span>
    }
    // Remove all units
<span class="fc" id="L1702">    removeFrom(kiangsu, kiangsu.getUnits().getUnits());</span>
<span class="fc" id="L1703">    removeFrom(hupeh, hupeh.getUnits().getUnits());</span>
    // Set up the unit types
<span class="fc" id="L1705">    addTo(hupeh, infantry(m_data).create(1, british));</span>
    // Get units
<span class="fc" id="L1707">    final Collection&lt;Unit&gt; moveUnits = hupeh.getUnits().getUnits();</span>
    // Get Owner prior to battle
<span class="fc" id="L1709">    final String preOwner = kiangsu.getOwner().getName();</span>
<span class="fc" id="L1710">    assertEquals(preOwner, Constants.PLAYER_NAME_JAPANESE);</span>
    // add a VALID attack
<span class="fc" id="L1712">    final String validResults = moveDelegate.move(moveUnits, new Route(hupeh, kiangsu));</span>
<span class="fc" id="L1713">    assertValid(validResults);</span>
    // Ensure owner after attack doesn't match attacker
<span class="fc" id="L1715">    final String postOwner = kiangsu.getOwner().getName();</span>
<span class="fc" id="L1716">    assertNotSame(postOwner, Constants.PLAYER_NAME_BRITISH);</span>
    // Check that original owner is now owner
<span class="fc" id="L1718">    assertEquals(postOwner, Constants.PLAYER_NAME_CHINESE);</span>
<span class="fc" id="L1719">  }</span>

  @Test
  public void testTwoStepBlitz() {
<span class="fc" id="L1723">    final ITestDelegateBridge delegateBridge = getDelegateBridge(british(m_data));</span>
    // Set up the territories
<span class="fc" id="L1725">    final Territory libya = territory(&quot;Libya&quot;, m_data);</span>
<span class="fc" id="L1726">    final Territory egypt = territory(&quot;Egypt&quot;, m_data);</span>
<span class="fc" id="L1727">    final Territory morrocco = territory(&quot;Morocco Algeria&quot;, m_data);</span>
<span class="fc" id="L1728">    removeFrom(libya, libya.getUnits().getUnits());</span>
    // Set up the move delegate
<span class="fc" id="L1730">    final MoveDelegate moveDelegate = moveDelegate(m_data);</span>
<span class="fc" id="L1731">    delegateBridge.setStepName(&quot;CombatMove&quot;);</span>
<span class="fc" id="L1732">    moveDelegate.setDelegateBridgeAndPlayer(delegateBridge);</span>
<span class="fc" id="L1733">    moveDelegate.start();</span>
    // blitz in two steps
<span class="fc" id="L1735">    final Collection&lt;Unit&gt; armour = egypt.getUnits().getMatches(Matches.UnitCanBlitz);</span>
<span class="fc" id="L1736">    move(armour, new Route(egypt, libya));</span>
<span class="fc" id="L1737">    assertEquals(libya.getOwner(), british(m_data));</span>
<span class="fc" id="L1738">    move(armour, new Route(libya, morrocco));</span>
<span class="fc" id="L1739">  }</span>

  /*
   * Add Utilities here
   */
  private Collection&lt;Unit&gt; getUnits(final IntegerMap&lt;UnitType&gt; units, final PlayerID from) {
<span class="fc" id="L1745">    final Iterator&lt;UnitType&gt; iter = units.keySet().iterator();</span>
<span class="fc" id="L1746">    final Collection&lt;Unit&gt; rVal = new ArrayList&lt;&gt;(units.totalValues());</span>
<span class="fc bfc" id="L1747" title="All 2 branches covered.">    while (iter.hasNext()) {</span>
<span class="fc" id="L1748">      final UnitType type = iter.next();</span>
<span class="fc" id="L1749">      rVal.addAll(from.getUnits().getUnits(type, units.getInt(type)));</span>
    }
<span class="fc" id="L1751">    return rVal;</span>
  }

  /*
   * Add assertions here
   */
  public void assertValid(final String string) {
<span class="fc" id="L1758">    assertNull(string, string);</span>
<span class="fc" id="L1759">  }</span>

  public void assertError(final String string) {
<span class="fc" id="L1762">    assertNotNull(string, string);</span>
<span class="fc" id="L1763">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>test (25/nov/2016 10:16:58)</div></body></html>